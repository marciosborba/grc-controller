import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { useAuth } from '@/contexts/AuthContextOptimized';
import { supabase } from '@/integrations/supabase/client';
import {
  Shield,
  Save,
  ArrowLeft,
  AlertTriangle,
  Info,
  X,
  Plus,
  User,
  FileText,
  Code,
  Globe,
  Server,
  Smartphone,
  Database,
  Cloud,
  Monitor,
  Target,
  Settings,
  Bell,
  Download,
  Trash,
  Paperclip,
  UploadCloud,
  CheckCircle2,
  AlertCircle,
  Activity,
  Users
} from 'lucide-react';
import { useNavigate, useParams } from 'react-router-dom';
import { toast } from 'sonner';
import { calculateCVSSBaseScore, calculateBusinessRiskScore, calculatePriorityScore } from '@/utils/risk-calculator';
import { useCustomFields } from './hooks/useCustomFields';
import { CycleTimeTimeline } from './CycleTimeTimeline';
import { RemediationBlock } from './RemediationBlock';
import { useDropzone } from 'react-dropzone';

// Types
interface Group {
  id: string;
  name: string;
}

type VulnerabilitySeverity = 'Critical' | 'High' | 'Medium' | 'Low' | 'Info';
type VulnerabilityStatus = 'Open' | 'In_Progress' | 'Testing' | 'Resolved' | 'Accepted' | 'False_Positive' | 'Duplicate' | string;
type VulnerabilitySource = 'Pentest' | 'SAST' | 'DAST' | 'Cloud' | 'Infrastructure' | 'Manual' | 'Risk_Register' | 'Bug_Bounty' | 'Compliance_Audit';
type AssetType = 'Web_Application' | 'Mobile_App' | 'API' | 'Database' | 'Server' | 'Network_Device' | 'Cloud_Service' | 'Desktop_App';
type RemediationEffort = 'Low' | 'Medium' | 'High' | 'Very_High';
type BusinessImpact = 'Low' | 'Medium' | 'High' | 'Critical';

const SEVERITY_OPTIONS: { value: VulnerabilitySeverity; label: string; color: string }[] = [
  { value: 'Critical', label: 'Crítica', color: 'bg-red-100 text-red-800' },
  { value: 'High', label: 'Alta', color: 'bg-orange-100 text-orange-800' },
  { value: 'Medium', label: 'Média', color: 'bg-yellow-100 text-yellow-800' },
  { value: 'Low', label: 'Baixa', color: 'bg-blue-100 text-blue-800' },
  { value: 'Info', label: 'Informativa', color: 'bg-gray-100 text-gray-800' },
];

const STATUS_OPTIONS: { value: VulnerabilityStatus; label: string }[] = [
  { value: 'Open', label: 'Aberta' },
  { value: 'In_Progress', label: 'Em Progresso' },
  { value: 'Testing', label: 'Em Teste' },
  { value: 'Resolved', label: 'Resolvida' },
  { value: 'Accepted', label: 'Aceita' },
  { value: 'False_Positive', label: 'Falso Positivo' },
  { value: 'Duplicate', label: 'Duplicada' },
];

const SOURCE_OPTIONS: { value: VulnerabilitySource; label: string; icon: any }[] = [
  { value: 'Pentest', label: 'Teste de Penetração', icon: Shield },
  { value: 'SAST', label: 'SAST', icon: Code },
  { value: 'DAST', label: 'DAST', icon: Globe },
  { value: 'Cloud', label: 'Cloud Security', icon: Cloud },
  { value: 'Infrastructure', label: 'Infraestrutura', icon: Server },
  { value: 'Manual', label: 'Manual', icon: User },
  { value: 'Risk_Register', label: 'Registro de Riscos', icon: FileText },
  { value: 'Bug_Bounty', label: 'Bug Bounty', icon: Target },
  { value: 'Compliance_Audit', label: 'Auditoria de Compliance', icon: Shield },
];

const ASSET_TYPE_OPTIONS: { value: AssetType; label: string; icon: any }[] = [
  { value: 'Web_Application', label: 'Aplicação Web', icon: Globe },
  { value: 'Mobile_App', label: 'Aplicativo Mobile', icon: Smartphone },
  { value: 'API', label: 'API', icon: Code },
  { value: 'Database', label: 'Banco de Dados', icon: Database },
  { value: 'Server', label: 'Servidor', icon: Server },
  { value: 'Network_Device', label: 'Dispositivo de Rede', icon: Monitor },
  { value: 'Cloud_Service', label: 'Serviço em Nuvem', icon: Cloud },
  { value: 'Desktop_App', label: 'Aplicação Desktop', icon: Monitor },
];

const EFFORT_OPTIONS: { value: RemediationEffort; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Very_High', label: 'Muito Alto' },
];

const IMPACT_OPTIONS: { value: BusinessImpact; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Critical', label: 'Crítico' },
];

interface VulnerabilityFormProps {
  vulnerabilityId?: string;
  isEmbedded?: boolean;
  onSuccess?: () => void;
  onCancel?: () => void;
}

export default function VulnerabilityForm({
  vulnerabilityId,
  isEmbedded = false,
  onSuccess,
  onCancel
}: VulnerabilityFormProps = {}) {
  const navigate = useNavigate();
  const { id: paramId } = useParams();
  const id = vulnerabilityId || paramId;
  const { customFields, getFieldValues, saveFieldValues } = useCustomFields();

  const isEditing = Boolean(id);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [customFieldValues, setCustomFieldValues] = useState<Record<string, any>>({});
  const [groups, setGroups] = useState<Group[]>([]);
  const [assigneeType, setAssigneeType] = useState<'user' | 'group'>('user');

  // Form state
  const [formData, setFormData] = useState({
    id: '',
    app_id: '',
    title: '',
    description: '',
    severity: 'Medium' as VulnerabilitySeverity,
    cvss_score: '',
    cvss_vector: '',
    cve_id: '',
    cwe_id: '',
    source_type: 'Manual' as VulnerabilitySource,
    source_tool: '',
    source_scan_id: '',
    asset_name: '',
    asset_type: 'Web_Application' as AssetType,
    asset_ip: '',
    asset_url: '',
    status: 'Open' as VulnerabilityStatus,
    assigned_to: '',
    assigned_team: '',
    due_date: '',
    remediation_effort: 'Medium' as RemediationEffort,
    business_impact: 'Medium' as BusinessImpact,
    tags: [] as string[],
    remediation_steps: '',
    remediation_notes: '',
    false_positive_reason: '',
    retest_required: false,
    exploit_available: false,
    patch_available: false,
    workaround_available: false,
    compliance_frameworks: [] as string[],
  });

  // Advanced Risk Calculation State
  const [riskFactors, setRiskFactors] = useState({
    // CVSS 3.1 Base Metrics
    attackVector: 'Network' as 'Network' | 'Adjacent' | 'Local' | 'Physical',
    attackComplexity: 'Low' as 'Low' | 'High',
    privilegesRequired: 'None' as 'None' | 'Low' | 'High',
    userInteraction: 'None' as 'None' | 'Required',
    scope: 'Unchanged' as 'Unchanged' | 'Changed',
    confidentialityImpact: 'High' as 'None' | 'Low' | 'High',
    integrityImpact: 'High' as 'None' | 'Low' | 'High',
    availabilityImpact: 'High' as 'None' | 'Low' | 'High',

    // Environmental Factors
    assetExposure: 'Internet' as 'Internet' | 'Internal' | 'Restricted' | 'Isolated',
    assetCriticality: 'High' as 'Low' | 'Medium' | 'High' | 'Critical',
    dataClassification: 'Confidential' as 'Public' | 'Internal' | 'Confidential' | 'Restricted',

    // Temporal Factors
    exploitCodeMaturity: 'Functional' as 'Not_Defined' | 'Unproven' | 'Proof_of_Concept' | 'Functional' | 'High',
    remediationLevel: 'Official_Fix' as 'Not_Defined' | 'Official_Fix' | 'Temporary_Fix' | 'Workaround' | 'Unavailable',
    reportConfidence: 'Confirmed' as 'Not_Defined' | 'Unknown' | 'Reasonable' | 'Confirmed',

    // Business Impact
    businessCriticality: 'High' as 'Low' | 'Medium' | 'High' | 'Critical',
    complianceImpact: 'High' as 'None' | 'Low' | 'Medium' | 'High',
    reputationImpact: 'Medium' as 'Low' | 'Medium' | 'High' | 'Critical',
    financialImpact: 'Medium' as 'Low' | 'Medium' | 'High' | 'Critical',
  });

  const [newTag, setNewTag] = useState('');
  const [errors, setErrors] = useState<{ [key: string]: string }>({});

  // Custom Status Logic
  const { user, refreshUser } = useAuth();
  const isAdmin = user?.isPlatformAdmin || user?.roles?.includes('admin') || user?.roles?.includes('super_admin');
  const [showStatusDialog, setShowStatusDialog] = useState(false);
  const [newStatus, setNewStatus] = useState('');
  const [customStatuses, setCustomStatuses] = useState<{ value: string; label: string }[]>([]);


  const [users, setUsers] = useState<{ id: string; full_name: string; email: string }[]>([]);

  // Remediation Blocks State
  const [remediationBlocks, setRemediationBlocks] = useState<any[]>([]);

  const fetchUsers = async () => {
    try {
      const { data, error } = await supabase
        .from('profiles')
        .select('id, full_name, email')
        .order('full_name');

      if (error) throw error;
      setUsers(data || []);
    } catch (error) {
      console.error('Error fetching users:', error);
    }
  };

  const fetchGroups = async () => {
    try {
      if (!user?.tenantId) return;
      const { data, error } = await supabase
        .from('groups')
        .select('id, name')
        .eq('tenant_id', user.tenantId)
        .order('name');

      if (error) throw error;
      setGroups(data || []);
    } catch (error) {
      console.error('Error fetching groups:', error);
    }
  };

  useEffect(() => {
    fetchUsers();
    fetchGroups();
  }, [user?.tenantId]);

  useEffect(() => {
    if (id) {
      fetchRemediationBlocks();
    }
  }, [id]);

  const fetchRemediationBlocks = async () => {
    const { data, error } = await supabase
      .from('remediation_tasks')
      .select('*')
      .eq('vulnerability_id', id)
      .order('created_at', { ascending: true });

    if (error) {
      console.error('Error fetching blocks:', error);
    } else {
      setRemediationBlocks(data || []);
    }
  };

  const handleCreateBlock = async () => {
    if (!id) return;

    const { error } = await supabase
      .from('remediation_tasks')
      .insert({
        vulnerability_id: id,
        status: 'open'
      });

    if (error) {
      toast.error('Erro ao criar etapa de remediação');
    } else {
      toast.success('Nova etapa de remediação criada');
      fetchRemediationBlocks();
    }
  };



  useEffect(() => {
    if (user?.settings?.vulnerability_status_options) {
      setCustomStatuses(user.settings.vulnerability_status_options);
    }
  }, [user]);

  const handleAddStatus = async () => {
    if (!newStatus.trim() || !user?.tenantId) return;

    const statusValue = newStatus.trim().replace(/\s+/g, '_');
    const statusLabel = newStatus.trim();

    // Check for duplicates
    if (STATUS_OPTIONS.some(s => s.value === statusValue) || customStatuses.some(s => s.value === statusValue)) {
      toast.error('Status já existe');
      return;
    }

    const newOption = { value: statusValue, label: statusLabel };
    const updatedStatuses = [...customStatuses, newOption];

    try {
      // Update tenant settings
      const newSettings = {
        ...user.settings,
        vulnerability_status_options: updatedStatuses
      };

      const { error } = await supabase
        .from('tenants')
        .update({ settings: newSettings })
        .eq('id', user.tenantId);

      if (error) throw error;

      setCustomStatuses(updatedStatuses);
      setNewStatus('');
      await refreshUser();
      toast.success('Novo status adicionado');
    } catch (error) {
      console.error('Error adding status:', error);
      toast.error('Erro ao adicionar status');
    }
  };

  const handleDeleteStatus = async (valueToDelete: string) => {
    if (!user?.tenantId) return;

    try {
      const updatedStatuses = customStatuses.filter(s => s.value !== valueToDelete);

      const newSettings = {
        ...user.settings,
        vulnerability_status_options: updatedStatuses
      };

      const { error } = await supabase
        .from('tenants')
        .update({ settings: newSettings })
        .eq('id', user.tenantId);

      if (error) throw error;

      setCustomStatuses(updatedStatuses);
      await refreshUser();
      toast.success('Status removido');
    } catch (error) {
      console.error('Error deleting status:', error);
      toast.error('Erro ao remover status');
    }
  };

  useEffect(() => {
    if (isEditing && id) {
      loadVulnerability(id);
      loadCustomFieldValues(id);
    }
  }, [id, isEditing]);

  const loadCustomFieldValues = async (vulnerabilityId: string) => {
    try {
      const values = await getFieldValues(vulnerabilityId);
      setCustomFieldValues(values);
    } catch (error) {
      console.error('Error loading custom field values:', error);
    }
  };

  const loadVulnerability = async (vulnerabilityId: string) => {
    setLoading(true);
    try {
      const { data, error } = await supabase
        .from('vulnerabilities')
        .select('*')
        .eq('id', vulnerabilityId)
        .single();

      if (error) throw error;

      if (data) {
        setFormData(prev => ({
          ...prev,
          id: data.id,
          app_id: data.app_id || '',
          title: data.title,
          description: data.description || '',
          severity: data.severity as VulnerabilitySeverity,
          cvss_score: data.cvss_score?.toString() || '',
          cve_id: data.cve_id || '',
          source_type: data.source_type as VulnerabilitySource,
          source_tool: data.source_tool || 'Manual',
          asset_name: data.asset_name || 'Desconhecido',
          asset_type: (data.asset_type as AssetType) || 'Web_Application',
          status: data.status as VulnerabilityStatus,
          asset_ip: data.asset_ip?.toString() || '',
          asset_url: data.asset_url || '',
          root_cause_details: data.root_cause_details || '',
          assigned_to: data.assigned_to || '',
          assigned_group_id: data.assigned_group_id || null,
        }));

        // Determine assignee type
        if (data.assigned_group_id) {
          setAssigneeType('group');
        } else if (data.assigned_to) {
          setAssigneeType('user');
        }

        if (data.risk_assessment_data) {
          setRiskFactors(prev => ({
            ...prev,
            ...data.risk_assessment_data
          }));
        }
      }
    } catch (error) {
      console.error('Error loading vulnerability:', error);
      toast.error('Erro ao carregar vulnerabilidade');
      navigate('/vulnerabilities/list');
    } finally {
      setLoading(false);
    }
  };

  const validateForm = (): boolean => {
    const newErrors: { [key: string]: string } = {};

    if (!formData.title.trim()) {
      newErrors.title = 'Título é obrigatório';
    }

    // if (!formData.description.trim()) {
    //   newErrors.description = 'Descrição é obrigatória';
    // }

    if (!formData.asset_name.trim()) {
      newErrors.asset_name = 'Nome do ativo é obrigatório';
    }

    /* Optional validation for source_tool */
    if (!formData.source_tool?.trim()) {
      // If empty, we can default it in handleSave instead of erroring
      // newErrors.source_tool = 'Ferramenta de origem é obrigatória';
    }

    if (formData.cvss_score && (isNaN(Number(formData.cvss_score)) || Number(formData.cvss_score) < 0 || Number(formData.cvss_score) > 10)) {
      newErrors.cvss_score = 'CVSS Score deve ser um número entre 0 e 10';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSave = async () => {
    // Validate first and capture errors locally to display them
    const newErrors: { [key: string]: string } = {};
    if (!formData.title.trim()) newErrors.title = 'Título';
    // if (!formData.description.trim()) newErrors.description = 'Descrição';
    if (!formData.asset_name.trim()) newErrors.asset_name = 'Nome do Ativo';

    // Optional weak validation for CVSS
    if (formData.cvss_score && (isNaN(Number(formData.cvss_score)) || Number(formData.cvss_score) < 0 || Number(formData.cvss_score) > 10)) {
      newErrors.cvss_score = 'CVSS Score (0-10)';
    }

    if (Object.keys(newErrors).length > 0) {
      setErrors(newErrors);
      const errorList = Object.values(newErrors).join(', ');
      toast.error(`Corrija os erros nos campos: ${errorList}`);
      return;
    }

    setSaving(true);
    try {
      if (!user?.tenantId) {
        throw new Error('Tenant not found');
      }

      const vulnerabilityData = {
        title: formData.title,
        description: formData.description,
        severity: formData.severity,
        status: formData.status,
        cvss_score: formData.cvss_score ? Number(formData.cvss_score) : null,
        cve_id: formData.cve_id || null,
        source_tool: formData.source_tool || 'Manual',
        source_type: formData.source_type,
        asset_name: formData.asset_name,
        asset_type: formData.asset_type,
        asset_url: formData.asset_url || null,
        asset_ip: formData.asset_ip || null,
        app_id: formData.app_id || null,
        tenant_id: user.tenantId,
        updated_at: new Date().toISOString(),
        root_cause_category: (formData as any).root_cause_category || null,
        root_cause_details: (formData as any).root_cause_details || null,
        assigned_to: assigneeType === 'user' ? (formData.assigned_to || null) : null,
        assigned_group_id: assigneeType === 'group' ? ((formData as any).assigned_group_id || null) : null,
        risk_score: calculateBusinessRiskScore(riskFactors),
        priority_score: calculatePriorityScore(riskFactors),
        risk_assessment_data: riskFactors,
      };

      let vulnerabilityId = id;

      if (isEditing && id) {
        const { error } = await supabase
          .from('vulnerabilities')
          .update(vulnerabilityData)
          .eq('id', id);

        if (error) throw error;
      } else {
        const { data, error } = await supabase
          .from('vulnerabilities')
          .insert([vulnerabilityData])
          .select()
          .single();

        if (error) throw error;
        vulnerabilityId = data.id;
      }

      // Save custom field values
      if (vulnerabilityId) {
        await saveFieldValues(vulnerabilityId, customFieldValues);
      }

      if (isEditing) {
        toast.success('Vulnerabilidade atualizada com sucesso');
      } else {
        toast.success('Vulnerabilidade criada com sucesso');
      }

      if (onSuccess) {
        onSuccess();
      } else {
        navigate('/vulnerabilities/list');
      }
    } catch (error: any) {
      console.error('Error saving vulnerability:', error);
      const errorMessage = error?.message || error?.error_description || (error instanceof Error ? error.message : 'Unknown error');
      toast.error(`Erro ao salvar vulnerabilidade: ${errorMessage}`);
    } finally {
      setSaving(false);
    }
  };



  const handleUpdateVulnerabilityStatus = async (newStatus: string) => {
    // Optimistic update
    setFormData(prev => ({ ...prev, status: newStatus as VulnerabilityStatus }));

    if (id) {
      try {
        const { error } = await supabase
          .from('vulnerabilities')
          .update({ status: newStatus })
          .eq('id', id);

        if (error) throw error;
        toast.success(`Status da vulnerabilidade atualizado para: ${newStatus}`);
      } catch (error) {
        console.error('Error updating vulnerability status:', error);
        toast.error('Erro ao atualizar status da vulnerabilidade');
        // Revert on error could be added here if needed, but for now we assume success
      }
    }
  };

  const handleNotifyTeam = async () => {
    if (!formData.assigned_to && !formData.assigned_team) {
      toast.error('Defina um Responsável ou Equipe antes de notificar.');
      return;
    }

    try {
      const { error } = await supabase
        .from('notifications')
        .insert({
          tenant_id: user?.tenantId,
          type: 'vulnerability_assignment',
          module: 'vulnerabilities',
          title: `Correção Solicitada: ${formData.title}`,
          message: `Você foi designado para corrigir a vulnerabilidade "${formData.title}". Prazo: ${formData.due_date || 'A definir'}.`,
          priority: 'high',
          metadata: { vulnerability_id: id }
        });

      if (error) throw error;
      toast.success('Notificação enviada com sucesso!');
    } catch (error) {
      console.error('Notification error:', error);
      toast.error('Erro ao enviar notificação.');
    }
  };

  /* Local CVSS calculation removed in favor of utility */
  const calculateCVSSBaseScoreWrapper = () => {
    return calculateCVSSBaseScore(riskFactors);
  };

  const calculateTemporalScore = (): number => {
    const exploitCodeMaturityScores = {
      Not_Defined: 1.0, Unproven: 0.91, Proof_of_Concept: 0.94, Functional: 0.97, High: 1.0
    };
    const remediationLevelScores = {
      Not_Defined: 1.0, Official_Fix: 0.95, Temporary_Fix: 0.96, Workaround: 0.97, Unavailable: 1.0
    };
    const reportConfidenceScores = {
      Not_Defined: 1.0, Unknown: 0.92, Reasonable: 0.96, Confirmed: 1.0
    };

    const baseScore = calculateCVSSBaseScore(riskFactors);
    const temporalScore = baseScore *
      exploitCodeMaturityScores[riskFactors.exploitCodeMaturity] *
      remediationLevelScores[riskFactors.remediationLevel] *
      reportConfidenceScores[riskFactors.reportConfidence];

    return Math.round(temporalScore * 10) / 10;
  };

  const calculateEnvironmentalScore = (): number => {
    const exposureMultiplier = {
      Internet: 1.2, Internal: 1.0, Restricted: 0.8, Isolated: 0.6
    };
    const criticalityMultiplier = {
      Low: 0.7, Medium: 0.85, High: 1.0, Critical: 1.15
    };
    const dataClassificationMultiplier = {
      Public: 0.7, Internal: 0.85, Confidential: 1.0, Restricted: 1.15
    };

    const temporalScore = calculateTemporalScore();
    const environmentalScore = temporalScore *
      exposureMultiplier[riskFactors.assetExposure] *
      criticalityMultiplier[riskFactors.assetCriticality] *
      dataClassificationMultiplier[riskFactors.dataClassification];

    return Math.min(10, Math.round(environmentalScore * 10) / 10);
  };

  const calculateBusinessRiskScoreWrapper = (): number => {
    return calculateBusinessRiskScore(riskFactors);
  };

  const calculatePriorityScoreWrapper = (): number => {
    // return calculatePriorityScore(riskFactors);
    // Using direct utility if available or local wrapper
    // Actually we imported calculatePriorityScore from utils
    return calculatePriorityScore(riskFactors);
  };

  const getRiskLevel = (score: number): { level: string; color: string; description: string } => {
    if (score >= 9.0) return { level: 'Crítico', color: 'bg-red-600 text-white', description: 'Requer ação imediata' };
    if (score >= 7.0) return { level: 'Alto', color: 'bg-red-500 text-white', description: 'Alta prioridade' };
    if (score >= 4.0) return { level: 'Médio', color: 'bg-yellow-500 text-white', description: 'Prioridade moderada' };
    if (score >= 0.1) return { level: 'Baixo', color: 'bg-green-500 text-white', description: 'Baixa prioridade' };
    return { level: 'Informativo', color: 'bg-gray-500 text-white', description: 'Apenas informativo' };
  };

  const calculateRiskScore = (): number => {
    return calculateBusinessRiskScore();
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }));
      setNewTag('');
    }
  };

  const handleRemoveTag = (tagToRemove: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(tag => tag !== tagToRemove)
    }));
  };

  const getSeverityBadge = (severity: VulnerabilitySeverity) => {
    const option = SEVERITY_OPTIONS.find(opt => opt.value === severity);
    return (
      <Badge className={option?.color}>
        {option?.label}
      </Badge>
    );
  };

  const renderCustomField = (field: any) => {
    const value = customFieldValues[field.name] || field.defaultValue || '';

    const updateCustomFieldValue = (fieldName: string, newValue: any) => {
      setCustomFieldValues(prev => ({
        ...prev,
        [fieldName]: newValue
      }));
    };

    switch (field.type) {
      case 'select':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Select
              value={value}
              onValueChange={(newValue) => updateCustomFieldValue(field.name, newValue)}
            >
              <SelectTrigger>
                <SelectValue placeholder={field.placeholder || `Selecione ${field.label}`} />
              </SelectTrigger>
              <SelectContent>
                {field.options?.map((option: string) => (
                  <SelectItem key={option} value={option}>
                    {option}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'textarea':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Textarea
              id={field.name}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              rows={3}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'boolean':
        return (
          <div key={field.id} className="space-y-2">
            <div className="flex items-center space-x-2">
              <Switch
                checked={Boolean(value)}
                onCheckedChange={(checked) => updateCustomFieldValue(field.name, checked)}
              />
              <Label htmlFor={field.name}>
                {field.label}
                {field.required && <span className="text-red-500 ml-1">*</span>}
              </Label>
            </div>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'number':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="number"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              min={field.validation?.min}
              max={field.validation?.max}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'date':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="date"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'email':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="email"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      case 'url':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="url"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );

      default: // text, phone
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type={field.type === 'phone' ? 'tel' : 'text'}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header - Conditionally Rendered */}
      {!isEmbedded ? (
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-4">
            <Button variant="ghost" onClick={() => navigate('/vulnerabilities/list')}>
              <ArrowLeft className="h-4 w-4 mr-2" />
              Voltar
            </Button>
            <div>
              <h1 className="text-3xl font-bold flex items-center gap-2">
                <Shield className="h-8 w-8 text-primary" />
                {isEditing ? 'Editar Vulnerabilidade' : 'Nova Vulnerabilidade'}
              </h1>
              <p className="text-muted-foreground">
                {isEditing ? 'Atualize as informações da vulnerabilidade' : 'Registre uma nova vulnerabilidade no sistema'}
              </p>
            </div>
          </div>
          <div className="flex gap-2">
            <Button variant="outline" onClick={() => navigate('/vulnerabilities/list')}>
              Cancelar
            </Button>
            <Button onClick={handleSave} disabled={saving}>
              {saving ? (
                <>
                  <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                  Salvando...
                </>
              ) : (
                <>
                  <Save className="h-4 w-4 mr-2" />
                  {isEditing ? 'Atualizar' : 'Criar'}
                </>
              )}
            </Button>
          </div>
        </div>
      ) : (
        /* Embedded Controls */
        <div className="flex items-center justify-between mb-4 pb-4 border-b">
          <div className="flex items-center gap-2">
            <Shield className="h-5 w-5 text-primary" />
            <h3 className="font-semibold text-lg">Editar Detalhes</h3>
          </div>
          <div className="flex gap-2">
            {onCancel && (
              <Button variant="ghost" size="sm" onClick={onCancel}>
                Cancelar
              </Button>
            )}
            <Button size="sm" onClick={handleSave} disabled={saving}>
              {saving ? 'Salvando...' : 'Salvar Alterações'}
            </Button>
          </div>
        </div>
      )}

      <Tabs defaultValue="basic" className="w-full">
        <TabsList>
          <TabsTrigger value="basic">Informações Básicas</TabsTrigger>
          <TabsTrigger value="technical">Detalhes Técnicos</TabsTrigger>
          <TabsTrigger value="remediation">Remediação</TabsTrigger>
          <TabsTrigger value="classification">Classificação</TabsTrigger>
          {customFields.length > 0 && (
            <TabsTrigger value="custom">Campos Customizados</TabsTrigger>
          )}
          {isEditing && (
            <TabsTrigger value="timeline">Cycle Time</TabsTrigger>
          )}
        </TabsList>

        <TabsContent value="basic" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Informações Básicas</CardTitle>
              <CardDescription>
                Dados principais da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* ID, APPID and Assignee */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="id">ID</Label>
                  <Input
                    id="id"
                    value={formData.id}
                    onChange={(e) => setFormData(prev => ({ ...prev, id: e.target.value }))}
                    placeholder="Ex: VULN-2024-001"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="app_id">APPID</Label>
                  <Input
                    id="app_id"
                    value={formData.app_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, app_id: e.target.value }))}
                    placeholder="Ex: APP-WEB-001"
                  />
                </div>

                <div className="space-y-2">
                  <Label>Tipo de Responsável</Label>
                  <div className="flex items-center space-x-4 mb-2">
                    <div className="flex items-center space-x-2">
                      <input
                        type="radio"
                        id="assignee_user"
                        checked={assigneeType === 'user'}
                        onChange={() => setAssigneeType('user')}
                        className="cursor-pointer"
                      />
                      <Label htmlFor="assignee_user" className="cursor-pointer font-normal">Usuário</Label>
                    </div>
                    <div className="flex items-center space-x-2">
                      <input
                        type="radio"
                        id="assignee_group"
                        checked={assigneeType === 'group'}
                        onChange={() => setAssigneeType('group')}
                        className="cursor-pointer"
                      />
                      <Label htmlFor="assignee_group" className="cursor-pointer font-normal">Grupo</Label>
                    </div>
                  </div>

                  {assigneeType === 'user' ? (
                    <Select
                      value={formData.assigned_to}
                      onValueChange={(value) => setFormData(prev => ({ ...prev, assigned_to: value, assigned_group_id: null }))}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Selecione um usuário" />
                      </SelectTrigger>
                      <SelectContent>
                        {users.map(user => (
                          <SelectItem key={user.id} value={user.id}>
                            {user.full_name || user.email}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  ) : (
                    <Select
                      value={(formData as any).assigned_group_id || ''}
                      onValueChange={(value) => setFormData(prev => ({ ...prev, assigned_group_id: value, assigned_to: '' }))}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="Selecione um grupo" />
                      </SelectTrigger>
                      <SelectContent>
                        {groups.length === 0 ? (
                          <SelectItem value="no_groups" disabled>Nenhum grupo encontrado</SelectItem>
                        ) : (
                          groups.map(group => (
                            <SelectItem key={group.id} value={group.id}>
                              {group.name}
                            </SelectItem>
                          ))
                        )}
                      </SelectContent>
                    </Select>
                  )}
                </div>
              </div>

              {/* Title and Description */}
              <div className="grid grid-cols-1 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="title">Título *</Label>
                  <Input
                    id="title"
                    value={formData.title}
                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="Ex: SQL Injection no formulário de login"
                    className={errors.title ? 'border-red-500' : ''}
                  />
                  {errors.title && (
                    <p className="text-sm text-red-600">{errors.title}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="description">Descrição</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="Descreva detalhadamente a vulnerabilidade encontrada..."
                    rows={4}
                    className={errors.description ? 'border-red-500' : ''}
                  />
                  {errors.description && (
                    <p className="text-sm text-red-600">{errors.description}</p>
                  )}
                </div>
              </div>

              {/* Severity and Status */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Severidade</Label>
                  <Select value={formData.severity} onValueChange={(value) => setFormData(prev => ({ ...prev, severity: value as VulnerabilitySeverity }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {SEVERITY_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <Badge className={option.color}>{option.label}</Badge>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Status</Label>
                  <Select value={formData.status} onValueChange={(value) => {
                    if (value === 'manage_custom_status') {
                      setShowStatusDialog(true);
                    } else {
                      setFormData(prev => ({ ...prev, status: value as VulnerabilityStatus }));
                    }
                  }}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {STATUS_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                      {customStatuses.length > 0 && <div className="h-px bg-muted my-1" />}
                      {customStatuses.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                      <div className="h-px bg-muted my-1" />
                      <SelectItem value="manage_custom_status" className="text-primary font-medium focus:text-primary focus:bg-primary/10">
                        <div className="flex items-center">
                          <Plus className="h-4 w-4 mr-2" />
                          Gerenciar Status
                        </div>
                      </SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>



              {/* Asset Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_name">Nome do Ativo *</Label>
                  <Input
                    id="asset_name"
                    value={formData.asset_name}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_name: e.target.value }))}
                    placeholder="Ex: Portal Web Principal"
                    className={errors.asset_name ? 'border-red-500' : ''}
                  />
                  {errors.asset_name && (
                    <p className="text-sm text-red-600">{errors.asset_name}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label>Tipo de Ativo</Label>
                  <Select value={formData.asset_type} onValueChange={(value) => setFormData(prev => ({ ...prev, asset_type: value as AssetType }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {ASSET_TYPE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Asset Details */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_ip">IP do Ativo</Label>
                  <Input
                    id="asset_ip"
                    value={formData.asset_ip}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_ip: e.target.value }))}
                    placeholder="Ex: 192.168.1.100"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="asset_url">URL do Ativo</Label>
                  <Input
                    id="asset_url"
                    value={formData.asset_url}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_url: e.target.value }))}
                    placeholder="Ex: https://portal.empresa.com"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="technical" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Detalhes Técnicos</CardTitle>
              <CardDescription>
                Informações técnicas e de origem da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Source Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Tipo de Fonte</Label>
                  <Select value={formData.source_type} onValueChange={(value) => setFormData(prev => ({ ...prev, source_type: value as VulnerabilitySource }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {SOURCE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_tool">Ferramenta de Origem *</Label>
                  <Input
                    id="source_tool"
                    value={formData.source_tool}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_tool: e.target.value }))}
                    placeholder="Ex: OWASP ZAP, Nessus, Manual"
                    className={errors.source_tool ? 'border-red-500' : ''}
                  />
                  {errors.source_tool && (
                    <p className="text-sm text-red-600">{errors.source_tool}</p>
                  )}
                </div>
              </div>

              {/* CVE and CWE */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cve_id">CVE ID</Label>
                  <Input
                    id="cve_id"
                    value={formData.cve_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cve_id: e.target.value }))}
                    placeholder="Ex: CVE-2024-1234"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cwe_id">CWE ID</Label>
                  <Input
                    id="cwe_id"
                    value={formData.cwe_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cwe_id: e.target.value }))}
                    placeholder="Ex: CWE-89"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_scan_id">ID do Scan</Label>
                  <Input
                    id="source_scan_id"
                    value={formData.source_scan_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_scan_id: e.target.value }))}
                    placeholder="ID do scan de origem"
                  />
                </div>
              </div>

              {/* CVSS Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cvss_score">CVSS Score</Label>
                  <Input
                    id="cvss_score"
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    value={formData.cvss_score}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_score: e.target.value }))}
                    placeholder="Ex: 8.1"
                    className={errors.cvss_score ? 'border-red-500' : ''}
                  />
                  {errors.cvss_score && (
                    <p className="text-sm text-red-600">{errors.cvss_score}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cvss_vector">CVSS Vector</Label>
                  <Input
                    id="cvss_vector"
                    value={formData.cvss_vector}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_vector: e.target.value }))}
                    placeholder="Ex: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
                  />
                </div>
              </div>

              {/* Flags */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Características</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.exploit_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, exploit_available: checked }))}
                    />
                    <Label>Exploit disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.patch_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, patch_available: checked }))}
                    />
                    <Label>Patch disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.workaround_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, workaround_available: checked }))}
                    />
                    <Label>Workaround disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.retest_required}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, retest_required: checked }))}
                    />
                    <Label>Reteste necessário</Label>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="remediation" className="space-y-6">
          <div className="space-y-6">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold">Etapas da Correção</h3>
                <p className="text-sm text-muted-foreground">Gerencie a correção por equipes e unidades de trabalho.</p>
              </div>
              <Button onClick={handleCreateBlock}>
                <Plus className="h-4 w-4 mr-2" />
                Adicionar Etapa da Correção
              </Button>
            </div>

            <div className="space-y-6">
              {remediationBlocks.map(block => (
                <RemediationBlock
                  key={block.id}
                  task={block}
                  onUpdate={fetchRemediationBlocks}
                  onDelete={async () => {
                    if (confirm('Tem certeza que deseja excluir esta etapa?')) {
                      await supabase.from('remediation_tasks').delete().eq('id', block.id);
                      fetchRemediationBlocks();
                    }
                  }}
                  customStatusOptions={customStatuses}
                  standardStatusOptions={STATUS_OPTIONS}
                  onManageStatus={() => setShowStatusDialog(true)}
                  onAddNext={handleCreateBlock}
                  isAdmin={Boolean(isAdmin)}
                  vulnerabilityStatus={formData.status}
                  onUpdateVulnerabilityStatus={handleUpdateVulnerabilityStatus}
                />
              ))}

              {remediationBlocks.length === 0 && (
                <div className="text-center py-12 border-2 border-dashed rounded-lg bg-muted/20">
                  <CheckCircle2 className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
                  <h3 className="text-lg font-medium">Nenhuma etapa de remediação</h3>
                  <p className="text-muted-foreground mb-4">Comece adicionando uma etapa de trabalho para uma equipe.</p>
                  <Button onClick={handleCreateBlock} variant="outline">
                    <Plus className="h-4 w-4 mr-2" />
                    Criar Primeira Etapa
                  </Button>
                </div>
              )}
            </div>
          </div>
        </TabsContent>

        <TabsContent value="classification" className="space-y-6">
          {/* Risk Calculator Header */}
          {/* Risk Calculator Header */}
          <Card className="relative overflow-hidden border-l-4 border-l-primary shadow-sm hover:shadow-md transition-all">
            <div className="absolute top-0 right-0 p-3 opacity-5">
              <AlertTriangle className="h-32 w-32" />
            </div>
            <CardHeader>
              <CardTitle className="flex items-center gap-2 text-xl font-bold">
                <div className="p-2 bg-primary/10 rounded-lg">
                  <AlertTriangle className="h-6 w-6 text-primary" />
                </div>
                Calculadora de Risco e Priorização
              </CardTitle>
              <CardDescription className="text-base">
                Calcule a criticidade e o impacto da vulnerabilidade cruzando métricas técnicas (CVSS) com o contexto de negócio.
              </CardDescription>
            </CardHeader>
          </Card>

          {/* CVSS 3.1 Base Metrics */}
          <Card className="relative overflow-hidden border-t-4 border-t-blue-500 hover:shadow-lg transition-all">
            <div className="absolute top-0 right-0 p-4 opacity-5 pointer-events-none">
              <Shield className="h-24 w-24 text-blue-500" />
            </div>
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <div className="p-1.5 bg-blue-100 dark:bg-blue-900/30 rounded-md">
                  <Target className="h-5 w-5 text-blue-600 dark:text-blue-400" />
                </div>
                CVSS 3.1 - Métricas Técnicas
              </CardTitle>
              <CardDescription>
                Configure os vetores de ataque para calcular o score base técnico.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6 relative z-10">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Vetor de Ataque (AV)</Label>
                  <Select value={riskFactors.attackVector} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, attackVector: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Network">Rede (N)</SelectItem>
                      <SelectItem value="Adjacent">Adjacente (A)</SelectItem>
                      <SelectItem value="Local">Local (L)</SelectItem>
                      <SelectItem value="Physical">Físico (P)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Complexidade (AC)</Label>
                  <Select value={riskFactors.attackComplexity} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, attackComplexity: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low">Baixa (L)</SelectItem>
                      <SelectItem value="High">Alta (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Privilégios (PR)</Label>
                  <Select value={riskFactors.privilegesRequired} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, privilegesRequired: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None">Nenhum (N)</SelectItem>
                      <SelectItem value="Low">Baixo (L)</SelectItem>
                      <SelectItem value="High">Alto (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Interação (UI)</Label>
                  <Select value={riskFactors.userInteraction} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, userInteraction: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None">Nenhuma (N)</SelectItem>
                      <SelectItem value="Required">Necessária (R)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Confidencialidade (C)</Label>
                  <Select value={riskFactors.confidentialityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, confidentialityImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None">Nenhuma (N)</SelectItem>
                      <SelectItem value="Low">Baixa (L)</SelectItem>
                      <SelectItem value="High">Alta (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Integridade (I)</Label>
                  <Select value={riskFactors.integrityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, integrityImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None">Nenhuma (N)</SelectItem>
                      <SelectItem value="Low">Baixa (L)</SelectItem>
                      <SelectItem value="High">Alta (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Disponibilidade (A)</Label>
                  <Select value={riskFactors.availabilityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, availabilityImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None">Nenhuma (N)</SelectItem>
                      <SelectItem value="Low">Baixa (L)</SelectItem>
                      <SelectItem value="High">Alta (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Escopo (S)</Label>
                  <Select value={riskFactors.scope} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, scope: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Unchanged">Inalterado (U)</SelectItem>
                      <SelectItem value="Changed">Alterado (C)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="p-5 bg-gradient-to-r from-blue-50 to-transparent dark:from-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900 flex justify-between items-center">
                <div>
                  <h4 className="font-bold text-blue-900 dark:text-blue-100 flex items-center gap-2">
                    <Activity className="h-5 w-5 text-blue-500" />
                    Score Técnico Calculado
                  </h4>
                  <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                    Base puramente técnica, sem contexto do ambiente.
                  </p>
                </div>
                <div className="flex items-center gap-4">
                  <Badge variant="outline" className="text-2xl px-4 py-2 bg-background font-bold border-blue-200">
                    {calculateCVSSBaseScoreWrapper()}
                  </Badge>
                  <Button
                    onClick={() => setFormData(prev => ({ ...prev, cvss_score: calculateCVSSBaseScoreWrapper().toString() }))}
                    size="sm"
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    Usar este Score
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Environmental Factors */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Fatores Ambientais</CardTitle>
              <CardDescription>
                Contextualize a vulnerabilidade com o ambiente e o ativo afetado
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label>Exposição do Ativo (MAV)</Label>
                  <Select value={riskFactors.assetExposure} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, assetExposure: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Internet">Internet (1.2x)</SelectItem>
                      <SelectItem value="Internal">Interna (1.0x)</SelectItem>
                      <SelectItem value="Restricted">Restrita (0.8x)</SelectItem>
                      <SelectItem value="Isolated">Isolada (0.6x)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Criticidade do Ativo (MAC)</Label>
                  <Select value={riskFactors.assetCriticality} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, assetCriticality: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Critical">Crítica (1.15x)</SelectItem>
                      <SelectItem value="High">Alta (1.0x)</SelectItem>
                      <SelectItem value="Medium">Média (0.85x)</SelectItem>
                      <SelectItem value="Low">Baixa (0.7x)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Classificação de Dados (MDC)</Label>
                  <Select value={riskFactors.dataClassification} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, dataClassification: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Restricted">Restrita (1.15x)</SelectItem>
                      <SelectItem value="Confidential">Confidencial (1.0x)</SelectItem>
                      <SelectItem value="Internal">Interna (0.85x)</SelectItem>
                      <SelectItem value="Public">Pública (0.7x)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="p-4 bg-muted rounded-md flex justify-between items-center">
                <div>
                  <h4 className="font-medium">Score Ambiental (CVSS Modificado)</h4>
                  <p className="text-sm text-muted-foreground">Considerando o ambiente específico</p>
                </div>
                <Badge variant="outline" className="text-lg px-4 py-1">
                  {calculateEnvironmentalScore()}
                </Badge>
              </div>
            </CardContent>
          </Card>

          {/* Business Impact */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Impacto no Negócio</CardTitle>
              <CardDescription>
                Avalie o impacto financeiro, operaciona e de reputação
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Impacto Financeiro</Label>
                  <Select value={riskFactors.financialImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, financialImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Critical">Crítico</SelectItem>
                      <SelectItem value="High">Alto</SelectItem>
                      <SelectItem value="Medium">Médio</SelectItem>
                      <SelectItem value="Low">Baixo</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto na Reputação</Label>
                  <Select value={riskFactors.reputationImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, reputationImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Critical">Crítico</SelectItem>
                      <SelectItem value="High">Alto</SelectItem>
                      <SelectItem value="Medium">Médio</SelectItem>
                      <SelectItem value="Low">Baixo</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto de Compliance</Label>
                  <Select value={riskFactors.complianceImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, complianceImpact: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="High">Alto (Violação)</SelectItem>
                      <SelectItem value="Medium">Médio</SelectItem>
                      <SelectItem value="Low">Baixo</SelectItem>
                      <SelectItem value="None">Nenhum</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Criticidade do Processo</Label>
                  <Select value={riskFactors.businessCriticality} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, businessCriticality: value as any }))}>
                    <SelectTrigger style={{ color: '#000000' }} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Critical">Crítica</SelectItem>
                      <SelectItem value="High">Alta</SelectItem>
                      <SelectItem value="Medium">Média</SelectItem>
                      <SelectItem value="Low">Baixa</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="flex items-center gap-4 p-4 border rounded-lg bg-slate-50 dark:bg-slate-900">
                <div className="flex-1">
                  <h4 className="font-semibold text-lg">Score de Risco de Negócio</h4>
                  <p className="text-sm text-muted-foreground">Prioridade sugerida para correção</p>
                </div>
                <div className="text-right">
                  <div className="text-2xl font-bold">{calculateBusinessRiskScoreWrapper()}</div>
                  <Badge className={`${getRiskLevel(calculateBusinessRiskScoreWrapper()).color} mt-1`}>
                    {getRiskLevel(calculateBusinessRiskScoreWrapper()).level}
                  </Badge>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {customFields.length > 0 && (
          <TabsContent value="custom" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Campos Customizados</CardTitle>
                <CardDescription>
                  Informações específicas da organização
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {customFields.map(field => renderCustomField(field))}
                </div>
              </CardContent>
            </Card>
          </TabsContent>
        )}

        {isEditing && (
          <TabsContent value="timeline" className="space-y-6">
            <CycleTimeTimeline vulnerabilityId={id!} />
          </TabsContent>
        )}

      </Tabs>

      {/* Dialog for Custom Status */}
      <Dialog open={showStatusDialog} onOpenChange={setShowStatusDialog}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Gerenciar Status Customizados</DialogTitle>
            <DialogDescription>
              Adicione ou remova status personalizados para suas vulnerabilidades.
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4 py-4">
            <div className="flex gap-2">
              <Input
                placeholder="Nome do novo status"
                value={newStatus}
                onChange={(e) => setNewStatus(e.target.value)}
              />
              <Button onClick={handleAddStatus}>Adicionar</Button>
            </div>

            <div className="space-y-2">
              <Label>Status Existentes</Label>
              <div className="border rounded-md divide-y">
                {STATUS_OPTIONS.map(status => (
                  <div key={status.value} className="p-3 flex justify-between items-center bg-muted/50">
                    <span className="font-medium">{status.label}</span>
                    <Badge variant="outline">Padrão</Badge>
                  </div>
                ))}
                {customStatuses.map(status => (
                  <div key={status.value} className="p-3 flex justify-between items-center">
                    <span>{status.label}</span>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleDeleteStatus(status.value)}
                      className="text-red-500 hover:text-red-600 hover:bg-red-50"
                    >
                      <Trash className="h-4 w-4" />
                    </Button>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowStatusDialog(false)}>
              Fechar
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}