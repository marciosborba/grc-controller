import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import {
  Settings,
  ArrowLeft,
  Plus,
  Edit,
  Trash2,
  Save,
  Eye,
  EyeOff,
  Move,
  Copy,
  Download,
  Upload,
  AlertTriangle,
  CheckCircle,
  Info,
  Zap,
  Type,
  Hash,
  Calendar,
  ToggleLeft,
  List,
  FileText,
  Link,
  Mail,
  Phone,
  Globe,
  GripVertical
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'sonner';
import { DragDropContext, Droppable, Draggable } from '@hello-pangea/dnd';
import { useCustomFields, CustomField as HookCustomField } from './hooks/useCustomFields';
import { useAuth } from '@/contexts/AuthContextOptimized';

// Types for custom fields
interface CustomField {
  id: string;
  name: string;
  label: string;
  type: 'text' | 'number' | 'date' | 'boolean' | 'select' | 'textarea' | 'email' | 'url' | 'phone';
  required: boolean;
  visible: boolean;
  order: number;
  tab: 'basic' | 'technical' | 'remediation' | 'classification' | 'custom';
  description?: string;
  placeholder?: string;
  defaultValue?: string;
  options?: string[]; // For select type
  validation?: {
    min?: number;
    max?: number;
    pattern?: string;
    message?: string;
  };
  importMapping?: {
    qualys?: string;
    nessus?: string;
    openvas?: string;
    burp?: string;
    custom?: string;
  };
  created_at: Date;
  updated_at: Date;
}

interface FieldTemplate {
  id: string;
  name: string;
  description: string;
  fields: Omit<CustomField, 'id' | 'created_at' | 'updated_at'>[];
  source: 'qualys' | 'nessus' | 'openvas' | 'burp' | 'custom';
}

const FIELD_TYPES = [
  { value: 'text', label: 'Texto', icon: Type, description: 'Campo de texto simples' },
  { value: 'textarea', label: 'Texto Longo', icon: FileText, description: 'Campo de texto com múltiplas linhas' },
  { value: 'number', label: 'Número', icon: Hash, description: 'Campo numérico' },
  { value: 'date', label: 'Data', icon: Calendar, description: 'Campo de data' },
  { value: 'boolean', label: 'Sim/Não', icon: ToggleLeft, description: 'Campo verdadeiro/falso' },
  { value: 'select', label: 'Lista', icon: List, description: 'Lista de opções predefinidas' },
  { value: 'email', label: 'Email', icon: Mail, description: 'Campo de email' },
  { value: 'url', label: 'URL', icon: Link, description: 'Campo de URL' },
  { value: 'phone', label: 'Telefone', icon: Phone, description: 'Campo de telefone' },
];

const TABS_OPTIONS = [
  { value: 'basic', label: 'Informações Básicas' },
  { value: 'technical', label: 'Detalhes Técnicos' },
  { value: 'remediation', label: 'Remediação' },
  { value: 'classification', label: 'Classificação' },
  { value: 'custom', label: 'Campos Customizados' },
];

const FIELD_TEMPLATES: FieldTemplate[] = [
  {
    id: 'qualys-extended',
    name: 'Qualys VMDR - Campos Completos',
    description: 'Conjunto completo de 44 campos oficiais do Qualys VMDR conforme documentação da API',
    source: 'qualys',
    fields: [
      {
        name: 'qid',
        label: 'QID',
        type: 'number',
        required: false,
        visible: true,
        order: 1,
        tab: 'technical',
        description: 'Qualys ID único da vulnerabilidade (número)',
        importMapping: { qualys: 'QID' }
      },
      {
        name: 'qualys_type',
        label: 'Type',
        type: 'select',
        required: false,
        visible: true,
        order: 2,
        tab: 'technical',
        options: ['Vuln', 'Potential', 'Info'],
        description: 'Tipo de detecção do Qualys',
        importMapping: { qualys: 'TYPE' }
      },
      {
        name: 'qualys_port',
        label: 'Port',
        type: 'number',
        required: false,
        visible: true,
        order: 3,
        tab: 'technical',
        description: 'Porta onde a vulnerabilidade foi detectada',
        importMapping: { qualys: 'PORT' }
      },
      {
        name: 'qualys_protocol',
        label: 'Protocol',
        type: 'select',
        required: false,
        visible: true,
        order: 4,
        tab: 'technical',
        options: ['tcp', 'udp', 'icmp'],
        description: 'Protocolo da vulnerabilidade',
        importMapping: { qualys: 'PROTOCOL' }
      },
      {
        name: 'qualys_fqdn',
        label: 'FQDN',
        type: 'text',
        required: false,
        visible: true,
        order: 5,
        tab: 'basic',
        description: 'Nome completo do domínio',
        importMapping: { qualys: 'FQDN' }
      },
      {
        name: 'qualys_ssl',
        label: 'SSL',
        type: 'boolean',
        required: false,
        visible: true,
        order: 6,
        tab: 'technical',
        description: 'Vulnerabilidade relacionada a SSL',
        importMapping: { qualys: 'SSL' }
      },
      {
        name: 'qualys_results',
        label: 'Results',
        type: 'textarea',
        required: false,
        visible: true,
        order: 7,
        tab: 'technical',
        description: 'Resultados detalhados do scan',
        importMapping: { qualys: 'RESULTS' }
      },
      {
        name: 'qualys_operating_system',
        label: 'Operating System',
        type: 'text',
        required: false,
        visible: true,
        order: 8,
        tab: 'basic',
        description: 'Sistema operacional do ativo',
        importMapping: { qualys: 'OPERATING_SYSTEM' }
      },
      {
        name: 'qualys_category',
        label: 'Category',
        type: 'select',
        required: false,
        visible: true,
        order: 9,
        tab: 'classification',
        options: ['CGI', 'General remote services', 'Windows', 'UNIX', 'Databases', 'Firewalls', 'Web servers', 'Mail servers', 'FTP servers', 'DNS servers', 'Backdoors', 'Peer-To-Peer File Sharing', 'SCADA'],
        description: 'Categoria oficial do Qualys',
        importMapping: { qualys: 'CATEGORY' }
      },
      {
        name: 'qualys_pci_vuln',
        label: 'PCI Vuln',
        type: 'boolean',
        required: false,
        visible: true,
        order: 10,
        tab: 'classification',
        description: 'Vulnerabilidade afeta PCI DSS',
        importMapping: { qualys: 'PCI_VULN' }
      },
      {
        name: 'qualys_instance',
        label: 'Instance',
        type: 'text',
        required: false,
        visible: true,
        order: 11,
        tab: 'technical',
        description: 'Instância específica da vulnerabilidade',
        importMapping: { qualys: 'INSTANCE' }
      },
      {
        name: 'qualys_first_found_datetime',
        label: 'First Found',
        type: 'date',
        required: false,
        visible: true,
        order: 12,
        tab: 'basic',
        description: 'Data da primeira detecção',
        importMapping: { qualys: 'FIRST_FOUND_DATETIME' }
      },
      {
        name: 'qualys_last_found_datetime',
        label: 'Last Found',
        type: 'date',
        required: false,
        visible: true,
        order: 13,
        tab: 'basic',
        description: 'Data da última detecção',
        importMapping: { qualys: 'LAST_FOUND_DATETIME' }
      },
      {
        name: 'qualys_times_found',
        label: 'Times Found',
        type: 'number',
        required: false,
        visible: true,
        order: 14,
        tab: 'basic',
        description: 'Número de vezes que foi encontrada',
        importMapping: { qualys: 'TIMES_FOUND' }
      },
      {
        name: 'qualys_last_test_datetime',
        label: 'Last Test',
        type: 'date',
        required: false,
        visible: true,
        order: 15,
        tab: 'basic',
        description: 'Data do último teste',
        importMapping: { qualys: 'LAST_TEST_DATETIME' }
      },
      {
        name: 'qualys_last_update_datetime',
        label: 'Last Update',
        type: 'date',
        required: false,
        visible: true,
        order: 16,
        tab: 'basic',
        description: 'Data da última atualização',
        importMapping: { qualys: 'LAST_UPDATE_DATETIME' }
      },
      {
        name: 'qualys_is_ignored',
        label: 'Is Ignored',
        type: 'boolean',
        required: false,
        visible: true,
        order: 17,
        tab: 'classification',
        description: 'Vulnerabilidade está sendo ignorada',
        importMapping: { qualys: 'IS_IGNORED' }
      },
      {
        name: 'qualys_is_disabled',
        label: 'Is Disabled',
        type: 'boolean',
        required: false,
        visible: true,
        order: 18,
        tab: 'classification',
        description: 'Vulnerabilidade está desabilitada',
        importMapping: { qualys: 'IS_DISABLED' }
      },
      {
        name: 'qualys_severity',
        label: 'Severity',
        type: 'select',
        required: false,
        visible: true,
        order: 19,
        tab: 'classification',
        options: ['1', '2', '3', '4', '5'],
        description: 'Nível de severidade do Qualys (1-5)',
        importMapping: { qualys: 'SEVERITY' }
      },
      {
        name: 'qualys_title',
        label: 'Title',
        type: 'text',
        required: false,
        visible: true,
        order: 20,
        tab: 'basic',
        description: 'Título da vulnerabilidade no Qualys',
        importMapping: { qualys: 'TITLE' }
      },
      {
        name: 'qualys_last_service_modification_datetime',
        label: 'Last Service Modification',
        type: 'date',
        required: false,
        visible: true,
        order: 21,
        tab: 'basic',
        description: 'Data da última modificação do serviço',
        importMapping: { qualys: 'LAST_SERVICE_MODIFICATION_DATETIME' }
      },
      {
        name: 'qualys_user_def_1',
        label: 'User Def 1',
        type: 'text',
        required: false,
        visible: true,
        order: 22,
        tab: 'custom',
        description: 'Campo definido pelo usuário 1',
        importMapping: { qualys: 'USER_DEF_1' }
      },
      {
        name: 'qualys_user_def_2',
        label: 'User Def 2',
        type: 'text',
        required: false,
        visible: true,
        order: 23,
        tab: 'custom',
        description: 'Campo definido pelo usuário 2',
        importMapping: { qualys: 'USER_DEF_2' }
      },
      {
        name: 'qualys_user_def_3',
        label: 'User Def 3',
        type: 'text',
        required: false,
        visible: true,
        order: 24,
        tab: 'custom',
        description: 'Campo definido pelo usuário 3',
        importMapping: { qualys: 'USER_DEF_3' }
      },
      {
        name: 'qualys_cvss_base',
        label: 'CVSS Base',
        type: 'number',
        required: false,
        visible: true,
        order: 25,
        tab: 'classification',
        description: 'Score CVSS base',
        validation: { min: 0, max: 10 },
        importMapping: { qualys: 'CVSS_BASE' }
      },
      {
        name: 'qualys_cvss_temporal',
        label: 'CVSS Temporal',
        type: 'number',
        required: false,
        visible: true,
        order: 26,
        tab: 'classification',
        description: 'Score CVSS temporal',
        validation: { min: 0, max: 10 },
        importMapping: { qualys: 'CVSS_TEMPORAL' }
      },
      {
        name: 'qualys_cvss3_base',
        label: 'CVSS3 Base',
        type: 'number',
        required: false,
        visible: true,
        order: 27,
        tab: 'classification',
        description: 'Score CVSS v3 base',
        validation: { min: 0, max: 10 },
        importMapping: { qualys: 'CVSS3_BASE' }
      },
      {
        name: 'qualys_cvss3_temporal',
        label: 'CVSS3 Temporal',
        type: 'number',
        required: false,
        visible: true,
        order: 28,
        tab: 'classification',
        description: 'Score CVSS v3 temporal',
        validation: { min: 0, max: 10 },
        importMapping: { qualys: 'CVSS3_TEMPORAL' }
      },
      {
        name: 'qualys_threat',
        label: 'Threat',
        type: 'text',
        required: false,
        visible: true,
        order: 29,
        tab: 'classification',
        description: 'Informações de ameaça',
        importMapping: { qualys: 'THREAT' }
      },
      {
        name: 'qualys_impact',
        label: 'Impact',
        type: 'text',
        required: false,
        visible: true,
        order: 30,
        tab: 'classification',
        description: 'Impacto da vulnerabilidade',
        importMapping: { qualys: 'IMPACT' }
      },
      {
        name: 'qualys_solution',
        label: 'Solution',
        type: 'textarea',
        required: false,
        visible: true,
        order: 31,
        tab: 'remediation',
        description: 'Solução recomendada pelo Qualys',
        importMapping: { qualys: 'SOLUTION' }
      },
      {
        name: 'qualys_exploitability',
        label: 'Exploitability',
        type: 'text',
        required: false,
        visible: true,
        order: 32,
        tab: 'classification',
        description: 'Nível de explorabilidade',
        importMapping: { qualys: 'EXPLOITABILITY' }
      },
      {
        name: 'qualys_associated_malware',
        label: 'Associated Malware',
        type: 'text',
        required: false,
        visible: true,
        order: 33,
        tab: 'classification',
        description: 'Malware associado',
        importMapping: { qualys: 'ASSOCIATED_MALWARE' }
      },
      {
        name: 'qualys_vendor_reference',
        label: 'Vendor Reference',
        type: 'text',
        required: false,
        visible: true,
        order: 34,
        tab: 'technical',
        description: 'Referência do fornecedor',
        importMapping: { qualys: 'VENDOR_REFERENCE' }
      },
      {
        name: 'qualys_cve_id',
        label: 'CVE ID',
        type: 'text',
        required: false,
        visible: true,
        order: 35,
        tab: 'technical',
        description: 'Identificador CVE',
        importMapping: { qualys: 'CVE_ID' }
      },
      {
        name: 'qualys_bugtraq_id',
        label: 'Bugtraq ID',
        type: 'text',
        required: false,
        visible: true,
        order: 36,
        tab: 'technical',
        description: 'Identificador Bugtraq',
        importMapping: { qualys: 'BUGTRAQ_ID' }
      },
      {
        name: 'qualys_patchable',
        label: 'Patchable',
        type: 'boolean',
        required: false,
        visible: true,
        order: 37,
        tab: 'remediation',
        description: 'Vulnerabilidade pode ser corrigida com patch',
        importMapping: { qualys: 'PATCHABLE' }
      },
      {
        name: 'qualys_diagnosis',
        label: 'Diagnosis',
        type: 'textarea',
        required: false,
        visible: true,
        order: 38,
        tab: 'technical',
        description: 'Diagnóstico detalhado da vulnerabilidade',
        importMapping: { qualys: 'DIAGNOSIS' }
      },
      {
        name: 'qualys_consequence',
        label: 'Consequence',
        type: 'textarea',
        required: false,
        visible: true,
        order: 39,
        tab: 'classification',
        description: 'Consequências da vulnerabilidade',
        importMapping: { qualys: 'CONSEQUENCE' }
      },
      {
        name: 'qualys_correlation',
        label: 'Correlation',
        type: 'textarea',
        required: false,
        visible: true,
        order: 40,
        tab: 'technical',
        description: 'Correlações com outras vulnerabilidades',
        importMapping: { qualys: 'CORRELATION' }
      },
      {
        name: 'qualys_compliance',
        label: 'Compliance',
        type: 'text',
        required: false,
        visible: true,
        order: 41,
        tab: 'classification',
        description: 'Frameworks de compliance afetados',
        importMapping: { qualys: 'COMPLIANCE' }
      },
      {
        name: 'qualys_authentication',
        label: 'Authentication',
        type: 'select',
        required: false,
        visible: true,
        order: 42,
        tab: 'technical',
        options: ['None', 'Single', 'Multiple'],
        description: 'Tipo de autenticação necessária',
        importMapping: { qualys: 'AUTHENTICATION' }
      },
      {
        name: 'qualys_access_vector',
        label: 'Access Vector',
        type: 'select',
        required: false,
        visible: true,
        order: 43,
        tab: 'classification',
        options: ['Local', 'Adjacent Network', 'Network'],
        description: 'Vetor de acesso da vulnerabilidade',
        importMapping: { qualys: 'ACCESS_VECTOR' }
      },
      {
        name: 'qualys_access_complexity',
        label: 'Access Complexity',
        type: 'select',
        required: false,
        visible: true,
        order: 44,
        tab: 'classification',
        options: ['Low', 'Medium', 'High'],
        description: 'Complexidade de acesso',
        importMapping: { qualys: 'ACCESS_COMPLEXITY' }
      }
    ]
  },
  {
    id: 'nessus-extended',
    name: 'Nessus - Campos Completos',
    description: 'Conjunto completo de 35 campos oficiais do Nessus conforme documentação da API',
    source: 'nessus',
    fields: [
      {
        name: 'nessus_plugin_id',
        label: 'Plugin ID',
        type: 'number',
        required: false,
        visible: true,
        order: 1,
        tab: 'technical',
        description: 'ID numérico do plugin Nessus',
        importMapping: { nessus: 'plugin_id' }
      },
      {
        name: 'nessus_plugin_name',
        label: 'Plugin Name',
        type: 'text',
        required: false,
        visible: true,
        order: 2,
        tab: 'basic',
        description: 'Nome do plugin Nessus',
        importMapping: { nessus: 'plugin_name' }
      },
      {
        name: 'nessus_plugin_family',
        label: 'Plugin Family',
        type: 'select',
        required: false,
        visible: true,
        order: 3,
        tab: 'classification',
        options: ['Web Servers', 'Windows', 'Unix', 'Databases', 'Firewalls', 'General', 'CGI abuses', 'SNMP', 'Service detection', 'Denial of Service', 'FTP', 'SMTP problems', 'RPC', 'Backdoors', 'Peer-To-Peer File Sharing', 'Gain a shell remotely', 'Malware', 'Policy Compliance', 'Default Unix Accounts', 'DNS', 'Netware', 'MacOS X Local Security Checks', 'Windows : Microsoft Bulletins', 'SCADA'],
        description: 'Família do plugin Nessus',
        importMapping: { nessus: 'plugin_family' }
      },
      {
        name: 'nessus_plugin_type',
        label: 'Plugin Type',
        type: 'select',
        required: false,
        visible: true,
        order: 4,
        tab: 'technical',
        options: ['remote', 'local', 'combined'],
        description: 'Tipo do plugin (remoto, local ou combinado)',
        importMapping: { nessus: 'plugin_type' }
      },
      {
        name: 'nessus_severity',
        label: 'Severity',
        type: 'select',
        required: false,
        visible: true,
        order: 5,
        tab: 'classification',
        options: ['0', '1', '2', '3', '4'],
        description: 'Nível de severidade Nessus (0-4)',
        importMapping: { nessus: 'severity' }
      },
      {
        name: 'nessus_risk_factor',
        label: 'Risk Factor',
        type: 'select',
        required: false,
        visible: true,
        order: 6,
        tab: 'classification',
        options: ['None', 'Low', 'Medium', 'High', 'Critical'],
        description: 'Fator de risco da vulnerabilidade',
        importMapping: { nessus: 'risk_factor' }
      },
      {
        name: 'nessus_port',
        label: 'Port',
        type: 'number',
        required: false,
        visible: true,
        order: 7,
        tab: 'technical',
        description: 'Porta onde a vulnerabilidade foi detectada',
        importMapping: { nessus: 'port' }
      },
      {
        name: 'nessus_protocol',
        label: 'Protocol',
        type: 'select',
        required: false,
        visible: true,
        order: 8,
        tab: 'technical',
        options: ['tcp', 'udp', 'icmp'],
        description: 'Protocolo da vulnerabilidade',
        importMapping: { nessus: 'protocol' }
      },
      {
        name: 'nessus_synopsis',
        label: 'Synopsis',
        type: 'textarea',
        required: false,
        visible: true,
        order: 9,
        tab: 'basic',
        description: 'Resumo da vulnerabilidade',
        importMapping: { nessus: 'synopsis' }
      },
      {
        name: 'nessus_description',
        label: 'Description',
        type: 'textarea',
        required: false,
        visible: true,
        order: 10,
        tab: 'technical',
        description: 'Descrição detalhada da vulnerabilidade',
        importMapping: { nessus: 'description' }
      },
      {
        name: 'nessus_solution',
        label: 'Solution',
        type: 'textarea',
        required: false,
        visible: true,
        order: 11,
        tab: 'remediation',
        description: 'Solução recomendada pelo Nessus',
        importMapping: { nessus: 'solution' }
      },
      {
        name: 'nessus_see_also',
        label: 'See Also',
        type: 'textarea',
        required: false,
        visible: true,
        order: 12,
        tab: 'technical',
        description: 'Links e referências adicionais',
        importMapping: { nessus: 'see_also' }
      },
      {
        name: 'nessus_cve',
        label: 'CVE',
        type: 'text',
        required: false,
        visible: true,
        order: 13,
        tab: 'technical',
        description: 'Identificadores CVE (separados por vírgula)',
        importMapping: { nessus: 'cve' }
      },
      {
        name: 'nessus_bid',
        label: 'BID',
        type: 'text',
        required: false,
        visible: true,
        order: 14,
        tab: 'technical',
        description: 'Bugtraq IDs (separados por vírgula)',
        importMapping: { nessus: 'bid' }
      },
      {
        name: 'nessus_xref',
        label: 'Cross References',
        type: 'textarea',
        required: false,
        visible: true,
        order: 15,
        tab: 'technical',
        description: 'Referências cruzadas',
        importMapping: { nessus: 'xref' }
      },
      {
        name: 'nessus_plugin_output',
        label: 'Plugin Output',
        type: 'textarea',
        required: false,
        visible: true,
        order: 16,
        tab: 'technical',
        description: 'Saída detalhada do plugin',
        importMapping: { nessus: 'plugin_output' }
      },
      {
        name: 'nessus_cvss_base_score',
        label: 'CVSS Base Score',
        type: 'number',
        required: false,
        visible: true,
        order: 17,
        tab: 'classification',
        description: 'Score CVSS base',
        validation: { min: 0, max: 10 },
        importMapping: { nessus: 'cvss_base_score' }
      },
      {
        name: 'nessus_cvss_temporal_score',
        label: 'CVSS Temporal Score',
        type: 'number',
        required: false,
        visible: true,
        order: 18,
        tab: 'classification',
        description: 'Score CVSS temporal',
        validation: { min: 0, max: 10 },
        importMapping: { nessus: 'cvss_temporal_score' }
      },
      {
        name: 'nessus_cvss_vector',
        label: 'CVSS Vector',
        type: 'text',
        required: false,
        visible: true,
        order: 19,
        tab: 'classification',
        description: 'Vetor CVSS completo',
        importMapping: { nessus: 'cvss_vector' }
      },
      {
        name: 'nessus_cvss3_base_score',
        label: 'CVSS3 Base Score',
        type: 'number',
        required: false,
        visible: true,
        order: 20,
        tab: 'classification',
        description: 'Score CVSS v3 base',
        validation: { min: 0, max: 10 },
        importMapping: { nessus: 'cvss3_base_score' }
      },
      {
        name: 'nessus_cvss3_temporal_score',
        label: 'CVSS3 Temporal Score',
        type: 'number',
        required: false,
        visible: true,
        order: 21,
        tab: 'classification',
        description: 'Score CVSS v3 temporal',
        validation: { min: 0, max: 10 },
        importMapping: { nessus: 'cvss3_temporal_score' }
      },
      {
        name: 'nessus_cvss3_vector',
        label: 'CVSS3 Vector',
        type: 'text',
        required: false,
        visible: true,
        order: 22,
        tab: 'classification',
        description: 'Vetor CVSS v3 completo',
        importMapping: { nessus: 'cvss3_vector' }
      },
      {
        name: 'nessus_exploit_available',
        label: 'Exploit Available',
        type: 'boolean',
        required: false,
        visible: true,
        order: 23,
        tab: 'classification',
        description: 'Exploit público disponível',
        importMapping: { nessus: 'exploit_available' }
      },
      {
        name: 'nessus_exploitability_ease',
        label: 'Exploitability Ease',
        type: 'select',
        required: false,
        visible: true,
        order: 24,
        tab: 'classification',
        options: ['No known exploits are available', 'Exploits are available', 'No exploit is required'],
        description: 'Facilidade de exploração',
        importMapping: { nessus: 'exploitability_ease' }
      },
      {
        name: 'nessus_patch_publication_date',
        label: 'Patch Publication Date',
        type: 'date',
        required: false,
        visible: true,
        order: 25,
        tab: 'remediation',
        description: 'Data de publicação do patch',
        importMapping: { nessus: 'patch_publication_date' }
      },
      {
        name: 'nessus_vuln_publication_date',
        label: 'Vulnerability Publication Date',
        type: 'date',
        required: false,
        visible: true,
        order: 26,
        tab: 'basic',
        description: 'Data de publicação da vulnerabilidade',
        importMapping: { nessus: 'vuln_publication_date' }
      },
      {
        name: 'nessus_plugin_publication_date',
        label: 'Plugin Publication Date',
        type: 'date',
        required: false,
        visible: true,
        order: 27,
        tab: 'technical',
        description: 'Data de publicação do plugin',
        importMapping: { nessus: 'plugin_publication_date' }
      },
      {
        name: 'nessus_plugin_modification_date',
        label: 'Plugin Modification Date',
        type: 'date',
        required: false,
        visible: true,
        order: 28,
        tab: 'technical',
        description: 'Data de modificação do plugin',
        importMapping: { nessus: 'plugin_modification_date' }
      },
      {
        name: 'nessus_first_found',
        label: 'First Found',
        type: 'date',
        required: false,
        visible: true,
        order: 29,
        tab: 'basic',
        description: 'Data da primeira detecção',
        importMapping: { nessus: 'first_found' }
      },
      {
        name: 'nessus_last_found',
        label: 'Last Found',
        type: 'date',
        required: false,
        visible: true,
        order: 30,
        tab: 'basic',
        description: 'Data da última detecção',
        importMapping: { nessus: 'last_found' }
      },
      {
        name: 'nessus_compliance',
        label: 'Compliance',
        type: 'text',
        required: false,
        visible: true,
        order: 31,
        tab: 'classification',
        description: 'Frameworks de compliance afetados',
        importMapping: { nessus: 'compliance' }
      },
      {
        name: 'nessus_asset_inventory',
        label: 'Asset Inventory',
        type: 'text',
        required: false,
        visible: true,
        order: 32,
        tab: 'basic',
        description: 'Informações de inventário do ativo',
        importMapping: { nessus: 'asset_inventory' }
      },
      {
        name: 'nessus_unsupported_by_vendor',
        label: 'Unsupported by Vendor',
        type: 'boolean',
        required: false,
        visible: true,
        order: 33,
        tab: 'classification',
        description: 'Software não suportado pelo fornecedor',
        importMapping: { nessus: 'unsupported_by_vendor' }
      },
      {
        name: 'nessus_in_the_news',
        label: 'In the News',
        type: 'boolean',
        required: false,
        visible: true,
        order: 34,
        tab: 'classification',
        description: 'Vulnerabilidade mencionada em notícias',
        importMapping: { nessus: 'in_the_news' }
      },
      {
        name: 'nessus_malware',
        label: 'Malware',
        type: 'boolean',
        required: false,
        visible: true,
        order: 35,
        tab: 'classification',
        description: 'Relacionada a malware',
        importMapping: { nessus: 'malware' }
      }
    ]
  },
  {
    id: 'openvas-extended',
    name: 'OpenVAS - Campos Completos',
    description: 'Conjunto completo de 28 campos oficiais do OpenVAS conforme documentação da API',
    source: 'openvas',
    fields: [
      {
        name: 'openvas_nvt_oid',
        label: 'NVT OID',
        type: 'text',
        required: false,
        visible: true,
        order: 1,
        tab: 'technical',
        description: 'Object Identifier único do Network Vulnerability Test',
        importMapping: { openvas: 'nvt_oid' }
      },
      {
        name: 'openvas_nvt_name',
        label: 'NVT Name',
        type: 'text',
        required: false,
        visible: true,
        order: 2,
        tab: 'basic',
        description: 'Nome do Network Vulnerability Test',
        importMapping: { openvas: 'nvt_name' }
      },
      {
        name: 'openvas_family',
        label: 'Family',
        type: 'select',
        required: false,
        visible: true,
        order: 3,
        tab: 'classification',
        options: ['Buffer overflow', 'CISCO', 'Compliance', 'Credentials', 'Databases', 'Default Accounts', 'Denial of Service', 'FTP', 'Firewalls', 'General', 'Gain a shell remotely', 'IT-Grundschutz', 'Malware', 'NMAP NSE', 'Netware', 'Policy', 'Port scanners', 'Privilege escalation', 'Product detection', 'RPC', 'SCADA', 'SMTP problems', 'SNMP', 'Service detection', 'Settings', 'Useless services', 'Web Servers', 'Web application abuses', 'Windows'],
        description: 'Família do teste de vulnerabilidade',
        importMapping: { openvas: 'family' }
      },
      {
        name: 'openvas_severity',
        label: 'Severity',
        type: 'number',
        required: false,
        visible: true,
        order: 4,
        tab: 'classification',
        description: 'Nível de severidade OpenVAS (0.0-10.0)',
        validation: { min: 0, max: 10 },
        importMapping: { openvas: 'severity' }
      },
      {
        name: 'openvas_threat',
        label: 'Threat',
        type: 'select',
        required: false,
        visible: true,
        order: 5,
        tab: 'classification',
        options: ['High', 'Medium', 'Low', 'Log', 'Debug'],
        description: 'Nível de ameaça',
        importMapping: { openvas: 'threat' }
      },
      {
        name: 'openvas_port',
        label: 'Port',
        type: 'text',
        required: false,
        visible: true,
        order: 6,
        tab: 'technical',
        description: 'Porta e protocolo (ex: 80/tcp)',
        importMapping: { openvas: 'port' }
      },
      {
        name: 'openvas_host',
        label: 'Host',
        type: 'text',
        required: false,
        visible: true,
        order: 7,
        tab: 'basic',
        description: 'Endereço IP ou hostname do alvo',
        importMapping: { openvas: 'host' }
      },
      {
        name: 'openvas_description',
        label: 'Description',
        type: 'textarea',
        required: false,
        visible: true,
        order: 8,
        tab: 'technical',
        description: 'Descrição detalhada da vulnerabilidade',
        importMapping: { openvas: 'description' }
      },
      {
        name: 'openvas_summary',
        label: 'Summary',
        type: 'textarea',
        required: false,
        visible: true,
        order: 9,
        tab: 'basic',
        description: 'Resumo da vulnerabilidade',
        importMapping: { openvas: 'summary' }
      },
      {
        name: 'openvas_insight',
        label: 'Insight',
        type: 'textarea',
        required: false,
        visible: true,
        order: 10,
        tab: 'technical',
        description: 'Insights técnicos sobre a vulnerabilidade',
        importMapping: { openvas: 'insight' }
      },
      {
        name: 'openvas_impact',
        label: 'Impact',
        type: 'textarea',
        required: false,
        visible: true,
        order: 11,
        tab: 'classification',
        description: 'Impacto da vulnerabilidade',
        importMapping: { openvas: 'impact' }
      },
      {
        name: 'openvas_affected',
        label: 'Affected',
        type: 'textarea',
        required: false,
        visible: true,
        order: 12,
        tab: 'basic',
        description: 'Sistemas/software afetados',
        importMapping: { openvas: 'affected' }
      },
      {
        name: 'openvas_solution',
        label: 'Solution',
        type: 'textarea',
        required: false,
        visible: true,
        order: 13,
        tab: 'remediation',
        description: 'Solução recomendada',
        importMapping: { openvas: 'solution' }
      },
      {
        name: 'openvas_solution_type',
        label: 'Solution Type',
        type: 'select',
        required: false,
        visible: true,
        order: 14,
        tab: 'remediation',
        options: ['VendorFix', 'Workaround', 'Mitigation', 'NoneAvailable', 'WillNotFix'],
        description: 'Tipo de solução disponível',
        importMapping: { openvas: 'solution_type' }
      },
      {
        name: 'openvas_detection',
        label: 'Detection',
        type: 'textarea',
        required: false,
        visible: true,
        order: 15,
        tab: 'technical',
        description: 'Método de detecção utilizado',
        importMapping: { openvas: 'detection' }
      },
      {
        name: 'openvas_qod',
        label: 'Quality of Detection',
        type: 'number',
        required: false,
        visible: true,
        order: 16,
        tab: 'technical',
        description: 'Qualidade da detecção (0-100%)',
        validation: { min: 0, max: 100 },
        importMapping: { openvas: 'qod' }
      },
      {
        name: 'openvas_qod_type',
        label: 'QoD Type',
        type: 'select',
        required: false,
        visible: true,
        order: 17,
        tab: 'technical',
        options: ['exploit', 'remote_vul', 'remote_app', 'package', 'registry', 'remote_active', 'remote_banner', 'executable_version', 'general_note'],
        description: 'Tipo de qualidade de detecção',
        importMapping: { openvas: 'qod_type' }
      },
      {
        name: 'openvas_cve',
        label: 'CVE',
        type: 'text',
        required: false,
        visible: true,
        order: 18,
        tab: 'technical',
        description: 'Identificadores CVE relacionados',
        importMapping: { openvas: 'cve' }
      },
      {
        name: 'openvas_bid',
        label: 'BID',
        type: 'text',
        required: false,
        visible: true,
        order: 19,
        tab: 'technical',
        description: 'Bugtraq IDs relacionados',
        importMapping: { openvas: 'bid' }
      },
      {
        name: 'openvas_xref',
        label: 'Cross References',
        type: 'textarea',
        required: false,
        visible: true,
        order: 20,
        tab: 'technical',
        description: 'Referências cruzadas',
        importMapping: { openvas: 'xref' }
      },
      {
        name: 'openvas_tags',
        label: 'Tags',
        type: 'text',
        required: false,
        visible: true,
        order: 21,
        tab: 'classification',
        description: 'Tags associadas à vulnerabilidade',
        importMapping: { openvas: 'tags' }
      },
      {
        name: 'openvas_cvss_base',
        label: 'CVSS Base',
        type: 'number',
        required: false,
        visible: true,
        order: 22,
        tab: 'classification',
        description: 'Score CVSS base',
        validation: { min: 0, max: 10 },
        importMapping: { openvas: 'cvss_base' }
      },
      {
        name: 'openvas_cvss_base_vector',
        label: 'CVSS Base Vector',
        type: 'text',
        required: false,
        visible: true,
        order: 23,
        tab: 'classification',
        description: 'Vetor CVSS base',
        importMapping: { openvas: 'cvss_base_vector' }
      },
      {
        name: 'openvas_creation_time',
        label: 'Creation Time',
        type: 'date',
        required: false,
        visible: true,
        order: 24,
        tab: 'basic',
        description: 'Data de criação do resultado',
        importMapping: { openvas: 'creation_time' }
      },
      {
        name: 'openvas_modification_time',
        label: 'Modification Time',
        type: 'date',
        required: false,
        visible: true,
        order: 25,
        tab: 'basic',
        description: 'Data de modificação do resultado',
        importMapping: { openvas: 'modification_time' }
      },
      {
        name: 'openvas_scan_nvt_version',
        label: 'Scan NVT Version',
        type: 'text',
        required: false,
        visible: true,
        order: 26,
        tab: 'technical',
        description: 'Versão do NVT utilizada no scan',
        importMapping: { openvas: 'scan_nvt_version' }
      },
      {
        name: 'openvas_compliance',
        label: 'Compliance',
        type: 'text',
        required: false,
        visible: true,
        order: 27,
        tab: 'classification',
        description: 'Frameworks de compliance relacionados',
        importMapping: { openvas: 'compliance' }
      },
      {
        name: 'openvas_notes',
        label: 'Notes',
        type: 'textarea',
        required: false,
        visible: true,
        order: 28,
        tab: 'custom',
        description: 'Notas adicionais sobre a vulnerabilidade',
        importMapping: { openvas: 'notes' }
      }
    ]
  },
  {
    id: 'burp-extended',
    name: 'Burp Suite - Campos Completos',
    description: 'Conjunto completo de 25 campos oficiais do Burp Suite conforme documentação da API',
    source: 'burp',
    fields: [
      {
        name: 'burp_issue_type',
        label: 'Issue Type',
        type: 'text',
        required: false,
        visible: true,
        order: 1,
        tab: 'technical',
        description: 'Tipo de issue do Burp Suite',
        importMapping: { burp: 'issue_type' }
      },
      {
        name: 'burp_issue_name',
        label: 'Issue Name',
        type: 'text',
        required: false,
        visible: true,
        order: 2,
        tab: 'basic',
        description: 'Nome da vulnerabilidade encontrada',
        importMapping: { burp: 'issue_name' }
      },
      {
        name: 'burp_severity',
        label: 'Severity',
        type: 'select',
        required: false,
        visible: true,
        order: 3,
        tab: 'classification',
        options: ['High', 'Medium', 'Low', 'Information'],
        description: 'Nível de severidade do Burp',
        importMapping: { burp: 'severity' }
      },
      {
        name: 'burp_confidence',
        label: 'Confidence',
        type: 'select',
        required: false,
        visible: true,
        order: 4,
        tab: 'classification',
        options: ['Certain', 'Firm', 'Tentative'],
        description: 'Nível de confiança na detecção',
        importMapping: { burp: 'confidence' }
      },
      {
        name: 'burp_host',
        label: 'Host',
        type: 'text',
        required: false,
        visible: true,
        order: 5,
        tab: 'basic',
        description: 'Host da aplicação web',
        importMapping: { burp: 'host' }
      },
      {
        name: 'burp_port',
        label: 'Port',
        type: 'number',
        required: false,
        visible: true,
        order: 6,
        tab: 'technical',
        description: 'Porta da aplicação web',
        importMapping: { burp: 'port' }
      },
      {
        name: 'burp_protocol',
        label: 'Protocol',
        type: 'select',
        required: false,
        visible: true,
        order: 7,
        tab: 'technical',
        options: ['http', 'https'],
        description: 'Protocolo utilizado',
        importMapping: { burp: 'protocol' }
      },
      {
        name: 'burp_path',
        label: 'Path',
        type: 'text',
        required: false,
        visible: true,
        order: 8,
        tab: 'technical',
        description: 'Caminho da URL afetada',
        importMapping: { burp: 'path' }
      },
      {
        name: 'burp_location',
        label: 'Location',
        type: 'text',
        required: false,
        visible: true,
        order: 9,
        tab: 'technical',
        description: 'Localização específica da vulnerabilidade',
        importMapping: { burp: 'location' }
      },
      {
        name: 'burp_issue_background',
        label: 'Issue Background',
        type: 'textarea',
        required: false,
        visible: true,
        order: 10,
        tab: 'technical',
        description: 'Contexto e background da vulnerabilidade',
        importMapping: { burp: 'issue_background' }
      },
      {
        name: 'burp_issue_detail',
        label: 'Issue Detail',
        type: 'textarea',
        required: false,
        visible: true,
        order: 11,
        tab: 'technical',
        description: 'Detalhes específicos da vulnerabilidade',
        importMapping: { burp: 'issue_detail' }
      },
      {
        name: 'burp_remediation_background',
        label: 'Remediation Background',
        type: 'textarea',
        required: false,
        visible: true,
        order: 12,
        tab: 'remediation',
        description: 'Contexto sobre a remediação',
        importMapping: { burp: 'remediation_background' }
      },
      {
        name: 'burp_remediation_detail',
        label: 'Remediation Detail',
        type: 'textarea',
        required: false,
        visible: true,
        order: 13,
        tab: 'remediation',
        description: 'Detalhes específicos da remediação',
        importMapping: { burp: 'remediation_detail' }
      },
      {
        name: 'burp_vulnerability_classifications',
        label: 'Vulnerability Classifications',
        type: 'text',
        required: false,
        visible: true,
        order: 14,
        tab: 'classification',
        description: 'Classificações da vulnerabilidade (CWE, OWASP)',
        importMapping: { burp: 'vulnerability_classifications' }
      },
      {
        name: 'burp_request',
        label: 'Request',
        type: 'textarea',
        required: false,
        visible: true,
        order: 15,
        tab: 'technical',
        description: 'Requisição HTTP que demonstra a vulnerabilidade',
        importMapping: { burp: 'request' }
      },
      {
        name: 'burp_response',
        label: 'Response',
        type: 'textarea',
        required: false,
        visible: true,
        order: 16,
        tab: 'technical',
        description: 'Resposta HTTP que demonstra a vulnerabilidade',
        importMapping: { burp: 'response' }
      },
      {
        name: 'burp_collaborator_event',
        label: 'Collaborator Event',
        type: 'textarea',
        required: false,
        visible: true,
        order: 17,
        tab: 'technical',
        description: 'Eventos do Burp Collaborator relacionados',
        importMapping: { burp: 'collaborator_event' }
      },
      {
        name: 'burp_scan_type',
        label: 'Scan Type',
        type: 'select',
        required: false,
        visible: true,
        order: 18,
        tab: 'technical',
        options: ['Active', 'Passive', 'Extension'],
        description: 'Tipo de scan que detectou a vulnerabilidade',
        importMapping: { burp: 'scan_type' }
      },
      {
        name: 'burp_scanner_confidence',
        label: 'Scanner Confidence',
        type: 'number',
        required: false,
        visible: true,
        order: 19,
        tab: 'classification',
        description: 'Confiança numérica do scanner (0-100)',
        validation: { min: 0, max: 100 },
        importMapping: { burp: 'scanner_confidence' }
      },
      {
        name: 'burp_false_positive',
        label: 'False Positive',
        type: 'boolean',
        required: false,
        visible: true,
        order: 20,
        tab: 'classification',
        description: 'Marcado como falso positivo',
        importMapping: { burp: 'false_positive' }
      },
      {
        name: 'burp_origin',
        label: 'Origin',
        type: 'text',
        required: false,
        visible: true,
        order: 21,
        tab: 'technical',
        description: 'Origem da detecção (scanner, extension, etc)',
        importMapping: { burp: 'origin' }
      },
      {
        name: 'burp_internal_data',
        label: 'Internal Data',
        type: 'textarea',
        required: false,
        visible: true,
        order: 22,
        tab: 'technical',
        description: 'Dados internos do Burp para a vulnerabilidade',
        importMapping: { burp: 'internal_data' }
      },
      {
        name: 'burp_serial_number',
        label: 'Serial Number',
        type: 'text',
        required: false,
        visible: true,
        order: 23,
        tab: 'technical',
        description: 'Número serial único da issue',
        importMapping: { burp: 'serial_number' }
      },
      {
        name: 'burp_caption',
        label: 'Caption',
        type: 'text',
        required: false,
        visible: true,
        order: 24,
        tab: 'basic',
        description: 'Legenda ou título curto da vulnerabilidade',
        importMapping: { burp: 'caption' }
      },
      {
        name: 'burp_evidence',
        label: 'Evidence',
        type: 'textarea',
        required: false,
        visible: true,
        order: 25,
        tab: 'technical',
        description: 'Evidências que comprovam a vulnerabilidade',
        importMapping: { burp: 'evidence' }
      }
    ]
  },
  {
    id: 'generic-security-tools',
    name: 'Ferramentas Genéricas - Campos Universais',
    description: 'Conjunto de 20 campos genéricos compatíveis com diversas ferramentas de segurança',
    source: 'custom',
    fields: [
      {
        name: 'tool_name',
        label: 'Tool Name',
        type: 'text',
        required: false,
        visible: true,
        order: 1,
        tab: 'basic',
        description: 'Nome da ferramenta que detectou a vulnerabilidade',
        importMapping: { custom: 'tool_name' }
      },
      {
        name: 'tool_version',
        label: 'Tool Version',
        type: 'text',
        required: false,
        visible: true,
        order: 2,
        tab: 'technical',
        description: 'Versão da ferramenta utilizada',
        importMapping: { custom: 'tool_version' }
      },
      {
        name: 'scan_id',
        label: 'Scan ID',
        type: 'text',
        required: false,
        visible: true,
        order: 3,
        tab: 'technical',
        description: 'Identificador único do scan',
        importMapping: { custom: 'scan_id' }
      },
      {
        name: 'finding_id',
        label: 'Finding ID',
        type: 'text',
        required: false,
        visible: true,
        order: 4,
        tab: 'technical',
        description: 'Identificador único do achado',
        importMapping: { custom: 'finding_id' }
      },
      {
        name: 'asset_name',
        label: 'Asset Name',
        type: 'text',
        required: false,
        visible: true,
        order: 5,
        tab: 'basic',
        description: 'Nome do ativo afetado',
        importMapping: { custom: 'asset_name' }
      },
      {
        name: 'asset_type',
        label: 'Asset Type',
        type: 'select',
        required: false,
        visible: true,
        order: 6,
        tab: 'classification',
        options: ['Server', 'Workstation', 'Network Device', 'Web Application', 'Mobile Application', 'Database', 'Cloud Service', 'IoT Device'],
        description: 'Tipo do ativo afetado',
        importMapping: { custom: 'asset_type' }
      },
      {
        name: 'environment',
        label: 'Environment',
        type: 'select',
        required: false,
        visible: true,
        order: 7,
        tab: 'classification',
        options: ['Production', 'Staging', 'Development', 'Testing', 'QA'],
        description: 'Ambiente onde a vulnerabilidade foi encontrada',
        importMapping: { custom: 'environment' }
      },
      {
        name: 'business_criticality',
        label: 'Business Criticality',
        type: 'select',
        required: false,
        visible: true,
        order: 8,
        tab: 'classification',
        options: ['Critical', 'High', 'Medium', 'Low'],
        description: 'Criticidade do ativo para o negócio',
        importMapping: { custom: 'business_criticality' }
      },
      {
        name: 'data_classification',
        label: 'Data Classification',
        type: 'select',
        required: false,
        visible: true,
        order: 9,
        tab: 'classification',
        options: ['Public', 'Internal', 'Confidential', 'Restricted'],
        description: 'Classificação dos dados no ativo',
        importMapping: { custom: 'data_classification' }
      },
      {
        name: 'network_zone',
        label: 'Network Zone',
        type: 'select',
        required: false,
        visible: true,
        order: 10,
        tab: 'technical',
        options: ['DMZ', 'Internal', 'External', 'Management', 'Guest'],
        description: 'Zona de rede onde o ativo está localizado',
        importMapping: { custom: 'network_zone' }
      },
      {
        name: 'owner_team',
        label: 'Owner Team',
        type: 'text',
        required: false,
        visible: true,
        order: 11,
        tab: 'basic',
        description: 'Equipe responsável pelo ativo',
        importMapping: { custom: 'owner_team' }
      },
      {
        name: 'technical_contact',
        label: 'Technical Contact',
        type: 'email',
        required: false,
        visible: true,
        order: 12,
        tab: 'basic',
        description: 'Contato técnico responsável',
        importMapping: { custom: 'technical_contact' }
      },
      {
        name: 'business_contact',
        label: 'Business Contact',
        type: 'email',
        required: false,
        visible: true,
        order: 13,
        tab: 'basic',
        description: 'Contato de negócio responsável',
        importMapping: { custom: 'business_contact' }
      },
      {
        name: 'remediation_priority',
        label: 'Remediation Priority',
        type: 'select',
        required: false,
        visible: true,
        order: 14,
        tab: 'remediation',
        options: ['P0 - Emergency', 'P1 - Critical', 'P2 - High', 'P3 - Medium', 'P4 - Low'],
        description: 'Prioridade de remediação',
        importMapping: { custom: 'remediation_priority' }
      },
      {
        name: 'estimated_effort',
        label: 'Estimated Effort',
        type: 'select',
        required: false,
        visible: true,
        order: 15,
        tab: 'remediation',
        options: ['1 hour', '4 hours', '1 day', '3 days', '1 week', '2 weeks', '1 month', '3 months'],
        description: 'Esforço estimado para remediação',
        importMapping: { custom: 'estimated_effort' }
      },
      {
        name: 'remediation_cost',
        label: 'Remediation Cost',
        type: 'select',
        required: false,
        visible: true,
        order: 16,
        tab: 'remediation',
        options: ['Low', 'Medium', 'High', 'Very High'],
        description: 'Custo estimado de remediação',
        importMapping: { custom: 'remediation_cost' }
      },
      {
        name: 'false_positive_risk',
        label: 'False Positive Risk',
        type: 'select',
        required: false,
        visible: true,
        order: 17,
        tab: 'classification',
        options: ['Very Low', 'Low', 'Medium', 'High', 'Very High'],
        description: 'Risco de ser um falso positivo',
        importMapping: { custom: 'false_positive_risk' }
      },
      {
        name: 'exploit_maturity',
        label: 'Exploit Maturity',
        type: 'select',
        required: false,
        visible: true,
        order: 18,
        tab: 'classification',
        options: ['Not Defined', 'Unproven', 'Proof of Concept', 'Functional', 'High'],
        description: 'Maturidade dos exploits disponíveis',
        importMapping: { custom: 'exploit_maturity' }
      },
      {
        name: 'regulatory_requirements',
        label: 'Regulatory Requirements',
        type: 'text',
        required: false,
        visible: true,
        order: 19,
        tab: 'classification',
        description: 'Requisitos regulatórios aplicados (LGPD, SOX, PCI, etc)',
        importMapping: { custom: 'regulatory_requirements' }
      },
      {
        name: 'custom_notes',
        label: 'Custom Notes',
        type: 'textarea',
        required: false,
        visible: true,
        order: 20,
        tab: 'custom',
        description: 'Notas customizadas da organização',
        importMapping: { custom: 'custom_notes' }
      }
    ]
  }
];

export default function VulnerabilityFieldsCustomization() {
  const navigate = useNavigate();
  const { user } = useAuth();

  const {
    customFields,
    loading,
    canManageFields,
    createCustomField,
    updateCustomField,
    deleteCustomField,
    reorderFields
  } = useCustomFields({ includeHidden: true });

  const [showFieldDialog, setShowFieldDialog] = useState(false);
  const [showTemplateDialog, setShowTemplateDialog] = useState(false);
  const [editingField, setEditingField] = useState<HookCustomField | null>(null);
  const [selectedTemplate, setSelectedTemplate] = useState<FieldTemplate | null>(null);

  // Form state for new/edit field
  const [fieldForm, setFieldForm] = useState({
    name: '',
    label: '',
    type: 'text' as CustomField['type'],
    required: false,
    visible: true,
    tab: 'custom' as CustomField['tab'],
    description: '',
    placeholder: '',
    defaultValue: '',
    options: [''],
    validation: {
      min: undefined as number | undefined,
      max: undefined as number | undefined,
      pattern: '',
      message: ''
    },
    importMapping: {
      qualys: '',
      nessus: '',
      openvas: '',
      burp: '',
      custom: ''
    }
  });

  // Check if user has permission to manage fields
  useEffect(() => {
    if (!canManageFields) {
      toast.error('Você não tem permissão para gerenciar campos customizados');
      navigate('/vulnerabilities');
    }
  }, [canManageFields, navigate]);

  const handleSaveField = async () => {
    if (!fieldForm.name.trim() || !fieldForm.label.trim()) {
      toast.error('Nome e rótulo são obrigatórios');
      return;
    }

    if (!canManageFields) {
      toast.error('Sem permissão para salvar campos');
      return;
    }

    try {
      const fieldData = {
        name: fieldForm.name,
        label: fieldForm.label,
        type: fieldForm.type,
        required: fieldForm.required,
        visible: fieldForm.visible,
        order: editingField?.order || customFields.length + 1,
        tab: fieldForm.tab,
        description: fieldForm.description,
        placeholder: fieldForm.placeholder,
        defaultValue: fieldForm.defaultValue,
        options: fieldForm.type === 'select' ? fieldForm.options.filter(opt => opt.trim()) : undefined,
        validation: fieldForm.validation.pattern || fieldForm.validation.min || fieldForm.validation.max
          ? fieldForm.validation
          : undefined,
        importMapping: Object.values(fieldForm.importMapping).some(v => v)
          ? fieldForm.importMapping
          : undefined,
      };

      if (editingField) {
        await updateCustomField(editingField.id, fieldData);
      } else {
        await createCustomField(fieldData);
      }

      resetFieldForm();
      setShowFieldDialog(false);
    } catch (error) {
      console.error('Error saving field:', error);
      toast.error('Erro ao salvar campo: ' + (error instanceof Error ? error.message : 'Erro desconhecido'));
    }
  };

  const handleDeleteField = async (fieldId: string) => {
    await deleteCustomField(fieldId);
  };

  const handleApplyTemplate = async (template: FieldTemplate) => {
    try {
      for (const field of template.fields) {
        await createCustomField({
          ...field,
          order: customFields.length + 1
        });
      }
      toast.success(`Template "${template.name}" aplicado com sucesso`);
      setShowTemplateDialog(false);
    } catch (error) {
      toast.error('Erro ao aplicar template');
    }
  };

  const handleDragEnd = async (result: any) => {
    if (!result.destination) return;

    const items = Array.from(customFields);
    const [reorderedItem] = items.splice(result.source.index, 1);
    items.splice(result.destination.index, 0, reorderedItem);

    // Get new order of field IDs
    const fieldIds = items.map(item => item.id);
    await reorderFields(fieldIds);
  };

  const resetFieldForm = () => {
    setFieldForm({
      name: '',
      label: '',
      type: 'text',
      required: false,
      visible: true,
      tab: 'custom',
      description: '',
      placeholder: '',
      defaultValue: '',
      options: [''],
      validation: {
        min: undefined,
        max: undefined,
        pattern: '',
        message: ''
      },
      importMapping: {
        qualys: '',
        nessus: '',
        openvas: '',
        burp: '',
        custom: ''
      }
    });
    setEditingField(null);
  };

  const openEditField = (field: HookCustomField) => {
    setEditingField(field);
    setFieldForm({
      name: field.name,
      label: field.label,
      type: field.type,
      required: field.required,
      visible: field.visible,
      tab: field.tab,
      description: field.description || '',
      placeholder: field.placeholder || '',
      defaultValue: field.defaultValue || '',
      options: field.options || [''],
      validation: field.validation || {
        min: undefined,
        max: undefined,
        pattern: '',
        message: ''
      },
      importMapping: {
        qualys: '',
        nessus: '',
        openvas: '',
        burp: '',
        custom: '',
        ...field.importMapping
      }
    });
    setShowFieldDialog(true);
  };

  const addOption = () => {
    setFieldForm(prev => ({
      ...prev,
      options: [...prev.options, '']
    }));
  };

  const updateOption = (index: number, value: string) => {
    setFieldForm(prev => ({
      ...prev,
      options: prev.options.map((opt, i) => i === index ? value : opt)
    }));
  };

  const removeOption = (index: number) => {
    setFieldForm(prev => ({
      ...prev,
      options: prev.options.filter((_, i) => i !== index)
    }));
  };

  const getFieldTypeIcon = (type: string) => {
    const fieldType = FIELD_TYPES.find(ft => ft.value === type);
    const IconComponent = fieldType?.icon || Type;
    return <IconComponent className="h-4 w-4" />;
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" onClick={() => navigate('/vulnerabilities')}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Voltar
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Settings className="h-8 w-8 text-primary" />
              Customização de Campos
            </h1>
            <p className="text-muted-foreground">
              Configure campos personalizados para vulnerabilidades
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => setShowTemplateDialog(true)}>
            <Download className="h-4 w-4 mr-2" />
            Templates
          </Button>
          <Button
            onClick={() => {
              if (!canManageFields) {
                toast.error('Sem permissão para criar campos');
                return;
              }
              resetFieldForm();
              setShowFieldDialog(true);
            }}
            disabled={!canManageFields}
          >
            <Plus className="h-4 w-4 mr-2" />
            Novo Campo
          </Button>
        </div>
      </div>

      {/* Warning for admin only */}
      <Alert>
        <AlertTriangle className="h-4 w-4" />
        <AlertDescription>
          <strong>Acesso Restrito:</strong> Apenas administradores da tenant podem customizar campos de vulnerabilidades.
          Alterações afetarão todos os usuários da organização.
        </AlertDescription>
      </Alert>

      <Tabs defaultValue="fields" className="w-full">
        <TabsList>
          <TabsTrigger value="fields">Campos Customizados</TabsTrigger>
          <TabsTrigger value="mapping">Mapeamento de Importação</TabsTrigger>
          <TabsTrigger value="preview">Preview do Formulário</TabsTrigger>
        </TabsList>

        <TabsContent value="fields" className="space-y-6">
          {/* Current Fields */}
          <Card>
            <CardHeader>
              <div className="flex items-center justify-between">
                <div>
                  <CardTitle>Campos Customizados ({customFields.length})</CardTitle>
                  <CardDescription>
                    Gerencie campos personalizados para vulnerabilidades
                  </CardDescription>
                </div>
                <div className="flex gap-2">
                  <Button variant="outline" size="sm">
                    <Upload className="h-4 w-4 mr-2" />
                    Importar
                  </Button>
                  <Button variant="outline" size="sm">
                    <Download className="h-4 w-4 mr-2" />
                    Exportar
                  </Button>
                </div>
              </div>
            </CardHeader>
            <CardContent>
              {customFields.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <Settings className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p className="text-lg font-medium mb-2">Nenhum campo customizado</p>
                  <p>Crie campos personalizados ou aplique um template</p>
                </div>
              ) : (
                <DragDropContext onDragEnd={handleDragEnd}>
                  <Droppable droppableId="fields">
                    {(provided) => (
                      <div {...provided.droppableProps} ref={provided.innerRef} className="space-y-2">
                        {customFields
                          .sort((a, b) => a.order - b.order)
                          .map((field, index) => (
                            <Draggable key={field.id} draggableId={field.id} index={index}>
                              {(provided) => (
                                <div
                                  ref={provided.innerRef}
                                  {...provided.draggableProps}
                                  className="border rounded-lg p-4 bg-card hover:bg-accent/50 transition-colors"
                                >
                                  <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-4">
                                      <div {...provided.dragHandleProps}>
                                        <GripVertical className="h-4 w-4 text-muted-foreground cursor-grab" />
                                      </div>
                                      <div className="flex items-center gap-2">
                                        {getFieldTypeIcon(field.type)}
                                        <div>
                                          <h4 className="font-medium">{field.label}</h4>
                                          <p className="text-sm text-muted-foreground">
                                            {field.name} • {FIELD_TYPES.find(ft => ft.value === field.type)?.label}
                                          </p>
                                        </div>
                                      </div>
                                      <div className="flex gap-2">
                                        <Badge variant="outline">
                                          {TABS_OPTIONS.find(tab => tab.value === field.tab)?.label}
                                        </Badge>
                                        {field.required && (
                                          <Badge variant="destructive">Obrigatório</Badge>
                                        )}
                                        {!field.visible && (
                                          <Badge variant="secondary">Oculto</Badge>
                                        )}
                                      </div>
                                    </div>
                                    <div className="flex items-center gap-1">
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => {
                                          setCustomFields(prev => prev.map(f =>
                                            f.id === field.id ? { ...f, visible: !f.visible } : f
                                          ));
                                        }}
                                      >
                                        {field.visible ? <Eye className="h-4 w-4" /> : <EyeOff className="h-4 w-4" />}
                                      </Button>
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => openEditField(field)}
                                      >
                                        <Edit className="h-4 w-4" />
                                      </Button>
                                      <Button
                                        variant="ghost"
                                        size="sm"
                                        onClick={() => handleDeleteField(field.id)}
                                      >
                                        <Trash2 className="h-4 w-4" />
                                      </Button>
                                    </div>
                                  </div>
                                  {field.description && (
                                    <p className="text-sm text-muted-foreground mt-2 ml-8">
                                      {field.description}
                                    </p>
                                  )}
                                </div>
                              )}
                            </Draggable>
                          ))}
                        {provided.placeholder}
                      </div>
                    )}
                  </Droppable>
                </DragDropContext>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="mapping" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Mapeamento de Importação</CardTitle>
              <CardDescription>
                Configure como os campos são mapeados durante a importação de diferentes ferramentas
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="overflow-x-auto">
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Campo</TableHead>
                      <TableHead>Qualys</TableHead>
                      <TableHead>Nessus</TableHead>
                      <TableHead>OpenVAS</TableHead>
                      <TableHead>Burp Suite</TableHead>
                      <TableHead>Customizado</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {customFields.map((field) => (
                      <TableRow key={field.id}>
                        <TableCell className="font-medium">{field.label}</TableCell>
                        <TableCell>{field.importMapping?.qualys || '-'}</TableCell>
                        <TableCell>{field.importMapping?.nessus || '-'}</TableCell>
                        <TableCell>{field.importMapping?.openvas || '-'}</TableCell>
                        <TableCell>{field.importMapping?.burp || '-'}</TableCell>
                        <TableCell>{field.importMapping?.custom || '-'}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="preview" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Preview do Formulário</CardTitle>
              <CardDescription>
                Visualize como os campos customizados aparecerão no formulário de vulnerabilidades
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="border rounded-lg p-6 bg-muted/30">
                <h3 className="text-lg font-semibold mb-4">Campos Customizados</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {customFields
                    .filter(field => field.visible)
                    .sort((a, b) => a.order - b.order)
                    .map((field) => (
                      <div key={field.id} className="space-y-2">
                        <Label>
                          {field.label}
                          {field.required && <span className="text-red-500 ml-1">*</span>}
                        </Label>
                        {field.type === 'select' ? (
                          <Select disabled>
                            <SelectTrigger>
                              <SelectValue placeholder={field.placeholder || `Selecione ${field.label}`} />
                            </SelectTrigger>
                          </Select>
                        ) : field.type === 'textarea' ? (
                          <Textarea
                            placeholder={field.placeholder}
                            disabled
                            rows={3}
                          />
                        ) : field.type === 'boolean' ? (
                          <div className="flex items-center space-x-2">
                            <Switch disabled />
                            <Label>{field.label}</Label>
                          </div>
                        ) : (
                          <Input
                            type={field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : 'text'}
                            placeholder={field.placeholder}
                            disabled
                          />
                        )}
                        {field.description && (
                          <p className="text-xs text-muted-foreground">{field.description}</p>
                        )}
                      </div>
                    ))}
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Field Dialog */}
      <Dialog open={showFieldDialog} onOpenChange={setShowFieldDialog}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {editingField ? 'Editar Campo' : 'Novo Campo Customizado'}
            </DialogTitle>
            <DialogDescription>
              Configure as propriedades do campo personalizado
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-6">
            {/* Basic Info */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="field-name">Nome do Campo *</Label>
                <Input
                  id="field-name"
                  value={fieldForm.name}
                  onChange={(e) => setFieldForm(prev => ({ ...prev, name: e.target.value }))}
                  placeholder="ex: business_unit"
                />
                <p className="text-xs text-muted-foreground">
                  Nome técnico usado no banco de dados (sem espaços)
                </p>
              </div>

              <div className="space-y-2">
                <Label htmlFor="field-label">Rótulo *</Label>
                <Input
                  id="field-label"
                  value={fieldForm.label}
                  onChange={(e) => setFieldForm(prev => ({ ...prev, label: e.target.value }))}
                  placeholder="ex: Unidade de Negócio"
                />
                <p className="text-xs text-muted-foreground">
                  Nome exibido no formulário
                </p>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Tipo de Campo *</Label>
                <Select value={fieldForm.type} onValueChange={(value) => setFieldForm(prev => ({ ...prev, type: value as CustomField['type'] }))}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {FIELD_TYPES.map(type => (
                      <SelectItem key={type.value} value={type.value}>
                        <div className="flex items-center gap-2">
                          <type.icon className="h-4 w-4" />
                          <div>
                            <p>{type.label}</p>
                            <p className="text-xs text-muted-foreground">{type.description}</p>
                          </div>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>

              <div className="space-y-2">
                <Label>Aba do Formulário</Label>
                <Select value={fieldForm.tab} onValueChange={(value) => setFieldForm(prev => ({ ...prev, tab: value as CustomField['tab'] }))}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {TABS_OPTIONS.map(tab => (
                      <SelectItem key={tab.value} value={tab.value}>
                        {tab.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="space-y-2">
              <Label htmlFor="field-description">Descrição</Label>
              <Textarea
                id="field-description"
                value={fieldForm.description}
                onChange={(e) => setFieldForm(prev => ({ ...prev, description: e.target.value }))}
                placeholder="Descrição do campo para ajudar os usuários"
                rows={2}
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label htmlFor="field-placeholder">Placeholder</Label>
                <Input
                  id="field-placeholder"
                  value={fieldForm.placeholder}
                  onChange={(e) => setFieldForm(prev => ({ ...prev, placeholder: e.target.value }))}
                  placeholder="Texto de exemplo no campo"
                />
              </div>

              <div className="space-y-2">
                <Label htmlFor="field-default">Valor Padrão</Label>
                <Input
                  id="field-default"
                  value={fieldForm.defaultValue}
                  onChange={(e) => setFieldForm(prev => ({ ...prev, defaultValue: e.target.value }))}
                  placeholder="Valor inicial do campo"
                />
              </div>
            </div>

            {/* Options for select type */}
            {fieldForm.type === 'select' && (
              <div className="space-y-2">
                <Label>Opções da Lista</Label>
                <div className="space-y-2">
                  {fieldForm.options.map((option, index) => (
                    <div key={index} className="flex gap-2">
                      <Input
                        value={option}
                        onChange={(e) => updateOption(index, e.target.value)}
                        placeholder={`Opção ${index + 1}`}
                      />
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => removeOption(index)}
                        disabled={fieldForm.options.length === 1}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  ))}
                  <Button type="button" variant="outline" onClick={addOption}>
                    <Plus className="h-4 w-4 mr-2" />
                    Adicionar Opção
                  </Button>
                </div>
              </div>
            )}

            {/* Field Properties */}
            <div className="flex items-center space-x-6">
              <div className="flex items-center space-x-2">
                <Switch
                  checked={fieldForm.required}
                  onCheckedChange={(checked) => setFieldForm(prev => ({ ...prev, required: checked }))}
                />
                <Label>Campo obrigatório</Label>
              </div>

              <div className="flex items-center space-x-2">
                <Switch
                  checked={fieldForm.visible}
                  onCheckedChange={(checked) => setFieldForm(prev => ({ ...prev, visible: checked }))}
                />
                <Label>Visível no formulário</Label>
              </div>
            </div>

            {/* Import Mapping */}
            <div className="space-y-4">
              <h4 className="text-lg font-semibold">Mapeamento de Importação</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Campo Qualys</Label>
                  <Input
                    value={fieldForm.importMapping.qualys}
                    onChange={(e) => setFieldForm(prev => ({
                      ...prev,
                      importMapping: { ...prev.importMapping, qualys: e.target.value }
                    }))}
                    placeholder="ex: QID, CATEGORY"
                  />
                </div>

                <div className="space-y-2">
                  <Label>Campo Nessus</Label>
                  <Input
                    value={fieldForm.importMapping.nessus}
                    onChange={(e) => setFieldForm(prev => ({
                      ...prev,
                      importMapping: { ...prev.importMapping, nessus: e.target.value }
                    }))}
                    placeholder="ex: plugin_id, plugin_family"
                  />
                </div>

                <div className="space-y-2">
                  <Label>Campo OpenVAS</Label>
                  <Input
                    value={fieldForm.importMapping.openvas}
                    onChange={(e) => setFieldForm(prev => ({
                      ...prev,
                      importMapping: { ...prev.importMapping, openvas: e.target.value }
                    }))}
                    placeholder="ex: nvt_oid, family"
                  />
                </div>

                <div className="space-y-2">
                  <Label>Campo Customizado</Label>
                  <Input
                    value={fieldForm.importMapping.custom}
                    onChange={(e) => setFieldForm(prev => ({
                      ...prev,
                      importMapping: { ...prev.importMapping, custom: e.target.value }
                    }))}
                    placeholder="Nome do campo no arquivo"
                  />
                </div>
              </div>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowFieldDialog(false)}>
              Cancelar
            </Button>
            <Button onClick={handleSaveField}>
              <Save className="h-4 w-4 mr-2" />
              {editingField ? 'Atualizar' : 'Criar'} Campo
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Template Dialog */}
      <Dialog open={showTemplateDialog} onOpenChange={setShowTemplateDialog}>
        <DialogContent className="max-w-4xl max-h-[90vh] flex flex-col">
          <DialogHeader className="flex-shrink-0">
            <DialogTitle>Templates de Campos</DialogTitle>
            <DialogDescription>
              Aplique templates pré-configurados para ferramentas específicas
            </DialogDescription>
          </DialogHeader>

          <div className="flex-1 overflow-y-auto space-y-4 pr-2">
            {FIELD_TEMPLATES.map((template) => (
              <Card key={template.id} className="cursor-pointer hover:shadow-md transition-shadow">
                <CardContent className="p-4">
                  <div className="flex items-center justify-between">
                    <div className="flex-1 mr-4">
                      <h4 className="font-semibold">{template.name}</h4>
                      <p className="text-sm text-muted-foreground">{template.description}</p>
                      <p className="text-xs text-muted-foreground mt-1">
                        {template.fields.length} campos • Fonte: {template.source}
                      </p>
                    </div>
                    <Button onClick={() => handleApplyTemplate(template)} className="flex-shrink-0">
                      <Download className="h-4 w-4 mr-2" />
                      Aplicar
                    </Button>
                  </div>
                  <div className="mt-3 flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                    {template.fields.map((field, index) => (
                      <Badge key={index} variant="outline" className="text-xs">
                        {field.label}
                      </Badge>
                    ))}
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          <DialogFooter className="flex-shrink-0 mt-4">
            <Button variant="outline" onClick={() => setShowTemplateDialog(false)}>
              Fechar
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}