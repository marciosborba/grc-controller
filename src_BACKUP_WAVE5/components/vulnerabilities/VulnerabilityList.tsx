import React, { useState, useMemo, useCallback } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from '@/components/ui/dropdown-menu';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { addDays } from 'date-fns';
import { Separator } from '@/components/ui/separator';
import { Command, CommandEmpty, CommandGroup, CommandInput, CommandItem, CommandList } from '@/components/ui/command';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { Calendar } from '@/components/ui/calendar';
import {
  List,
  ArrowLeft,
  Search,
  Filter,
  Download,
  Eye,
  Edit,
  Plus,
  Settings,
  SortAsc,
  SortDesc,
  ChevronDown,
  FileText,
  X,
  CalendarIcon,
  User,
  Shield,
  Target,
  Clock,
  AlertTriangle,
  CheckCircle2,
  RotateCcw,
  Sliders,
  MoreHorizontal,
  Trash2
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'sonner';
import VulnerabilityImportDropdown from './import/VulnerabilityImportDropdown';
import { ImportSource } from './import/types/import';
import { useVulnerabilities } from './hooks/useVulnerabilities';
import VulnerabilityMetricsCards from './VulnerabilityMetricsCards';
import ExpandableVulnerabilityCard from './ExpandableVulnerabilityCard';
import { useAuth } from '@/contexts/AuthContextOptimized';
import { useCurrentTenantId } from '@/contexts/TenantSelectorContext';

// Static Data Generation (Moved outside component)
const generateAppOptions = () => {
  const types = ['WEB', 'API', 'MOB', 'SRV', 'DB', 'IOT'];
  const environments = ['PRD', 'HML', 'DEV', 'TST'];
  const apps = [];

  // Aplicações principais
  const mainApps = [
    { value: 'APP-WEB-001', label: 'Portal Web Principal', type: 'Web', env: 'PRD' },
    { value: 'APP-API-001', label: 'API Gateway Principal', type: 'API', env: 'PRD' },
    { value: 'APP-MOB-001', label: 'App Mobile iOS', type: 'Mobile', env: 'PRD' },
    { value: 'APP-MOB-002', label: 'App Mobile Android', type: 'Mobile', env: 'PRD' },
    { value: 'APP-WEB-002', label: 'Portal Administrativo', type: 'Web', env: 'PRD' },
    { value: 'APP-API-002', label: 'API Interna CRM', type: 'API', env: 'PRD' },
    { value: 'APP-API-003', label: 'API Pagamentos', type: 'API', env: 'PRD' },
    { value: 'APP-WEB-003', label: 'Portal Cliente', type: 'Web', env: 'PRD' },
    { value: 'APP-SRV-001', label: 'Servidor de Autenticação', type: 'Service', env: 'PRD' },
    { value: 'APP-DB-001', label: 'Banco Principal MySQL', type: 'Database', env: 'PRD' }
  ];

  apps.push(...mainApps);

  // Gerar aplicações adicionais
  for (let i = 1; i <= 50; i++) {
    types.forEach(type => {
      environments.forEach(env => {
        const id = `APP-${type}-${String(i + 10).padStart(3, '0')}-${env}`;
        apps.push({
          value: id,
          label: `${type} Application ${i} (${env})`,
          type: type,
          env: env
        });
      });
    });
  }

  return apps.slice(0, 200); // Limitar a 200 para performance
};

const STATIC_APP_OPTIONS = generateAppOptions();

const STATIC_ASSIGNEE_OPTIONS = [
  { value: 'dev@empresa.com', label: 'Equipe Desenvolvimento', team: 'Dev' },
  { value: 'security@empresa.com', label: 'Equipe Segurança', team: 'Security' },
  { value: 'mobile@empresa.com', label: 'Equipe Mobile', team: 'Mobile' },
  { value: 'devops@empresa.com', label: 'Equipe DevOps', team: 'DevOps' }
];

const STATIC_SOURCE_TYPE_OPTIONS = [
  { value: 'DAST', label: 'DAST', icon: Shield, color: 'bg-blue-500 text-white' },
  { value: 'SAST', label: 'SAST', icon: Search, color: 'bg-green-500 text-white' },
  { value: 'Manual', label: 'Manual', icon: User, color: 'bg-purple-500 text-white' },
  { value: 'Pentest', label: 'Pentest', icon: Target, color: 'bg-red-500 text-white' },
  { value: 'SCA', label: 'SCA', icon: FileText, color: 'bg-orange-500 text-white' },
  { value: 'IAST', label: 'IAST', icon: AlertTriangle, color: 'bg-yellow-500 text-black' }
];

const STATIC_EXPORT_FORMATS = [
  {
    id: 'csv',
    name: 'CSV',
    description: 'Arquivo de valores separados por vírgula',
    icon: FileText,
    extension: '.csv'
  },
  {
    id: 'excel',
    name: 'Excel',
    description: 'Planilha do Microsoft Excel',
    icon: FileText,
    extension: '.xlsx'
  },
  {
    id: 'json',
    name: 'JSON',
    description: 'Formato de dados JavaScript Object Notation',
    icon: FileText,
    extension: '.json'
  },
  {
    id: 'xml',
    name: 'XML',
    description: 'Arquivo de marcação extensível',
    icon: FileText,
    extension: '.xml'
  },
  {
    id: 'pdf',
    name: 'PDF',
    description: 'Relatório em PDF para apresentação',
    icon: FileText,
    extension: '.pdf'
  }
];

export default function VulnerabilityList() {
  const navigate = useNavigate();
  const { user } = useAuth();
  const tenantId = useCurrentTenantId();

  // State for filters and pagination
  const [page, setPage] = useState(1);
  const [limit] = useState(50);
  const [selectedVulnerabilities, setSelectedVulnerabilities] = useState<string[]>([]);

  // Filter states
  const [searchTerm, setSearchTerm] = useState('');
  const [severityFilter, setSeverityFilter] = useState('all');
  const [statusFilter, setStatusFilter] = useState('all');
  const [sortField, setSortField] = useState('created_at');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');

  // State restored for UI functionality
  const [exportModalOpen, setExportModalOpen] = useState(false);
  const [selectedExportFormat, setSelectedExportFormat] = useState<string | null>(null);
  const [advancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);
  const [appSearchOpen, setAppSearchOpen] = useState(false);
  const [viewModalOpen, setViewModalOpen] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<any>(null);
  const [appSearchTerm, setAppSearchTerm] = useState('');
  const [advancedFilters, setAdvancedFilters] = useState({
    sourceTypes: [] as string[],
    assignedTo: 'all',
    dateRange: {
      from: undefined as Date | undefined,
      to: undefined as Date | undefined
    },
    hasAssignee: 'all' as 'all' | 'assigned' | 'unassigned',
    appIds: [] as string[]
  });

  const handleImportSelect = useCallback((source: ImportSource) => {
    console.log('Fonte de importação selecionada:', source);
  }, []);

  // Optimized: Filter applications only when searchTerm changes
  const filteredAppOptions = useMemo(() => {
    if (!appSearchTerm) return STATIC_APP_OPTIONS;

    const lowerTerm = appSearchTerm.toLowerCase();
    return STATIC_APP_OPTIONS.filter(app =>
      app.value.toLowerCase().includes(lowerTerm) ||
      app.label.toLowerCase().includes(lowerTerm) ||
      app.type.toLowerCase().includes(lowerTerm) ||
      app.env.toLowerCase().includes(lowerTerm)
    );
  }, [appSearchTerm]);

  const addAppId = useCallback((appId: string) => {
    setAdvancedFilters(prev => {
      if (prev.appIds.includes(appId)) return prev;
      return {
        ...prev,
        appIds: [...prev.appIds, appId]
      };
    });
    setAppSearchTerm('');
    setAppSearchOpen(false);
  }, []);

  const removeAppId = useCallback((appId: string) => {
    setAdvancedFilters(prev => ({
      ...prev,
      appIds: prev.appIds.filter(id => id !== appId)
    }));
  }, []);

  const getActiveFiltersCount = () => {
    let count = 0;
    if (advancedFilters.sourceTypes.length > 0) count++;
    if (advancedFilters.assignedTo !== 'all' && advancedFilters.assignedTo !== '') count++;
    if (advancedFilters.dateRange.from || advancedFilters.dateRange.to) count++;
    if (advancedFilters.hasAssignee !== 'all') count++;
    if (advancedFilters.appIds.length > 0) count++;
    return count;
  };

  const clearAllAdvancedFilters = useCallback(() => {
    setAdvancedFilters({
      sourceTypes: [],
      assignedTo: 'all',
      dateRange: { from: undefined, to: undefined },
      hasAssignee: 'all',
      appIds: []
    });
  }, []);

  // Stable Callbacks for Child Components
  const handleViewVulnerability = useCallback((vulnerability: any) => {
    setSelectedVulnerability(vulnerability);
    setViewModalOpen(true);
  }, []);

  const handleDeleteVulnerability = useCallback((vulnerabilityId: string) => {
    console.log('Excluindo vulnerabilidade:', vulnerabilityId);
    toast.success(`Vulnerabilidade ${vulnerabilityId} excluída com sucesso!`);
  }, []);

  const toggleSelection = useCallback((id: string) => {
    setSelectedVulnerabilities(prev =>
      prev.includes(id) ? prev.filter(v => v !== id) : [...prev, id]
    );
  }, []);


  // Load real data
  const {
    vulnerabilities,
    metrics,
    loading: isLoading,
    totalCount,
    refetch
  } = useVulnerabilities({
    page,
    limit,
    sortBy: sortField as any,
    sortOrder,
    filters: useMemo(() => ({
      search: searchTerm,
      severity: severityFilter !== 'all' ? [severityFilter as any] : undefined,
      status: statusFilter !== 'all' ? [statusFilter as any] : undefined
    }), [searchTerm, severityFilter, statusFilter])
  });

  const filteredVulnerabilities = vulnerabilities || [];

  const handleSort = (field: string) => {
    if (sortField === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortField(field);
      setSortOrder('asc');
    }
  };

  // Export handlers
  const handleExportToFormat = useCallback((format: string) => {
    setSelectedExportFormat(format);
    setExportModalOpen(true);
  }, []);

  const exportToCSV = useCallback((data: any[], options: any) => {
    const delimiter = options.delimiter || ',';
    const headers = Object.keys(data[0]).join(delimiter);
    const rows = data.map(row => Object.values(row).join(delimiter));
    const csvContent = [headers, ...rows].join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `vulnerabilidades_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();

    const count = data.length;
    toast.success(`Exportação concluída! ${count} vulnerabilidade${count !== 1 ? 's' : ''} exportada${count !== 1 ? 's' : ''}.`);
  }, []);

  const exportToJSON = useCallback((data: any[], options: any) => {
    const jsonContent = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `vulnerabilidades_${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    toast.success('Exportação JSON concluída!');
  }, []);

  const exportToXML = useCallback((data: any[], options: any) => {
    let xmlContent = '<?xml version="1.0" encoding="UTF-8"?>\n<vulnerabilidades>\n';
    data.forEach(item => {
      xmlContent += '  <vulnerabilidade>\n';
      Object.entries(item).forEach(([key, value]) => {
        xmlContent += `    <${key.toLowerCase().replace(/\s+/g, '_')}>${value}</${key.toLowerCase().replace(/\s+/g, '_')}>\n`;
      });
      xmlContent += '  </vulnerabilidade>\n';
    });
    xmlContent += '</vulnerabilidades>';

    const blob = new Blob([xmlContent], { type: 'application/xml;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `vulnerabilidades_${new Date().toISOString().split('T')[0]}.xml`;
    link.click();

    toast.success('Exportação XML concluída!');
  }, []);

  // Helpers for export (simple console logs for now as per original)
  const exportToExcel = useCallback((data: any[], options: any) => {
    console.log('Exportação Excel não implementada. Use CSV como alternativa.');
    exportToCSV(data, { delimiter: ',' });
  }, [exportToCSV]);

  const exportToPDF = useCallback((data: any[], options: any) => {
    console.log('Exportação PDF não implementada. Use CSV como alternativa.');
    exportToCSV(data, { delimiter: ',' });
  }, [exportToCSV]);

  const executeExport = useCallback((format: string, options: any = {}) => {
    const dataToExport = filteredVulnerabilities.map(vuln => ({
      ID: vuln.id,
      'App ID': (vuln as any).app_id || 'N/A',
      Título: vuln.title,
      Severidade: vuln.severity,
      Status: vuln.status.replace('_', ' '),
      Ativo: vuln.asset_name,
      Fonte: vuln.source_type,
      Responsável: vuln.assigned_to || 'Não atribuído',
      'Data de Criação': vuln.created_at
    }));

    switch (format) {
      case 'csv':
        exportToCSV(dataToExport, options);
        break;
      case 'excel':
        exportToExcel(dataToExport, options);
        break;
      case 'pdf':
        exportToPDF(dataToExport, options);
        break;
      case 'json':
        exportToJSON(dataToExport, options);
        break;
      case 'xml':
        exportToXML(dataToExport, options);
        break;
      default:
        console.error('Formato de exportação não suportado:', format);
    }
  }, [filteredVulnerabilities, exportToCSV, exportToExcel, exportToJSON, exportToPDF, exportToXML]);


  // ... (keeping helper functions as is, though they could be memoized or static too if complex)
  // Moving complex export logic outside component or into useMemo/useCallback would be ideal, 
  // but let's focus on render-critical parts first.

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="space-y-4">
        <div className="flex items-center gap-4">
          <Button variant="ghost" onClick={() => navigate('/vulnerabilities')}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Voltar
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <List className="h-8 w-8 text-primary" />
              Lista de Vulnerabilidades
            </h1>
            <p className="text-muted-foreground">
              Relação classificada de acordo com os critérios estabelecidos
            </p>
          </div>
        </div>
        <div className="flex justify-end gap-2">
          <VulnerabilityImportDropdown onImportSelect={handleImportSelect} />
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline">
                <Download className="h-4 w-4 mr-2" />
                Exportar
                <ChevronDown className="h-4 w-4 ml-2" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-64 max-h-96 overflow-y-auto">
              {STATIC_EXPORT_FORMATS.map((format) => {
                const IconComponent = format.icon;
                return (
                  <DropdownMenuItem
                    key={format.id}
                    onClick={() => handleExportToFormat(format.id)}
                    className="flex items-start gap-3 p-3"
                  >
                    <IconComponent className="h-4 w-4 mt-0.5 text-primary" />
                    <div className="flex-1">
                      <div className="font-medium">{format.name}</div>
                      <div className="text-sm text-muted-foreground">{format.description}</div>
                    </div>
                  </DropdownMenuItem>
                );
              })}
              <DropdownMenuSeparator />
              <DropdownMenuItem onClick={() => executeExport('csv', { delimiter: ',' })}>
                <Download className="h-4 w-4 mr-2" />
                Exportação Rápida (CSV)
              </DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>

          <Button variant="outline" onClick={() => navigate('/vulnerabilities/fields-customization')}>
            <Settings className="h-4 w-4 mr-2" />
            Customizar
          </Button>
          <Button onClick={() => navigate('/vulnerabilities/create')}>
            <Plus className="h-4 w-4 mr-2" />
            Nova Vulnerabilidade
          </Button>
        </div>
      </div>

      {/* Metrics Cards */}
      <VulnerabilityMetricsCards metrics={metrics} loading={isLoading} />

      {/* Filters */}
      <Card>
        <CardHeader>
          <CardTitle>Filtros</CardTitle>
          <CardDescription>
            Filtre e pesquise vulnerabilidades de acordo com seus critérios
          </CardDescription>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div className="space-y-2">
              <label className="text-sm font-medium">Pesquisar</label>
              <div className="relative">
                <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="ID, título ou ativo..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10"
                />
              </div>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Severidade</label>
              <Select value={severityFilter} onValueChange={setSeverityFilter}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todas</SelectItem>
                  <SelectItem value="Critical">Crítica</SelectItem>
                  <SelectItem value="High">Alta</SelectItem>
                  <SelectItem value="Medium">Média</SelectItem>
                  <SelectItem value="Low">Baixa</SelectItem>
                  <SelectItem value="Info">Info</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Status</label>
              <Select value={statusFilter} onValueChange={setStatusFilter}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="all">Todos</SelectItem>
                  <SelectItem value="Open">Aberta</SelectItem>
                  <SelectItem value="In_Progress">Em Progresso</SelectItem>
                  <SelectItem value="Testing">Em Teste</SelectItem>
                  <SelectItem value="Resolved">Resolvida</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Ações</label>
              <Button
                variant={getActiveFiltersCount() > 0 ? "default" : "outline"}
                className="w-full relative"
                onClick={() => setAdvancedFiltersOpen(true)}
              >
                <Sliders className="h-4 w-4 mr-2" />
                Filtros Avançados
                {getActiveFiltersCount() > 0 && (
                  <Badge
                    variant="secondary"
                    className="ml-2 h-5 w-5 p-0 flex items-center justify-center text-xs"
                  >
                    {getActiveFiltersCount()}
                  </Badge>
                )}
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Active Advanced Filters */}
      {getActiveFiltersCount() > 0 && (
        <Card className="border-primary/20 bg-primary/5">
          <CardContent className="p-4">
            <div className="flex items-center justify-between mb-3">
              <div className="flex items-center gap-2">
                <Sliders className="h-4 w-4 text-primary" />
                <span className="text-sm font-medium">Filtros Avançados Ativos</span>
                <Badge variant="secondary">
                  {getActiveFiltersCount()}
                </Badge>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={clearAllAdvancedFilters}
                className="h-8 px-2 text-muted-foreground hover:text-foreground"
              >
                <X className="h-4 w-4 mr-1" />
                Limpar Todos
              </Button>
            </div>
            <div className="flex flex-wrap gap-2">
              {advancedFilters.sourceTypes.map((type) => {
                const option = STATIC_SOURCE_TYPE_OPTIONS.find(o => o.value === type);
                return (
                  <Badge key={type} variant="outline" className="gap-1 pr-1">
                    {option?.icon && <option.icon className="h-3 w-3" />}
                    {option?.label}
                    <Button
                      variant="ghost"
                      size="sm"
                      className="h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground ml-1"
                      onClick={() => setAdvancedFilters(prev => ({
                        ...prev,
                        sourceTypes: prev.sourceTypes.filter(t => t !== type)
                      }))}
                    >
                      <X className="h-3 w-3" />
                    </Button>
                  </Badge>
                );
              })}
              {advancedFilters.appIds.length > 0 && (
                <Badge variant="outline" className="gap-1 pr-1">
                  <Target className="h-3 w-3" />
                  {advancedFilters.appIds.length} aplicação{advancedFilters.appIds.length > 1 ? 'ões' : ''} selecionada{advancedFilters.appIds.length > 1 ? 's' : ''}
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground ml-1"
                    onClick={() => setAdvancedFilters(prev => ({ ...prev, appIds: [] }))}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </Badge>
              )}
              {advancedFilters.assignedTo !== 'all' && advancedFilters.assignedTo !== '' && (
                <Badge variant="outline" className="gap-1 pr-1">
                  <User className="h-3 w-3" />
                  {STATIC_ASSIGNEE_OPTIONS.find(o => o.value === advancedFilters.assignedTo)?.label}
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground ml-1"
                    onClick={() => setAdvancedFilters(prev => ({ ...prev, assignedTo: 'all' }))}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </Badge>
              )}
              {(advancedFilters.dateRange.from || advancedFilters.dateRange.to) && (
                <Badge variant="outline" className="gap-1 pr-1">
                  <CalendarIcon className="h-3 w-3" />
                  Período Personalizado
                  <Button
                    variant="ghost"
                    size="sm"
                    className="h-4 w-4 p-0 hover:bg-destructive hover:text-destructive-foreground ml-1"
                    onClick={() => setAdvancedFilters(prev => ({ ...prev, dateRange: { from: undefined, to: undefined } }))}
                  >
                    <X className="h-3 w-3" />
                  </Button>
                </Badge>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Results - Expandable Cards List */}
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <div>
            <h3 className="text-lg font-semibold">Vulnerabilidades ({filteredVulnerabilities.length})</h3>
            <p className="text-sm text-muted-foreground">
              Lista de vulnerabilidades filtradas
            </p>
          </div>
        </div>

        <div className="space-y-2">
          {filteredVulnerabilities.map((vulnerability) => (
            <ExpandableVulnerabilityCard
              key={vulnerability.id}
              vulnerability={vulnerability}
              isSelected={selectedVulnerabilities.includes(vulnerability.id)}
              onSelect={toggleSelection}
              onDelete={handleDeleteVulnerability}
              onRefresh={refetch}
            />
          ))}
        </div>
      </div>

      {/* Advanced Filters Modal */}
      <Dialog open={advancedFiltersOpen} onOpenChange={setAdvancedFiltersOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          {/* ... keeping advanced filter content same as simplified before ... */}
          {/* Re-implementing the dialog content fully to ensure it works */}
          <DialogHeader className="pb-4 border-b">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <div className="p-2 bg-primary/10 rounded-lg">
                  <Sliders className="h-5 w-5 text-primary" />
                </div>
                <div>
                  <DialogTitle className="text-xl font-semibold">
                    Filtros Avançados
                  </DialogTitle>
                  <DialogDescription className="text-sm text-muted-foreground">
                    Configure filtros detalhados para refinar sua busca por vulnerabilidades
                  </DialogDescription>
                </div>
              </div>
            </div>
          </DialogHeader>

          <div className="space-y-6 py-6">
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Left Column */}
              <div className="space-y-6">
                {/* Source Types */}
                <Card>
                  <CardHeader className="pb-3">
                    <CardTitle className="text-base flex items-center gap-2">
                      <Shield className="h-4 w-4" />
                      Tipos de Fonte
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-2 gap-3">
                      {STATIC_SOURCE_TYPE_OPTIONS.map((option) => (
                        <div key={option.value} className="flex items-center space-x-3 p-3 border rounded-lg hover:bg-muted/50 transition-colors">
                          <Checkbox
                            id={`source-${option.value}`}
                            checked={advancedFilters.sourceTypes.includes(option.value)}
                            onCheckedChange={(checked) => {
                              if (checked) {
                                setAdvancedFilters(prev => ({
                                  ...prev,
                                  sourceTypes: [...prev.sourceTypes, option.value]
                                }));
                              } else {
                                setAdvancedFilters(prev => ({
                                  ...prev,
                                  sourceTypes: prev.sourceTypes.filter(t => t !== option.value)
                                }));
                              }
                            }}
                          />
                          <Label htmlFor={`source-${option.value}`} className="text-sm font-medium cursor-pointer">
                            {option.label}
                          </Label>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Right Column */}
              <div className="space-y-6">
                {/* Applications Search */}
                <Card>
                  <CardHeader className="pb-3">
                    <CardTitle className="text-base flex items-center gap-2">
                      <Target className="h-4 w-4" />
                      Aplicações
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <div className="space-y-2">
                      <Label className="text-sm font-medium">Buscar Aplicações</Label>
                      <Input
                        placeholder="Digite ID, nome..."
                        value={appSearchTerm}
                        onChange={(e) => setAppSearchTerm(e.target.value)}
                      />
                      {appSearchTerm && filteredAppOptions.length > 0 && (
                        <div className="border rounded-lg max-h-48 overflow-y-auto mt-2">
                          {filteredAppOptions.slice(0, 5).map(app => (
                            <div
                              key={app.value}
                              className="p-2 hover:bg-muted cursor-pointer text-sm"
                              onClick={() => addAppId(app.value)}
                            >
                              {app.label} ({app.value})
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              </div>
            </div>

            <div className="flex justify-end gap-3 pt-6 border-t">
              <Button variant="outline" onClick={clearAllAdvancedFilters}>Limpar Filtros</Button>
              <Button onClick={() => setAdvancedFiltersOpen(false)}>Aplicar Filtros</Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

    </div>
  );
}
