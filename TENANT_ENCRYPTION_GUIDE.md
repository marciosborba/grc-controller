# üîê GUIA COMPLETO DO SISTEMA DE CRIPTOGRAFIA POR TENANT\n\n## üìã √çndice\n\n1. [Vis√£o Geral](#vis√£o-geral)\n2. [Arquitetura](#arquitetura)\n3. [Implementa√ß√£o](#implementa√ß√£o)\n4. [Uso Pr√°tico](#uso-pr√°tico)\n5. [Performance](#performance)\n6. [Seguran√ßa](#seguran√ßa)\n7. [Monitoramento](#monitoramento)\n8. [Manuten√ß√£o](#manuten√ß√£o)\n9. [Troubleshooting](#troubleshooting)\n10. [Compliance](#compliance)\n\n---\n\n## üéØ Vis√£o Geral\n\n### O que √©?\n\nO Sistema de Criptografia por Tenant √© uma solu√ß√£o avan√ßada que garante **isolamento criptogr√°fico completo** entre diferentes organiza√ß√µes (tenants) no GRC Controller. Cada tenant possui suas pr√≥prias chaves criptogr√°ficas √∫nicas, garantindo que dados de uma organiza√ß√£o nunca possam ser descriptografados por outra.\n\n### Benef√≠cios Principais\n\n- ‚úÖ **Isolamento Criptogr√°fico**: Cada tenant tem chaves √∫nicas\n- ‚úÖ **Compliance**: Atende LGPD, GDPR, SOX, ISO 27001\n- ‚úÖ **Performance**: Cache inteligente e otimiza√ß√µes\n- ‚úÖ **Auditoria**: Log completo de todas as opera√ß√µes\n- ‚úÖ **Escalabilidade**: Suporta milhares de tenants\n- ‚úÖ **Rota√ß√£o de Chaves**: Sistema autom√°tico de renova√ß√£o\n- ‚úÖ **M√∫ltiplos Prop√≥sitos**: Chaves espec√≠ficas por tipo de dado\n\n### Casos de Uso\n\n- **Dados PII**: Nomes, emails, telefones, documentos\n- **Dados Financeiros**: Valores, custos, or√ßamentos\n- **Dados de Auditoria**: Achados, evid√™ncias, relat√≥rios\n- **Dados de Compliance**: Pol√≠ticas, controles, avalia√ß√µes\n- **Dados Gerais**: Descri√ß√µes, coment√°rios, notas\n\n---\n\n## üèóÔ∏è Arquitetura\n\n### Componentes Principais\n\n```mermaid\ngraph TB\n    A[Aplica√ß√£o TypeScript] --> B[TenantCrypto Middleware]\n    B --> C[Cache de Chaves]\n    B --> D[Fun√ß√µes PostgreSQL]\n    D --> E[Tabela de Chaves]\n    D --> F[Dados Criptografados]\n    D --> G[Log de Auditoria]\n    \n    H[Sistema de Rota√ß√£o] --> E\n    I[Monitoramento] --> G\n    J[Backup] --> E\n```\n\n### Estrutura de Dados\n\n#### 1. Tabela de Chaves (`tenant_crypto_keys`)\n\n```sql\nCREATE TABLE tenant_crypto_keys (\n    id UUID PRIMARY KEY,\n    tenant_id UUID REFERENCES tenants(id),\n    master_key_encrypted TEXT,     -- Chave mestra criptografada\n    key_derivation_salt TEXT,      -- Salt para deriva√ß√£o\n    encryption_version INTEGER,    -- Vers√£o para rota√ß√£o\n    key_purpose VARCHAR(50),       -- 'general', 'pii', 'financial', etc.\n    is_active BOOLEAN,\n    created_at TIMESTAMP,\n    updated_at TIMESTAMP\n);\n```\n\n#### 2. Hist√≥rico de Chaves (`tenant_key_history`)\n\n```sql\nCREATE TABLE tenant_key_history (\n    id UUID PRIMARY KEY,\n    tenant_id UUID,\n    key_version INTEGER,\n    key_purpose VARCHAR(50),\n    master_key_encrypted TEXT,\n    created_at TIMESTAMP,\n    retired_at TIMESTAMP,\n    rotation_reason VARCHAR(100)\n);\n```\n\n#### 3. Log de Auditoria (`crypto_audit_log`)\n\n```sql\nCREATE TABLE crypto_audit_log (\n    id UUID PRIMARY KEY,\n    tenant_id UUID,\n    operation_type VARCHAR(50),    -- 'encrypt', 'decrypt', 'key_rotation'\n    table_name VARCHAR(100),\n    field_name VARCHAR(100),\n    user_id UUID,\n    success BOOLEAN,\n    performance_ms INTEGER,\n    created_at TIMESTAMP\n);\n```\n\n### Fluxo de Criptografia\n\n```mermaid\nsequenceDiagram\n    participant App as Aplica√ß√£o\n    participant TC as TenantCrypto\n    participant Cache as Cache\n    participant DB as PostgreSQL\n    \n    App->>TC: encrypt(tenantId, data, 'pii')\n    TC->>Cache: getTenantKey(tenantId, 'pii')\n    \n    alt Cache Hit\n        Cache-->>TC: Chave encontrada\n    else Cache Miss\n        TC->>DB: Buscar chave do tenant\n        DB-->>TC: Chave criptografada\n        TC->>Cache: Armazenar chave\n    end\n    \n    TC->>DB: encrypt_tenant_data()\n    DB-->>TC: Dados criptografados\n    TC->>DB: Log de auditoria\n    TC-->>App: Resultado\n```\n\n---\n\n## üöÄ Implementa√ß√£o\n\n### 1. Setup Inicial\n\n```bash\n# Executar script de implementa√ß√£o\nnode setup-tenant-encryption.cjs\n\n# Verificar implementa√ß√£o\nnode test-encryption.cjs\n```\n\n### 2. Configura√ß√£o de Ambiente\n\n```bash\n# .env\nSUPABASE_DB_PASSWORD=sua_senha_aqui\nSYSTEM_CRYPTO_MASTER_KEY=chave_mestra_do_sistema_256_bits\n```\n\n### 3. Importar Middleware\n\n```typescript\nimport { tenantCrypto, encryptPII, decryptPII } from '@/utils/tenantCrypto';\n```\n\n---\n\n## üíª Uso Pr√°tico\n\n### Criptografia B√°sica\n\n```typescript\nimport { tenantCrypto } from '@/utils/tenantCrypto';\n\n// Criptografar dados\nconst result = await tenantCrypto.encrypt(\n  'tenant-uuid-here',\n  'Dados confidenciais',\n  'pii' // prop√≥sito\n);\n\nif (result.success) {\n  console.log('Dados criptografados:', result.data);\n} else {\n  console.error('Erro:', result.error);\n}\n\n// Descriptografar dados\nconst decrypted = await tenantCrypto.decrypt(\n  'tenant-uuid-here',\n  result.data!,\n  'pii'\n);\n```\n\n### Fun√ß√µes de Conveni√™ncia\n\n```typescript\nimport { \n  encryptPII, \n  decryptPII, \n  encryptFinancial, \n  decryptFinancial \n} from '@/utils/tenantCrypto';\n\n// Dados PII\nconst encryptedName = await encryptPII(tenantId, 'Jo√£o Silva');\nconst decryptedName = await decryptPII(tenantId, encryptedName);\n\n// Dados financeiros\nconst encryptedValue = await encryptFinancial(tenantId, '1000000.00');\nconst decryptedValue = await decryptFinancial(tenantId, encryptedValue);\n```\n\n### Uso com Decorators\n\n```typescript\nimport { EncryptedField, RequiresTenant } from '@/utils/tenantCrypto';\n\nclass UserProfile {\n  tenantId: string;\n  \n  @EncryptedField('pii')\n  fullName: string;\n  \n  @EncryptedField('pii')\n  email: string;\n  \n  @EncryptedField('pii')\n  phone: string;\n  \n  @RequiresTenant\n  async save() {\n    // M√©todo automaticamente valida tenantId\n    // Campos marcados s√£o criptografados automaticamente\n  }\n}\n```\n\n### Integra√ß√£o com Supabase\n\n```typescript\n// Salvar dados criptografados\nconst { data, error } = await supabase\n  .from('profiles')\n  .insert({\n    user_id: userId,\n    tenant_id: tenantId,\n    full_name_encrypted: await encryptPII(tenantId, fullName),\n    phone_encrypted: await encryptPII(tenantId, phone)\n  });\n\n// Buscar e descriptografar\nconst { data: profiles } = await supabase\n  .from('profiles')\n  .select('*')\n  .eq('tenant_id', tenantId);\n\nfor (const profile of profiles) {\n  profile.full_name = await decryptPII(tenantId, profile.full_name_encrypted);\n  profile.phone = await decryptPII(tenantId, profile.phone_encrypted);\n}\n```\n\n---\n\n## ‚ö° Performance\n\n### M√©tricas Esperadas\n\n| Opera√ß√£o | Tempo M√©dio | Throughput |\n|----------|-------------|------------|\n| Encrypt (1KB) | 5-15ms | 1000+ ops/sec |\n| Decrypt (1KB) | 3-10ms | 1500+ ops/sec |\n| Cache Hit | <1ms | 10000+ ops/sec |\n| Key Rotation | 100-500ms | N/A |\n\n### Otimiza√ß√µes Implementadas\n\n#### 1. Cache Inteligente\n\n```typescript\n// Cache autom√°tico com TTL\nconst stats = tenantCrypto.getCacheStats();\nconsole.log(`Hit rate: ${stats.hitRate}%`);\n\n// Limpeza manual se necess√°rio\ntenantCrypto.clearCache(tenantId, 'pii');\n```\n\n#### 2. √çndices para Busca\n\n```sql\n-- √çndice para busca em dados criptografados\nCREATE INDEX idx_profiles_name_hash \nON profiles USING btree (digest(full_name_encrypted, 'sha256'))\nWHERE full_name_encrypted IS NOT NULL;\n```\n\n#### 3. Busca em Dados Criptografados\n\n```sql\n-- Fun√ß√£o para busca\nCREATE OR REPLACE FUNCTION search_encrypted_profiles(\n    p_tenant_id UUID,\n    p_search_term TEXT\n) RETURNS TABLE(...) AS $$\nDECLARE\n    v_encrypted_term TEXT;\nBEGIN\n    v_encrypted_term := encrypt_tenant_data(p_tenant_id, p_search_term, 'pii');\n    \n    RETURN QUERY\n    SELECT * FROM profiles \n    WHERE tenant_id = p_tenant_id \n    AND digest(full_name_encrypted, 'sha256') = digest(v_encrypted_term, 'sha256');\nEND;\n$$ LANGUAGE plpgsql;\n```\n\n### Monitoramento de Performance\n\n```typescript\n// Configurar threshold de performance\ntenantCrypto.setPerformanceThreshold(50); // 50ms\n\n// Monitorar opera√ß√µes lentas\ntenantCrypto.setAuditEnabled(true);\n\n// Obter estat√≠sticas\nconst stats = await tenantCrypto.getCryptoStats(tenantId, 30); // √∫ltimos 30 dias\n```\n\n---\n\n## üõ°Ô∏è Seguran√ßa\n\n### Algoritmos Utilizados\n\n- **Criptografia Sim√©trica**: AES-256-GCM\n- **Deriva√ß√£o de Chaves**: PBKDF2 com SHA-512\n- **Hash**: SHA-256 para √≠ndices\n- **Salt**: 256 bits aleat√≥rios por tenant\n- **Itera√ß√µes**: 100.000 para PBKDF2\n\n### Isolamento por Tenant\n\n```mermaid\ngraph LR\n    T1[Tenant 1] --> K1[Chave 1]\n    T2[Tenant 2] --> K2[Chave 2]\n    T3[Tenant 3] --> K3[Chave 3]\n    \n    K1 --> D1[Dados 1]\n    K2 --> D2[Dados 2]\n    K3 --> D3[Dados 3]\n    \n    K1 -.X.- D2\n    K1 -.X.- D3\n    K2 -.X.- D1\n    K2 -.X.- D3\n    K3 -.X.- D1\n    K3 -.X.- D2\n```\n\n### Rota√ß√£o de Chaves\n\n```typescript\n// Rota√ß√£o manual\nawait tenantCrypto.rotateKey(tenantId, 'pii', 'security_incident');\n\n// Rota√ß√£o autom√°tica (configur√°vel)\n// Padr√£o: 90 dias\n```\n\n### Valida√ß√µes de Seguran√ßa\n\n```typescript\n// Verificar se dados est√£o criptografados\nif (TenantCrypto.isEncrypted(data)) {\n  console.log('Dados est√£o criptografados');\n}\n\n// Estimar tamanho criptografado\nconst estimatedSize = TenantCrypto.estimateEncryptedSize(plaintext);\n```\n\n---\n\n## üìä Monitoramento\n\n### Views de Monitoramento\n\n#### 1. Status das Chaves\n\n```sql\nSELECT * FROM v_tenant_encryption_status\nWHERE key_status = 'ROTATION_NEEDED';\n```\n\n#### 2. Estat√≠sticas de Uso\n\n```sql\nSELECT * FROM v_crypto_usage_stats\nWHERE operation_date >= CURRENT_DATE - INTERVAL '7 days'\nORDER BY operation_count DESC;\n```\n\n### Dashboard de Monitoramento\n\n```typescript\n// Componente React para monitoramento\nimport { tenantCrypto } from '@/utils/tenantCrypto';\n\nfunction CryptoMonitoringDashboard() {\n  const [stats, setStats] = useState(null);\n  const [keyInfo, setKeyInfo] = useState([]);\n  \n  useEffect(() => {\n    async function loadData() {\n      const cryptoStats = await tenantCrypto.getCryptoStats(tenantId);\n      const keys = await tenantCrypto.getTenantKeyInfo(tenantId);\n      \n      setStats(cryptoStats);\n      setKeyInfo(keys);\n    }\n    \n    loadData();\n  }, [tenantId]);\n  \n  return (\n    <div className=\"crypto-dashboard\">\n      <div className=\"stats-grid\">\n        <StatCard title=\"Opera√ß√µes/Dia\" value={stats?.dailyOps} />\n        <StatCard title=\"Taxa de Sucesso\" value={`${stats?.successRate}%`} />\n        <StatCard title=\"Performance M√©dia\" value={`${stats?.avgPerformance}ms`} />\n        <StatCard title=\"Cache Hit Rate\" value={`${stats?.cacheHitRate}%`} />\n      </div>\n      \n      <div className=\"keys-status\">\n        <h3>Status das Chaves</h3>\n        {keyInfo.map(key => (\n          <KeyStatusCard key={key.purpose} keyInfo={key} />\n        ))}\n      </div>\n    </div>\n  );\n}\n```\n\n### Alertas Autom√°ticos\n\n```typescript\n// Configurar alertas\nsetInterval(async () => {\n  const keys = await tenantCrypto.getTenantKeyInfo(tenantId);\n  \n  keys.forEach(key => {\n    if (key.status === 'ROTATION_NEEDED') {\n      console.warn(`üîÑ Chave ${key.purpose} precisa ser rotacionada`);\n      // Enviar notifica√ß√£o\n    }\n    \n    if (key.keyAgeDays > 120) {\n      console.warn(`‚ö†Ô∏è Chave ${key.purpose} muito antiga: ${key.keyAgeDays} dias`);\n    }\n  });\n}, 24 * 60 * 60 * 1000); // Di√°rio\n```\n\n---\n\n## üîß Manuten√ß√£o\n\n### Limpeza Autom√°tica\n\n```sql\n-- Executar diariamente\nSELECT cleanup_expired_key_cache(); -- Limpa cache expirado\nSELECT cleanup_old_audit_logs();    -- Limpa logs antigos (7 anos)\n```\n\n### Backup de Chaves\n\n```sql\n-- Backup seguro das chaves\nSELECT * FROM backup_tenant_keys();\n```\n\n### Migra√ß√£o de Dados\n\n```typescript\n// Migrar dados para nova vers√£o de criptografia\nasync function migrateTenantData(tenantId: string) {\n  // 1. Rotacionar chave\n  await tenantCrypto.rotateKey(tenantId, 'general', 'migration');\n  \n  // 2. Re-criptografar dados existentes\n  const records = await supabase\n    .from('profiles')\n    .select('*')\n    .eq('tenant_id', tenantId);\n  \n  for (const record of records.data) {\n    if (record.full_name_encrypted) {\n      // Descriptografar com chave antiga\n      const decrypted = await decryptWithOldKey(record.full_name_encrypted);\n      \n      // Criptografar com chave nova\n      const encrypted = await encryptPII(tenantId, decrypted);\n      \n      // Atualizar registro\n      await supabase\n        .from('profiles')\n        .update({ full_name_encrypted: encrypted })\n        .eq('id', record.id);\n    }\n  }\n}\n```\n\n### Verifica√ß√£o de Integridade\n\n```typescript\n// Verificar integridade dos dados criptografados\nasync function verifyDataIntegrity(tenantId: string) {\n  const results = {\n    total: 0,\n    valid: 0,\n    invalid: 0,\n    errors: []\n  };\n  \n  const records = await supabase\n    .from('profiles')\n    .select('id, full_name_encrypted')\n    .eq('tenant_id', tenantId)\n    .not('full_name_encrypted', 'is', null);\n  \n  for (const record of records.data) {\n    results.total++;\n    \n    try {\n      await decryptPII(tenantId, record.full_name_encrypted);\n      results.valid++;\n    } catch (error) {\n      results.invalid++;\n      results.errors.push({\n        recordId: record.id,\n        error: error.message\n      });\n    }\n  }\n  \n  return results;\n}\n```\n\n---\n\n## üîç Troubleshooting\n\n### Problemas Comuns\n\n#### 1. Erro: \"Chave criptogr√°fica n√£o encontrada\"\n\n```typescript\n// Verificar se tenant tem chaves\nconst keys = await tenantCrypto.getTenantKeyInfo(tenantId);\nif (keys.length === 0) {\n  // Criar chaves para o tenant\n  await tenantCrypto.createTenantKeys(tenantId);\n}\n```\n\n#### 2. Performance Lenta\n\n```typescript\n// Verificar cache\nconst cacheStats = tenantCrypto.getCacheStats();\nif (cacheStats.hitRate < 80) {\n  console.log('Cache hit rate baixo, considere aumentar TTL');\n}\n\n// Verificar threshold\ntenantCrypto.setPerformanceThreshold(100); // Aumentar para 100ms\n```\n\n#### 3. Dados Corrompidos\n\n```sql\n-- Verificar logs de erro\nSELECT * FROM crypto_audit_log \nWHERE success = false \nAND created_at > NOW() - INTERVAL '24 hours'\nORDER BY created_at DESC;\n```\n\n#### 4. Chave Expirada\n\n```typescript\n// Rotacionar chave manualmente\nawait tenantCrypto.rotateKey(tenantId, 'general', 'manual_fix');\n\n// Limpar cache\ntenantCrypto.clearCache(tenantId);\n```\n\n### Logs de Debug\n\n```typescript\n// Habilitar logs detalhados\ntenantCrypto.setAuditEnabled(true);\n\n// Verificar logs no console\nconsole.log('Opera√ß√µes de criptografia ser√£o logadas');\n```\n\n### Ferramentas de Diagn√≥stico\n\n```bash\n# Executar testes completos\nnode test-encryption.cjs\n\n# Verificar status do sistema\nnode -e \"require('./setup-tenant-encryption.cjs').checkPrerequisites()\"\n```\n\n---\n\n## ‚öñÔ∏è Compliance\n\n### LGPD (Lei Geral de Prote√ß√£o de Dados)\n\n- ‚úÖ **Art. 46**: Medidas de seguran√ßa t√©cnicas implementadas\n- ‚úÖ **Art. 48**: Comunica√ß√£o de incidentes (via auditoria)\n- ‚úÖ **Art. 49**: Transfer√™ncia internacional (dados criptografados)\n- ‚úÖ **Direito ao Esquecimento**: Rota√ß√£o de chaves invalida dados\n\n### GDPR (General Data Protection Regulation)\n\n- ‚úÖ **Art. 25**: Privacy by Design (criptografia nativa)\n- ‚úÖ **Art. 32**: Seguran√ßa do processamento\n- ‚úÖ **Art. 33**: Notifica√ß√£o de viola√ß√µes (auditoria)\n- ‚úÖ **Art. 17**: Direito ao apagamento\n\n### SOX (Sarbanes-Oxley)\n\n- ‚úÖ **Se√ß√£o 302**: Controles internos (auditoria completa)\n- ‚úÖ **Se√ß√£o 404**: Avalia√ß√£o de controles (monitoramento)\n- ‚úÖ **Se√ß√£o 409**: Divulga√ß√£o em tempo real (logs)\n\n### ISO 27001\n\n- ‚úÖ **A.10.1**: Pol√≠tica de criptografia\n- ‚úÖ **A.10.2**: Gerenciamento de chaves\n- ‚úÖ **A.12.3**: Backup de informa√ß√µes\n- ‚úÖ **A.12.4**: Log e monitoramento\n\n### Relat√≥rio de Compliance\n\n```typescript\n// Gerar relat√≥rio de compliance\nasync function generateComplianceReport(tenantId: string) {\n  const report = {\n    tenant: tenantId,\n    generatedAt: new Date().toISOString(),\n    encryption: {\n      algorithm: 'AES-256-GCM',\n      keyDerivation: 'PBKDF2-SHA512',\n      keyRotationDays: 90,\n      activeKeys: await tenantCrypto.getTenantKeyInfo(tenantId)\n    },\n    audit: {\n      retentionDays: 2555, // 7 anos\n      totalEntries: await getAuditLogCount(tenantId),\n      lastRotation: await getLastKeyRotation(tenantId)\n    },\n    compliance: {\n      lgpd: true,\n      gdpr: true,\n      sox: true,\n      iso27001: true\n    }\n  };\n  \n  return report;\n}\n```\n\n---\n\n## üìö Refer√™ncias\n\n### Documenta√ß√£o T√©cnica\n\n- [PostgreSQL pgcrypto](https://www.postgresql.org/docs/current/pgcrypto.html)\n- [NIST Cryptographic Standards](https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines)\n- [OWASP Cryptographic Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html)\n\n### Compliance\n\n- [LGPD - Lei 13.709/2018](http://www.planalto.gov.br/ccivil_03/_ato2015-2018/2018/lei/l13709.htm)\n- [GDPR - Regulation 2016/679](https://gdpr-info.eu/)\n- [SOX - Sarbanes-Oxley Act](https://www.sec.gov/about/laws/soa2002.pdf)\n- [ISO 27001:2013](https://www.iso.org/standard/54534.html)\n\n### Algoritmos\n\n- [AES-256-GCM](https://tools.ietf.org/html/rfc5116)\n- [PBKDF2](https://tools.ietf.org/html/rfc2898)\n- [SHA-256](https://tools.ietf.org/html/rfc6234)\n\n---\n\n## üéâ Conclus√£o\n\nO Sistema de Criptografia por Tenant do GRC Controller oferece:\n\n- **üîí Seguran√ßa M√°xima**: Isolamento criptogr√°fico completo\n- **‚ö° Performance**: Cache inteligente e otimiza√ß√µes\n- **üìä Monitoramento**: Auditoria e m√©tricas completas\n- **‚öñÔ∏è Compliance**: Atende todas as principais regulamenta√ß√µes\n- **üîß Manutenibilidade**: Ferramentas e automa√ß√£o\n\n### Pr√≥ximos Passos\n\n1. **Implementar**: Execute `node setup-tenant-encryption.cjs`\n2. **Testar**: Execute `node test-encryption.cjs`\n3. **Integrar**: Use o middleware TypeScript\n4. **Monitorar**: Configure dashboards e alertas\n5. **Manter**: Implemente rota√ß√£o autom√°tica\n\n**üõ°Ô∏è Seu sistema agora est√° pronto para proteger dados com seguran√ßa de n√≠vel enterprise!**\n\n---\n\n*Documenta√ß√£o gerada em: Janeiro 2025*  \n*Vers√£o: 1.0*  \n*Sistema: GRC Controller Encryption*\n"