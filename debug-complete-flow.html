<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Debug Completo - Fluxo de Cores</title>
    
    <!-- SISTEMA DE DEBUG ULTRA DETALHADO -->
    <script>
      window.colorFlowDebug = [];
      window.debugStart = performance.now();
      
      function logFlow(stage, source, details) {
        const timestamp = Math.round(performance.now() - window.debugStart);
        const entry = {
          timestamp,
          stage,
          source,
          details,
          domState: document.readyState,
          computedPrimary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()
        };
        
        window.colorFlowDebug.push(entry);
        console.log(`üîç [${timestamp}ms] ${stage} ‚Üí ${source}:`, details);
        
        // Destacar mudan√ßas de cor
        if (entry.computedPrimary && window.colorFlowDebug.length > 1) {
          const prev = window.colorFlowDebug[window.colorFlowDebug.length - 2];
          if (prev.computedPrimary !== entry.computedPrimary) {
            console.warn(`üé® COR MUDOU! ${prev.computedPrimary} ‚Üí ${entry.computedPrimary}`);
          }
        }
      }
      
      logFlow('INIT', 'DEBUG_START', { message: 'Debug ultra detalhado iniciado' });
    </script>
    
    <!-- SIMULA√á√ÉO DO INDEX.CSS (cores padr√£o) -->
    <style>
      :root {
        /* Essas s√£o as cores que v√™m do index.css */
        --primary: 233 79% 47% !important; /* AZUL PADR√ÉO */
        --primary-foreground: 210 40% 98%;
        --background: 0 0% 100%;
        --foreground: 225 71% 12%;
        --border: 214 32% 91%;
        --muted: 210 20% 96%;
      }
      
      body {
        font-family: 'Inter', sans-serif;
        background: hsl(var(--background));
        color: hsl(var(--foreground));
        margin: 0;
        padding: 20px;
      }
      
      .debug-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .debug-header {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        padding: 30px;
        text-align: center;
      }
      
      .debug-section {
        padding: 25px;
        border-bottom: 1px solid #e5e7eb;
      }
      
      .debug-section:last-child { border-bottom: none; }
      
      .color-indicator {
        display: inline-block;
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 3px solid #333;
        margin: 10px;
        background: hsl(var(--primary));
        vertical-align: middle;
      }
      
      .debug-log {
        background: #1f2937;
        color: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Monaco', monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        margin: 15px 0;
      }
      
      .timeline {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin: 20px 0;
      }
      
      .timeline-item {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
      }
      
      .timeline-time {
        background: #3b82f6;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        min-width: 80px;
        text-align: center;
      }
      
      .btn {
        background: #dc2626;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 8px;
        font-weight: 600;
      }
      
      .btn:hover { background: #b91c1c; }
    </style>
    
    <script>
      logFlow('CSS_LOADED', 'STYLE_TAG', { 
        message: 'CSS padr√£o carregado com --primary: 233 79% 47%',
        currentPrimary: getComputedStyle(document.documentElement).getPropertyValue('--primary').trim()
      });
    </script>
    
    <!-- SIMULA√á√ÉO DO SCRIPT DIN√ÇMICO -->
    <script>
      logFlow('DYNAMIC_SCRIPT_START', 'INDEX_HTML', { message: 'Iniciando script din√¢mico' });
      
      (function() {
        // PASSO 1: Verificar localStorage
        const savedTheme = localStorage.getItem('grc-theme-preferences');
        logFlow('CHECK_LOCALSTORAGE', 'SCRIPT', {
          found: !!savedTheme,
          value: savedTheme ? 'exists' : 'null'
        });
        
        // PASSO 2: Definir cores padr√£o
        let themeColors = {
          primary: '233 79% 47%', // AZUL PADR√ÉO
          primaryForeground: '210 40% 98%',
          background: '0 0% 100%',
          foreground: '225 71% 12%'
        };
        
        logFlow('DEFAULT_COLORS_SET', 'SCRIPT', {
          defaultPrimary: themeColors.primary,
          message: 'Cores padr√£o definidas no script'
        });
        
        // PASSO 3: Aplicar cores via CSS
        const style = document.createElement('style');
        style.id = 'dynamic-theme';
        style.textContent = `
          :root {
            --primary: ${themeColors.primary} !important;
            --primary-foreground: ${themeColors.primaryForeground} !important;
            --background: ${themeColors.background} !important;
            --foreground: ${themeColors.foreground} !important;
          }
        `;
        document.head.appendChild(style);
        
        logFlow('CSS_APPLIED', 'SCRIPT', {
          appliedPrimary: themeColors.primary,
          method: 'createElement + appendChild',
          hasImportant: true
        });
        
        // PASSO 4: Verificar resultado
        setTimeout(() => {
          const result = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
          logFlow('CSS_VERIFICATION', 'SCRIPT', {
            expected: themeColors.primary,
            actual: result,
            success: result === themeColors.primary
          });
        }, 10);
        
      })();
    </script>
</head>

<body>
    <script>
      logFlow('BODY_START', 'HTML', { message: 'Body come√ßou a carregar' });
    </script>
    
    <div class="debug-container">
        <div class="debug-header">
            <h1>üîç Debug Completo - Fluxo de Cores</h1>
            <p>An√°lise detalhada de onde vem o azul padr√£o</p>
            <div class="color-indicator" title="Cor atual: hsl(var(--primary))"></div>
            <div id="current-color">Carregando cor...</div>
        </div>

        <div class="debug-section">
            <h2>üéØ Problema Identificado</h2>
            <p><strong>Causa raiz:</strong> O script din√¢mico est√° aplicando cores padr√£o azuis, mesmo quando deveria buscar o tema ativo do banco.</p>
            
            <div style="background: #fef2f2; padding: 20px; border-radius: 8px; border: 1px solid #fecaca;">
                <h3>‚ùå Fluxo Atual (Problem√°tico):</h3>
                <div class="timeline">
                    <div class="timeline-item">
                        <div class="timeline-time">0ms</div>
                        <div>Script din√¢mico aplica azul padr√£o (233 79% 47%)</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">100ms</div>
                        <div>CSS do index.css carrega (tamb√©m azul)</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">1500ms</div>
                        <div>React carrega ‚Üí ThemeContext busca tema global</div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-time">2000ms</div>
                        <div>Tema global aplicado (173 88% 58% - verde)</div>
                    </div>
                </div>
                <p><strong>Resultado:</strong> Flash azul ‚Üí verde üòû</p>
            </div>
        </div>

        <div class="debug-section">
            <h2>‚úÖ Solu√ß√£o Proposta</h2>
            <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 1px solid #bbf7d0;">
                <h3>Op√ß√£o 1: Script Din√¢mico com Fetch</h3>
                <p>Modificar o script no index.html para buscar o tema ativo do banco ANTES de aplicar CSS.</p>
                
                <h3>Op√ß√£o 2: Endpoint de Tema P√∫blico</h3>
                <p>Criar endpoint p√∫blico que retorna a cor do tema ativo sem autentica√ß√£o.</p>
                
                <h3>Op√ß√£o 3: Cache de Tema</h3>
                <p>Salvar a cor do tema ativo no localStorage quando aplicado, usar como fallback.</p>
            </div>
        </div>

        <div class="debug-section">
            <h2>üìä Log Detalhado</h2>
            <div id="debug-log" class="debug-log">
                Carregando logs...
            </div>
            <button class="btn" onclick="updateDebugLog()">üîÑ Atualizar Logs</button>
            <button class="btn" onclick="exportDebugLog()">üíæ Exportar</button>
            <button class="btn" onclick="simulateThemeApplication()">üé® Simular Aplica√ß√£o de Tema</button>
        </div>

        <div class="debug-section">
            <h2>üîß Testes Interativos</h2>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <button class="btn" onclick="testCSSOthersideride()">üîÑ Testar Sobrescrita CSS</button>
                <button class="btn" onclick="testDirectStyleProperty()">‚ö° Testar setProperty Direto</button>
                <button class="btn" onclick="testImportantForce()">üí™ Testar !important Force</button>
                <button class="btn" onclick="openRealApp()">üöÄ Abrir App Real</button>
            </div>
        </div>

        <div class="debug-section">
            <h2>üìà An√°lise de Performance</h2>
            <div id="performance-analysis">
                <p>Total de mudan√ßas de cor: <span id="color-changes">0</span></p>
                <p>Tempo at√© estabiliza√ß√£o: <span id="stabilization-time">Calculando...</span></p>
                <p>Fonte final da cor: <span id="final-source">Analisando...</span></p>
            </div>
        </div>
    </div>

    <script>
      logFlow('BODY_END', 'HTML', { message: 'Body carregado completamente' });
      
      function updateDebugLog() {
        const logDiv = document.getElementById('debug-log');
        const colorDiv = document.getElementById('current-color');
        
        const currentColor = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
        colorDiv.textContent = `Cor atual: ${currentColor}`;
        
        logDiv.innerHTML = window.colorFlowDebug.map(entry => 
          `<div style="margin: 5px 0; padding: 8px; background: rgba(59, 130, 246, 0.1); border-radius: 4px;">
            <strong>[${entry.timestamp}ms]</strong> ${entry.stage} ‚Üí ${entry.source}<br>
            <small>Computed: ${entry.computedPrimary}</small><br>
            <small>${JSON.stringify(entry.details, null, 2).substring(0, 200)}...</small>
          </div>`
        ).join('');
        
        // Atualizar an√°lise
        const colorChanges = window.colorFlowDebug.filter((entry, index) => {
          if (index === 0) return false;
          return entry.computedPrimary !== window.colorFlowDebug[index - 1].computedPrimary;
        }).length;
        
        document.getElementById('color-changes').textContent = colorChanges;
        
        const lastEntry = window.colorFlowDebug[window.colorFlowDebug.length - 1];
        document.getElementById('stabilization-time').textContent = `${lastEntry.timestamp}ms`;
        document.getElementById('final-source').textContent = lastEntry.source;
      }
      
      function exportDebugLog() {
        const blob = new Blob([JSON.stringify(window.colorFlowDebug, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `color-flow-debug-${Date.now()}.json`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      function simulateThemeApplication() {
        logFlow('MANUAL_THEME_TEST', 'USER_ACTION', { message: 'Simulando aplica√ß√£o manual de tema verde' });
        
        // Simular aplica√ß√£o do tema ui_nativa
        document.documentElement.style.setProperty('--primary', '173 88% 58%', 'important');
        
        setTimeout(() => {
          logFlow('MANUAL_THEME_APPLIED', 'USER_ACTION', {
            appliedColor: '173 88% 58%',
            method: 'setProperty with important'
          });
          updateDebugLog();
        }, 10);
      }
      
      function testCSSOverride() {
        logFlow('TEST_CSS_OVERRIDE', 'USER_TEST', { message: 'Testando sobrescrita via CSS' });
        
        const style = document.createElement('style');
        style.textContent = ':root { --primary: 142 71% 45% !important; }';
        document.head.appendChild(style);
        
        setTimeout(() => {
          logFlow('CSS_OVERRIDE_RESULT', 'USER_TEST', {
            method: 'createElement style'
          });
          updateDebugLog();
        }, 10);
      }
      
      function testDirectStyleProperty() {
        logFlow('TEST_DIRECT_PROPERTY', 'USER_TEST', { message: 'Testando setProperty direto' });
        
        document.documentElement.style.setProperty('--primary', '258 90% 66%', 'important');
        
        setTimeout(() => {
          logFlow('DIRECT_PROPERTY_RESULT', 'USER_TEST', {
            method: 'setProperty direct'
          });
          updateDebugLog();
        }, 10);
      }
      
      function testImportantForce() {
        logFlow('TEST_IMPORTANT_FORCE', 'USER_TEST', { message: 'Testando for√ßa m√°xima' });
        
        // M√∫ltiplas tentativas de for√ßa
        document.documentElement.style.setProperty('--primary', '38 92% 50%', 'important');
        document.documentElement.style.cssText += '--primary: 38 92% 50% !important;';
        
        const style = document.createElement('style');
        style.textContent = ':root { --primary: 38 92% 50% !important; }';
        style.setAttribute('data-priority', 'maximum');
        document.head.appendChild(style);
        
        setTimeout(() => {
          logFlow('IMPORTANT_FORCE_RESULT', 'USER_TEST', {
            method: 'multiple force attempts'
          });
          updateDebugLog();
        }, 10);
      }
      
      function openRealApp() {
        window.open('http://localhost:8080', '_blank');
      }
      
      // Auto-update logs
      setInterval(updateDebugLog, 1000);
      setTimeout(updateDebugLog, 100);
      
      // Log final do setup
      logFlow('DEBUG_SETUP_COMPLETE', 'SYSTEM', {
        totalLoggers: window.colorFlowDebug.length,
        message: 'Sistema de debug completo ativo'
      });
    </script>
</body>
</html>