import React, { useState, useCallback } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Progress } from '@/components/ui/progress';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Upload, 
  FileText, 
  Download, 
  CheckCircle, 
  AlertTriangle, 
  X,
  Eye,
  Settings,
  Play,
  Pause,
  RotateCcw,
  ArrowRight,
  FileSpreadsheet,
  Code,
  Globe,
  Shield,
  Bug,
  Server,
  Cloud,
  Users,
  Target
} from 'lucide-react';
import { useDropzone } from 'react-dropzone';
import { toast } from 'sonner';
import { useAuth } from '@/contexts/AuthContextOptimized';
import { useCurrentTenantId } from '@/contexts/TenantSelectorContext';

interface ImportPreview {
  fileName: string;
  fileType: string;
  totalRecords: number;
  validRecords: number;
  invalidRecords: number;
  preview: any[];
  mapping: { [key: string]: string };
  errors: string[];
}

interface ImportJob {
  id: string;
  fileName: string;
  status: 'pending' | 'processing' | 'completed' | 'failed';
  progress: number;
  totalRecords: number;
  processedRecords: number;
  successfulImports: number;
  failedImports: number;
  errors: string[];
  startTime: Date;
  endTime?: Date;
}

const SUPPORTED_TOOLS = [
  { value: 'nessus', label: 'Nessus', icon: Shield },
  { value: 'openvas', label: 'OpenVAS', icon: Shield },
  { value: 'qualys', label: 'Qualys VMDR', icon: Shield },
  { value: 'rapid7', label: 'Rapid7 Nexpose', icon: Shield },
  { value: 'burp', label: 'Burp Suite', icon: Bug },
  { value: 'owasp_zap', label: 'OWASP ZAP', icon: Bug },
  { value: 'sonarqube', label: 'SonarQube', icon: Code },
  { value: 'checkmarx', label: 'Checkmarx', icon: Code },
  { value: 'veracode', label: 'Veracode', icon: Code },
  { value: 'aws_inspector', label: 'AWS Inspector', icon: Cloud },
  { value: 'azure_defender', label: 'Azure Defender', icon: Cloud },
  { value: 'gcp_security', label: 'GCP Security Command Center', icon: Cloud },
  { value: 'custom', label: 'Formato Customizado', icon: FileText },
];

const DEFAULT_FIELD_MAPPING = {
  title: 'Title',
  description: 'Description',
  severity: 'Severity',
  cvss_score: 'CVSS Score',
  cve_id: 'CVE ID',
  asset_name: 'Asset Name',
  asset_ip: 'Asset IP',
  source_tool: 'Source Tool',
};

export default function VulnerabilityImport() {
  const { user } = useAuth();
  const effectiveTenantId = useCurrentTenantId();
  
  const [selectedTool, setSelectedTool] = useState('');
  const [importMethod, setImportMethod] = useState<'file' | 'api'>('file');
  const [preview, setPreview] = useState<ImportPreview | null>(null);
  const [importJobs, setImportJobs] = useState<ImportJob[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [fieldMapping, setFieldMapping] = useState(DEFAULT_FIELD_MAPPING);
  
  // API Configuration
  const [apiConfig, setApiConfig] = useState({
    url: '',
    apiKey: '',
    username: '',
    password: '',
    additionalParams: ''
  });

  const onDrop = useCallback((acceptedFiles: File[]) => {
    const file = acceptedFiles[0];
    if (!file) return;

    // Validate file type
    const allowedTypes = ['.csv', '.xml', '.json', '.txt'];
    const fileExtension = '.' + file.name.split('.').pop()?.toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
      toast.error('Tipo de arquivo não suportado. Use CSV, XML, JSON ou TXT.');
      return;
    }

    // Read and preview file
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const content = e.target?.result as string;
        const previewData = parseFileContent(content, fileExtension, file.name);
        setPreview(previewData);
      } catch (error) {
        toast.error('Erro ao processar arquivo: ' + (error as Error).message);
      }
    };
    reader.readAsText(file);
  }, []);

  const { getRootProps, getInputProps, isDragActive } = useDropzone({
    onDrop,
    accept: {
      'text/csv': ['.csv'],
      'application/xml': ['.xml'],
      'text/xml': ['.xml'],
      'application/json': ['.json'],
      'text/plain': ['.txt']
    },
    maxFiles: 1
  });

  const parseFileContent = (content: string, fileType: string, fileName: string): ImportPreview => {
    let data: any[] = [];
    let errors: string[] = [];

    try {
      switch (fileType) {
        case '.csv':
          data = parseCSV(content);
          break;
        case '.xml':
          data = parseXML(content);
          break;
        case '.json':
          data = JSON.parse(content);
          if (!Array.isArray(data)) {
            data = [data];
          }
          break;
        case '.txt':
          data = parseTXT(content);
          break;
        default:
          throw new Error('Formato de arquivo não suportado');
      }
    } catch (error) {
      errors.push('Erro ao analisar arquivo: ' + (error as Error).message);
    }

    // Validate records
    const validRecords = data.filter(record => validateRecord(record));
    const invalidRecords = data.length - validRecords.length;

    return {
      fileName,
      fileType,
      totalRecords: data.length,
      validRecords: validRecords.length,
      invalidRecords,
      preview: data.slice(0, 10), // Show first 10 records
      mapping: fieldMapping,
      errors
    };
  };

  const parseCSV = (content: string): any[] => {
    const lines = content.split('\n').filter(line => line.trim());
    if (lines.length < 2) throw new Error('Arquivo CSV deve ter pelo menos um cabeçalho e uma linha de dados');
    
    const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
      const values = lines[i].split(',').map(v => v.trim().replace(/"/g, ''));
      const record: any = {};
      headers.forEach((header, index) => {
        record[header] = values[index] || '';
      });
      data.push(record);
    }
    
    return data;
  };

  const parseXML = (content: string): any[] => {
    // Simplified XML parsing - in production, use a proper XML parser
    const data: any[] = [];
    const vulnerabilityRegex = /<vulnerability[^>]*>(.*?)<\/vulnerability>/gs;
    let match;
    
    while ((match = vulnerabilityRegex.exec(content)) !== null) {
      const vulnContent = match[1];
      const record: any = {};
      
      // Extract common fields
      const titleMatch = vulnContent.match(/<title[^>]*>(.*?)<\/title>/s);
      if (titleMatch) record.title = titleMatch[1].trim();
      
      const severityMatch = vulnContent.match(/<severity[^>]*>(.*?)<\/severity>/s);
      if (severityMatch) record.severity = severityMatch[1].trim();
      
      const descMatch = vulnContent.match(/<description[^>]*>(.*?)<\/description>/s);
      if (descMatch) record.description = descMatch[1].trim();
      
      data.push(record);
    }
    
    return data;
  };

  const parseTXT = (content: string): any[] => {
    // Simple text parsing - assumes each line is a vulnerability title
    const lines = content.split('\n').filter(line => line.trim());
    return lines.map((line, index) => ({
      title: line.trim(),
      description: `Vulnerabilidade importada da linha ${index + 1}`,
      severity: 'Medium',
      source_tool: selectedTool || 'Manual'
    }));
  };

  const validateRecord = (record: any): boolean => {
    // Basic validation - must have title and severity
    return record.title && record.severity;
  };

  const handleImport = async () => {
    if (!preview || !effectiveTenantId || !user) {
      toast.error('Dados insuficientes para importação');
      return;
    }

    setIsProcessing(true);
    
    const jobId = Date.now().toString();
    const newJob: ImportJob = {
      id: jobId,
      fileName: preview.fileName,
      status: 'processing',
      progress: 0,
      totalRecords: preview.validRecords,
      processedRecords: 0,
      successfulImports: 0,
      failedImports: 0,
      errors: [],
      startTime: new Date()
    };

    setImportJobs(prev => [newJob, ...prev]);

    try {
      // Simulate import process
      for (let i = 0; i < preview.validRecords; i++) {
        // Simulate processing time
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const progress = Math.round(((i + 1) / preview.validRecords) * 100);
        
        setImportJobs(prev => prev.map(job => 
          job.id === jobId 
            ? { 
                ...job, 
                progress, 
                processedRecords: i + 1,
                successfulImports: i + 1 // Simulate all successful for demo
              }
            : job
        ));
      }

      // Complete the job
      setImportJobs(prev => prev.map(job => 
        job.id === jobId 
          ? { 
              ...job, 
              status: 'completed',
              endTime: new Date()
            }
          : job
      ));

      toast.success(`Importação concluída: ${preview.validRecords} vulnerabilidades importadas`);
      setPreview(null);
      
    } catch (error) {
      setImportJobs(prev => prev.map(job => 
        job.id === jobId 
          ? { 
              ...job, 
              status: 'failed',
              errors: [(error as Error).message],
              endTime: new Date()
            }
          : job
      ));
      toast.error('Erro na importação: ' + (error as Error).message);
    } finally {
      setIsProcessing(false);
    }
  };

  const handleApiImport = async () => {
    if (!apiConfig.url || !selectedTool) {
      toast.error('Configure a URL da API e selecione a ferramenta');
      return;
    }

    setIsProcessing(true);
    
    try {
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 2000));
      toast.success('Importação via API iniciada');
    } catch (error) {
      toast.error('Erro na importação via API: ' + (error as Error).message);
    } finally {
      setIsProcessing(false);
    }
  };

  const getToolIcon = (toolValue: string) => {
    const tool = SUPPORTED_TOOLS.find(t => t.value === toolValue);
    const IconComponent = tool?.icon || FileText;
    return <IconComponent className="h-4 w-4" />;
  };

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'bg-green-100 text-green-800';
      case 'failed': return 'bg-red-100 text-red-800';
      case 'processing': return 'bg-blue-100 text-blue-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Upload className="h-8 w-8 text-primary" />
            Importação de Vulnerabilidades
          </h1>
          <p className="text-muted-foreground">
            Importe vulnerabilidades de ferramentas de segurança e arquivos
          </p>
        </div>
      </div>

      <Tabs value={importMethod} onValueChange={(value) => setImportMethod(value as 'file' | 'api')}>
        <TabsList className="grid w-full grid-cols-2">
          <TabsTrigger value="file">Importação por Arquivo</TabsTrigger>
          <TabsTrigger value="api">Importação via API</TabsTrigger>
        </TabsList>

        <TabsContent value="file" className="space-y-6">
          {/* Tool Selection */}
          <Card>
            <CardHeader>
              <CardTitle>Selecionar Ferramenta</CardTitle>
              <CardDescription>
                Escolha a ferramenta de origem para otimizar o processamento
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                {SUPPORTED_TOOLS.map((tool) => (
                  <Card 
                    key={tool.value}
                    className={`cursor-pointer transition-colors hover:bg-muted/50 ${
                      selectedTool === tool.value ? 'ring-2 ring-primary' : ''
                    }`}
                    onClick={() => setSelectedTool(tool.value)}
                  >
                    <CardContent className="p-4 text-center">
                      <tool.icon className="h-8 w-8 mx-auto mb-2 text-muted-foreground" />
                      <p className="text-sm font-medium">{tool.label}</p>
                    </CardContent>
                  </Card>
                ))}
              </div>
            </CardContent>
          </Card>

          {/* File Upload */}
          <Card>
            <CardHeader>
              <CardTitle>Upload de Arquivo</CardTitle>
              <CardDescription>
                Arraste e solte ou clique para selecionar arquivos CSV, XML, JSON ou TXT
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div
                {...getRootProps()}
                className={`border-2 border-dashed rounded-lg p-8 text-center cursor-pointer transition-colors ${
                  isDragActive 
                    ? 'border-primary bg-primary/5' 
                    : 'border-muted-foreground/25 hover:border-primary/50'
                }`}
              >
                <input {...getInputProps()} />
                <Upload className="h-12 w-12 mx-auto mb-4 text-muted-foreground" />
                {isDragActive ? (
                  <p className="text-lg font-medium">Solte o arquivo aqui...</p>
                ) : (
                  <div>
                    <p className="text-lg font-medium mb-2">
                      Arraste um arquivo aqui ou clique para selecionar
                    </p>
                    <p className="text-sm text-muted-foreground">
                      Suporta CSV, XML, JSON e TXT (máx. 50MB)
                    </p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Preview */}
          {preview && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <span>Preview da Importação</span>
                  <Button variant="outline" size="sm" onClick={() => setPreview(null)}>
                    <X className="h-4 w-4" />
                  </Button>
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                {/* Summary */}
                <div className="grid grid-cols-3 gap-4">
                  <div className="text-center">
                    <p className="text-2xl font-bold">{preview.totalRecords}</p>
                    <p className="text-sm text-muted-foreground">Total de Registros</p>
                  </div>
                  <div className="text-center">
                    <p className="text-2xl font-bold text-green-600">{preview.validRecords}</p>
                    <p className="text-sm text-muted-foreground">Registros Válidos</p>
                  </div>
                  <div className="text-center">
                    <p className="text-2xl font-bold text-red-600">{preview.invalidRecords}</p>
                    <p className="text-sm text-muted-foreground">Registros Inválidos</p>
                  </div>
                </div>

                {/* Errors */}
                {preview.errors.length > 0 && (
                  <Alert>
                    <AlertTriangle className="h-4 w-4" />
                    <AlertDescription>
                      <div className="space-y-1">
                        <p className="font-medium">Erros encontrados:</p>
                        {preview.errors.map((error, index) => (
                          <p key={index} className="text-sm">• {error}</p>
                        ))}
                      </div>
                    </AlertDescription>
                  </Alert>
                )}

                {/* Field Mapping */}
                <div>
                  <h4 className="font-medium mb-3">Mapeamento de Campos</h4>
                  <div className="grid grid-cols-2 gap-4">
                    {Object.entries(fieldMapping).map(([targetField, sourceField]) => (
                      <div key={targetField} className="space-y-2">
                        <Label>{targetField.replace('_', ' ').toUpperCase()}</Label>
                        <Select 
                          value={sourceField} 
                          onValueChange={(value) => 
                            setFieldMapping(prev => ({ ...prev, [targetField]: value }))
                          }
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            {preview.preview.length > 0 && 
                              Object.keys(preview.preview[0]).map(field => (
                                <SelectItem key={field} value={field}>{field}</SelectItem>
                              ))
                            }
                          </SelectContent>
                        </Select>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Preview Table */}
                <div>
                  <h4 className="font-medium mb-3">Preview dos Dados</h4>
                  <div className="border rounded-lg overflow-hidden">
                    <Table>
                      <TableHeader>
                        <TableRow>
                          {preview.preview.length > 0 && 
                            Object.keys(preview.preview[0]).map(field => (
                              <TableHead key={field}>{field}</TableHead>
                            ))
                          }
                        </TableRow>
                      </TableHeader>
                      <TableBody>
                        {preview.preview.slice(0, 5).map((record, index) => (
                          <TableRow key={index}>
                            {Object.values(record).map((value: any, cellIndex) => (
                              <TableCell key={cellIndex} className="max-w-xs truncate">
                                {String(value)}
                              </TableCell>
                            ))}
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  </div>
                </div>

                {/* Import Button */}
                <div className="flex justify-end">
                  <Button 
                    onClick={handleImport} 
                    disabled={isProcessing || preview.validRecords === 0}
                    className="min-w-32"
                  >
                    {isProcessing ? (
                      <>
                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                        Importando...
                      </>
                    ) : (
                      <>
                        <Play className="h-4 w-4 mr-2" />
                        Importar {preview.validRecords} Vulnerabilidades
                      </>
                    )}
                  </Button>
                </div>
              </CardContent>
            </Card>
          )}
        </TabsContent>

        <TabsContent value="api" className="space-y-6">
          {/* API Configuration */}
          <Card>
            <CardHeader>
              <CardTitle>Configuração da API</CardTitle>
              <CardDescription>
                Configure a conexão com a API da ferramenta de segurança
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Ferramenta</Label>
                  <Select value={selectedTool} onValueChange={setSelectedTool}>
                    <SelectTrigger>
                      <SelectValue placeholder="Selecione a ferramenta" />
                    </SelectTrigger>
                    <SelectContent>
                      {SUPPORTED_TOOLS.filter(tool => tool.value !== 'custom').map(tool => (
                        <SelectItem key={tool.value} value={tool.value}>
                          <div className="flex items-center gap-2">
                            <tool.icon className="h-4 w-4" />
                            {tool.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>URL da API</Label>
                  <Input 
                    placeholder="https://api.exemplo.com/vulnerabilities"
                    value={apiConfig.url}
                    onChange={(e) => setApiConfig(prev => ({ ...prev, url: e.target.value }))}
                  />
                </div>

                <div className="space-y-2">
                  <Label>API Key</Label>
                  <Input 
                    type="password"
                    placeholder="Sua chave de API"
                    value={apiConfig.apiKey}
                    onChange={(e) => setApiConfig(prev => ({ ...prev, apiKey: e.target.value }))}
                  />
                </div>

                <div className="space-y-2">
                  <Label>Usuário (opcional)</Label>
                  <Input 
                    placeholder="Nome de usuário"
                    value={apiConfig.username}
                    onChange={(e) => setApiConfig(prev => ({ ...prev, username: e.target.value }))}
                  />
                </div>

                <div className="space-y-2 md:col-span-2">
                  <Label>Parâmetros Adicionais</Label>
                  <Textarea 
                    placeholder="Parâmetros adicionais em formato JSON"
                    value={apiConfig.additionalParams}
                    onChange={(e) => setApiConfig(prev => ({ ...prev, additionalParams: e.target.value }))}
                  />
                </div>
              </div>

              <div className="flex justify-end">
                <Button onClick={handleApiImport} disabled={isProcessing}>
                  {isProcessing ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      Conectando...
                    </>
                  ) : (
                    <>
                      <Globe className="h-4 w-4 mr-2" />
                      Importar via API
                    </>
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Import Jobs */}
      {importJobs.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Histórico de Importações</CardTitle>
            <CardDescription>
              Acompanhe o progresso das importações
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {importJobs.map((job) => (
                <div key={job.id} className="border rounded-lg p-4">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <FileText className="h-4 w-4" />
                      <span className="font-medium">{job.fileName}</span>
                      <Badge className={getStatusColor(job.status)}>
                        {job.status}
                      </Badge>
                    </div>
                    <span className="text-sm text-muted-foreground">
                      {job.startTime.toLocaleString()}
                    </span>
                  </div>
                  
                  {job.status === 'processing' && (
                    <div className="space-y-2">
                      <Progress value={job.progress} className="h-2" />
                      <p className="text-sm text-muted-foreground">
                        {job.processedRecords} de {job.totalRecords} registros processados
                      </p>
                    </div>
                  )}
                  
                  {job.status === 'completed' && (
                    <div className="flex items-center gap-4 text-sm">
                      <span className="text-green-600">
                        ✓ {job.successfulImports} importados
                      </span>
                      {job.failedImports > 0 && (
                        <span className="text-red-600">
                          ✗ {job.failedImports} falharam
                        </span>
                      )}
                      <span className="text-muted-foreground">
                        Concluído em {job.endTime?.toLocaleString()}
                      </span>
                    </div>
                  )}
                  
                  {job.status === 'failed' && (
                    <Alert>
                      <AlertTriangle className="h-4 w-4" />
                      <AlertDescription>
                        {job.errors.join(', ')}
                      </AlertDescription>
                    </Alert>
                  )}
                </div>
              ))}
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}