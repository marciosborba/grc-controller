import React from 'react';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Progress } from '@/components/ui/progress';
import {
  Shield,
  AlertTriangle,
  CheckCircle,
  TrendingUp,
  TrendingDown,
  Target,
  Server,
  Layers,
  ArrowRight,
  Zap,
  Activity,
  Box,
  LayoutGrid,
  Globe,
  List
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { useVulnerabilities } from './hooks/useVulnerabilities';

export default function VulnerabilityDashboard() {
  const navigate = useNavigate();

  // Load real data
  const { metrics, loading } = useVulnerabilities({
    limit: 5,
    sortBy: 'created_at',
    sortOrder: 'desc'
  });

  // Safe metrics access
  const totalVulns = metrics?.total_vulnerabilities || 0;
  const criticalVulns = metrics?.critical_open || 0;
  const highVulns = metrics?.high_open || 0;
  const appsCount = 24; // Placeholder or need a new hook for count
  const assetsCount = 156; // Placeholder or need a new hook for count

  // Dynamic Storytelling Logic
  const getRiskNarrative = () => {
    if (loading) return { title: "Analisando segurança...", desc: "Obtendo dados em tempo real.", color: "text-muted-foreground", bg: "bg-muted" };
    if (criticalVulns > 0) return {
      title: "Risco Crítico Detectado",
      desc: `${criticalVulns} vulnerabilidades críticas requerem atenção imediata.`,
      color: "text-red-500",
      bg: "bg-red-500/10",
      icon: AlertTriangle
    };
    if (highVulns > 5) return {
      title: "Elevado Número de Riscos",
      desc: "Acúmulo de vulnerabilidades de alta severidade.",
      color: "text-orange-500",
      bg: "bg-orange-500/10",
      icon: Zap
    };
    return {
      title: "Ambiente Estável",
      desc: "Nenhuma vulnerabilidade crítica pendente.",
      color: "text-green-500",
      bg: "bg-green-500/10",
      icon: CheckCircle
    };
  };

  const narrative = getRiskNarrative();
  const NarrativeIcon = narrative.icon || Activity;

  return (
    <div className="space-y-8 p-1">
      {/* Premium Header */}
      <div className="flex flex-col md:flex-row justify-between items-start md:items-end gap-4">
        <div>
          <h1 className="text-4xl font-extrabold tracking-tight flex items-center gap-3 text-primary">
            <Shield className="h-10 w-10" />
            Vulnerability Center
          </h1>
          <p className="text-lg text-muted-foreground mt-2 max-w-2xl">
            Visão unificada da postura de segurança, riscos e superfície de ataque.
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => navigate('/vulnerabilities/list')}>
            Ver Lista Completa
          </Button>
          <Button onClick={() => navigate('/vulnerabilities/create')} className="bg-primary hover:bg-primary/90 text-white shadow-lg shadow-primary/20">
            Nova Análise
          </Button>
        </div>
      </div>

      {/* Storytelling Cards Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">

        {/* Card 1: Risk Narrative (Dynamic) */}
        <Card className="relative overflow-hidden border-l-4 border-l-primary shadow-sm hover:shadow-md transition-all">
          <div className={`absolute top-0 right-0 p-3 opacity-10`}>
            <NarrativeIcon className="h-24 w-24" />
          </div>
          <CardHeader className="pb-2">
            <CardTitle className={`text-lg font-bold flex items-center gap-2 ${narrative.color}`}>
              {narrative.title}
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground font-medium text-sm leading-relaxed">
              {narrative.desc}
            </p>
            <div className={`mt-4 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${narrative.bg} ${narrative.color}`}>
              Status Atual
            </div>
          </CardContent>
        </Card>

        {/* Card 2: Impact Analysis */}
        <Card className="relative overflow-hidden shadow-sm hover:shadow-md transition-all group cursor-pointer" onClick={() => navigate('/vulnerabilities/applications')}>
          <div className="absolute top-0 right-0 p-3 opacity-5 group-hover:opacity-10 transition-opacity">
            <Layers className="h-24 w-24 text-blue-500" />
          </div>
          <CardHeader className="pb-2">
            <CardTitle className="text-lg font-bold text-foreground">
              Aplicações em Risco
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-baseline gap-2">
              <span className="text-3xl font-bold text-foreground">{appsCount}</span>
              <span className="text-sm text-muted-foreground">Monitoradas</span>
            </div>
            <p className="text-sm text-muted-foreground mt-2">
              3 aplicações possuem vulnerabilidades críticas pendentes de correção.
            </p>
            <div className="mt-4 w-full bg-secondary h-1.5 rounded-full overflow-hidden">
              <div className="bg-blue-500 h-full rounded-full" style={{ width: '85%' }}></div>
            </div>
          </CardContent>
        </Card>

        {/* Card 3: Asset Attack Surface */}
        <Card className="relative overflow-hidden shadow-sm hover:shadow-md transition-all group cursor-pointer" onClick={() => navigate('/vulnerabilities/cmdb')}>
          <div className="absolute top-0 right-0 p-3 opacity-5 group-hover:opacity-10 transition-opacity">
            <Server className="h-24 w-24 text-purple-500" />
          </div>
          <CardHeader className="pb-2">
            <CardTitle className="text-lg font-bold text-foreground">
              Superfície de Ataque
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="flex items-baseline gap-2">
              <span className="text-3xl font-bold text-foreground">{assetsCount}</span>
              <span className="text-sm text-muted-foreground">Ativos</span>
            </div>
            <p className="text-sm text-muted-foreground mt-2">
              98% dos ativos estão em conformidade com as políticas de hardening.
            </p>
            <div className="mt-4 w-full bg-secondary h-1.5 rounded-full overflow-hidden">
              <div className="bg-purple-500 h-full rounded-full" style={{ width: '98%' }}></div>
            </div>
          </CardContent>
        </Card>

        {/* Card 4: Remediation Focus */}
        <Card className="relative overflow-hidden shadow-sm hover:shadow-md transition-all bg-gradient-to-br from-primary/5 to-transparent border-primary/20">
          <CardHeader className="pb-2">
            <CardTitle className="text-lg font-bold text-foreground flex items-center gap-2">
              Foco Prioritário <Target className="h-4 w-4 text-primary" />
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm font-medium text-foreground">
              Atualizar Apache Struts
            </p>
            <p className="text-xs text-muted-foreground mt-1">
              Afeta o servidor de Pagamentos (APP-API-003). Risco de RCE.
            </p>
            <Button size="sm" variant="secondary" className="mt-4 w-full text-xs h-7">
              Ver Detalhes <ArrowRight className="h-3 w-3 ml-1" />
            </Button>
          </CardContent>
        </Card>
      </div>

      {/* Navigation Cards - Premium Design */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 my-8">
        <Card
          className="relative overflow-hidden group hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-blue-500"
          onClick={() => navigate('/vulnerabilities/list')}
        >
          <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <List className="h-24 w-24 text-blue-500" />
          </div>
          <CardHeader>
            <CardTitle className="flex items-center gap-3 text-xl">
              <div className="p-2 bg-blue-500/10 rounded-lg group-hover:bg-blue-500/20 transition-colors">
                <List className="h-6 w-6 text-blue-600" />
              </div>
              Vulnerabilidades
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground mb-4">
              Gestão completa de vulnerabilidades com filtros avançados, métricas detalhadas e relatórios.
            </p>
            <div className="flex items-center text-sm font-medium text-blue-600 group-hover:translate-x-1 transition-transform">
              Acessar Lista <ArrowRight className="h-4 w-4 ml-1" />
            </div>
          </CardContent>
        </Card>

        <Card
          className="relative overflow-hidden group hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-purple-500"
          onClick={() => navigate('/vulnerabilities/applications')}
        >
          <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <Layers className="h-24 w-24 text-purple-500" />
          </div>
          <CardHeader>
            <CardTitle className="flex items-center gap-3 text-xl">
              <div className="p-2 bg-purple-500/10 rounded-lg group-hover:bg-purple-500/20 transition-colors">
                <Layers className="h-6 w-6 text-purple-600" />
              </div>
              Aplicações
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground mb-4">
              Catálogo de aplicações monitoradas, riscos associados e inventário de softwares.
            </p>
            <div className="flex items-center text-sm font-medium text-purple-600 group-hover:translate-x-1 transition-transform">
              Ver Aplicações <ArrowRight className="h-4 w-4 ml-1" />
            </div>
          </CardContent>
        </Card>

        <Card
          className="relative overflow-hidden group hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-emerald-500"
          onClick={() => navigate('/vulnerabilities/cmdb')}
        >
          <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
            <Server className="h-24 w-24 text-emerald-500" />
          </div>
          <CardHeader>
            <CardTitle className="flex items-center gap-3 text-xl">
              <div className="p-2 bg-emerald-500/10 rounded-lg group-hover:bg-emerald-500/20 transition-colors">
                <Server className="h-6 w-6 text-emerald-600" />
              </div>
              CMDB
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground mb-4">
              Gestão de ativos de infraestrutura, servidores e dependências tecnológicas.
            </p>
            <div className="flex items-center text-sm font-medium text-emerald-600 group-hover:translate-x-1 transition-transform">
              Acessar CMDB <ArrowRight className="h-4 w-4 ml-1" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Reliable Data Totals */}
      <h2 className="text-xl font-semibold tracking-tight mt-8">Métricas Gerais</h2>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">

        <Card>
          <CardContent className="p-6 flex items-center gap-4">
            <div className="p-3 bg-blue-100 dark:bg-blue-900/30 rounded-2xl">
              <Shield className="h-8 w-8 text-blue-600 dark:text-blue-400" />
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">Total de Vulnerabilidades</p>
              <h3 className="text-3xl font-bold text-foreground">{loading ? '...' : totalVulns}</h3>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6 flex items-center gap-4">
            <div className="p-3 bg-green-100 dark:bg-green-900/30 rounded-2xl">
              <Globe className="h-8 w-8 text-green-600 dark:text-green-400" />
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">Aplicações Monitoradas</p>
              <h3 className="text-3xl font-bold text-foreground">{appsCount}</h3>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6 flex items-center gap-4">
            <div className="p-3 bg-purple-100 dark:bg-purple-900/30 rounded-2xl">
              <Box className="h-8 w-8 text-purple-600 dark:text-purple-400" />
            </div>
            <div>
              <p className="text-sm font-medium text-muted-foreground">Ativos Inventariados</p>
              <h3 className="text-3xl font-bold text-foreground">{assetsCount}</h3>
            </div>
          </CardContent>
        </Card>

      </div>

      {/* Actions Grid */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6 pt-4">
        <Button variant="outline" className="h-auto py-4 px-6 justify-start gap-4 hover:border-primary/50 group" onClick={() => navigate('/vulnerabilities/import')}>
          <div className="p-2 bg-secondary rounded-lg group-hover:bg-primary/10 transition-colors">
            <LayoutGrid className="h-6 w-6 text-foreground group-hover:text-primary" />
          </div>
          <div className="text-left">
            <div className="font-semibold text-foreground">Importar Scan</div>
            <div className="text-xs text-muted-foreground">Processar relatórios SAST/DAST</div>
          </div>
        </Button>

        <Button variant="outline" className="h-auto py-4 px-6 justify-start gap-4 hover:border-primary/50 group" onClick={() => navigate('/vulnerabilities/reports')}>
          <div className="p-2 bg-secondary rounded-lg group-hover:bg-primary/10 transition-colors">
            <Activity className="h-6 w-6 text-foreground group-hover:text-primary" />
          </div>
          <div className="text-left">
            <div className="font-semibold text-foreground">Relatórios</div>
            <div className="text-xs text-muted-foreground">Gerar PDFs executivos</div>
          </div>
        </Button>

        <Button variant="outline" className="h-auto py-4 px-6 justify-start gap-4 hover:border-primary/50 group" onClick={() => navigate('/vulnerabilities/classification')}>
          <div className="p-2 bg-secondary rounded-lg group-hover:bg-primary/10 transition-colors">
            <Target className="h-6 w-6 text-foreground group-hover:text-primary" />
          </div>
          <div className="text-left">
            <div className="font-semibold text-foreground">Classificação</div>
            <div className="text-xs text-muted-foreground">Configurar regras de risco</div>
          </div>
        </Button>
      </div>

    </div>
  );
}