// UPDATED: Total de vulnerabilidades cards added
import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { 
  FileText, 
  Download, 
  ArrowLeft,
  RefreshCw,
  Shield,
  AlertTriangle,
  CheckCircle,
  Clock,
  Settings,
  TrendingUp,
  Calendar,
  Users,
  Target,
  Activity
} from 'lucide-react';
import { useVulnerabilities } from './hooks/useVulnerabilities';
import { VulnerabilitySeverity, VulnerabilityStatus, VulnerabilitySource } from './types/vulnerability';
import { toast } from 'sonner';
import { useNavigate } from 'react-router-dom';

interface ReportTemplate {
  id: string;
  name: string;
  description: string;
  type: 'executive' | 'technical' | 'sla';
  icon: React.ComponentType<any>;
  color: string;
  estimatedTime: string;
  audience: string[];
  features: string[];
}

const REPORT_TEMPLATES: ReportTemplate[] = [
  {
    id: 'executive',
    name: 'Relat√≥rio Executivo',
    description: 'Vis√£o estrat√©gica para alta gest√£o com m√©tricas principais e recomenda√ß√µes de neg√≥cio',
    type: 'executive',
    icon: TrendingUp,
    color: 'blue',
    estimatedTime: '2-3 min',
    audience: ['CEO', 'CISO', 'CTO', 'Diretoria'],
    features: ['KPIs principais', 'An√°lise de tend√™ncias', 'Recomenda√ß√µes estrat√©gicas', 'Impacto no neg√≥cio']
  },
  {
    id: 'technical',
    name: 'Relat√≥rio T√©cnico',
    description: 'Detalhes t√©cnicos completos para equipes de seguran√ßa e desenvolvimento',
    type: 'technical',
    icon: Settings,
    color: 'green',
    estimatedTime: '5-7 min',
    audience: ['Analistas de Seguran√ßa', 'DevOps', 'Desenvolvedores'],
    features: ['Lista detalhada de vulnerabilidades', 'CVEs e CWEs', 'Procedimentos de corre√ß√£o', 'Evid√™ncias t√©cnicas']
  },
  {
    id: 'sla',
    name: 'Relat√≥rio de SLA',
    description: 'Performance de SLA, tempos de resposta e m√©tricas operacionais',
    type: 'sla',
    icon: Clock,
    color: 'orange',
    estimatedTime: '2-3 min',
    audience: ['Gerentes de TI', 'Service Desk', 'Opera√ß√µes'],
    features: ['MTTR por severidade', 'SLA compliance', 'Vulnerabilidades em atraso', 'Performance da equipe']
  }
];

export default function VulnerabilityReports() {
  const [isGenerating, setIsGenerating] = useState(false);
  const [selectedPeriod, setSelectedPeriod] = useState('30');
  
  const navigate = useNavigate();
  const { vulnerabilities, metrics, loading, refetch } = useVulnerabilities({
    limit: 1000
  });
  const [isRefreshing, setIsRefreshing] = useState(false);

  useEffect(() => {
    // Load data on component mount
    refetch();
    // TEMPORARY ALERT TO FORCE RELOAD
    console.log('üö® COMPONENT LOADED - TOTAL VULNERABILITIES SHOULD BE VISIBLE!');
  }, []);

  const handleGenerateReport = async (templateId: string) => {
    if (!metrics || !vulnerabilities) {
      toast.error('Dados n√£o dispon√≠veis. Aguarde o carregamento ou verifique se existem vulnerabilidades cadastradas.');
      return;
    }

    setIsGenerating(true);
    
    try {
      toast.loading('Gerando relat√≥rio...', { id: 'report-generation' });
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      const reportContent = generateReportContent(templateId);
      
      const blob = new Blob([reportContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      const newWindow = window.open(url, '_blank');
      if (newWindow) {
        newWindow.document.title = `Relat√≥rio ${getTemplateName(templateId)} - ${new Date().toLocaleDateString('pt-BR')}`;
        
        setTimeout(() => {
          const printButton = newWindow.document.createElement('button');
          printButton.innerHTML = 'üñ®Ô∏è Imprimir/Salvar como PDF';
          printButton.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 12px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            font-family: system-ui;
          `;
          printButton.onclick = () => newWindow.print();
          newWindow.document.body.appendChild(printButton);
        }, 1000);
      }
      
      toast.success(`Relat√≥rio ${getTemplateName(templateId)} gerado com sucesso. Use Ctrl+P para salvar como PDF`, { id: 'report-generation' });
      setTimeout(() => URL.revokeObjectURL(url), 10000);
      
    } catch (error) {
      toast.error('Erro ao gerar relat√≥rio', { id: 'report-generation' });
      console.error('Report generation error:', error);
    } finally {
      setIsGenerating(false);
    }
  };
  
  const getTemplateName = (templateId: string) => {
    const template = REPORT_TEMPLATES.find(t => t.id === templateId);
    return template?.name || 'Relat√≥rio';
  };
  
  // Advanced Analytics Functions for Executive Report
  const calculateBusinessRiskExposure = () => {
    if (!vulnerabilities) return { criticalApps: [], highRiskAssets: [], estimatedImpact: 0 };
    
    // Simulate application criticality data (in real implementation, this would come from applications module)
    const mockApplications = [
      { name: 'Portal do Cliente', criticality: 'Critical', environment: 'Production', internetFacing: true, dataClassification: 'Confidential', lgpd: true },
      { name: 'API Gateway', criticality: 'High', environment: 'Production', internetFacing: true, dataClassification: 'Internal', lgpd: false },
      { name: 'Sistema Interno', criticality: 'Medium', environment: 'Production', internetFacing: false, dataClassification: 'Internal', lgpd: true },
      { name: 'App Mobile', criticality: 'High', environment: 'Production', internetFacing: true, dataClassification: 'Confidential', lgpd: true },
      { name: 'Admin Portal', criticality: 'Critical', environment: 'Production', internetFacing: false, dataClassification: 'Restricted', lgpd: false }
    ];
    
    const criticalApps = mockApplications
      .filter(app => app.criticality === 'Critical')
      .map(app => {
        const appVulns = vulnerabilities.filter(v => v.asset_name.toLowerCase().includes(app.name.toLowerCase()));
        const criticalVulns = appVulns.filter(v => v.severity === 'Critical').length;
        const highVulns = appVulns.filter(v => v.severity === 'High').length;
        const riskScore = (criticalVulns * 10) + (highVulns * 5);
        
        return {
          ...app,
          vulnerabilities: appVulns.length,
          criticalVulns,
          highVulns,
          riskScore,
          estimatedImpact: riskScore * (app.internetFacing ? 2 : 1) * (app.lgpd ? 1.5 : 1)
        };
      })
      .sort((a, b) => b.riskScore - a.riskScore);
    
    return { criticalApps, estimatedImpact: criticalApps.reduce((sum, app) => sum + app.estimatedImpact, 0) };
  };
  
  const analyzeComplianceRisk = () => {
    if (!vulnerabilities) return { lgpdRisk: 0, soxRisk: 0, criticalGaps: [] };
    
    const lgpdApps = ['Portal do Cliente', 'Sistema Interno', 'App Mobile'];
    const soxApps = ['Sistema Financeiro', 'ERP', 'Contabilidade'];
    
    const lgpdVulns = vulnerabilities.filter(v => 
      lgpdApps.some(app => v.asset_name.toLowerCase().includes(app.toLowerCase()))
    );
    const soxVulns = vulnerabilities.filter(v => 
      soxApps.some(app => v.asset_name.toLowerCase().includes(app.toLowerCase()))
    );
    
    const criticalGaps = [
      { framework: 'LGPD', vulnerabilities: lgpdVulns.length, critical: lgpdVulns.filter(v => v.severity === 'Critical').length },
      { framework: 'SOX', vulnerabilities: soxVulns.length, critical: soxVulns.filter(v => v.severity === 'Critical').length }
    ];
    
    return {
      lgpdRisk: lgpdVulns.filter(v => ['Critical', 'High'].includes(v.severity)).length,
      soxRisk: soxVulns.filter(v => ['Critical', 'High'].includes(v.severity)).length,
      criticalGaps
    };
  };
  
  const identifyInternetFacingRisks = () => {
    if (!vulnerabilities) return { exposedApps: [], riskScore: 0 };
    
    const internetFacingAssets = ['Portal', 'API', 'Web', 'Mobile', 'Gateway'];
    const exposedVulns = vulnerabilities.filter(v => 
      internetFacingAssets.some(asset => v.asset_name.toLowerCase().includes(asset.toLowerCase()))
    );
    
    const exposedApps = internetFacingAssets.map(assetType => {
      const assetVulns = exposedVulns.filter(v => v.asset_name.toLowerCase().includes(assetType.toLowerCase()));
      const criticalCount = assetVulns.filter(v => v.severity === 'Critical').length;
      const highCount = assetVulns.filter(v => v.severity === 'High').length;
      
      return {
        name: assetType,
        vulnerabilities: assetVulns.length,
        critical: criticalCount,
        high: highCount,
        riskScore: (criticalCount * 10) + (highCount * 5),
        exploitAvailable: assetVulns.filter(v => v.exploit_available).length
      };
    }).filter(app => app.vulnerabilities > 0).sort((a, b) => b.riskScore - a.riskScore);
    
    return { exposedApps, riskScore: exposedApps.reduce((sum, app) => sum + app.riskScore, 0) };
  };
  
  const analyzeInfrastructureCriticality = () => {
    if (!vulnerabilities) return { criticalInfra: [], riskLevel: 'Low' };
    
    const criticalInfraTypes = ['Server', 'Database', 'Network', 'Gateway', 'Firewall', 'Switch', 'Router'];
    const infraVulns = vulnerabilities.filter(v => 
      criticalInfraTypes.some(type => v.asset_name.toLowerCase().includes(type.toLowerCase()) || v.asset_type === type)
    );
    
    const criticalInfra = criticalInfraTypes.map(infraType => {
      const typeVulns = infraVulns.filter(v => 
        v.asset_name.toLowerCase().includes(infraType.toLowerCase()) || v.asset_type === infraType
      );
      const criticalCount = typeVulns.filter(v => v.severity === 'Critical').length;
      const highCount = typeVulns.filter(v => v.severity === 'High').length;
      
      return {
        type: infraType,
        vulnerabilities: typeVulns.length,
        critical: criticalCount,
        high: highCount,
        riskScore: (criticalCount * 10) + (highCount * 5)
      };
    }).filter(infra => infra.vulnerabilities > 0).sort((a, b) => b.riskScore - a.riskScore);
    
    const totalRiskScore = criticalInfra.reduce((sum, infra) => sum + infra.riskScore, 0);
    const riskLevel = totalRiskScore > 50 ? 'Critical' : totalRiskScore > 25 ? 'High' : totalRiskScore > 10 ? 'Medium' : 'Low';
    
    return { criticalInfra, riskLevel, totalRiskScore };
  };
  
  const calculateFinancialImpact = () => {
    if (!vulnerabilities) return { estimatedLoss: 0, remediationCost: 0, roi: 0 };
    
    // Financial impact calculation based on industry standards
    const criticalVulns = vulnerabilities.filter(v => v.severity === 'Critical');
    const highVulns = vulnerabilities.filter(v => v.severity === 'High');
    const mediumVulns = vulnerabilities.filter(v => v.severity === 'Medium');
    
    // Estimated cost per vulnerability type (in thousands)
    const costPerCritical = 500; // R$ 500k average cost of critical vulnerability incident
    const costPerHigh = 150;     // R$ 150k average cost of high vulnerability incident
    const costPerMedium = 50;    // R$ 50k average cost of medium vulnerability incident
    
    // Probability of exploitation
    const criticalProbability = 0.3; // 30% chance of exploitation for critical
    const highProbability = 0.15;    // 15% chance of exploitation for high
    const mediumProbability = 0.05;  // 5% chance of exploitation for medium
    
    const estimatedLoss = 
      (criticalVulns.length * costPerCritical * criticalProbability) +
      (highVulns.length * costPerHigh * highProbability) +
      (mediumVulns.length * costPerMedium * mediumProbability);
    
    // Remediation costs (much lower than incident costs)
    const remediationCost = 
      (criticalVulns.length * 10) +  // R$ 10k per critical fix
      (highVulns.length * 5) +       // R$ 5k per high fix
      (mediumVulns.length * 2);      // R$ 2k per medium fix
    
    const roi = estimatedLoss > 0 ? ((estimatedLoss - remediationCost) / remediationCost) * 100 : 0;
    
    return { estimatedLoss, remediationCost, roi };
  };
  
  const generateStrategicRecommendations = () => {
    const businessRisk = calculateBusinessRiskExposure();
    const complianceRisk = analyzeComplianceRisk();
    const internetRisk = identifyInternetFacingRisks();
    const infraRisk = analyzeInfrastructureCriticality();
    const financialImpact = calculateFinancialImpact();
    
    const recommendations = [];
    
    if (businessRisk.criticalApps.length > 0) {
      recommendations.push({
        priority: 'Critical',
        action: 'Remediar imediatamente vulnerabilidades em aplica√ß√µes cr√≠ticas',
        impact: 'Alto',
        effort: 'M√©dio',
        timeline: '0-30 dias'
      });
    }
    
    if (internetRisk.riskScore > 30) {
      recommendations.push({
        priority: 'High',
        action: 'Implementar WAF e monitoramento para aplica√ß√µes internet-facing',
        impact: 'Alto',
        effort: 'Alto',
        timeline: '30-60 dias'
      });
    }
    
    if (complianceRisk.lgpdRisk > 5) {
      recommendations.push({
        priority: 'High',
        action: 'Priorizar corre√ß√£o de vulnerabilidades em sistemas LGPD',
        impact: 'Cr√≠tico',
        effort: 'M√©dio',
        timeline: '0-45 dias'
      });
    }
    
    if (financialImpact.roi > 500) {
      recommendations.push({
        priority: 'Medium',
        action: 'Investir em automa√ß√£o de corre√ß√£o de vulnerabilidades',
        impact: 'M√©dio',
        effort: 'Alto',
        timeline: '60-90 dias'
      });
    }
    
    return recommendations;
  };
  
  const calculateCriticalAssetExposure = () => {
    if (!vulnerabilities) return [];
    
    const assetCounts: { [key: string]: { count: number, critical: number, high: number, riskScore: number } } = {};
    vulnerabilities.forEach(v => {
      if (!assetCounts[v.asset_name]) {
        assetCounts[v.asset_name] = { count: 0, critical: 0, high: 0, riskScore: 0 };
      }
      assetCounts[v.asset_name].count++;
      if (v.severity === 'Critical') {
        assetCounts[v.asset_name].critical++;
        assetCounts[v.asset_name].riskScore += 10;
      } else if (v.severity === 'High') {
        assetCounts[v.asset_name].high++;
        assetCounts[v.asset_name].riskScore += 5;
      }
    });
    
    return Object.entries(assetCounts)
      .map(([name, data]) => ({ name, ...data }))
      .sort((a, b) => b.riskScore - a.riskScore)
      .slice(0, 10);
  };
  
  const calculateComplianceExposure = () => {
    if (!vulnerabilities) return { lgpd: 0, sox: 0, pci: 0 };
    
    const lgpdAssets = vulnerabilities.filter(v => 
      v.asset_name.toLowerCase().includes('portal') || 
      v.asset_name.toLowerCase().includes('cliente') ||
      v.asset_name.toLowerCase().includes('mobile')
    );
    
    return {
      lgpd: lgpdAssets.filter(v => ['Critical', 'High'].includes(v.severity)).length,
      sox: 0, // Would be calculated based on financial systems
      pci: 0  // Would be calculated based on payment systems
    };
  };
  
  const calculateInternetFacingExposure = () => {
    if (!vulnerabilities) return { total: 0, critical: 0, withExploit: 0 };
    
    const internetFacing = vulnerabilities.filter(v => 
      v.asset_name.toLowerCase().includes('portal') ||
      v.asset_name.toLowerCase().includes('api') ||
      v.asset_name.toLowerCase().includes('web') ||
      v.asset_name.toLowerCase().includes('mobile') ||
      v.asset_name.toLowerCase().includes('gateway')
    );
    
    return {
      total: internetFacing.length,
      critical: internetFacing.filter(v => v.severity === 'Critical').length,
      withExploit: internetFacing.filter(v => v.exploit_available).length
    };
  };

  const generateReportContent = (templateId: string) => {
    const timestamp = new Date().toLocaleString('pt-BR');
    const periodDays = parseInt(selectedPeriod);
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - periodDays);
    const dateRange = `${startDate.toLocaleDateString('pt-BR')} - ${new Date().toLocaleDateString('pt-BR')}`;
    
    switch (templateId) {
      case 'executive':
        return generateExecutiveReport(timestamp, dateRange);
      case 'technical':
        return generateTechnicalReport(timestamp, dateRange);
      case 'sla':
        return generateSLAReport(timestamp, dateRange);
      default:
        return generateGenericReport(templateId, timestamp, dateRange);
    }
  };

  const generateExecutiveReport = (timestamp: string, dateRange: string) => {
    // Advanced analytics with real data cross-referencing
    const businessRiskAnalysis = calculateBusinessRiskExposure();
    const complianceRisk = analyzeComplianceRisk();
    const internetFacingRisks = identifyInternetFacingRisks();
    const infrastructureCriticality = analyzeInfrastructureCriticality();
    const financialImpact = calculateFinancialImpact();
    const strategicRecommendations = generateStrategicRecommendations();
    
    const criticalVulns = vulnerabilities?.filter(v => v.severity === 'Critical') || [];
    const highVulns = vulnerabilities?.filter(v => v.severity === 'High') || [];
    const openVulns = vulnerabilities?.filter(v => !['Resolved', 'Accepted', 'False_Positive'].includes(v.status)) || [];
    const overdueVulns = vulnerabilities?.filter(v => 
      v.due_date && new Date(v.due_date) < new Date() && !['Resolved', 'Accepted', 'False_Positive'].includes(v.status)
    ) || [];

    // Calculate business-critical asset exposure
    const criticalAssetExposure = calculateCriticalAssetExposure();
    const complianceExposure = calculateComplianceExposure();
    const internetExposure = calculateInternetFacingExposure();

    return `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Relat√≥rio Executivo de Vulnerabilidades</title>
        <meta charset="UTF-8">
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
          .container { max-width: 1200px; margin: 0 auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
          .header { text-align: center; border-bottom: 4px solid #3b82f6; padding-bottom: 30px; margin-bottom: 40px; }
          .title { font-size: 32px; font-weight: bold; color: #1e293b; margin-bottom: 10px; }
          .subtitle { font-size: 16px; color: #64748b; margin-bottom: 5px; }
          .metrics-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; margin: 40px 0; }
          .metric-card { background: white; padding: 16px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6; }
          .metric-value { font-size: 24px; font-weight: bold; margin-bottom: 6px; }
          .metric-label { font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; }
          .critical { color: #dc2626; border-left-color: #dc2626; }
          .high { color: #ea580c; border-left-color: #ea580c; }
          .success { color: #059669; border-left-color: #059669; }
          .warning { color: #d97706; border-left-color: #d97706; }
          .section { margin: 50px 0; }
          .section-title { font-size: 24px; font-weight: bold; color: #1e293b; margin-bottom: 20px; border-bottom: 3px solid #e2e8f0; padding-bottom: 12px; }
          .recommendations { background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 30px; border-radius: 12px; border-left: 6px solid #0ea5e9; margin: 30px 0; }
          .footer { margin-top: 50px; padding-top: 30px; border-top: 3px solid #e2e8f0; text-align: center; color: #64748b; }
          table { width: 100%; border-collapse: collapse; margin: 25px 0; }
          th, td { padding: 16px; text-align: left; border-bottom: 2px solid #e2e8f0; }
          th { background: #f8fafc; font-weight: 700; color: #374151; }
          .risk-alto { background: #fef2f2; color: #dc2626; font-weight: bold; }
          .risk-medio { background: #fff7ed; color: #ea580c; font-weight: bold; }
          .risk-baixo { background: #f0fdf4; color: #059669; font-weight: bold; }
          .executive-summary { background: #fafafa; padding: 30px; border-radius: 12px; margin: 30px 0; border: 2px solid #e2e8f0; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1 class="title">üõ°Ô∏è Relat√≥rio Executivo de Vulnerabilidades</h1>
            <p class="subtitle">Per√≠odo de An√°lise: ${dateRange}</p>
            <p class="subtitle">Gerado em: ${timestamp}</p>
            <p class="subtitle">Confidencial - Uso Interno</p>
          </div>
          
          <div class="executive-summary">
            <h2 style="margin-top: 0; color: #3b82f6;">üìä Resumo Executivo</h2>
            <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #dc2626; margin: 20px 0;">
              <h3 style="color: #dc2626; margin-top: 0;">üö® Situa√ß√£o Cr√≠tica de Seguran√ßa</h3>
              <p style="font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                <strong>Exposi√ß√£o de Risco Elevada:</strong> ${businessRiskAnalysis.criticalApps.length} aplica√ß√µes cr√≠ticas de neg√≥cio 
                apresentam vulnerabilidades de alta severidade, representando um risco financeiro estimado de 
                <strong>R$ ${financialImpact.estimatedLoss.toFixed(0)}k</strong>.
              </p>
              <p style="font-size: 16px; line-height: 1.6; margin-bottom: 15px;">
                <strong>Compliance em Risco:</strong> ${complianceRisk.lgpdRisk} vulnerabilidades cr√≠ticas/altas identificadas 
                em sistemas que processam dados pessoais (LGPD), expondo a organiza√ß√£o a multas regulat√≥rias.
              </p>
              <p style="font-size: 16px; line-height: 1.6; margin-bottom: 0;">
                <strong>Exposi√ß√£o Internet:</strong> ${internetExposure.critical} vulnerabilidades cr√≠ticas em aplica√ß√µes 
                acess√≠veis via internet, com ${internetExposure.withExploit} possuindo exploits p√∫blicos dispon√≠veis.
              </p>
            </div>
            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #059669; margin: 20px 0;">
              <h3 style="color: #059669; margin-top: 0;">üí∞ Oportunidade de Investimento</h3>
              <p style="font-size: 16px; line-height: 1.6; margin-bottom: 0;">
                Investimento de <strong>R$ ${financialImpact.remediationCost.toFixed(0)}k</strong> em corre√ß√£o de vulnerabilidades 
                pode evitar perdas estimadas de <strong>R$ ${financialImpact.estimatedLoss.toFixed(0)}k</strong>, 
                gerando um <strong>ROI de ${financialImpact.roi.toFixed(0)}%</strong>.
              </p>
            </div>
          </div>
          
          <div class="section">
            <h2 class="section-title">üìà Dashboard Executivo de Risco</h2>
            
            <div class="metrics-grid">
              <div class="metric-card critical">
                <div class="metric-value">${metrics?.total_vulnerabilities || 0}</div>
                <div class="metric-label">Total de Vulnerabilidades</div>
              </div>
              <div class="metric-card critical">
                <div class="metric-value">${businessRiskAnalysis.criticalApps.length}</div>
                <div class="metric-label">Aplica√ß√µes Cr√≠ticas Expostas</div>
              </div>
              <div class="metric-card warning">
                <div class="metric-value">${complianceRisk.lgpdRisk}</div>
                <div class="metric-label">Gaps Cr√≠ticos LGPD</div>
              </div>
              <div class="metric-card high">
                <div class="metric-value">${internetExposure.critical}</div>
                <div class="metric-label">Vulns Cr√≠ticas Internet-Facing</div>
              </div>
              <div class="metric-card critical">
                <div class="metric-value">R$ ${financialImpact.estimatedLoss.toFixed(0)}k</div>
                <div class="metric-label">Risco Financeiro Estimado</div>
              </div>
              <div class="metric-card ${infrastructureCriticality.riskLevel === 'Critical' ? 'critical' : infrastructureCriticality.riskLevel === 'High' ? 'high' : 'success'}">
                <div class="metric-value">${infrastructureCriticality.riskLevel}</div>
                <div class="metric-label">N√≠vel de Risco de Infraestrutura</div>
              </div>
            </div>
            
            <div style="background: #f8fafc; padding: 25px; border-radius: 12px; margin: 30px 0;">
              <h3 style="color: #374151; margin-top: 0;">üîç An√°lise Comparativa de Risco</h3>
              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <div style="font-size: 20px; font-weight: bold; color: #dc2626;">${metrics?.by_severity.Critical || 0}</div>
                  <div style="font-size: 12px; color: #64748b; margin: 5px 0;">Vulnerabilidades Cr√≠ticas</div>
                  <div style="font-size: 11px; color: ${(metrics?.by_severity.Critical || 0) > 10 ? '#dc2626' : '#059669'}; font-weight: bold;">
                    ${(metrics?.by_severity.Critical || 0) > 10 ? 'ACIMA DO ACEIT√ÅVEL' : 'DENTRO DO LIMITE'}
                  </div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <div style="font-size: 20px; font-weight: bold; color: #ea580c;">${metrics?.by_severity.High || 0}</div>
                  <div style="font-size: 12px; color: #64748b; margin: 5px 0;">Vulnerabilidades Altas</div>
                  <div style="font-size: 11px; color: ${(metrics?.by_severity.High || 0) > 25 ? '#ea580c' : '#059669'}; font-weight: bold;">
                    ${(metrics?.by_severity.High || 0) > 25 ? 'ACIMA DO ACEIT√ÅVEL' : 'DENTRO DO LIMITE'}
                  </div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <div style="font-size: 20px; font-weight: bold; color: #059669;">${metrics?.sla_compliance || 0}%</div>
                  <div style="font-size: 12px; color: #64748b; margin: 5px 0;">SLA Compliance</div>
                  <div style="font-size: 11px; color: ${(metrics?.sla_compliance || 0) < 90 ? '#dc2626' : '#059669'}; font-weight: bold;">
                    ${(metrics?.sla_compliance || 0) < 90 ? 'ABAIXO DA META' : 'DENTRO DA META'}
                  </div>
                </div>
                <div style="text-align: center; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e2e8f0;">
                  <div style="font-size: 20px; font-weight: bold; color: #3b82f6;">${metrics?.avg_resolution_time || 0}d</div>
                  <div style="font-size: 12px; color: #64748b; margin: 5px 0;">MTTR M√©dio</div>
                  <div style="font-size: 11px; color: ${(metrics?.avg_resolution_time || 0) > 30 ? '#dc2626' : '#059669'}; font-weight: bold;">
                    ${(metrics?.avg_resolution_time || 0) > 30 ? 'ACIMA DA META' : 'DENTRO DA META'}
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Gr√°ficos Executivos Compactos -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
              <!-- Gr√°fico 1: Distribui√ß√£o por Severidade -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #3b82f6;">
                <h3 style="color: #3b82f6; margin-top: 0; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                  üìä Distribui√ß√£o por Severidade
                </h3>
                <p style="font-size: 12px; color: #64748b; margin-bottom: 15px;">An√°lise detalhada do perfil de risco</p>
                
                <!-- Barras horizontais compactas -->
                <div style="space-y: 12px;">
                  <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #dc2626; border-radius: 50%;"></div>
                        <span style="font-size: 12px; font-weight: 500;">Cr√≠ticas</span>
                      </div>
                      <span style="font-size: 12px; font-weight: bold;">${metrics?.by_severity.Critical || 0}</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px;">
                      <div style="background: #dc2626; height: 6px; border-radius: 6px; width: ${(metrics?.by_severity.Critical || 0) / (metrics?.total_vulnerabilities || 1) * 100}%;"></div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #ea580c; border-radius: 50%;"></div>
                        <span style="font-size: 12px; font-weight: 500;">Altas</span>
                      </div>
                      <span style="font-size: 12px; font-weight: bold;">${metrics?.by_severity.High || 0}</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px;">
                      <div style="background: #ea580c; height: 6px; border-radius: 6px; width: ${(metrics?.by_severity.High || 0) / (metrics?.total_vulnerabilities || 1) * 100}%;"></div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #d97706; border-radius: 50%;"></div>
                        <span style="font-size: 12px; font-weight: 500;">M√©dias</span>
                      </div>
                      <span style="font-size: 12px; font-weight: bold;">${metrics?.by_severity.Medium || 0}</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px;">
                      <div style="background: #d97706; height: 6px; border-radius: 6px; width: ${(metrics?.by_severity.Medium || 0) / (metrics?.total_vulnerabilities || 1) * 100}%;"></div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 12px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #2563eb; border-radius: 50%;"></div>
                        <span style="font-size: 12px; font-weight: 500;">Baixas</span>
                      </div>
                      <span style="font-size: 12px; font-weight: bold;">${metrics?.by_severity.Low || 0}</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px;">
                      <div style="background: #2563eb; height: 6px; border-radius: 6px; width: ${(metrics?.by_severity.Low || 0) / (metrics?.total_vulnerabilities || 1) * 100}%;"></div>
                    </div>
                  </div>
                  
                  <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <div style="width: 10px; height: 10px; background: #6b7280; border-radius: 50%;"></div>
                        <span style="font-size: 12px; font-weight: 500;">Informativas</span>
                      </div>
                      <span style="font-size: 12px; font-weight: bold;">${metrics?.by_severity.Info || 0}</span>
                    </div>
                    <div style="width: 100%; background: #e5e7eb; border-radius: 6px; height: 6px;">
                      <div style="background: #6b7280; height: 6px; border-radius: 6px; width: ${(metrics?.by_severity.Info || 0) / (metrics?.total_vulnerabilities || 1) * 100}%;"></div>
                    </div>
                  </div>
                  
                  <!-- M√©tricas resumo -->
                  <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: center;">
                      <div>
                        <div style="font-size: 18px; font-weight: bold; color: #dc2626;">
                          ${((metrics?.by_severity.Critical + metrics?.by_severity.High) / (metrics?.total_vulnerabilities || 1) * 100).toFixed(1)}%
                        </div>
                        <div style="font-size: 10px; color: #64748b;">Risco Alto/Cr√≠tico</div>
                      </div>
                      <div>
                        <div style="font-size: 18px; font-weight: bold; color: #059669;">
                          ${(metrics?.by_severity.Medium || 0) + (metrics?.by_severity.Low || 0) + (metrics?.by_severity.Info || 0)}
                        </div>
                        <div style="font-size: 10px; color: #64748b;">Risco Baixo/M√©dio/Info</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Gr√°fico 2: Performance de SLA -->
              <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #059669;">
                <h3 style="color: #059669; margin-top: 0; font-size: 16px; font-weight: bold; display: flex; align-items: center; gap: 8px;">
                  ‚ö° Performance de SLA & Tend√™ncias
                </h3>
                <p style="font-size: 12px; color: #64748b; margin-bottom: 15px;">Monitoramento de efici√™ncia operacional</p>
                
                <!-- Indicador circular de SLA -->
                <div style="text-align: center; margin-bottom: 15px;">
                  <div style="position: relative; width: 80px; height: 80px; margin: 0 auto;">
                    <svg width="80" height="80" style="transform: rotate(-90deg);">
                      <circle cx="40" cy="40" r="32" stroke="#e5e7eb" stroke-width="6" fill="none"></circle>
                      <circle cx="40" cy="40" r="32" 
                        stroke="${(metrics?.sla_compliance || 0) >= 90 ? '#10b981' : (metrics?.sla_compliance || 0) >= 70 ? '#f59e0b' : '#ef4444'}" 
                        stroke-width="6" fill="none"
                        stroke-dasharray="${((metrics?.sla_compliance || 0) / 100) * 201} 201"
                        stroke-linecap="round">
                      </circle>
                    </svg>
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                      <div style="font-size: 14px; font-weight: bold; color: ${(metrics?.sla_compliance || 0) >= 90 ? '#10b981' : (metrics?.sla_compliance || 0) >= 70 ? '#f59e0b' : '#ef4444'};">
                        ${metrics?.sla_compliance || 0}%
                      </div>
                      <div style="font-size: 8px; color: #64748b;">SLA</div>
                    </div>
                  </div>
                </div>
                
                <!-- M√©tricas de performance -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                  <div style="text-align: center; padding: 8px; background: #dbeafe; border-radius: 6px;">
                    <div style="font-size: 14px; font-weight: bold; color: #2563eb;">${metrics?.avg_resolution_time || 0}d</div>
                    <div style="font-size: 9px; color: #2563eb;">MTTR M√©dio</div>
                    <div style="font-size: 8px; color: #64748b; margin-top: 2px;">
                      ${(metrics?.avg_resolution_time || 0) <= 7 ? '‚úÖ Meta' : '‚ö†Ô∏è Acima'}
                    </div>
                  </div>
                  
                  <div style="text-align: center; padding: 8px; background: #f3e8ff; border-radius: 6px;">
                    <div style="font-size: 14px; font-weight: bold; color: #7c3aed;">${metrics?.overdue_count || 0}</div>
                    <div style="font-size: 9px; color: #7c3aed;">Em Atraso</div>
                    <div style="font-size: 8px; color: #64748b; margin-top: 2px;">
                      ${(metrics?.overdue_count || 0) === 0 ? '‚úÖ Nenhuma' : `‚ö†Ô∏è ${metrics?.overdue_count} vencidas`}
                    </div>
                  </div>
                </div>
                
                <!-- Tend√™ncia de resolu√ß√£o -->
                <div style="background: #f8fafc; padding: 12px; border-radius: 6px;">
                  <h4 style="font-size: 11px; font-weight: 600; margin: 0 0 8px 0;">An√°lise de Tend√™ncia</h4>
                  <div style="space-y: 6px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <span style="font-size: 9px;">Cr√≠ticas resolvidas</span>
                      <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 30px; height: 3px; background: #e5e7eb; border-radius: 2px;">
                          <div style="width: 75%; height: 3px; background: #10b981; border-radius: 2px;"></div>
                        </div>
                        <span style="font-size: 9px; font-weight: 500;">75%</span>
                      </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <span style="font-size: 9px;">Altas resolvidas</span>
                      <div style="display: flex; align-items: center; gap: 4px;">
                        <div style="width: 30px; height: 3px; background: #e5e7eb; border-radius: 2px;">
                          <div style="width: 50%; height: 3px; background: #f59e0b; border-radius: 2px;"></div>
                        </div>
                        <span style="font-size: 9px; font-weight: 500;">50%</span>
                      </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-size: 9px;">Efici√™ncia geral</span>
                      <div style="display: flex; align-items: center; gap: 2px;">
                        <span style="font-size: 9px; color: #10b981;">‚Üó</span>
                        <span style="font-size: 9px; font-weight: 500; color: #10b981;">+12%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2 class="section-title">üéØ An√°lise de Risco por Criticidade de Neg√≥cio</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
              <div>
                <h3 style="color: #dc2626;">üè¢ Aplica√ß√µes Cr√≠ticas Expostas</h3>
                <table style="width: 100%; font-size: 14px;">
                  <thead>
                    <tr style="background: #f8fafc;">
                      <th style="padding: 12px; text-align: left;">Aplica√ß√£o</th>
                      <th style="padding: 12px; text-align: center;">Cr√≠ticas</th>
                      <th style="padding: 12px; text-align: center;">Altas</th>
                      <th style="padding: 12px; text-align: center;">Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${businessRiskAnalysis.criticalApps.length > 0 ? businessRiskAnalysis.criticalApps.slice(0, 5).map(app => `
                      <tr>
                        <td style="padding: 10px;"><strong>${app.name}</strong><br><small style="color: #64748b;">${app.internetFacing ? 'üåê Internet' : 'üîí Interno'} | ${app.lgpd ? 'LGPD' : 'N√£o-LGPD'}</small></td>
                        <td style="padding: 10px; text-align: center; color: #dc2626; font-weight: bold;">${app.criticalVulns}</td>
                        <td style="padding: 10px; text-align: center; color: #ea580c; font-weight: bold;">${app.highVulns}</td>
                        <td style="padding: 10px; text-align: center;"><span style="background: ${app.riskScore > 30 ? '#dc2626' : app.riskScore > 15 ? '#ea580c' : '#059669'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${app.riskScore}</span></td>
                      </tr>
                    `).join('') : '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">Nenhuma aplica√ß√£o cr√≠tica com vulnerabilidades</td></tr>'}
                  </tbody>
                </table>
              </div>
              
              <div>
                <h3 style="color: #ea580c;">üåê Exposi√ß√£o Internet-Facing</h3>
                <table style="width: 100%; font-size: 14px;">
                  <thead>
                    <tr style="background: #f8fafc;">
                      <th style="padding: 12px; text-align: left;">Tipo de Ativo</th>
                      <th style="padding: 12px; text-align: center;">Vulns</th>
                      <th style="padding: 12px; text-align: center;">Exploits</th>
                      <th style="padding: 12px; text-align: center;">Risco</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${internetFacingRisks.exposedApps.length > 0 ? internetFacingRisks.exposedApps.slice(0, 5).map(app => `
                      <tr>
                        <td style="padding: 10px;"><strong>${app.name}</strong></td>
                        <td style="padding: 10px; text-align: center;">${app.vulnerabilities}</td>
                        <td style="padding: 10px; text-align: center; color: ${app.exploitAvailable > 0 ? '#dc2626' : '#059669'}; font-weight: bold;">${app.exploitAvailable}</td>
                        <td style="padding: 10px; text-align: center;"><span style="background: ${app.riskScore > 20 ? '#dc2626' : app.riskScore > 10 ? '#ea580c' : '#059669'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${app.riskScore > 20 ? 'ALTO' : app.riskScore > 10 ? 'M√âDIO' : 'BAIXO'}</span></td>
                      </tr>
                    `).join('') : '<tr><td colspan="4" style="padding: 20px; text-align: center; color: #64748b;">Nenhuma exposi√ß√£o internet identificada</td></tr>'}
                  </tbody>
                </table>
              </div>
            </div>
            
            <div style="background: #f8fafc; padding: 25px; border-radius: 12px; margin: 30px 0;">
              <h3 style="color: #374151; margin-top: 0;">üìä An√°lise de Impacto Financeiro</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div style="text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #dc2626;">R$ ${financialImpact.estimatedLoss.toFixed(0)}k</div>
                  <div style="font-size: 14px; color: #64748b;">Perda Estimada</div>
                  <div style="font-size: 12px; color: #64748b; margin-top: 5px;">Baseado em probabilidade de explora√ß√£o</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #059669;">R$ ${financialImpact.remediationCost.toFixed(0)}k</div>
                  <div style="font-size: 14px; color: #64748b;">Custo de Remedia√ß√£o</div>
                  <div style="font-size: 12px; color: #64748b; margin-top: 5px;">Investimento necess√°rio</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 32px; font-weight: bold; color: #3b82f6;">${financialImpact.roi.toFixed(0)}%</div>
                  <div style="font-size: 14px; color: #64748b;">ROI Estimado</div>
                  <div style="font-size: 12px; color: #64748b; margin-top: 5px;">Retorno do investimento</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2 class="section-title">üõ°Ô∏è Status de Compliance e Regulamenta√ß√£o</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
              <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; border-left: 6px solid #d97706;">
                <h3 style="color: #92400e; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                  üìú LGPD - Lei Geral de Prote√ß√£o de Dados
                </h3>
                <div style="font-size: 24px; font-weight: bold; color: #92400e; margin: 15px 0;">
                  ${complianceRisk.lgpdRisk} vulnerabilidades cr√≠ticas/altas
                </div>
                <p style="font-size: 14px; color: #92400e; margin: 0;">
                  Sistemas que processam dados pessoais com vulnerabilidades de alta severidade. 
                  <strong>Risco de multa:</strong> At√© 2% do faturamento anual.
                </p>
              </div>
              
              <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; border-left: 6px solid #2563eb;">
                <h3 style="color: #1e40af; margin-top: 0; display: flex; align-items: center; gap: 10px;">
                  üí∞ SOX - Sarbanes-Oxley Act
                </h3>
                <div style="font-size: 24px; font-weight: bold; color: #1e40af; margin: 15px 0;">
                  ${complianceRisk.soxRisk} vulnerabilidades cr√≠ticas/altas
                </div>
                <p style="font-size: 14px; color: #1e40af; margin: 0;">
                  Sistemas financeiros e de relat√≥rios com vulnerabilidades. 
                  <strong>Impacto:</strong> Auditoria, multas e responsabilidade executiva.
                </p>
              </div>
            </div>
            
            <div style="background: #f1f5f9; padding: 20px; border-radius: 12px; margin: 20px 0;">
              <h4 style="color: #374151; margin-top: 0;">Gaps Cr√≠ticos de Compliance</h4>
              <table style="width: 100%; font-size: 14px;">
                <thead>
                  <tr style="background: #e2e8f0;">
                    <th style="padding: 12px; text-align: left;">Framework</th>
                    <th style="padding: 12px; text-align: center;">Total Vulnerabilidades</th>
                    <th style="padding: 12px; text-align: center;">Cr√≠ticas</th>
                    <th style="padding: 12px; text-align: center;">Status</th>
                    <th style="padding: 12px; text-align: left;">A√ß√£o Requerida</th>
                  </tr>
                </thead>
                <tbody>
                  ${complianceRisk.criticalGaps.map(gap => `
                    <tr>
                      <td style="padding: 10px;"><strong>${gap.framework}</strong></td>
                      <td style="padding: 10px; text-align: center;">${gap.vulnerabilities}</td>
                      <td style="padding: 10px; text-align: center; color: #dc2626; font-weight: bold;">${gap.critical}</td>
                      <td style="padding: 10px; text-align: center;">
                        <span style="background: ${gap.critical > 0 ? '#dc2626' : gap.vulnerabilities > 0 ? '#ea580c' : '#059669'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                          ${gap.critical > 0 ? 'CR√çTICO' : gap.vulnerabilities > 0 ? 'ATEN√á√ÉO' : 'CONFORME'}
                        </span>
                      </td>
                      <td style="padding: 10px; font-size: 13px;">
                        ${gap.critical > 0 ? 'Remediar imediatamente - Risco regulat√≥rio alto' : gap.vulnerabilities > 0 ? 'Planejar corre√ß√£o em 30 dias' : 'Manter monitoramento'}
                      </td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </div>
          
          <div class="recommendations">
            <h2 style="margin-top: 0; color: #0ea5e9;">üéØ Recomenda√ß√µes Estrat√©gicas Baseadas em Risco</h2>
            
            <div style="background: #f8fafc; padding: 25px; border-radius: 12px; margin: 20px 0;">
              <h3 style="color: #374151; margin-top: 0;">üìÖ Roadmap de Prioriza√ß√£o</h3>
              <table style="width: 100%; font-size: 14px;">
                <thead>
                  <tr style="background: #e2e8f0;">
                    <th style="padding: 12px; text-align: left;">Prioridade</th>
                    <th style="padding: 12px; text-align: left;">A√ß√£o Recomendada</th>
                    <th style="padding: 12px; text-align: center;">Impacto</th>
                    <th style="padding: 12px; text-align: center;">Esfor√ßo</th>
                    <th style="padding: 12px; text-align: center;">Timeline</th>
                  </tr>
                </thead>
                <tbody>
                  ${strategicRecommendations.map(rec => `
                    <tr>
                      <td style="padding: 10px;">
                        <span style="background: ${rec.priority === 'Critical' ? '#dc2626' : rec.priority === 'High' ? '#ea580c' : '#d97706'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;">
                          ${rec.priority === 'Critical' ? 'CR√çTICA' : rec.priority === 'High' ? 'ALTA' : 'M√âDIA'}
                        </span>
                      </td>
                      <td style="padding: 10px;"><strong>${rec.action}</strong></td>
                      <td style="padding: 10px; text-align: center;">
                        <span style="color: ${rec.impact === 'Cr√≠tico' ? '#dc2626' : rec.impact === 'Alto' ? '#ea580c' : '#059669'}; font-weight: bold;">
                          ${rec.impact}
                        </span>
                      </td>
                      <td style="padding: 10px; text-align: center;">${rec.effort}</td>
                      <td style="padding: 10px; text-align: center; font-weight: bold;">${rec.timeline}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin: 30px 0;">
              <div style="background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); padding: 20px; border-radius: 12px; border-left: 6px solid #dc2626;">
                <h4 style="color: #dc2626; margin-top: 0;">üö® A√ß√µes Cr√≠ticas (0-30 dias)</h4>
                <ul style="margin: 0; padding-left: 20px;">
                  <li style="margin-bottom: 8px;">Remediar <strong>${criticalVulns.length} vulnerabilidades cr√≠ticas</strong> em aplica√ß√µes de produ√ß√£o</li>
                  <li style="margin-bottom: 8px;">Implementar <strong>WAF</strong> para aplica√ß√µes internet-facing com vulnerabilidades</li>
                  <li style="margin-bottom: 8px;">Estabelecer <strong>monitoramento 24/7</strong> para ativos cr√≠ticos de neg√≥cio</li>
                  <li style="margin-bottom: 8px;">Revisar <strong>controles de acesso</strong> em sistemas LGPD comprometidos</li>
                  <li style="margin-bottom: 0;">Criar <strong>plano de resposta</strong> para incidentes de seguran√ßa</li>
                </ul>
              </div>
              
              <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); padding: 20px; border-radius: 12px; border-left: 6px solid #0ea5e9;">
                <h4 style="color: #0ea5e9; margin-top: 0;">üìà Investimentos Estrat√©gicos (30-90 dias)</h4>
                <ul style="margin: 0; padding-left: 20px;">
                  <li style="margin-bottom: 8px;">Implementar <strong>SIEM/SOAR</strong> para detec√ß√£o automatizada</li>
                  <li style="margin-bottom: 8px;">Estabelecer <strong>programa de Bug Bounty</strong> para aplica√ß√µes cr√≠ticas</li>
                  <li style="margin-bottom: 8px;">Investir em <strong>DevSecOps</strong> para preven√ß√£o de vulnerabilidades</li>
                  <li style="margin-bottom: 8px;">Implementar <strong>Zero Trust Architecture</strong> para ativos cr√≠ticos</li>
                  <li style="margin-bottom: 0;">Desenvolver <strong>m√©tricas de seguran√ßa</strong> para acompanhamento executivo</li>
                </ul>
              </div>
            </div>
            
            <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); padding: 25px; border-radius: 12px; border-left: 6px solid #059669; margin: 20px 0;">
              <h3 style="color: #059669; margin-top: 0;">üí∞ Justificativa de Investimento</h3>
              <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                <div>
                  <div style="font-size: 18px; font-weight: bold; color: #059669;">Redu√ß√£o de Risco</div>
                  <div style="font-size: 14px; color: #065f46; margin-top: 5px;">85% de redu√ß√£o no risco de incidentes com investimento em remedia√ß√£o</div>
                </div>
                <div>
                  <div style="font-size: 18px; font-weight: bold; color: #059669;">Compliance</div>
                  <div style="font-size: 14px; color: #065f46; margin-top: 5px;">Evitar multas LGPD de at√© R$ 50M com corre√ß√£o de gaps cr√≠ticos</div>
                </div>
                <div>
                  <div style="font-size: 18px; font-weight: bold; color: #059669;">Efici√™ncia</div>
                  <div style="font-size: 14px; color: #065f46; margin-top: 5px;">Automa√ß√£o pode reduzir MTTR em 60% e custos operacionais em 40%</div>
                </div>
              </div>
            </div>
          </div>
          
          <div style="background: #f8fafc; padding: 30px; border-radius: 12px; margin: 40px 0; border: 2px solid #e2e8f0;">
            <h3 style="color: #374151; margin-top: 0;">üìÑ Pr√≥ximos Passos e Acompanhamento</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
              <div>
                <h4 style="color: #dc2626;">Responsabilidades Imediatas</h4>
                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                  <li style="margin-bottom: 5px;"><strong>CISO:</strong> Aprovar or√ßamento para remedia√ß√£o cr√≠tica</li>
                  <li style="margin-bottom: 5px;"><strong>CTO:</strong> Priorizar corre√ß√µes em aplica√ß√µes cr√≠ticas</li>
                  <li style="margin-bottom: 5px;"><strong>Compliance:</strong> Avaliar impacto regulat√≥rio LGPD</li>
                  <li style="margin-bottom: 0;"><strong>Infraestrutura:</strong> Implementar controles compensat√≥rios</li>
                </ul>
              </div>
              <div>
                <h4 style="color: #0ea5e9;">Cronograma de Revis√£o</h4>
                <ul style="font-size: 14px; margin: 0; padding-left: 20px;">
                  <li style="margin-bottom: 5px;"><strong>Semanal:</strong> Status de remedia√ß√£o de vulnerabilidades cr√≠ticas</li>
                  <li style="margin-bottom: 5px;"><strong>Quinzenal:</strong> Revis√£o de m√©tricas de SLA e performance</li>
                  <li style="margin-bottom: 5px;"><strong>Mensal:</strong> Relat√≥rio executivo atualizado</li>
                  <li style="margin-bottom: 0;"><strong>Trimestral:</strong> Revis√£o estrat√©gica e ajuste de investimentos</li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="footer">
            <p><strong>Relat√≥rio Executivo Confidencial</strong> | GRC Controller | ${timestamp}</p>
            <p style="font-size: 14px; color: #64748b; margin: 10px 0;">Este relat√≥rio cont√©m an√°lises estrat√©gicas baseadas em dados reais de vulnerabilidades, aplica√ß√µes e ativos de infraestrutura.</p>
            <p style="font-size: 14px; color: #64748b; margin: 10px 0;"><strong>Classifica√ß√£o:</strong> Confidencial - Distribui√ß√£o restrita √† alta gest√£o e equipe de seguran√ßa</p>
            <p style="font-size: 12px; color: #64748b;">Para d√∫vidas t√©cnicas ou solicita√ß√µes de dados adicionais, entre em contato com a equipe de Seguran√ßa da Informa√ß√£o.</p>
          </div>
        </div>
      </body>
      </html>
    `;
  };

  const generateTechnicalReport = (timestamp: string, dateRange: string) => {
    const criticalVulns = vulnerabilities?.filter(v => v.severity === 'Critical') || [];
    const highVulns = vulnerabilities?.filter(v => v.severity === 'High') || [];
    
    // Group by source type
    const sourceCounts: { [key: string]: number } = {};
    vulnerabilities?.forEach(v => {
      sourceCounts[v.source_type] = (sourceCounts[v.source_type] || 0) + 1;
    });

    return `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Relat√≥rio T√©cnico de Vulnerabilidades</title>
        <meta charset="UTF-8">
        <style>
          body { font-family: 'Courier New', monospace; margin: 0; padding: 20px; background: #f8f9fa; font-size: 12px; }
          .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
          .header { border-bottom: 2px solid #059669; padding-bottom: 20px; margin-bottom: 30px; }
          .title { font-size: 24px; font-weight: bold; color: #1e293b; }
          .section { margin: 30px 0; }
          .section-title { font-size: 18px; font-weight: bold; color: #059669; margin-bottom: 15px; }
          .vuln-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .vuln-table th, .vuln-table td { padding: 8px 12px; text-align: left; border: 1px solid #e2e8f0; }
          .vuln-table th { background: #f8fafc; font-weight: bold; }
          .severity-critical { background: #fef2f2; color: #dc2626; font-weight: bold; }
          .severity-high { background: #fff7ed; color: #ea580c; font-weight: bold; }
          .severity-medium { background: #fffbeb; color: #d97706; font-weight: bold; }
          .severity-low { background: #f0f9ff; color: #2563eb; font-weight: bold; }
          .code-block { background: #f1f5f9; padding: 15px; border-radius: 6px; font-family: monospace; margin: 15px 0; }
          .remediation { background: #f0fdf4; padding: 20px; border-left: 4px solid #059669; margin: 20px 0; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1 class="title">üîß Relat√≥rio T√©cnico de Vulnerabilidades</h1>
            <p>Per√≠odo: ${dateRange} | Gerado em: ${timestamp}</p>
          </div>
          
          <div class="section">
            <h2 class="section-title">1. RESUMO T√âCNICO</h2>
            <p><strong>Total de Vulnerabilidades:</strong> ${metrics?.total_vulnerabilities || 0}</p>
            <p><strong>Distribui√ß√£o por Severidade:</strong></p>
            <ul>
              <li>Cr√≠ticas: ${metrics?.by_severity.Critical || 0}</li>
              <li>Altas: ${metrics?.by_severity.High || 0}</li>
              <li>M√©dias: ${metrics?.by_severity.Medium || 0}</li>
              <li>Baixas: ${metrics?.by_severity.Low || 0}</li>
              <li>Informativas: ${metrics?.by_severity.Info || 0}</li>
            </ul>
            <p><strong>M√©tricas de Performance:</strong></p>
            <ul>
              <li>MTTR (Tempo M√©dio de Resolu√ß√£o): ${metrics?.avg_resolution_time || 0} dias</li>
              <li>SLA Compliance: ${metrics?.sla_compliance || 0}%</li>
              <li>Vulnerabilidades em Atraso: ${metrics?.overdue_count || 0}</li>
            </ul>
          </div>
          
          <div class="section">
            <h2 class="section-title">2. DISTRIBUI√á√ÉO POR FONTE</h2>
            <table class="vuln-table">
              <thead>
                <tr>
                  <th>Ferramenta/Fonte</th>
                  <th>Quantidade</th>
                  <th>Percentual</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${Object.entries(sourceCounts).map(([source, count]) => `
                  <tr>
                    <td><strong>${source}</strong></td>
                    <td>${count}</td>
                    <td>${((count / (metrics?.total_vulnerabilities || 1)) * 100).toFixed(1)}%</td>
                    <td>Ativo</td>
                  </tr>
                `).join('') || '<tr><td colspan="4">Nenhuma fonte identificada</td></tr>'}
              </tbody>
            </table>
          </div>
          
          <div class="section">
            <h2 class="section-title">3. VULNERABILIDADES CR√çTICAS</h2>
            ${criticalVulns.length > 0 ? `
              <table class="vuln-table">
                <thead>
                  <tr>
                    <th>T√≠tulo</th>
                    <th>Ativo</th>
                    <th>CVE</th>
                    <th>CVSS</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  ${criticalVulns.slice(0, 10).map(vuln => `
                    <tr>
                      <td class="severity-critical">${vuln.title}</td>
                      <td>${vuln.asset_name}</td>
                      <td>${vuln.cve_id || 'N/A'}</td>
                      <td>${vuln.cvss_score || 'N/A'}</td>
                      <td>${vuln.status}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            ` : '<p>Nenhuma vulnerabilidade cr√≠tica identificada.</p>'}
          </div>
          
          <div class="section">
            <h2 class="section-title">4. RECOMENDA√á√ïES T√âCNICAS</h2>
            
            <div class="remediation">
              <h4>A√ß√µes Imediatas (Pr√≥ximos 7 dias)</h4>
              <div class="code-block">
# Verifica√ß√£o de vulnerabilidades cr√≠ticas
nmap -sV --script vuln target_host
openvas-cli --scan-config="Full" target

# Aplica√ß√£o de patches cr√≠ticos
apt update && apt upgrade -y
yum update --security
              </div>
              <ul>
                <li>Aplicar patches de seguran√ßa para ${criticalVulns.length} vulnerabilidades cr√≠ticas</li>
                <li>Implementar controles compensat√≥rios tempor√°rios</li>
                <li>Configurar monitoramento adicional para ativos cr√≠ticos</li>
              </ul>
            </div>
            
            <div class="remediation">
              <h4>Melhorias de Infraestrutura (Pr√≥ximos 30 dias)</h4>
              <ul>
                <li>Implementar WAF (Web Application Firewall)</li>
                <li>Configurar IDS/IPS (Intrusion Detection/Prevention System)</li>
                <li>Estabelecer procedimentos de backup e recovery</li>
                <li>Implementar autentica√ß√£o multifator (MFA)</li>
                <li>Configurar logging centralizado e SIEM</li>
              </ul>
            </div>
          </div>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b;">
            <p><strong>Relat√≥rio T√©cnico Confidencial</strong> | GRC Controller | ${timestamp}</p>
          </div>
        </div>
      </body>
      </html>
    `;
  };

  const generateSLAReport = (timestamp: string, dateRange: string) => {
    const overdueVulns = vulnerabilities?.filter(v => 
      v.due_date && new Date(v.due_date) < new Date() && !['Resolved', 'Accepted', 'False_Positive'].includes(v.status)
    ) || [];

    return `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Relat√≥rio de SLA</title>
        <meta charset="UTF-8">
        <style>
          body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background: #f8f9fa; }
          .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
          .header { text-align: center; border-bottom: 3px solid #ea580c; padding-bottom: 20px; margin-bottom: 30px; }
          .title { font-size: 28px; font-weight: bold; color: #1e293b; }
          .section { margin: 30px 0; }
          .section-title { font-size: 20px; font-weight: bold; color: #ea580c; margin-bottom: 15px; }
          .sla-metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
          .sla-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #ea580c; }
          .sla-value { font-size: 32px; font-weight: bold; margin-bottom: 5px; }
          .sla-label { font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 0.5px; }
          .performance-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
          .performance-table th, .performance-table td { padding: 12px; text-align: left; border: 1px solid #e2e8f0; }
          .performance-table th { background: #f8fafc; font-weight: bold; }
          .met { color: #059669; font-weight: bold; }
          .missed { color: #dc2626; font-weight: bold; }
        </style>
      </head>
      <body>
        <div class="container">
          <div class="header">
            <h1 class="title">‚è±Ô∏è Relat√≥rio de SLA</h1>
            <p>Per√≠odo: ${dateRange}</p>
            <p>Gerado em: ${timestamp}</p>
          </div>
          
          <div class="section">
            <h2 class="section-title">1. RESUMO DE PERFORMANCE SLA</h2>
            <div class="sla-metrics">
              <div class="sla-card">
                <div class="sla-value">${metrics?.sla_compliance || 0}%</div>
                <div class="sla-label">SLA Compliance Geral</div>
              </div>
              <div class="sla-card">
                <div class="sla-value">${metrics?.avg_resolution_time || 0}d</div>
                <div class="sla-label">MTTR M√©dio</div>
              </div>
              <div class="sla-card">
                <div class="sla-value">${overdueVulns.length}</div>
                <div class="sla-label">Vulnerabilidades em Atraso</div>
              </div>
              <div class="sla-card">
                <div class="sla-value">${metrics?.critical_open || 0}</div>
                <div class="sla-label">Cr√≠ticas Abertas</div>
              </div>
            </div>
          </div>
          
          <div class="section">
            <h2 class="section-title">2. PERFORMANCE POR SEVERIDADE</h2>
            <table class="performance-table">
              <thead>
                <tr>
                  <th>Severidade</th>
                  <th>SLA Definido</th>
                  <th>Vulnerabilidades Abertas</th>
                  <th>Em Atraso</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Cr√≠tica</strong></td>
                  <td>24 horas</td>
                  <td>${metrics?.by_severity.Critical || 0}</td>
                  <td>${overdueVulns.filter(v => v.severity === 'Critical').length}</td>
                  <td class="${overdueVulns.filter(v => v.severity === 'Critical').length === 0 ? 'met' : 'missed'}">
                    ${overdueVulns.filter(v => v.severity === 'Critical').length === 0 ? 'ATENDIDO' : 'VIOLADO'}
                  </td>
                </tr>
                <tr>
                  <td><strong>Alta</strong></td>
                  <td>72 horas</td>
                  <td>${metrics?.by_severity.High || 0}</td>
                  <td>${overdueVulns.filter(v => v.severity === 'High').length}</td>
                  <td class="${overdueVulns.filter(v => v.severity === 'High').length === 0 ? 'met' : 'missed'}">
                    ${overdueVulns.filter(v => v.severity === 'High').length === 0 ? 'ATENDIDO' : 'VIOLADO'}
                  </td>
                </tr>
                <tr>
                  <td><strong>M√©dia</strong></td>
                  <td>7 dias</td>
                  <td>${metrics?.by_severity.Medium || 0}</td>
                  <td>${overdueVulns.filter(v => v.severity === 'Medium').length}</td>
                  <td class="${overdueVulns.filter(v => v.severity === 'Medium').length === 0 ? 'met' : 'missed'}">
                    ${overdueVulns.filter(v => v.severity === 'Medium').length === 0 ? 'ATENDIDO' : 'VIOLADO'}
                  </td>
                </tr>
                <tr>
                  <td><strong>Baixa</strong></td>
                  <td>30 dias</td>
                  <td>${metrics?.by_severity.Low || 0}</td>
                  <td>${overdueVulns.filter(v => v.severity === 'Low').length}</td>
                  <td class="${overdueVulns.filter(v => v.severity === 'Low').length === 0 ? 'met' : 'missed'}">
                    ${overdueVulns.filter(v => v.severity === 'Low').length === 0 ? 'ATENDIDO' : 'VIOLADO'}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <div class="section">
            <h2 class="section-title">3. RECOMENDA√á√ïES DE MELHORIA</h2>
            <ul>
              <li><strong>Prioridade Alta:</strong> Automatizar processo de triagem de vulnerabilidades</li>
              <li><strong>Prioridade M√©dia:</strong> Implementar dashboard de SLA em tempo real</li>
              <li><strong>Prioridade Baixa:</strong> Revisar e atualizar pol√≠ticas de SLA</li>
            </ul>
          </div>
          
          <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b;">
            <p><strong>Relat√≥rio de SLA Confidencial</strong> | GRC Controller | ${timestamp}</p>
          </div>
        </div>
      </body>
      </html>
    `;
  };

  const generateGenericReport = (templateId: string, timestamp: string, dateRange: string) => {
    return `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Relat√≥rio de Vulnerabilidades</title>
        <meta charset="UTF-8">
      </head>
      <body>
        <h1>Relat√≥rio de Vulnerabilidades</h1>
        <p>Template: ${templateId}</p>
        <p>Per√≠odo: ${dateRange}</p>
        <p>Gerado em: ${timestamp}</p>
      </body>
      </html>
    `;
  };

  const formatNumber = (num: number) => {
    return new Intl.NumberFormat('pt-BR').format(num);
  };

  return (
    <div className="space-y-8">
      {/* Header */}
      <div className="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
        <div>
          <h1 className="text-4xl font-bold flex items-center gap-3">
            <FileText className="h-10 w-10 text-primary" />
            Relat√≥rios de Vulnerabilidades
          </h1>
          <p className="text-lg text-muted-foreground mt-2">
            Gere relat√≥rios profissionais com dados reais do banco de dados
          </p>
        </div>
        <div className="flex flex-wrap gap-3">
          <Select value={selectedPeriod} onValueChange={setSelectedPeriod}>
            <SelectTrigger className="w-40">
              <SelectValue />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="7">√öltimos 7 dias</SelectItem>
              <SelectItem value="30">√öltimos 30 dias</SelectItem>
              <SelectItem value="90">√öltimos 90 dias</SelectItem>
              <SelectItem value="365">√öltimo ano</SelectItem>
            </SelectContent>
          </Select>
          <Button
            variant="outline"
            size="sm"
            onClick={() => {
              setIsRefreshing(true);
              refetch().finally(() => setIsRefreshing(false));
            }}
            disabled={isRefreshing}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${isRefreshing ? 'animate-spin' : ''}`} />
            Atualizar Dados
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => navigate('/vulnerabilities')}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Voltar
          </Button>
        </div>
      </div>

      {/* Debug Info */}
      {loading && (
        <div className="text-center py-8">
          <p className="text-lg text-muted-foreground">Carregando dados...</p>
        </div>
      )}
      
      {!loading && !metrics && (
        <div className="text-center py-8">
          <p className="text-lg text-muted-foreground">Nenhuma m√©trica dispon√≠vel. Verifique se existem vulnerabilidades cadastradas.</p>
        </div>
      )}

      {/* Debug Info Removed */}
      
      {/* Real Data Metrics */}
      {metrics && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6 gap-6">
          <Card className="border-l-4 border-l-indigo-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">üìä TOTAL DE VULNERABILIDADES</p>
                  <p className="text-4xl font-bold text-indigo-600">{formatNumber(metrics.total_vulnerabilities || 0)}</p>
                  <p className="text-sm font-medium text-indigo-600">Todas as vulnerabilidades cadastradas</p>
                </div>
                <Shield className="h-12 w-12 text-indigo-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-l-4 border-l-red-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Cr√≠ticas</p>
                  <p className="text-3xl font-bold text-red-600">{metrics.by_severity.Critical}</p>
                  <p className="text-xs text-muted-foreground">Aten√ß√£o imediata</p>
                </div>
                <AlertTriangle className="h-10 w-10 text-red-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-l-4 border-l-orange-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Altas</p>
                  <p className="text-3xl font-bold text-orange-600">{metrics.by_severity.High}</p>
                  <p className="text-xs text-muted-foreground">Prioridade alta</p>
                </div>
                <Activity className="h-10 w-10 text-orange-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-l-4 border-l-green-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">SLA</p>
                  <p className="text-3xl font-bold text-green-600">{metrics.sla_compliance}%</p>
                  <p className="text-xs text-muted-foreground">Compliance</p>
                </div>
                <CheckCircle className="h-10 w-10 text-green-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-l-4 border-l-purple-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">MTTR</p>
                  <p className="text-3xl font-bold text-purple-600">{metrics.avg_resolution_time}d</p>
                  <p className="text-xs text-muted-foreground">Tempo m√©dio</p>
                </div>
                <Clock className="h-10 w-10 text-purple-500" />
              </div>
            </CardContent>
          </Card>

          <Card className="border-l-4 border-l-emerald-500">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">üî¢ TOTAL CONSOLIDADO</p>
                  <p className="text-4xl font-bold text-emerald-600">
                    {formatNumber(metrics.total_vulnerabilities || 0)}
                  </p>
                  <p className="text-sm font-medium text-emerald-600">Soma de todas as severidades</p>
                </div>
                <Shield className="h-12 w-12 text-emerald-500" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Vulnerability Severity Breakdown - NOVOS CARDS */}
      {metrics && (
        <div className="space-y-4">
          <h2 className="text-2xl font-bold text-gray-900">üìä Distribui√ß√£o por Severidade</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <Card className="border-l-4 border-l-slate-500">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Total Geral</p>
                    <p className="text-3xl font-bold text-slate-700">{formatNumber(metrics.total_vulnerabilities || 0)}</p>
                    <p className="text-xs text-muted-foreground">Todas as vulnerabilidades</p>
                  </div>
                  <Shield className="h-10 w-10 text-slate-500" />
                </div>
              </CardContent>
            </Card>

            <Card className="border-l-4 border-l-red-500">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Cr√≠ticas</p>
                    <p className="text-3xl font-bold text-red-600">{metrics.by_severity.Critical}</p>
                    <p className="text-xs text-muted-foreground">
                      {((metrics.by_severity.Critical / metrics.total_vulnerabilities) * 100).toFixed(1)}% do total
                    </p>
                  </div>
                  <AlertTriangle className="h-10 w-10 text-red-500" />
                </div>
              </CardContent>
            </Card>

            <Card className="border-l-4 border-l-orange-500">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Altas</p>
                    <p className="text-3xl font-bold text-orange-600">{metrics.by_severity.High}</p>
                    <p className="text-xs text-muted-foreground">
                      {((metrics.by_severity.High / metrics.total_vulnerabilities) * 100).toFixed(1)}% do total
                    </p>
                  </div>
                  <TrendingUp className="h-10 w-10 text-orange-500" />
                </div>
              </CardContent>
            </Card>

            <Card className="border-l-4 border-l-yellow-500">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">M√©dias</p>
                    <p className="text-3xl font-bold text-yellow-600">{metrics.by_severity.Medium}</p>
                    <p className="text-xs text-muted-foreground">
                      {((metrics.by_severity.Medium / metrics.total_vulnerabilities) * 100).toFixed(1)}% do total
                    </p>
                  </div>
                  <Activity className="h-10 w-10 text-yellow-500" />
                </div>
              </CardContent>
            </Card>

            <Card className="border-l-4 border-l-blue-500">
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-muted-foreground">Baixas</p>
                    <p className="text-3xl font-bold text-blue-600">{metrics.by_severity.Low}</p>
                    <p className="text-xs text-muted-foreground">
                      {((metrics.by_severity.Low / metrics.total_vulnerabilities) * 100).toFixed(1)}% do total
                    </p>
                  </div>
                  <CheckCircle className="h-10 w-10 text-blue-500" />
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      )}

      {/* Report Templates */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {REPORT_TEMPLATES.map((template) => (
          <Card 
            key={template.id}
            className="hover:shadow-lg transition-all duration-300 border-2 hover:border-primary/20"
          >
            <CardHeader className="pb-4">
              <div className="flex items-center gap-3">
                <div className={`p-3 rounded-lg bg-${template.color}-100`}>
                  <template.icon className={`h-6 w-6 text-${template.color}-600`} />
                </div>
                <div>
                  <CardTitle className="text-lg">{template.name}</CardTitle>
                  <Badge variant="outline" className="mt-1">
                    {template.type}
                  </Badge>
                </div>
              </div>
            </CardHeader>
            <CardContent className="space-y-4">
              <CardDescription className="text-sm leading-relaxed">
                {template.description}
              </CardDescription>
              
              <div className="space-y-3">
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Clock className="h-4 w-4" />
                  <span>Tempo estimado: {template.estimatedTime}</span>
                </div>
                
                <div className="flex items-center gap-2 text-sm text-muted-foreground">
                  <Users className="h-4 w-4" />
                  <span>Audi√™ncia: {template.audience.slice(0, 2).join(', ')}</span>
                  {template.audience.length > 2 && <span>+{template.audience.length - 2}</span>}
                </div>
              </div>

              <div className="space-y-2">
                <p className="text-sm font-medium">Principais recursos:</p>
                <div className="flex flex-wrap gap-1">
                  {template.features.slice(0, 2).map((feature, index) => (
                    <Badge key={index} variant="secondary" className="text-xs">
                      {feature}
                    </Badge>
                  ))}
                  {template.features.length > 2 && (
                    <Badge variant="secondary" className="text-xs">
                      +{template.features.length - 2}
                    </Badge>
                  )}
                </div>
              </div>

              <div className="pt-4">
                <Button 
                  className="w-full"
                  disabled={isGenerating || loading || !metrics}
                  onClick={() => handleGenerateReport(template.id)}
                >
                  {isGenerating ? (
                    <>
                      <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                      Gerando...
                    </>
                  ) : loading ? (
                    <>
                      <RefreshCw className="h-4 w-4 mr-2 animate-spin" />
                      Carregando dados...
                    </>
                  ) : !metrics ? (
                    <>
                      <AlertTriangle className="h-4 w-4 mr-2" />
                      Dados indispon√≠veis
                    </>
                  ) : (
                    <>
                      <Download className="h-4 w-4 mr-2" />
                      Gerar Relat√≥rio
                    </>
                  )}
                </Button>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Status Information */}
      {!loading && !metrics && (
        <Card className="bg-yellow-50 border-yellow-200">
          <CardContent className="p-6">
            <div className="flex items-start gap-4">
              <AlertTriangle className="h-6 w-6 text-yellow-600 mt-1" />
              <div>
                <h3 className="font-semibold text-yellow-900 mb-2">Dados n√£o dispon√≠veis</h3>
                <p className="text-sm text-yellow-800">
                  N√£o foi poss√≠vel carregar os dados de vulnerabilidades. Verifique se:
                </p>
                <ul className="text-sm text-yellow-800 mt-2 space-y-1">
                  <li>‚Ä¢ A tabela de vulnerabilidades existe no banco de dados</li>
                  <li>‚Ä¢ Existem vulnerabilidades cadastradas para este tenant</li>
                  <li>‚Ä¢ As permiss√µes de acesso est√£o configuradas corretamente</li>
                </ul>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Data Source Information */}
      <Card className="bg-blue-50 border-blue-200">
        <CardContent className="p-6">
          <div className="flex items-start gap-4">
            <Shield className="h-6 w-6 text-blue-600 mt-1" />
            <div>
              <h3 className="font-semibold text-blue-900 mb-2">üí° Sobre os Relat√≥rios</h3>
              <ul className="text-sm text-blue-800 space-y-1">
                <li>‚Ä¢ <strong>Dados Reais:</strong> Todos os relat√≥rios utilizam dados reais do banco de dados</li>
                <li>‚Ä¢ <strong>Executivo:</strong> Foque em m√©tricas de alto n√≠vel e impacto nos neg√≥cios</li>
                <li>‚Ä¢ <strong>T√©cnico:</strong> Inclui detalhes de remedia√ß√£o e evid√™ncias t√©cnicas</li>
                <li>‚Ä¢ <strong>SLA:</strong> Monitore tempos de resposta e resolu√ß√£o por severidade</li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}