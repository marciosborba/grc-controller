import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Settings, 
  Plus, 
  Edit, 
  Trash2, 
  Play, 
  Pause,
  Eye,
  Copy,
  RotateCcw,
  AlertTriangle,
  CheckCircle,
  Info,
  Zap,
  Target,
  Filter,
  ArrowRight,
  ArrowDown,
  ArrowUp,
  Shield,
  Clock,
  Users,
  Tag,
  Calendar,
  TrendingUp,
  BarChart3
} from 'lucide-react';
import { toast } from 'sonner';
import { VulnerabilitySeverity, VulnerabilityStatus, VulnerabilitySource, AssetType } from './types/vulnerability';

interface ClassificationRule {
  id: string;
  name: string;
  description: string;
  priority: number;
  enabled: boolean;
  conditions: RuleCondition[];
  actions: RuleAction[];
  created_at: Date;
  updated_at: Date;
  execution_count: number;
  last_executed: Date | null;
}

interface RuleCondition {
  id: string;
  field: string;
  operator: 'equals' | 'contains' | 'greater_than' | 'less_than' | 'in' | 'not_in' | 'starts_with' | 'ends_with';
  value: string | number | string[];
  logical_operator: 'AND' | 'OR';
}

interface RuleAction {
  id: string;
  type: 'set_severity' | 'set_priority' | 'assign_to' | 'add_tag' | 'set_due_date' | 'set_status' | 'set_business_impact';
  value: any;
  description: string;
}

interface ClassificationMetrics {
  total_rules: number;
  active_rules: number;
  total_executions: number;
  success_rate: number;
  avg_execution_time: number;
  rules_by_priority: { [key: number]: number };
  most_used_actions: { type: string; count: number }[];
}

const RULE_FIELDS = [
  { value: 'severity', label: 'Severidade', type: 'select' },
  { value: 'cvss_score', label: 'CVSS Score', type: 'number' },
  { value: 'source_type', label: 'Tipo de Fonte', type: 'select' },
  { value: 'source_tool', label: 'Ferramenta', type: 'text' },
  { value: 'asset_type', label: 'Tipo de Ativo', type: 'select' },
  { value: 'asset_name', label: 'Nome do Ativo', type: 'text' },
  { value: 'title', label: 'Título', type: 'text' },
  { value: 'description', label: 'Descrição', type: 'text' },
  { value: 'cve_id', label: 'CVE ID', type: 'text' },
  { value: 'tags', label: 'Tags', type: 'array' },
];

const OPERATORS = [
  { value: 'equals', label: 'Igual a' },
  { value: 'contains', label: 'Contém' },
  { value: 'starts_with', label: 'Inicia com' },
  { value: 'ends_with', label: 'Termina com' },
  { value: 'greater_than', label: 'Maior que' },
  { value: 'less_than', label: 'Menor que' },
  { value: 'in', label: 'Está em' },
  { value: 'not_in', label: 'Não está em' },
];

const ACTION_TYPES = [
  { value: 'set_severity', label: 'Definir Severidade', icon: AlertTriangle },
  { value: 'set_priority', label: 'Definir Prioridade', icon: TrendingUp },
  { value: 'assign_to', label: 'Atribuir a', icon: Users },
  { value: 'add_tag', label: 'Adicionar Tag', icon: Tag },
  { value: 'set_due_date', label: 'Definir Prazo', icon: Calendar },
  { value: 'set_status', label: 'Definir Status', icon: CheckCircle },
  { value: 'set_business_impact', label: 'Definir Impacto no Negócio', icon: Target },
];

export default function VulnerabilityClassification() {
  const [rules, setRules] = useState<ClassificationRule[]>([]);
  const [selectedRule, setSelectedRule] = useState<ClassificationRule | null>(null);
  const [showRuleDialog, setShowRuleDialog] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [metrics, setMetrics] = useState<ClassificationMetrics | null>(null);
  const [testResults, setTestResults] = useState<any[]>([]);
  const [showTestDialog, setShowTestDialog] = useState(false);

  // Form state for rule creation/editing
  const [ruleForm, setRuleForm] = useState({
    name: '',
    description: '',
    priority: 1,
    enabled: true,
    conditions: [] as RuleCondition[],
    actions: [] as RuleAction[]
  });

  useEffect(() => {
    loadRules();
    loadMetrics();
  }, []);

  const loadRules = async () => {
    // Simulate loading rules from API
    const mockRules: ClassificationRule[] = [
      {
        id: '1',
        name: 'Vulnerabilidades Críticas de Infraestrutura',
        description: 'Classifica vulnerabilidades críticas em servidores como alta prioridade',
        priority: 1,
        enabled: true,
        conditions: [
          {
            id: '1',
            field: 'severity',
            operator: 'equals',
            value: 'Critical',
            logical_operator: 'AND'
          },
          {
            id: '2',
            field: 'asset_type',
            operator: 'equals',
            value: 'Server',
            logical_operator: 'AND'
          }
        ],
        actions: [
          {
            id: '1',
            type: 'set_priority',
            value: 'High',
            description: 'Definir prioridade como Alta'
          },
          {
            id: '2',
            type: 'set_due_date',
            value: '24h',
            description: 'Definir prazo para 24 horas'
          }
        ],
        created_at: new Date('2024-01-15'),
        updated_at: new Date('2024-01-20'),
        execution_count: 45,
        last_executed: new Date('2024-01-20')
      },
      {
        id: '2',
        name: 'CVEs com Exploit Público',
        description: 'Prioriza vulnerabilidades com CVE que possuem exploit público',
        priority: 2,
        enabled: true,
        conditions: [
          {
            id: '3',
            field: 'cve_id',
            operator: 'contains',
            value: 'CVE-',
            logical_operator: 'AND'
          },
          {
            id: '4',
            field: 'description',
            operator: 'contains',
            value: 'exploit',
            logical_operator: 'AND'
          }
        ],
        actions: [
          {
            id: '3',
            type: 'add_tag',
            value: 'exploit-available',
            description: 'Adicionar tag exploit-available'
          },
          {
            id: '4',
            type: 'set_priority',
            value: 'Critical',
            description: 'Definir prioridade como Crítica'
          }
        ],
        created_at: new Date('2024-01-10'),
        updated_at: new Date('2024-01-18'),
        execution_count: 23,
        last_executed: new Date('2024-01-19')
      }
    ];
    setRules(mockRules);
  };

  const loadMetrics = async () => {
    // Simulate loading metrics
    const mockMetrics: ClassificationMetrics = {
      total_rules: 8,
      active_rules: 6,
      total_executions: 234,
      success_rate: 94.5,
      avg_execution_time: 0.8,
      rules_by_priority: { 1: 3, 2: 2, 3: 2, 4: 1 },
      most_used_actions: [
        { type: 'set_priority', count: 89 },
        { type: 'add_tag', count: 67 },
        { type: 'assign_to', count: 45 },
        { type: 'set_due_date', count: 33 }
      ]
    };
    setMetrics(mockMetrics);
  };

  const handleCreateRule = () => {
    setRuleForm({
      name: '',
      description: '',
      priority: 1,
      enabled: true,
      conditions: [],
      actions: []
    });
    setIsEditing(false);
    setShowRuleDialog(true);
  };

  const handleEditRule = (rule: ClassificationRule) => {
    setRuleForm({
      name: rule.name,
      description: rule.description,
      priority: rule.priority,
      enabled: rule.enabled,
      conditions: rule.conditions,
      actions: rule.actions
    });
    setSelectedRule(rule);
    setIsEditing(true);
    setShowRuleDialog(true);
  };

  const handleSaveRule = async () => {
    if (!ruleForm.name.trim()) {
      toast.error('Nome da regra é obrigatório');
      return;
    }

    if (ruleForm.conditions.length === 0) {
      toast.error('Adicione pelo menos uma condição');
      return;
    }

    if (ruleForm.actions.length === 0) {
      toast.error('Adicione pelo menos uma ação');
      return;
    }

    try {
      if (isEditing && selectedRule) {
        // Update existing rule
        const updatedRule = {
          ...selectedRule,
          ...ruleForm,
          updated_at: new Date()
        };
        setRules(prev => prev.map(r => r.id === selectedRule.id ? updatedRule : r));
        toast.success('Regra atualizada com sucesso');
      } else {
        // Create new rule
        const newRule: ClassificationRule = {
          id: Date.now().toString(),
          ...ruleForm,
          created_at: new Date(),
          updated_at: new Date(),
          execution_count: 0,
          last_executed: null
        };
        setRules(prev => [...prev, newRule]);
        toast.success('Regra criada com sucesso');
      }
      
      setShowRuleDialog(false);
      await loadMetrics();
    } catch (error) {
      toast.error('Erro ao salvar regra');
    }
  };

  const handleDeleteRule = async (ruleId: string) => {
    if (confirm('Tem certeza que deseja excluir esta regra?')) {
      setRules(prev => prev.filter(r => r.id !== ruleId));
      toast.success('Regra excluída com sucesso');
      await loadMetrics();
    }
  };

  const handleToggleRule = async (ruleId: string, enabled: boolean) => {
    setRules(prev => prev.map(r => 
      r.id === ruleId ? { ...r, enabled, updated_at: new Date() } : r
    ));
    toast.success(`Regra ${enabled ? 'ativada' : 'desativada'} com sucesso`);
  };

  const handleTestRule = async (rule: ClassificationRule) => {
    // Simulate testing rule against sample data
    const mockResults = [
      {
        vulnerability: {
          title: 'SQL Injection in Login Form',
          severity: 'Critical',
          asset_type: 'Server',
          source_type: 'DAST'
        },
        matched: true,
        actions_applied: ['set_priority: High', 'set_due_date: 24h']
      },
      {
        vulnerability: {
          title: 'XSS in Contact Form',
          severity: 'Medium',
          asset_type: 'Web_Application',
          source_type: 'DAST'
        },
        matched: false,
        actions_applied: []
      }
    ];
    
    setTestResults(mockResults);
    setSelectedRule(rule);
    setShowTestDialog(true);
  };

  const addCondition = () => {
    const newCondition: RuleCondition = {
      id: Date.now().toString(),
      field: 'severity',
      operator: 'equals',
      value: '',
      logical_operator: 'AND'
    };
    setRuleForm(prev => ({
      ...prev,
      conditions: [...prev.conditions, newCondition]
    }));
  };

  const updateCondition = (index: number, updates: Partial<RuleCondition>) => {
    setRuleForm(prev => ({
      ...prev,
      conditions: prev.conditions.map((condition, i) => 
        i === index ? { ...condition, ...updates } : condition
      )
    }));
  };

  const removeCondition = (index: number) => {
    setRuleForm(prev => ({
      ...prev,
      conditions: prev.conditions.filter((_, i) => i !== index)
    }));
  };

  const addAction = () => {
    const newAction: RuleAction = {
      id: Date.now().toString(),
      type: 'set_severity',
      value: '',
      description: ''
    };
    setRuleForm(prev => ({
      ...prev,
      actions: [...prev.actions, newAction]
    }));
  };

  const updateAction = (index: number, updates: Partial<RuleAction>) => {
    setRuleForm(prev => ({
      ...prev,
      actions: prev.actions.map((action, i) => 
        i === index ? { ...action, ...updates } : action
      )
    }));
  };

  const removeAction = (index: number) => {
    setRuleForm(prev => ({
      ...prev,
      actions: prev.actions.filter((_, i) => i !== index)
    }));
  };

  const getPriorityBadge = (priority: number) => {
    const colors = {
      1: 'bg-red-100 text-red-800',
      2: 'bg-orange-100 text-orange-800',
      3: 'bg-yellow-100 text-yellow-800',
      4: 'bg-blue-100 text-blue-800',
    };
    return (
      <Badge className={colors[priority as keyof typeof colors] || 'bg-gray-100 text-gray-800'}>
        Prioridade {priority}
      </Badge>
    );
  };

  const getActionIcon = (actionType: string) => {
    const action = ACTION_TYPES.find(a => a.value === actionType);
    const IconComponent = action?.icon || Settings;
    return <IconComponent className="h-4 w-4" />;
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Settings className="h-8 w-8 text-primary" />
            Classificação de Vulnerabilidades
          </h1>
          <p className="text-muted-foreground">
            Configure regras automáticas para classificação e priorização
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline">
            <Play className="h-4 w-4 mr-2" />
            Executar Todas
          </Button>
          <Button onClick={handleCreateRule}>
            <Plus className="h-4 w-4 mr-2" />
            Nova Regra
          </Button>
        </div>
      </div>

      {/* Metrics Cards */}
      {metrics && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Total de Regras</p>
                  <p className="text-2xl font-bold">{metrics.total_rules}</p>
                  <p className="text-xs text-muted-foreground">
                    {metrics.active_rules} ativas
                  </p>
                </div>
                <Settings className="h-10 w-10 text-blue-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Execuções</p>
                  <p className="text-2xl font-bold">{metrics.total_executions}</p>
                  <p className="text-xs text-muted-foreground flex items-center">
                    <TrendingUp className="h-3 w-3 mr-1 text-green-600" />
                    {metrics.success_rate}% sucesso
                  </p>
                </div>
                <Play className="h-10 w-10 text-green-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Tempo Médio</p>
                  <p className="text-2xl font-bold">{metrics.avg_execution_time}s</p>
                  <p className="text-xs text-muted-foreground">
                    Por execução
                  </p>
                </div>
                <Clock className="h-10 w-10 text-orange-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-muted-foreground">Ação Mais Usada</p>
                  <p className="text-lg font-bold">{metrics.most_used_actions[0]?.type.replace('_', ' ')}</p>
                  <p className="text-xs text-muted-foreground">
                    {metrics.most_used_actions[0]?.count} vezes
                  </p>
                </div>
                <Zap className="h-10 w-10 text-purple-600" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      <Tabs defaultValue="rules" className="w-full">
        <TabsList>
          <TabsTrigger value="rules">Regras</TabsTrigger>
          <TabsTrigger value="analytics">Analytics</TabsTrigger>
          <TabsTrigger value="templates">Templates</TabsTrigger>
        </TabsList>

        <TabsContent value="rules" className="space-y-6">
          {/* Rules List */}
          <Card>
            <CardHeader>
              <CardTitle>Regras de Classificação</CardTitle>
              <CardDescription>
                Gerencie as regras automáticas de classificação de vulnerabilidades
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {rules.map((rule) => (
                  <div key={rule.id} className="border rounded-lg p-4 hover:bg-muted/50 transition-colors">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-2">
                          <h3 className="font-semibold">{rule.name}</h3>
                          {getPriorityBadge(rule.priority)}
                          <Badge variant={rule.enabled ? 'default' : 'secondary'}>
                            {rule.enabled ? 'Ativa' : 'Inativa'}
                          </Badge>
                        </div>
                        <p className="text-sm text-muted-foreground mb-3">{rule.description}</p>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                          <div>
                            <p className="font-medium mb-1">Condições ({rule.conditions.length})</p>
                            <div className="space-y-1">
                              {rule.conditions.slice(0, 2).map((condition, index) => (
                                <p key={condition.id} className="text-muted-foreground">
                                  {index > 0 && `${condition.logical_operator} `}
                                  {condition.field} {condition.operator} {String(condition.value)}
                                </p>
                              ))}
                              {rule.conditions.length > 2 && (
                                <p className="text-muted-foreground">
                                  +{rule.conditions.length - 2} mais...
                                </p>
                              )}
                            </div>
                          </div>
                          
                          <div>
                            <p className="font-medium mb-1">Ações ({rule.actions.length})</p>
                            <div className="space-y-1">
                              {rule.actions.slice(0, 2).map((action) => (
                                <div key={action.id} className="flex items-center gap-2 text-muted-foreground">
                                  {getActionIcon(action.type)}
                                  <span>{action.description || `${action.type}: ${action.value}`}</span>
                                </div>
                              ))}
                              {rule.actions.length > 2 && (
                                <p className="text-muted-foreground">
                                  +{rule.actions.length - 2} mais...
                                </p>
                              )}
                            </div>
                          </div>
                        </div>

                        <div className="flex items-center gap-4 mt-3 text-xs text-muted-foreground">
                          <span>Executada {rule.execution_count} vezes</span>
                          {rule.last_executed && (
                            <span>Última execução: {rule.last_executed.toLocaleDateString()}</span>
                          )}
                        </div>
                      </div>

                      <div className="flex items-center gap-2 ml-4">
                        <Switch
                          checked={rule.enabled}
                          onCheckedChange={(enabled) => handleToggleRule(rule.id, enabled)}
                        />
                        <Button variant="ghost" size="sm" onClick={() => handleTestRule(rule)}>
                          <Play className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="sm" onClick={() => handleEditRule(rule)}>
                          <Edit className="h-4 w-4" />
                        </Button>
                        <Button 
                          variant="ghost" 
                          size="sm" 
                          onClick={() => handleDeleteRule(rule.id)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </div>
                ))}

                {rules.length === 0 && (
                  <div className="text-center py-8 text-muted-foreground">
                    <Settings className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p className="mb-4">Nenhuma regra configurada</p>
                    <Button onClick={handleCreateRule}>
                      <Plus className="h-4 w-4 mr-2" />
                      Criar Primeira Regra
                    </Button>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="analytics">
          <Card>
            <CardHeader>
              <CardTitle>Analytics de Classificação</CardTitle>
              <CardDescription>
                Análise de performance e eficácia das regras
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="text-center py-8 text-muted-foreground">
                <BarChart3 className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Analytics em desenvolvimento</p>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="templates">
          <Card>
            <CardHeader>
              <CardTitle>Templates de Regras</CardTitle>
              <CardDescription>
                Templates pré-configurados para diferentes cenários
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="text-center py-8 text-muted-foreground">
                <Copy className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Templates em desenvolvimento</p>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Rule Creation/Edit Dialog */}
      <Dialog open={showRuleDialog} onOpenChange={setShowRuleDialog}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {isEditing ? 'Editar Regra' : 'Nova Regra de Classificação'}
            </DialogTitle>
            <DialogDescription>
              Configure as condições e ações para classificação automática
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-6">
            {/* Basic Info */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Nome da Regra</Label>
                <Input
                  value={ruleForm.name}
                  onChange={(e) => setRuleForm(prev => ({ ...prev, name: e.target.value }))}
                  placeholder="Ex: Vulnerabilidades Críticas de Produção"
                />
              </div>
              <div className="space-y-2">
                <Label>Prioridade</Label>
                <Select 
                  value={ruleForm.priority.toString()} 
                  onValueChange={(value) => setRuleForm(prev => ({ ...prev, priority: parseInt(value) }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">1 - Mais Alta</SelectItem>
                    <SelectItem value="2">2 - Alta</SelectItem>
                    <SelectItem value="3">3 - Média</SelectItem>
                    <SelectItem value="4">4 - Baixa</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="space-y-2">
              <Label>Descrição</Label>
              <Textarea
                value={ruleForm.description}
                onChange={(e) => setRuleForm(prev => ({ ...prev, description: e.target.value }))}
                placeholder="Descreva o propósito desta regra..."
              />
            </div>

            <div className="flex items-center space-x-2">
              <Switch
                checked={ruleForm.enabled}
                onCheckedChange={(enabled) => setRuleForm(prev => ({ ...prev, enabled }))}
              />
              <Label>Regra ativa</Label>
            </div>

            {/* Conditions */}
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold">Condições</h3>
                <Button variant="outline" size="sm" onClick={addCondition}>
                  <Plus className="h-4 w-4 mr-2" />
                  Adicionar Condição
                </Button>
              </div>

              {ruleForm.conditions.map((condition, index) => (
                <div key={condition.id} className="border rounded-lg p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h4 className="font-medium">Condição {index + 1}</h4>
                    <Button 
                      variant="ghost" 
                      size="sm" 
                      onClick={() => removeCondition(index)}
                      className="text-red-600"
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    {index > 0 && (
                      <div className="space-y-2">
                        <Label>Operador Lógico</Label>
                        <Select 
                          value={condition.logical_operator} 
                          onValueChange={(value) => updateCondition(index, { logical_operator: value as 'AND' | 'OR' })}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            <SelectItem value="AND">E (AND)</SelectItem>
                            <SelectItem value="OR">OU (OR)</SelectItem>
                          </SelectContent>
                        </Select>
                      </div>
                    )}

                    <div className="space-y-2">
                      <Label>Campo</Label>
                      <Select 
                        value={condition.field} 
                        onValueChange={(value) => updateCondition(index, { field: value })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {RULE_FIELDS.map(field => (
                            <SelectItem key={field.value} value={field.value}>
                              {field.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label>Operador</Label>
                      <Select 
                        value={condition.operator} 
                        onValueChange={(value) => updateCondition(index, { operator: value as any })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {OPERATORS.map(op => (
                            <SelectItem key={op.value} value={op.value}>
                              {op.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label>Valor</Label>
                      <Input
                        value={String(condition.value)}
                        onChange={(e) => updateCondition(index, { value: e.target.value })}
                        placeholder="Valor da condição"
                      />
                    </div>
                  </div>
                </div>
              ))}

              {ruleForm.conditions.length === 0 && (
                <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                  <Filter className="h-8 w-8 mx-auto mb-2 opacity-50" />
                  <p>Adicione condições para definir quando a regra deve ser aplicada</p>
                </div>
              )}
            </div>

            {/* Actions */}
            <div className="space-y-4">
              <div className="flex items-center justify-between">
                <h3 className="text-lg font-semibold">Ações</h3>
                <Button variant="outline" size="sm" onClick={addAction}>
                  <Plus className="h-4 w-4 mr-2" />
                  Adicionar Ação
                </Button>
              </div>

              {ruleForm.actions.map((action, index) => (
                <div key={action.id} className="border rounded-lg p-4 space-y-4">
                  <div className="flex items-center justify-between">
                    <h4 className="font-medium">Ação {index + 1}</h4>
                    <Button 
                      variant="ghost" 
                      size="sm" 
                      onClick={() => removeAction(index)}
                      className="text-red-600"
                    >
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div className="space-y-2">
                      <Label>Tipo de Ação</Label>
                      <Select 
                        value={action.type} 
                        onValueChange={(value) => updateAction(index, { type: value as any })}
                      >
                        <SelectTrigger>
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          {ACTION_TYPES.map(actionType => (
                            <SelectItem key={actionType.value} value={actionType.value}>
                              <div className="flex items-center gap-2">
                                <actionType.icon className="h-4 w-4" />
                                {actionType.label}
                              </div>
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    </div>

                    <div className="space-y-2">
                      <Label>Valor</Label>
                      <Input
                        value={String(action.value)}
                        onChange={(e) => updateAction(index, { value: e.target.value })}
                        placeholder="Valor da ação"
                      />
                    </div>

                    <div className="space-y-2">
                      <Label>Descrição</Label>
                      <Input
                        value={action.description}
                        onChange={(e) => updateAction(index, { description: e.target.value })}
                        placeholder="Descrição da ação"
                      />
                    </div>
                  </div>
                </div>
              ))}

              {ruleForm.actions.length === 0 && (
                <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                  <Zap className="h-8 w-8 mx-auto mb-2 opacity-50" />
                  <p>Adicione ações que serão executadas quando as condições forem atendidas</p>
                </div>
              )}
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowRuleDialog(false)}>
              Cancelar
            </Button>
            <Button onClick={handleSaveRule}>
              {isEditing ? 'Atualizar' : 'Criar'} Regra
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      {/* Test Results Dialog */}
      <Dialog open={showTestDialog} onOpenChange={setShowTestDialog}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Resultado do Teste</DialogTitle>
            <DialogDescription>
              Resultado da execução da regra "{selectedRule?.name}" contra dados de exemplo
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {testResults.map((result, index) => (
              <div key={index} className="border rounded-lg p-4">
                <div className="flex items-center justify-between mb-2">
                  <h4 className="font-medium">{result.vulnerability.title}</h4>
                  <Badge className={result.matched ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}>
                    {result.matched ? 'Corresponde' : 'Não corresponde'}
                  </Badge>
                </div>
                <div className="text-sm text-muted-foreground space-y-1">
                  <p>Severidade: {result.vulnerability.severity}</p>
                  <p>Tipo de Ativo: {result.vulnerability.asset_type}</p>
                  <p>Fonte: {result.vulnerability.source_type}</p>
                </div>
                {result.matched && result.actions_applied.length > 0 && (
                  <div className="mt-3">
                    <p className="text-sm font-medium mb-1">Ações aplicadas:</p>
                    <div className="space-y-1">
                      {result.actions_applied.map((action: string, actionIndex: number) => (
                        <p key={actionIndex} className="text-sm text-green-600">• {action}</p>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            ))}
          </div>

          <DialogFooter>
            <Button onClick={() => setShowTestDialog(false)}>Fechar</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}