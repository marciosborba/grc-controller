import React, { useState, useMemo } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { 
  Search, 
  Filter, 
  Plus, 
  Edit, 
  Trash2, 
  Eye, 
  Download, 
  Upload,
  MoreHorizontal,
  AlertTriangle,
  CheckCircle,
  Clock,
  User,
  Calendar,
  Tag,
  ExternalLink,
  FileText,
  MessageSquare,
  History,
  Shield,
  Bug,
  Server,
  Globe,
  Smartphone,
  Database,
  Cloud,
  Monitor,
  Users,
  Target,
  ArrowUpDown,
  ChevronLeft,
  ChevronRight
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { useVulnerabilities } from './hooks/useVulnerabilities';
import { 
  Vulnerability, 
  VulnerabilitySeverity, 
  VulnerabilityStatus, 
  VulnerabilitySource,
  VulnerabilityFilter 
} from './types/vulnerability';
import { toast } from 'sonner';

const SEVERITY_COLORS = {
  Critical: 'bg-red-100 text-red-800 border-red-200',
  High: 'bg-orange-100 text-orange-800 border-orange-200',
  Medium: 'bg-yellow-100 text-yellow-800 border-yellow-200',
  Low: 'bg-blue-100 text-blue-800 border-blue-200',
  Info: 'bg-gray-100 text-gray-800 border-gray-200',
};

const STATUS_COLORS = {
  Open: 'bg-red-100 text-red-800',
  In_Progress: 'bg-yellow-100 text-yellow-800',
  Testing: 'bg-blue-100 text-blue-800',
  Resolved: 'bg-green-100 text-green-800',
  Accepted: 'bg-gray-100 text-gray-800',
  False_Positive: 'bg-gray-100 text-gray-800',
  Duplicate: 'bg-gray-100 text-gray-800',
};

const SOURCE_ICONS = {
  Pentest: Bug,
  SAST: FileText,
  DAST: Globe,
  Cloud: Cloud,
  Infrastructure: Server,
  Manual: Users,
  Risk_Register: Shield,
  Bug_Bounty: Target,
  Compliance_Audit: CheckCircle,
};

export default function VulnerabilityManagement() {
  const navigate = useNavigate();
  
  // State for filters and pagination
  const [filters, setFilters] = useState<VulnerabilityFilter>({});
  const [page, setPage] = useState(1);
  const [limit] = useState(25);
  const [sortBy, setSortBy] = useState<keyof Vulnerability>('created_at');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  
  // State for UI
  const [selectedVulnerabilities, setSelectedVulnerabilities] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(false);
  const [selectedVulnerability, setSelectedVulnerability] = useState<Vulnerability | null>(null);
  const [showDetails, setShowDetails] = useState(false);
  const [showBulkActions, setShowBulkActions] = useState(false);
  
  // Load vulnerabilities with current filters
  const { 
    vulnerabilities, 
    loading, 
    totalCount, 
    updateVulnerability, 
    bulkUpdateVulnerabilities,
    deleteVulnerability,
    refetch 
  } = useVulnerabilities({
    filters,
    page,
    limit,
    sortBy,
    sortOrder
  });

  const totalPages = Math.ceil(totalCount / limit);

  // Handle filter changes
  const handleFilterChange = (key: keyof VulnerabilityFilter, value: any) => {
    setFilters(prev => ({ ...prev, [key]: value }));
    setPage(1); // Reset to first page when filters change
  };

  // Handle sorting
  const handleSort = (field: keyof Vulnerability) => {
    if (sortBy === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(field);
      setSortOrder('desc');
    }
  };

  // Handle selection
  const handleSelectVulnerability = (id: string) => {
    setSelectedVulnerabilities(prev => 
      prev.includes(id) 
        ? prev.filter(selectedId => selectedId !== id)
        : [...prev, id]
    );
  };

  const handleSelectAll = () => {
    if (selectedVulnerabilities.length === vulnerabilities.length) {
      setSelectedVulnerabilities([]);
    } else {
      setSelectedVulnerabilities(vulnerabilities.map(v => v.id));
    }
  };

  // Handle bulk actions
  const handleBulkStatusUpdate = async (status: VulnerabilityStatus) => {
    if (selectedVulnerabilities.length === 0) return;
    
    const success = await bulkUpdateVulnerabilities(selectedVulnerabilities, { status });
    if (success) {
      setSelectedVulnerabilities([]);
      setShowBulkActions(false);
    }
  };

  const handleBulkAssignment = async (assignedTo: string) => {
    if (selectedVulnerabilities.length === 0) return;
    
    const success = await bulkUpdateVulnerabilities(selectedVulnerabilities, { assigned_to: assignedTo });
    if (success) {
      setSelectedVulnerabilities([]);
      setShowBulkActions(false);
    }
  };

  // Handle individual actions
  const handleStatusUpdate = async (vulnerability: Vulnerability, status: VulnerabilityStatus) => {
    await updateVulnerability(vulnerability.id, { status });
  };

  const handleAssignment = async (vulnerability: Vulnerability, assignedTo: string) => {
    await updateVulnerability(vulnerability.id, { assigned_to: assignedTo });
  };

  const handleDelete = async (vulnerability: Vulnerability) => {
    if (confirm(`Tem certeza que deseja excluir a vulnerabilidade "${vulnerability.title}"?`)) {
      await deleteVulnerability(vulnerability.id);
    }
  };

  // Get severity badge
  const getSeverityBadge = (severity: VulnerabilitySeverity) => (
    <Badge className={SEVERITY_COLORS[severity]}>{severity}</Badge>
  );

  // Get status badge
  const getStatusBadge = (status: VulnerabilityStatus) => (
    <Badge className={STATUS_COLORS[status]}>{status.replace('_', ' ')}</Badge>
  );

  // Get source icon
  const getSourceIcon = (source: VulnerabilitySource) => {
    const IconComponent = SOURCE_ICONS[source] || Bug;
    return <IconComponent className="h-4 w-4" />;
  };

  // Calculate days overdue
  const getDaysOverdue = (dueDate: Date | undefined) => {
    if (!dueDate) return null;
    const now = new Date();
    const due = new Date(dueDate);
    const diffTime = now.getTime() - due.getTime();
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays > 0 ? diffDays : null;
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Shield className="h-8 w-8 text-primary" />
            Gestão de Vulnerabilidades
          </h1>
          <p className="text-muted-foreground">
            {totalCount} vulnerabilidades encontradas
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => setShowFilters(!showFilters)}>
            <Filter className="h-4 w-4 mr-2" />
            Filtros
          </Button>
          <Button variant="outline" onClick={() => navigate('/vulnerabilities/import')}>
            <Upload className="h-4 w-4 mr-2" />
            Importar
          </Button>
          <Button onClick={() => navigate('/vulnerabilities/create')}>
            <Plus className="h-4 w-4 mr-2" />
            Nova Vulnerabilidade
          </Button>
        </div>
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <Card>
          <CardHeader>
            <CardTitle>Filtros</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {/* Search */}
              <div className="space-y-2">
                <Label>Buscar</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="Título, descrição, ativo..."
                    value={filters.search || ''}
                    onChange={(e) => handleFilterChange('search', e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>

              {/* Severity */}
              <div className="space-y-2">
                <Label>Severidade</Label>
                <Select 
                  value={filters.severity?.[0] || ''} 
                  onValueChange={(value) => handleFilterChange('severity', value ? [value] : undefined)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todas" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">Todas</SelectItem>
                    <SelectItem value="Critical">Critical</SelectItem>
                    <SelectItem value="High">High</SelectItem>
                    <SelectItem value="Medium">Medium</SelectItem>
                    <SelectItem value="Low">Low</SelectItem>
                    <SelectItem value="Info">Info</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Status */}
              <div className="space-y-2">
                <Label>Status</Label>
                <Select 
                  value={filters.status?.[0] || ''} 
                  onValueChange={(value) => handleFilterChange('status', value ? [value] : undefined)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todos" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">Todos</SelectItem>
                    <SelectItem value="Open">Open</SelectItem>
                    <SelectItem value="In_Progress">In Progress</SelectItem>
                    <SelectItem value="Testing">Testing</SelectItem>
                    <SelectItem value="Resolved">Resolved</SelectItem>
                    <SelectItem value="Accepted">Accepted</SelectItem>
                    <SelectItem value="False_Positive">False Positive</SelectItem>
                  </SelectContent>
                </Select>
              </div>

              {/* Source */}
              <div className="space-y-2">
                <Label>Fonte</Label>
                <Select 
                  value={filters.source_type?.[0] || ''} 
                  onValueChange={(value) => handleFilterChange('source_type', value ? [value] : undefined)}
                >
                  <SelectTrigger>
                    <SelectValue placeholder="Todas" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="">Todas</SelectItem>
                    <SelectItem value="Pentest">Pentest</SelectItem>
                    <SelectItem value="SAST">SAST</SelectItem>
                    <SelectItem value="DAST">DAST</SelectItem>
                    <SelectItem value="Cloud">Cloud</SelectItem>
                    <SelectItem value="Infrastructure">Infrastructure</SelectItem>
                    <SelectItem value="Manual">Manual</SelectItem>
                    <SelectItem value="Risk_Register">Risk Register</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Bulk Actions */}
      {selectedVulnerabilities.length > 0 && (
        <Card className="border-blue-200 bg-blue-50">
          <CardContent className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <Checkbox 
                  checked={selectedVulnerabilities.length === vulnerabilities.length}
                  onCheckedChange={handleSelectAll}
                />
                <span className="font-medium">
                  {selectedVulnerabilities.length} vulnerabilidades selecionadas
                </span>
              </div>
              <div className="flex items-center gap-2">
                <Select onValueChange={handleBulkStatusUpdate}>
                  <SelectTrigger className="w-40">
                    <SelectValue placeholder="Alterar status" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="In_Progress">In Progress</SelectItem>
                    <SelectItem value="Testing">Testing</SelectItem>
                    <SelectItem value="Resolved">Resolved</SelectItem>
                    <SelectItem value="False_Positive">False Positive</SelectItem>
                  </SelectContent>
                </Select>
                <Button variant="outline" size="sm">
                  <User className="h-4 w-4 mr-2" />
                  Atribuir
                </Button>
                <Button variant="outline" size="sm">
                  <Download className="h-4 w-4 mr-2" />
                  Exportar
                </Button>
                <Button 
                  variant="ghost" 
                  size="sm"
                  onClick={() => setSelectedVulnerabilities([])}
                >
                  Cancelar
                </Button>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Vulnerabilities Table */}
      <Card>
        <CardContent className="p-0">
          <div className="overflow-x-auto">
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="w-12">
                    <Checkbox 
                      checked={selectedVulnerabilities.length === vulnerabilities.length && vulnerabilities.length > 0}
                      onCheckedChange={handleSelectAll}
                    />
                  </TableHead>
                  <TableHead className="cursor-pointer" onClick={() => handleSort('severity')}>
                    <div className="flex items-center gap-1">
                      Severidade
                      <ArrowUpDown className="h-4 w-4" />
                    </div>
                  </TableHead>
                  <TableHead className="cursor-pointer" onClick={() => handleSort('title')}>
                    <div className="flex items-center gap-1">
                      Título
                      <ArrowUpDown className="h-4 w-4" />
                    </div>
                  </TableHead>
                  <TableHead>Ativo</TableHead>
                  <TableHead>Fonte</TableHead>
                  <TableHead className="cursor-pointer" onClick={() => handleSort('status')}>
                    <div className="flex items-center gap-1">
                      Status
                      <ArrowUpDown className="h-4 w-4" />
                    </div>
                  </TableHead>
                  <TableHead>Responsável</TableHead>
                  <TableHead className="cursor-pointer" onClick={() => handleSort('created_at')}>
                    <div className="flex items-center gap-1">
                      Criado em
                      <ArrowUpDown className="h-4 w-4" />
                    </div>
                  </TableHead>
                  <TableHead>SLA</TableHead>
                  <TableHead className="w-12">Ações</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {loading ? (
                  <TableRow>
                    <TableCell colSpan={10} className="text-center py-8">
                      <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-primary mx-auto"></div>
                    </TableCell>
                  </TableRow>
                ) : vulnerabilities.length === 0 ? (
                  <TableRow>
                    <TableCell colSpan={10} className="text-center py-8 text-muted-foreground">
                      <Shield className="h-12 w-12 mx-auto mb-4 opacity-50" />
                      <p>Nenhuma vulnerabilidade encontrada</p>
                    </TableCell>
                  </TableRow>
                ) : (
                  vulnerabilities.map((vulnerability) => {
                    const daysOverdue = getDaysOverdue(vulnerability.due_date);
                    
                    return (
                      <TableRow 
                        key={vulnerability.id}
                        className={`hover:bg-muted/50 ${selectedVulnerabilities.includes(vulnerability.id) ? 'bg-blue-50' : ''}`}
                      >
                        <TableCell>
                          <Checkbox 
                            checked={selectedVulnerabilities.includes(vulnerability.id)}
                            onCheckedChange={() => handleSelectVulnerability(vulnerability.id)}
                          />
                        </TableCell>
                        <TableCell>
                          {getSeverityBadge(vulnerability.severity)}
                        </TableCell>
                        <TableCell>
                          <div className="max-w-xs">
                            <p className="font-medium truncate">{vulnerability.title}</p>
                            {vulnerability.cve_id && (
                              <p className="text-xs text-muted-foreground">{vulnerability.cve_id}</p>
                            )}
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center gap-2">
                            {getSourceIcon(vulnerability.source_type)}
                            <span className="text-sm">{vulnerability.asset_name}</span>
                          </div>
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center gap-2">
                            {getSourceIcon(vulnerability.source_type)}
                            <span className="text-sm">{vulnerability.source_type}</span>
                          </div>
                        </TableCell>
                        <TableCell>
                          {getStatusBadge(vulnerability.status)}
                        </TableCell>
                        <TableCell>
                          {vulnerability.assigned_to ? (
                            <div className="flex items-center gap-2">
                              <User className="h-4 w-4 text-muted-foreground" />
                              <span className="text-sm">{vulnerability.assigned_to}</span>
                            </div>
                          ) : (
                            <span className="text-sm text-muted-foreground">Não atribuído</span>
                          )}
                        </TableCell>
                        <TableCell>
                          <span className="text-sm text-muted-foreground">
                            {new Date(vulnerability.created_at).toLocaleDateString()}
                          </span>
                        </TableCell>
                        <TableCell>
                          {daysOverdue ? (
                            <Badge className="bg-red-100 text-red-800">
                              <Clock className="h-3 w-3 mr-1" />
                              {daysOverdue}d atrasado
                            </Badge>
                          ) : vulnerability.sla_breach ? (
                            <Badge className="bg-orange-100 text-orange-800">
                              <AlertTriangle className="h-3 w-3 mr-1" />
                              SLA violado
                            </Badge>
                          ) : (
                            <Badge className="bg-green-100 text-green-800">
                              <CheckCircle className="h-3 w-3 mr-1" />
                              No prazo
                            </Badge>
                          )}
                        </TableCell>
                        <TableCell>
                          <div className="flex items-center gap-1">
                            <Button 
                              variant="ghost" 
                              size="sm"
                              onClick={() => {
                                setSelectedVulnerability(vulnerability);
                                setShowDetails(true);
                              }}
                            >
                              <Eye className="h-4 w-4" />
                            </Button>
                            <Button 
                              variant="ghost" 
                              size="sm"
                              onClick={() => navigate(`/vulnerabilities/edit/${vulnerability.id}`)}
                            >
                              <Edit className="h-4 w-4" />
                            </Button>
                          </div>
                        </TableCell>
                      </TableRow>
                    );
                  })
                )}
              </TableBody>
            </Table>
          </div>
        </CardContent>
      </Card>

      {/* Pagination */}
      {totalPages > 1 && (
        <div className="flex items-center justify-between">
          <p className="text-sm text-muted-foreground">
            Mostrando {(page - 1) * limit + 1} a {Math.min(page * limit, totalCount)} de {totalCount} vulnerabilidades
          </p>
          <div className="flex items-center gap-2">
            <Button 
              variant="outline" 
              size="sm"
              onClick={() => setPage(page - 1)}
              disabled={page === 1}
            >
              <ChevronLeft className="h-4 w-4" />
              Anterior
            </Button>
            <span className="text-sm">
              Página {page} de {totalPages}
            </span>
            <Button 
              variant="outline" 
              size="sm"
              onClick={() => setPage(page + 1)}
              disabled={page === totalPages}
            >
              Próxima
              <ChevronRight className="h-4 w-4" />
            </Button>
          </div>
        </div>
      )}

      {/* Vulnerability Details Modal */}
      <Dialog open={showDetails} onOpenChange={setShowDetails}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              <Shield className="h-5 w-5" />
              Detalhes da Vulnerabilidade
            </DialogTitle>
          </DialogHeader>
          
          {selectedVulnerability && (
            <div className="space-y-6">
              {/* Header Info */}
              <div className="flex items-start justify-between">
                <div className="space-y-2">
                  <h3 className="text-lg font-semibold">{selectedVulnerability.title}</h3>
                  <div className="flex items-center gap-2">
                    {getSeverityBadge(selectedVulnerability.severity)}
                    {getStatusBadge(selectedVulnerability.status)}
                    {selectedVulnerability.cvss_score && (
                      <Badge variant="outline">
                        CVSS: {selectedVulnerability.cvss_score}
                      </Badge>
                    )}
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button variant="outline" size="sm">
                    <Edit className="h-4 w-4 mr-2" />
                    Editar
                  </Button>
                  <Button variant="outline" size="sm">
                    <MessageSquare className="h-4 w-4 mr-2" />
                    Comentar
                  </Button>
                </div>
              </div>

              <Tabs defaultValue="details" className="w-full">
                <TabsList>
                  <TabsTrigger value="details">Detalhes</TabsTrigger>
                  <TabsTrigger value="evidence">Evidências</TabsTrigger>
                  <TabsTrigger value="remediation">Remediação</TabsTrigger>
                  <TabsTrigger value="history">Histórico</TabsTrigger>
                </TabsList>

                <TabsContent value="details" className="space-y-4">
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <Label className="text-sm font-medium">Ativo</Label>
                      <p className="text-sm">{selectedVulnerability.asset_name}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Fonte</Label>
                      <p className="text-sm">{selectedVulnerability.source_type}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Ferramenta</Label>
                      <p className="text-sm">{selectedVulnerability.source_tool}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium">Responsável</Label>
                      <p className="text-sm">{selectedVulnerability.assigned_to || 'Não atribuído'}</p>
                    </div>
                  </div>
                  
                  <div>
                    <Label className="text-sm font-medium">Descrição</Label>
                    <p className="text-sm mt-1">{selectedVulnerability.description}</p>
                  </div>

                  {selectedVulnerability.cve_id && (
                    <div>
                      <Label className="text-sm font-medium">CVE</Label>
                      <div className="flex items-center gap-2 mt-1">
                        <p className="text-sm">{selectedVulnerability.cve_id}</p>
                        <Button variant="ghost" size="sm">
                          <ExternalLink className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  )}
                </TabsContent>

                <TabsContent value="evidence">
                  <div className="text-center py-8 text-muted-foreground">
                    <FileText className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p>Nenhuma evidência anexada</p>
                  </div>
                </TabsContent>

                <TabsContent value="remediation">
                  <div className="space-y-4">
                    {selectedVulnerability.remediation_steps ? (
                      <div>
                        <Label className="text-sm font-medium">Passos de Remediação</Label>
                        <p className="text-sm mt-1">{selectedVulnerability.remediation_steps}</p>
                      </div>
                    ) : (
                      <div className="text-center py-8 text-muted-foreground">
                        <CheckCircle className="h-12 w-12 mx-auto mb-4 opacity-50" />
                        <p>Nenhum passo de remediação definido</p>
                      </div>
                    )}
                  </div>
                </TabsContent>

                <TabsContent value="history">
                  <div className="text-center py-8 text-muted-foreground">
                    <History className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p>Histórico de alterações</p>
                  </div>
                </TabsContent>
              </Tabs>
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}