import React, { useState, useMemo } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from '@/components/ui/dropdown-menu';
import {
  Search,
  Filter,
  Plus,
  Download,
  Upload,
  MoreHorizontal,
  ChevronDown,
  Bug,
  Globe,
  Shield,
  Target,
  FileText,
  Cloud,
  ArrowLeft
} from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { useVulnerabilities } from './hooks/useVulnerabilities';
import {
  Vulnerability,
  VulnerabilitySeverity,
  VulnerabilityStatus,
  VulnerabilitySource,
  VulnerabilityFilter
} from './types/vulnerability';
import { toast } from 'sonner';
import { MetricsTab } from './tabs/MetricsTab';

export default function VulnerabilityManagement() {
  const navigate = useNavigate();
  const [filters, setFilters] = useState<VulnerabilityFilter>({});
  const [page, setPage] = useState(1);
  const [limit, setLimit] = useState(10);
  const [sortBy, setSortBy] = useState<keyof Vulnerability>('created_at');
  const [sortOrder, setSortOrder] = useState<'asc' | 'desc'>('desc');
  const [selectedVulnerabilities, setSelectedVulnerabilities] = useState<string[]>([]);
  const [showFilters, setShowFilters] = useState(true);

  const {
    vulnerabilities,
    totalCount,
    loading,
    metrics,
    deleteVulnerability,
    updateVulnerability,
    bulkUpdateVulnerabilities
  } = useVulnerabilities({
    filters,
    page,
    limit,
    sortBy,
    sortOrder
  });

  const totalPages = Math.ceil(totalCount / limit);

  // Handle filter changes
  const handleFilterChange = (key: keyof VulnerabilityFilter, value: any) => {
    setFilters(prev => ({ ...prev, [key]: value }));
    setPage(1); // Reset to first page when filters change
  };

  const getSeverityBadgeColor = (severity: string) => {
    const colors = {
      Critical: 'bg-red-600 text-white border border-red-700',
      High: 'bg-orange-600 text-white border border-orange-700',
      Medium: 'bg-yellow-600 text-white border border-yellow-700',
      Low: 'bg-green-600 text-white border border-green-700',
      Info: 'bg-blue-600 text-white border border-blue-700',
    };
    return colors[severity as keyof typeof colors] || colors.Info;
  };

  const getStatusBadgeColor = (status: string) => {
    const colors = {
      Open: 'bg-red-600 text-white border border-red-700',
      In_Progress: 'bg-amber-600 text-white border border-amber-700',
      Testing: 'bg-blue-600 text-white border border-blue-700',
      Resolved: 'bg-emerald-600 text-white border border-emerald-700',
      Accepted: 'bg-purple-600 text-white border border-purple-700',
      False_Positive: 'bg-pink-600 text-white border border-pink-700',
    };
    return colors[status as keyof typeof colors] || colors.Open;
  };

  const EXPORT_FORMATS = [
    { id: 'csv', name: 'CSV', description: 'Arquivo de valores separados por vírgula', icon: FileText },
    { id: 'excel', name: 'Excel', description: 'Planilha do Microsoft Excel', icon: FileText },
    { id: 'json', name: 'JSON', description: 'Formato de dados JavaScript Object Notation', icon: FileText },
    { id: 'pdf', name: 'PDF', description: 'Relatório em PDF para apresentação', icon: FileText }
  ];

  const handleExportToFormat = (format: string) => {
    toast.info(`Exportando para ${format}...`);
    // Mock export logic
    setTimeout(() => toast.success('Exportação concluída!'), 1500);
  };

  const executeExport = (format: string, options: any) => {
    handleExportToFormat(format);
  };

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Button variant="ghost" size="icon" onClick={() => navigate('/vulnerabilities')}>
              <ArrowLeft className="h-6 w-6" />
            </Button>
            Lista de Vulnerabilidades
          </h1>
          <p className="text-muted-foreground ml-12">
            Relação classificada de acordo com os critérios estabelecidos
          </p>
        </div>
        <div className="flex gap-2">
          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline">
                <Upload className="h-4 w-4 mr-2" />
                Importar
                <ChevronDown className="h-4 w-4 ml-2" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent>
              <DropdownMenuItem onClick={() => navigate('/vulnerabilities/import')}>Importar Scan</DropdownMenuItem>
            </DropdownMenuContent>
          </DropdownMenu>

          <DropdownMenu>
            <DropdownMenuTrigger asChild>
              <Button variant="outline">
                <Download className="h-4 w-4 mr-2" />
                Exportar
                <ChevronDown className="h-4 w-4 ml-2" />
              </Button>
            </DropdownMenuTrigger>
            <DropdownMenuContent align="end" className="w-64">
              {EXPORT_FORMATS.map((format) => (
                <DropdownMenuItem key={format.id} onClick={() => handleExportToFormat(format.id)}>
                  <div className="flex items-center gap-2">
                    <format.icon className="h-4 w-4" />
                    <div className="flex flex-col">
                      <span>{format.name}</span>
                      <span className="text-xs text-muted-foreground">{format.description}</span>
                    </div>
                  </div>
                </DropdownMenuItem>
              ))}
            </DropdownMenuContent>
          </DropdownMenu>

          <Button variant="outline" onClick={() => navigate('/vulnerabilities/classification')}>
            Customizar
          </Button>

          <Button onClick={() => navigate('/vulnerabilities/create')}>
            <Plus className="h-4 w-4 mr-2" />
            Nova Vulnerabilidade
          </Button>
        </div>
      </div>

      {/* Metrics Section - Added Explicitly Here */}
      <div className="mb-8">
        <MetricsTab
          loading={loading}
          displayMetrics={metrics || {
            total_vulnerabilities: 0,
            critical_open: 0,
            high_open: 0,
            sla_compliance: 100,
            avg_resolution_time: 0,
            by_severity: { Critical: 0, High: 0, Medium: 0, Low: 0, Info: 0 },
            by_status: { Open: 0, In_Progress: 0, Testing: 0, Resolved: 0, Accepted: 0, False_Positive: 0, Duplicate: 0 }
          }}
          metrics={metrics}
          recentVulnerabilities={[]}
        />
      </div>

      {/* Filters Panel */}
      {showFilters && (
        <Card>
          <CardHeader>
            <CardTitle>Filtros</CardTitle>
          </CardHeader>
          <CardContent>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="space-y-2">
                <Label>Pesquisar</Label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="ID, título ou ativo..."
                    value={filters.search || ''}
                    onChange={(e) => handleFilterChange('search', e.target.value)}
                    className="pl-10"
                  />
                </div>
              </div>
              <div className="space-y-2">
                <Label>Severidade</Label>
                <Select
                  value={filters.severity?.[0] || 'all'}
                  onValueChange={(value) => handleFilterChange('severity', value === 'all' ? undefined : [value])}
                >
                  <SelectTrigger><SelectValue placeholder="Todas" /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todas</SelectItem>
                    <SelectItem value="Critical">Crítica</SelectItem>
                    <SelectItem value="High">Alta</SelectItem>
                    <SelectItem value="Medium">Média</SelectItem>
                    <SelectItem value="Low">Baixa</SelectItem>
                    <SelectItem value="Info">Info</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <Label>Status</Label>
                <Select
                  value={filters.status?.[0] || 'all'}
                  onValueChange={(value) => handleFilterChange('status', value === 'all' ? undefined : [value])}
                >
                  <SelectTrigger><SelectValue placeholder="Todos" /></SelectTrigger>
                  <SelectContent>
                    <SelectItem value="all">Todos</SelectItem>
                    <SelectItem value="Open">Aberta</SelectItem>
                    <SelectItem value="In_Progress">Em Progresso</SelectItem>
                    <SelectItem value="Resolved">Resolvida</SelectItem>
                    <SelectItem value="Accepted">Aceita</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="mt-4 flex justify-end">
              <Button variant="secondary" onClick={() => setFilters({})}>Limpar Filtros</Button>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Table */}
      <Card>
        <CardHeader>
          <CardTitle>Vulnerabilidades ({totalCount})</CardTitle>
          <CardDescription>Lista de vulnerabilidades filtradas</CardDescription>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>ID</TableHead>
                <TableHead>Título</TableHead>
                <TableHead>Severidade</TableHead>
                <TableHead>Status</TableHead>
                <TableHead>Ativo</TableHead>
                <TableHead>Data</TableHead>
                <TableHead>Ações</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={7} className="text-center py-8">Carregando...</TableCell>
                </TableRow>
              ) : vulnerabilities.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={7} className="text-center py-8">Nenhuma vulnerabilidade encontrada</TableCell>
                </TableRow>
              ) : (
                vulnerabilities.map((v) => (
                  <TableRow key={v.id}>
                    <TableCell className="font-mono">{v.id.substring(0, 8)}</TableCell>
                    <TableCell className="font-medium">{v.title}</TableCell>
                    <TableCell>
                      <Badge className={getSeverityBadgeColor(v.severity)}>{v.severity}</Badge>
                    </TableCell>
                    <TableCell>
                      <Badge className={getStatusBadgeColor(v.status)}>{v.status}</Badge>
                    </TableCell>
                    <TableCell>{v.asset_name}</TableCell>
                    <TableCell>{new Date(v.created_at).toLocaleDateString()}</TableCell>
                    <TableCell>
                      <Button variant="ghost" size="sm" onClick={() => navigate(`/vulnerabilities/edit/${v.id}`)}>
                        <MoreHorizontal className="h-4 w-4" />
                      </Button>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </CardContent>
        {/* Pagination would go here */}
      </Card>
    </div>
  );
}