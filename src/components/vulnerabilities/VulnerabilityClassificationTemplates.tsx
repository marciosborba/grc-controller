import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { supabase } from '@/integrations/supabase/client';
import { useAuth } from '@/contexts/AuthContextOptimized';
import { useCurrentTenantId } from '@/contexts/TenantSelectorContext';
import { 
  Settings, 
  Plus, 
  Edit, 
  Trash2, 
  Play, 
  AlertTriangle,
  CheckCircle,
  Zap,
  Target,
  Filter,
  Shield,
  Clock,
  Users,
  Tag,
  Calendar,
  TrendingUp,
  BarChart3,
  Server,
  Globe,
  Database,
  Smartphone,
  Cloud,
  Wifi,
  HardDrive,
  Activity
} from 'lucide-react';
import { toast } from 'sonner';

// Interfaces
interface RuleCondition {
  id: string;
  field: string;
  operator: 'equals' | 'contains' | 'greater_than' | 'less_than' | 'in' | 'not_in' | 'starts_with' | 'ends_with';
  value: string | number | string[];
  logical_operator: 'AND' | 'OR';
  category: 'criticality' | 'asset' | 'application';
}

interface RuleAction {
  id: string;
  type: 'set_severity' | 'set_priority' | 'assign_to' | 'add_tag' | 'set_due_date' | 'set_status' | 'set_business_impact';
  value: any;
  description: string;
}

interface ClassificationTemplate {
  id: string;
  name: string;
  description: string;
  vulnerability_class: VulnerabilityClass;
  enabled: boolean;
  priority: number;
  conditions: RuleCondition[];
  actions: RuleAction[];
  analysis_template: string;
  recommendation_template: string;
  created_at: Date;
  updated_at: Date;
  created_by: string;
  last_executed?: Date;
  execution_count: number;
  success_rate: number;
}

type VulnerabilityClass = 'Infrastructure' | 'Web_Application' | 'Database' | 'Network' | 'Operating_System' | 'Mobile_Application' | 'Cloud_Service' | 'API' | 'IoT_Device' | 'Third_Party';

const VULNERABILITY_CLASS_LABELS: Record<VulnerabilityClass, string> = {
  Infrastructure: 'Infraestrutura',
  Web_Application: 'Aplicação Web',
  Database: 'Banco de Dados',
  Network: 'Rede',
  Operating_System: 'Sistema Operacional',
  Mobile_Application: 'Aplicação Mobile',
  Cloud_Service: 'Serviço em Nuvem',
  API: 'API',
  IoT_Device: 'Dispositivo IoT',
  Third_Party: 'Terceiros'
};

const CRITICALITY_FIELDS = [
  { value: 'severity', label: 'Severidade', type: 'select' },
  { value: 'cvss_score', label: 'CVSS Score', type: 'number' },
  { value: 'cvss_version', label: 'Versão CVSS', type: 'select' },
  { value: 'exploit_available', label: 'Exploit Disponível', type: 'boolean' },
  { value: 'patch_available', label: 'Patch Disponível', type: 'boolean' },
  { value: 'public_disclosure', label: 'Divulgação Pública', type: 'boolean' },
  { value: 'age_days', label: 'Idade (dias)', type: 'number' },
];

const ASSET_FIELDS = [
  { value: 'asset_type', label: 'Tipo de Ativo', type: 'select' },
  { value: 'asset_name', label: 'Nome do Ativo', type: 'text' },
  { value: 'asset_status', label: 'Status do Ativo', type: 'select' },
  { value: 'exposure_level', label: 'Nível de Exposição', type: 'select' },
  { value: 'security_controls', label: 'Controles de Segurança', type: 'array' },
  { value: 'asset_ip', label: 'IP do Ativo', type: 'text' },
];

const APPLICATION_FIELDS = [
  { value: 'business_criticality', label: 'Criticidade do Negócio', type: 'select' },
  { value: 'compliance_frameworks', label: 'Frameworks de Compliance', type: 'array' },
  { value: 'data_classification', label: 'Classificação de Dados', type: 'select' },
  { value: 'customer_facing', label: 'Voltado ao Cliente', type: 'boolean' },
  { value: 'processes_pii', label: 'Processa PII', type: 'boolean' },
  { value: 'processes_financial_data', label: 'Dados Financeiros', type: 'boolean' },
];

const OPERATORS = [
  { value: 'equals', label: 'Igual a' },
  { value: 'contains', label: 'Contém' },
  { value: 'starts_with', label: 'Inicia com' },
  { value: 'ends_with', label: 'Termina com' },
  { value: 'greater_than', label: 'Maior que' },
  { value: 'less_than', label: 'Menor que' },
  { value: 'in', label: 'Está em' },
  { value: 'not_in', label: 'Não está em' },
];

const ACTION_TYPES = [
  { value: 'set_severity', label: 'Definir Severidade', icon: AlertTriangle },
  { value: 'set_priority', label: 'Definir Prioridade', icon: TrendingUp },
  { value: 'assign_to', label: 'Atribuir a', icon: Users },
  { value: 'add_tag', label: 'Adicionar Tag', icon: Tag },
  { value: 'set_due_date', label: 'Definir Prazo', icon: Calendar },
  { value: 'set_status', label: 'Definir Status', icon: CheckCircle },
  { value: 'set_business_impact', label: 'Definir Impacto no Negócio', icon: Target },
];

const VULNERABILITY_CLASS_ICONS: Record<VulnerabilityClass, React.ComponentType<any>> = {
  Infrastructure: Server,
  Web_Application: Globe,
  Database: Database,
  Network: Wifi,
  Operating_System: HardDrive,
  Mobile_Application: Smartphone,
  Cloud_Service: Cloud,
  API: Activity,
  IoT_Device: Shield,
  Third_Party: Users
};

export default function VulnerabilityClassificationTemplates() {
  const { user } = useAuth();
  const currentTenantId = useCurrentTenantId();
  const [templates, setTemplates] = useState<ClassificationTemplate[]>([]);
  const [selectedTemplate, setSelectedTemplate] = useState<ClassificationTemplate | null>(null);
  const [showTemplateDialog, setShowTemplateDialog] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [testResults, setTestResults] = useState<any[]>([]);
  const [showTestDialog, setShowTestDialog] = useState(false);
  const [loading, setLoading] = useState(true);

  const [templateForm, setTemplateForm] = useState({
    name: '',
    description: '',
    vulnerability_class: 'Infrastructure' as VulnerabilityClass,
    enabled: true,
    priority: 1,
    conditions: [] as RuleCondition[],
    actions: [] as RuleAction[],
    analysis_template: '',
    recommendation_template: ''
  });

  useEffect(() => {
    if (currentTenantId) {
      loadTemplates();
    }
  }, [currentTenantId]);

  const loadTemplates = async () => {
    if (!currentTenantId) {
      console.warn('Tenant ID não definido');
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      
      const tenantId = currentTenantId;
      
      if (tenantId === 'default') {
        console.warn('Tenant ID é default:', tenantId);
        setLoading(false);
        return;
      }

      const { data: templatesData, error } = await supabase
        .from('vulnerability_classification_templates')
        .select('*')
        .eq('tenant_id', tenantId)
        .order('priority', { ascending: true });

      if (error) {
        console.error('Erro ao carregar regras:', error);
        toast.error('Erro ao carregar regras de classificação');
        return;
      }

      const templates: ClassificationTemplate[] = (templatesData || []).map(template => {
        const conditions: RuleCondition[] = [];
        
        if (template.criticality_criteria) {
          const criteria = template.criticality_criteria;
          if (criteria.severity_levels) {
            conditions.push({
              id: `crit_sev_${Date.now()}`,
              field: 'severity',
              operator: 'in',
              value: criteria.severity_levels,
              logical_operator: 'AND',
              category: 'criticality'
            });
          }
        }
        
        const actions: RuleAction[] = [];
        if (template.actions) {
          const oldActions = template.actions;
          if (oldActions.set_priority) {
            actions.push({
              id: `action_prio_${Date.now()}`,
              type: 'set_priority',
              value: oldActions.set_priority,
              description: `Definir prioridade como ${oldActions.set_priority}`
            });
          }
        }
        
        return {
          id: template.id,
          name: template.name,
          description: template.description || '',
          vulnerability_class: template.vulnerability_class,
          enabled: template.enabled,
          priority: template.priority,
          conditions,
          actions,
          analysis_template: template.analysis_template || '',
          recommendation_template: template.recommendation_template || '',
          created_at: new Date(template.created_at),
          updated_at: new Date(template.updated_at),
          created_by: template.created_by || user?.email || 'unknown',
          last_executed: template.last_executed ? new Date(template.last_executed) : undefined,
          execution_count: template.execution_count || 0,
          success_rate: template.success_rate || 0
        };
      });

      setTemplates(templates);
    } catch (error) {
      console.error('Erro inesperado ao carregar regras:', error);
      toast.error('Erro inesperado ao carregar regras');
    } finally {
      setLoading(false);
    }
  };

  const handleCreateTemplate = () => {
    setTemplateForm({
      name: '',
      description: '',
      vulnerability_class: 'Infrastructure',
      enabled: true,
      priority: 1,
      conditions: [],
      actions: [],
      analysis_template: '',
      recommendation_template: ''
    });
    setIsEditing(false);
    setShowTemplateDialog(true);
  };

  const handleEditTemplate = (template: ClassificationTemplate) => {
    setTemplateForm({
      name: template.name,
      description: template.description,
      vulnerability_class: template.vulnerability_class,
      enabled: template.enabled,
      priority: template.priority,
      conditions: template.conditions,
      actions: template.actions,
      analysis_template: template.analysis_template || '',
      recommendation_template: template.recommendation_template || ''
    });
    setSelectedTemplate(template);
    setIsEditing(true);
    setShowTemplateDialog(true);
  };

  const handleSaveTemplate = async () => {
    if (!templateForm.name.trim()) {
      toast.error('Nome da regra é obrigatório');
      return;
    }

    if (!currentTenantId) {
      toast.error('Tenant não definido');
      return;
    }

    try {
      const tenantId = currentTenantId;
      
      if (isEditing && selectedTemplate) {
        const criticalityConditions = templateForm.conditions.filter(c => c.category === 'criticality');
        const assetConditions = templateForm.conditions.filter(c => c.category === 'asset');
        const applicationConditions = templateForm.conditions.filter(c => c.category === 'application');
        
        const { error } = await supabase
          .from('vulnerability_classification_templates')
          .update({
            name: templateForm.name,
            description: templateForm.description,
            vulnerability_class: templateForm.vulnerability_class,
            enabled: templateForm.enabled,
            priority: templateForm.priority,
            criticality_criteria: criticalityConditions.length > 0 ? { conditions: criticalityConditions } : {},
            asset_criteria: assetConditions.length > 0 ? { conditions: assetConditions } : {},
            application_criteria: applicationConditions.length > 0 ? { conditions: applicationConditions } : {},
            actions: templateForm.actions.length > 0 ? { actions: templateForm.actions } : {},
            analysis_template: templateForm.analysis_template,
            recommendation_template: templateForm.recommendation_template,
            updated_at: new Date().toISOString()
          })
          .eq('id', selectedTemplate.id)
          .eq('tenant_id', tenantId);

        if (error) {
          console.error('Erro ao atualizar regra:', error);
          toast.error('Erro ao atualizar regra');
          return;
        }

        toast.success('Regra atualizada com sucesso');
      } else {
        const criticalityConditions = templateForm.conditions.filter(c => c.category === 'criticality');
        const assetConditions = templateForm.conditions.filter(c => c.category === 'asset');
        const applicationConditions = templateForm.conditions.filter(c => c.category === 'application');
        
        const { error } = await supabase
          .from('vulnerability_classification_templates')
          .insert({
            tenant_id: tenantId,
            name: templateForm.name,
            description: templateForm.description,
            vulnerability_class: templateForm.vulnerability_class,
            enabled: templateForm.enabled,
            priority: templateForm.priority,
            criticality_criteria: criticalityConditions.length > 0 ? { conditions: criticalityConditions } : {},
            asset_criteria: assetConditions.length > 0 ? { conditions: assetConditions } : {},
            application_criteria: applicationConditions.length > 0 ? { conditions: applicationConditions } : {},
            actions: templateForm.actions.length > 0 ? { actions: templateForm.actions } : {},
            analysis_template: templateForm.analysis_template,
            recommendation_template: templateForm.recommendation_template,
            created_by: user?.id
          });

        if (error) {
          console.error('Erro ao criar regra:', error);
          toast.error('Erro ao criar regra');
          return;
        }

        toast.success('Regra criada com sucesso');
      }
      
      setShowTemplateDialog(false);
      await loadTemplates();
    } catch (error) {
      console.error('Erro inesperado ao salvar regra:', error);
      toast.error('Erro inesperado ao salvar regra');
    }
  };

  const handleDeleteTemplate = async (templateId: string) => {
    if (!confirm('Tem certeza que deseja excluir esta regra?')) {
      return;
    }

    if (!currentTenantId) {
      toast.error('Tenant não definido');
      return;
    }

    try {
      const { error } = await supabase
        .from('vulnerability_classification_templates')
        .delete()
        .eq('id', templateId)
        .eq('tenant_id', currentTenantId);

      if (error) {
        console.error('Erro ao excluir regra:', error);
        toast.error('Erro ao excluir regra');
        return;
      }

      toast.success('Regra excluída com sucesso');
      await loadTemplates();
    } catch (error) {
      console.error('Erro inesperado ao excluir regra:', error);
      toast.error('Erro inesperado ao excluir regra');
    }
  };

  const handleToggleTemplate = async (templateId: string, enabled: boolean) => {
    const template = templates.find(t => t.id === templateId);
    if (!template) return;

    if (!currentTenantId) {
      toast.error('Tenant não definido');
      return;
    }

    try {
      const { error } = await supabase
        .from('vulnerability_classification_templates')
        .update({ 
          enabled, 
          updated_at: new Date().toISOString() 
        })
        .eq('id', templateId)
        .eq('tenant_id', currentTenantId);

      if (error) {
        console.error('Erro ao atualizar status da regra:', error);
        toast.error('Erro ao atualizar status da regra');
        return;
      }

      toast.success(`Regra ${enabled ? 'ativada' : 'desativada'} com sucesso`);
      await loadTemplates();
    } catch (error) {
      console.error('Erro inesperado ao atualizar regra:', error);
      toast.error('Erro inesperado ao atualizar regra');
    }
  };

  const handleTestTemplate = async (template: ClassificationTemplate) => {
    const mockResults = [
      {
        vulnerability: {
          title: 'SQL Injection in Login Form',
          severity: 'Critical',
          asset_type: 'Web_Application',
          cvss_score: 9.1,
          exposure: 'Internet_Facing'
        },
        matched: true,
        criteria_met: ['CVSS Score: 9.1 >= 6.0', 'Severity: Critical', 'Asset Type: Web Application', 'Internet Facing: Yes'],
        actions_applied: ['Priority: High', 'SLA: 8 hours', 'Team: Application Security', 'Tags: web-app, pii, lgpd']
      }
    ];
    
    setTestResults(mockResults);
    setSelectedTemplate(template);
    setShowTestDialog(true);
  };

  const getClassIcon = (vulnerabilityClass: VulnerabilityClass) => {
    const IconComponent = VULNERABILITY_CLASS_ICONS[vulnerabilityClass];
    return <IconComponent className="h-5 w-5" />;
  };

  const getPriorityBadge = (priority: number) => {
    const colors = {
      1: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
      2: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200',
      3: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
      4: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
    };
    return (
      <Badge className={colors[priority as keyof typeof colors] || 'bg-gray-100 text-gray-800'}>
        Prioridade {priority}
      </Badge>
    );
  };

  const addCondition = (category: 'criticality' | 'asset' | 'application') => {
    const newCondition: RuleCondition = {
      id: `${category}_${Date.now()}`,
      field: category === 'criticality' ? 'severity' : category === 'asset' ? 'asset_type' : 'business_criticality',
      operator: 'equals',
      value: '',
      logical_operator: 'AND',
      category
    };
    setTemplateForm(prev => ({
      ...prev,
      conditions: [...prev.conditions, newCondition]
    }));
  };

  const updateCondition = (conditionId: string, updates: Partial<RuleCondition>) => {
    setTemplateForm(prev => ({
      ...prev,
      conditions: prev.conditions.map(condition => 
        condition.id === conditionId ? { ...condition, ...updates } : condition
      )
    }));
  };

  const removeCondition = (conditionId: string) => {
    setTemplateForm(prev => ({
      ...prev,
      conditions: prev.conditions.filter(condition => condition.id !== conditionId)
    }));
  };

  const addAction = () => {
    const newAction: RuleAction = {
      id: `action_${Date.now()}`,
      type: 'set_priority',
      value: '',
      description: ''
    };
    setTemplateForm(prev => ({
      ...prev,
      actions: [...prev.actions, newAction]
    }));
  };

  const updateAction = (actionId: string, updates: Partial<RuleAction>) => {
    setTemplateForm(prev => ({
      ...prev,
      actions: prev.actions.map(action => 
        action.id === actionId ? { ...action, ...updates } : action
      )
    }));
  };

  const removeAction = (actionId: string) => {
    setTemplateForm(prev => ({
      ...prev,
      actions: prev.actions.filter(action => action.id !== actionId)
    }));
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold flex items-center gap-2">
            <Settings className="h-8 w-8 text-primary" />
            Regras de Classificação
          </h1>
          <p className="text-muted-foreground">
            Configure as regras de avaliação para classificação automática de vulnerabilidades
          </p>
        </div>
        <div className="flex gap-2">
          <Button variant="outline">
            <Play className="h-4 w-4 mr-2" />
            Executar Todos
          </Button>
          <Button onClick={handleCreateTemplate}>
            <Plus className="h-4 w-4 mr-2" />
            Nova Regra
          </Button>
        </div>
      </div>

      <Tabs defaultValue="templates" className="w-full">
        <TabsList>
          <TabsTrigger value="templates">Regras</TabsTrigger>
          <TabsTrigger value="analytics">Analytics</TabsTrigger>
          <TabsTrigger value="execution-history">Histórico</TabsTrigger>
        </TabsList>

        <TabsContent value="templates" className="space-y-6">
          {loading && (
            <div className="text-center py-12">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
              <p className="text-muted-foreground">Carregando regras...</p>
            </div>
          )}

          {!loading && (
            <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
              {templates.map((template) => (
                <Card key={template.id} className={`hover:shadow-lg transition-shadow ${template.enabled ? 'border-green-200 dark:border-green-800' : 'border-gray-200 dark:border-gray-700'}`}>
                  <CardHeader className="pb-3">
                    <div className="flex items-start justify-between">
                      <div className="flex items-center gap-3">
                        {getClassIcon(template.vulnerability_class)}
                        <div>
                          <CardTitle className="text-lg">{template.name}</CardTitle>
                          <CardDescription className="text-sm">
                            {VULNERABILITY_CLASS_LABELS[template.vulnerability_class]}
                          </CardDescription>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        {getPriorityBadge(template.priority)}
                        <Badge variant={template.enabled ? 'default' : 'secondary'}>
                          {template.enabled ? 'Ativo' : 'Inativo'}
                        </Badge>
                      </div>
                    </div>
                  </CardHeader>
                  <CardContent className="space-y-4">
                    <p className="text-sm text-muted-foreground">{template.description}</p>
                    
                    <div className="space-y-2">
                      <h4 className="text-sm font-medium">Condições Configuradas:</h4>
                      <div className="flex flex-wrap gap-1">
                        {template.conditions.filter(c => c.category === 'criticality').length > 0 && (
                          <Badge variant="outline" className="text-xs">
                            <AlertTriangle className="h-3 w-3 mr-1" />
                            Criticidade ({template.conditions.filter(c => c.category === 'criticality').length})
                          </Badge>
                        )}
                        {template.conditions.filter(c => c.category === 'asset').length > 0 && (
                          <Badge variant="outline" className="text-xs">
                            <Shield className="h-3 w-3 mr-1" />
                            Ativo ({template.conditions.filter(c => c.category === 'asset').length})
                          </Badge>
                        )}
                        {template.conditions.filter(c => c.category === 'application').length > 0 && (
                          <Badge variant="outline" className="text-xs">
                            <Target className="h-3 w-3 mr-1" />
                            Aplicação ({template.conditions.filter(c => c.category === 'application').length})
                          </Badge>
                        )}
                      </div>
                    </div>

                    <div className="space-y-2">
                      <h4 className="text-sm font-medium">Ações ({template.actions.length}):</h4>
                      <div className="text-xs text-muted-foreground space-y-1">
                        {template.actions.slice(0, 3).map((action, index) => (
                          <p key={index}>• {action.description || `${action.type}: ${action.value}`}</p>
                        ))}
                        {template.actions.length > 3 && (
                          <p>• +{template.actions.length - 3} mais...</p>
                        )}
                      </div>
                    </div>

                    <div className="flex items-center justify-between text-xs text-muted-foreground pt-2 border-t">
                      <span>Executado {template.execution_count} vezes</span>
                      <span>{template.success_rate}% sucesso</span>
                    </div>

                    <div className="flex items-center justify-between pt-2">
                      <Switch
                        checked={template.enabled}
                        onCheckedChange={(enabled) => handleToggleTemplate(template.id, enabled)}
                      />
                      <div className="flex gap-1">
                        <Button variant="ghost" size="sm" onClick={() => handleTestTemplate(template)}>
                          <Play className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="sm" onClick={() => handleEditTemplate(template)}>
                          <Edit className="h-4 w-4" />
                        </Button>
                        <Button 
                          variant="ghost" 
                          size="sm" 
                          onClick={() => handleDeleteTemplate(template.id)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))}

              {templates.length === 0 && (
                <div className="col-span-full text-center py-12">
                  <Settings className="h-12 w-12 mx-auto mb-4 opacity-50" />
                  <p className="text-muted-foreground mb-4">Nenhuma regra configurada</p>
                  <Button onClick={handleCreateTemplate}>
                    <Plus className="h-4 w-4 mr-2" />
                    Criar Primeira Regra
                  </Button>
                </div>
              )}
            </div>
          )}
        </TabsContent>

        <TabsContent value="analytics">
          <Card>
            <CardHeader>
              <CardTitle>Analytics de Regras</CardTitle>
              <CardDescription>
                Análise de performance e eficácia das regras
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="text-center py-8 text-muted-foreground">
                <BarChart3 className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Analytics em desenvolvimento</p>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="execution-history">
          <Card>
            <CardHeader>
              <CardTitle>Histórico de Execuções</CardTitle>
              <CardDescription>
                Histórico detalhado das execuções das regras
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="text-center py-8 text-muted-foreground">
                <Clock className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Histórico de execuções em desenvolvimento</p>
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      <Dialog open={showTemplateDialog} onOpenChange={setShowTemplateDialog}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              {isEditing ? 'Editar Regra' : 'Nova Regra de Classificação'}
            </DialogTitle>
            <DialogDescription>
              Configure os critérios e ações para classificação automática de vulnerabilidades
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Nome da Regra</Label>
                <Input
                  value={templateForm.name}
                  onChange={(e) => setTemplateForm(prev => ({ ...prev, name: e.target.value }))}
                  placeholder="Ex: Vulnerabilidades Críticas de Produção"
                />
              </div>
              <div className="space-y-2">
                <Label>Classe de Vulnerabilidade</Label>
                <Select 
                  value={templateForm.vulnerability_class} 
                  onValueChange={(value) => setTemplateForm(prev => ({ ...prev, vulnerability_class: value as VulnerabilityClass }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {Object.entries(VULNERABILITY_CLASS_LABELS).map(([value, label]) => (
                      <SelectItem key={value} value={value}>
                        <div className="flex items-center gap-2">
                          {getClassIcon(value as VulnerabilityClass)}
                          {label}
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="space-y-2">
              <Label>Descrição</Label>
              <Textarea
                value={templateForm.description}
                onChange={(e) => setTemplateForm(prev => ({ ...prev, description: e.target.value }))}
                placeholder="Descreva o propósito desta regra..."
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Prioridade</Label>
                <Select 
                  value={templateForm.priority.toString()} 
                  onValueChange={(value) => setTemplateForm(prev => ({ ...prev, priority: parseInt(value) }))}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1">1 - Crítica</SelectItem>
                    <SelectItem value="2">2 - Alta</SelectItem>
                    <SelectItem value="3">3 - Média</SelectItem>
                    <SelectItem value="4">4 - Baixa</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div className="flex items-center space-x-2 pt-6">
                <Switch
                  checked={templateForm.enabled}
                  onCheckedChange={(enabled) => setTemplateForm(prev => ({ ...prev, enabled }))}
                />
                <Label>Regra ativa</Label>
              </div>
            </div>

            <div className="space-y-6">
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Condições</h3>
                
                <Tabs defaultValue="criticality" className="w-full">
                  <TabsList className="grid w-full grid-cols-3">
                    <TabsTrigger value="criticality" className="flex items-center gap-2">
                      <AlertTriangle className="h-4 w-4" />
                      Criticidade
                    </TabsTrigger>
                    <TabsTrigger value="asset" className="flex items-center gap-2">
                      <Shield className="h-4 w-4" />
                      Ativo
                    </TabsTrigger>
                    <TabsTrigger value="application" className="flex items-center gap-2">
                      <Target className="h-4 w-4" />
                      Aplicação
                    </TabsTrigger>
                  </TabsList>

                  <TabsContent value="criticality" className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium">Condições de Criticidade</h4>
                      <Button variant="outline" size="sm" onClick={() => addCondition('criticality')}>
                        <Plus className="h-4 w-4 mr-2" />
                        Adicionar Condição
                      </Button>
                    </div>
                    
                    {templateForm.conditions.filter(c => c.category === 'criticality').map((condition, index) => (
                      <div key={condition.id} className="border rounded-lg p-4 space-y-4">
                        <div className="flex items-center justify-between">
                          <h5 className="font-medium flex items-center gap-2">
                            <AlertTriangle className="h-4 w-4" />
                            Condição {index + 1}
                          </h5>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => removeCondition(condition.id)}
                            className="text-red-600"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          {index > 0 && (
                            <div className="space-y-2">
                              <Label>Operador Lógico</Label>
                              <Select 
                                value={condition.logical_operator} 
                                onValueChange={(value) => updateCondition(condition.id, { logical_operator: value as 'AND' | 'OR' })}
                              >
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="AND">E (AND)</SelectItem>
                                  <SelectItem value="OR">OU (OR)</SelectItem>
                                </SelectContent>
                              </Select>
                            </div>
                          )}

                          <div className="space-y-2">
                            <Label>Campo</Label>
                            <Select 
                              value={condition.field} 
                              onValueChange={(value) => updateCondition(condition.id, { field: value })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {CRITICALITY_FIELDS.map(field => (
                                  <SelectItem key={field.value} value={field.value}>
                                    {field.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Operador</Label>
                            <Select 
                              value={condition.operator} 
                              onValueChange={(value) => updateCondition(condition.id, { operator: value as any })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {OPERATORS.map(op => (
                                  <SelectItem key={op.value} value={op.value}>
                                    {op.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Valor</Label>
                            <Input
                              value={String(condition.value)}
                              onChange={(e) => updateCondition(condition.id, { value: e.target.value })}
                              placeholder="Valor da condição"
                            />
                          </div>
                        </div>
                      </div>
                    ))}

                    {templateForm.conditions.filter(c => c.category === 'criticality').length === 0 && (
                      <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                        <AlertTriangle className="h-8 w-8 mx-auto mb-2 opacity-50" />
                        <p>Adicione condições de criticidade para avaliar a severidade das vulnerabilidades</p>
                      </div>
                    )}
                  </TabsContent>

                  <TabsContent value="asset" className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium">Condições de Ativo</h4>
                      <Button variant="outline" size="sm" onClick={() => addCondition('asset')}>
                        <Plus className="h-4 w-4 mr-2" />
                        Adicionar Condição
                      </Button>
                    </div>
                    
                    {templateForm.conditions.filter(c => c.category === 'asset').map((condition, index) => (
                      <div key={condition.id} className="border rounded-lg p-4 space-y-4">
                        <div className="flex items-center justify-between">
                          <h5 className="font-medium flex items-center gap-2">
                            <Shield className="h-4 w-4" />
                            Condição {index + 1}
                          </h5>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => removeCondition(condition.id)}
                            className="text-red-600"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          {index > 0 && (
                            <div className="space-y-2">
                              <Label>Operador Lógico</Label>
                              <Select 
                                value={condition.logical_operator} 
                                onValueChange={(value) => updateCondition(condition.id, { logical_operator: value as 'AND' | 'OR' })}
                              >
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="AND">E (AND)</SelectItem>
                                  <SelectItem value="OR">OU (OR)</SelectItem>
                                </SelectContent>
                              </Select>
                            </div>
                          )}

                          <div className="space-y-2">
                            <Label>Campo</Label>
                            <Select 
                              value={condition.field} 
                              onValueChange={(value) => updateCondition(condition.id, { field: value })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {ASSET_FIELDS.map(field => (
                                  <SelectItem key={field.value} value={field.value}>
                                    {field.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Operador</Label>
                            <Select 
                              value={condition.operator} 
                              onValueChange={(value) => updateCondition(condition.id, { operator: value as any })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {OPERATORS.map(op => (
                                  <SelectItem key={op.value} value={op.value}>
                                    {op.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Valor</Label>
                            <Input
                              value={String(condition.value)}
                              onChange={(e) => updateCondition(condition.id, { value: e.target.value })}
                              placeholder="Valor da condição"
                            />
                          </div>
                        </div>
                      </div>
                    ))}

                    {templateForm.conditions.filter(c => c.category === 'asset').length === 0 && (
                      <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                        <Shield className="h-8 w-8 mx-auto mb-2 opacity-50" />
                        <p>Adicione condições de ativo para avaliar características dos recursos</p>
                      </div>
                    )}
                  </TabsContent>

                  <TabsContent value="application" className="space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium">Condições de Aplicação</h4>
                      <Button variant="outline" size="sm" onClick={() => addCondition('application')}>
                        <Plus className="h-4 w-4 mr-2" />
                        Adicionar Condição
                      </Button>
                    </div>
                    
                    {templateForm.conditions.filter(c => c.category === 'application').map((condition, index) => (
                      <div key={condition.id} className="border rounded-lg p-4 space-y-4">
                        <div className="flex items-center justify-between">
                          <h5 className="font-medium flex items-center gap-2">
                            <Target className="h-4 w-4" />
                            Condição {index + 1}
                          </h5>
                          <Button 
                            variant="ghost" 
                            size="sm" 
                            onClick={() => removeCondition(condition.id)}
                            className="text-red-600"
                          >
                            <Trash2 className="h-4 w-4" />
                          </Button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                          {index > 0 && (
                            <div className="space-y-2">
                              <Label>Operador Lógico</Label>
                              <Select 
                                value={condition.logical_operator} 
                                onValueChange={(value) => updateCondition(condition.id, { logical_operator: value as 'AND' | 'OR' })}
                              >
                                <SelectTrigger>
                                  <SelectValue />
                                </SelectTrigger>
                                <SelectContent>
                                  <SelectItem value="AND">E (AND)</SelectItem>
                                  <SelectItem value="OR">OU (OR)</SelectItem>
                                </SelectContent>
                              </Select>
                            </div>
                          )}

                          <div className="space-y-2">
                            <Label>Campo</Label>
                            <Select 
                              value={condition.field} 
                              onValueChange={(value) => updateCondition(condition.id, { field: value })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {APPLICATION_FIELDS.map(field => (
                                  <SelectItem key={field.value} value={field.value}>
                                    {field.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Operador</Label>
                            <Select 
                              value={condition.operator} 
                              onValueChange={(value) => updateCondition(condition.id, { operator: value as any })}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {OPERATORS.map(op => (
                                  <SelectItem key={op.value} value={op.value}>
                                    {op.label}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div className="space-y-2">
                            <Label>Valor</Label>
                            <Input
                              value={String(condition.value)}
                              onChange={(e) => updateCondition(condition.id, { value: e.target.value })}
                              placeholder="Valor da condição"
                            />
                          </div>
                        </div>
                      </div>
                    ))}

                    {templateForm.conditions.filter(c => c.category === 'application').length === 0 && (
                      <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                        <Target className="h-8 w-8 mx-auto mb-2 opacity-50" />
                        <p>Adicione condições de aplicação para avaliar contexto de negócio</p>
                      </div>
                    )}
                  </TabsContent>
                </Tabs>
              </div>

              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <h3 className="text-lg font-semibold">Ações</h3>
                  <Button variant="outline" size="sm" onClick={addAction}>
                    <Plus className="h-4 w-4 mr-2" />
                    Adicionar Ação
                  </Button>
                </div>

                {templateForm.actions.map((action, index) => (
                  <div key={action.id} className="border rounded-lg p-4 space-y-4">
                    <div className="flex items-center justify-between">
                      <h4 className="font-medium">Ação {index + 1}</h4>
                      <Button 
                        variant="ghost" 
                        size="sm" 
                        onClick={() => removeAction(action.id)}
                        className="text-red-600"
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      <div className="space-y-2">
                        <Label>Tipo de Ação</Label>
                        <Select 
                          value={action.type} 
                          onValueChange={(value) => updateAction(action.id, { type: value as any })}
                        >
                          <SelectTrigger>
                            <SelectValue />
                          </SelectTrigger>
                          <SelectContent>
                            {ACTION_TYPES.map(actionType => (
                              <SelectItem key={actionType.value} value={actionType.value}>
                                <div className="flex items-center gap-2">
                                  <actionType.icon className="h-4 w-4" />
                                  {actionType.label}
                                </div>
                              </SelectItem>
                            ))}
                          </SelectContent>
                        </Select>
                      </div>

                      <div className="space-y-2">
                        <Label>Valor</Label>
                        <Input
                          value={String(action.value)}
                          onChange={(e) => updateAction(action.id, { value: e.target.value })}
                          placeholder="Valor da ação"
                        />
                      </div>

                      <div className="space-y-2">
                        <Label>Descrição</Label>
                        <Input
                          value={action.description}
                          onChange={(e) => updateAction(action.id, { description: e.target.value })}
                          placeholder="Descrição da ação"
                        />
                      </div>
                    </div>
                  </div>
                ))}

                {templateForm.actions.length === 0 && (
                  <div className="text-center py-8 text-muted-foreground border-2 border-dashed rounded-lg">
                    <Zap className="h-8 w-8 mx-auto mb-2 opacity-50" />
                    <p>Adicione ações que serão executadas quando as condições forem atendidas</p>
                  </div>
                )}
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <Label>Modelo de Análise</Label>
                <Textarea
                  value={templateForm.analysis_template}
                  onChange={(e) => setTemplateForm(prev => ({ ...prev, analysis_template: e.target.value }))}
                  placeholder="Modelo para análise automática da vulnerabilidade..."
                  rows={3}
                />
              </div>

              <div className="space-y-2">
                <Label>Modelo de Recomendação</Label>
                <Textarea
                  value={templateForm.recommendation_template}
                  onChange={(e) => setTemplateForm(prev => ({ ...prev, recommendation_template: e.target.value }))}
                  placeholder="Modelo para recomendações de remediação..."
                  rows={3}
                />
              </div>
            </div>
          </div>

          <DialogFooter>
            <Button variant="outline" onClick={() => setShowTemplateDialog(false)}>
              Cancelar
            </Button>
            <Button onClick={handleSaveTemplate}>
              {isEditing ? 'Atualizar' : 'Criar'} Regra
            </Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>

      <Dialog open={showTestDialog} onOpenChange={setShowTestDialog}>
        <DialogContent className="max-w-4xl">
          <DialogHeader>
            <DialogTitle>Resultado do Teste</DialogTitle>
            <DialogDescription>
              Resultado da execução da regra "{selectedTemplate?.name}" contra dados de exemplo
            </DialogDescription>
          </DialogHeader>

          <div className="space-y-4">
            {testResults.map((result, index) => (
              <Card key={index}>
                <CardContent className="p-4">
                  <div className="flex items-center justify-between mb-3">
                    <h4 className="font-medium">{result.vulnerability.title}</h4>
                    <Badge className={result.matched ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}>
                      {result.matched ? 'Corresponde' : 'Não corresponde'}
                    </Badge>
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                      <p className="font-medium mb-2">Detalhes da Vulnerabilidade:</p>
                      <div className="space-y-1 text-muted-foreground">
                        <p>Severidade: {result.vulnerability.severity}</p>
                        <p>Tipo de Ativo: {result.vulnerability.asset_type}</p>
                        <p>CVSS Score: {result.vulnerability.cvss_score}</p>
                        <p>Exposição: {result.vulnerability.exposure}</p>
                      </div>
                    </div>
                    
                    <div>
                      <p className="font-medium mb-2">Critérios Avaliados:</p>
                      <div className="space-y-1">
                        {result.criteria_met.map((criteria: string, criteriaIndex: number) => (
                          <p key={criteriaIndex} className={`text-sm ${result.matched ? 'text-green-600' : 'text-red-600'}`}>
                            • {criteria}
                          </p>
                        ))}
                      </div>
                    </div>
                  </div>

                  {result.matched && result.actions_applied.length > 0 && (
                    <div className="mt-4 pt-4 border-t">
                      <p className="font-medium mb-2">Ações Aplicadas:</p>
                      <div className="space-y-1">
                        {result.actions_applied.map((action: string, actionIndex: number) => (
                          <p key={actionIndex} className="text-sm text-green-600">• {action}</p>
                        ))}
                      </div>
                    </div>
                  )}
                </CardContent>
              </Card>
            ))}
          </div>

          <DialogFooter>
            <Button onClick={() => setShowTestDialog(false)}>Fechar</Button>
          </DialogFooter>
        </DialogContent>
      </Dialog>
    </div>
  );
}