import React, { useState } from 'react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuLabel,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
  DropdownMenuSub,
  DropdownMenuSubContent,
  DropdownMenuSubTrigger,
} from '@/components/ui/dropdown-menu';
import { Dialog, DialogContent, DialogHeader, DialogTitle } from '@/components/ui/dialog';
import { 
  Upload, 
  ChevronDown,
  Shield,
  Bug,
  Code,
  Cloud,
  FileText,
  Globe,
  Server,
  Target,
  Zap,
  Database,
  Lock,
  Eye,
  Scan,
  AlertTriangle
} from 'lucide-react';
import { ImportSource, ImportSourceType } from './types/import';
import ImportSourceSelector from './ImportSourceSelector';

// Definição das fontes de importação disponíveis
const IMPORT_SOURCES: ImportSource[] = [
  // Vulnerability Scanners
  {
    id: 'nessus_file',
    type: 'nessus_file',
    name: 'Nessus (.nessus)',
    description: 'Importar arquivo .nessus do Tenable Nessus',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['.nessus', '.xml'],
    requiresAuth: false,
    documentationUrl: 'https://developer.tenable.com/reference/navigate'
  },
  {
    id: 'nessus_api',
    type: 'nessus_api',
    name: 'Nessus API',
    description: 'Conectar diretamente à API do Tenable Nessus',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://developer.tenable.com/reference/navigate'
  },
  {
    id: 'qualys_file',
    type: 'qualys_file',
    name: 'Qualys VMDR',
    description: 'Importar relatório XML/CSV do Qualys',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['.xml', '.csv'],
    requiresAuth: false,
    documentationUrl: 'https://qualysguard.qg2.apps.qualys.com/qwebhelp/fo_portal/api_doc/index.htm'
  },
  {
    id: 'qualys_api',
    type: 'qualys_api',
    name: 'Qualys API',
    description: 'Conectar diretamente à API do Qualys VMDR',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'basic_auth',
    documentationUrl: 'https://qualysguard.qg2.apps.qualys.com/qwebhelp/fo_portal/api_doc/index.htm'
  },
  {
    id: 'openvas_file',
    type: 'openvas_file',
    name: 'OpenVAS',
    description: 'Importar relatório XML do OpenVAS/Greenbone',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['.xml'],
    requiresAuth: false,
    documentationUrl: 'https://docs.greenbone.net/'
  },
  {
    id: 'rapid7_api',
    type: 'rapid7_api',
    name: 'Rapid7 InsightVM',
    description: 'Conectar à API do Rapid7 Nexpose/InsightVM',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'basic_auth',
    documentationUrl: 'https://help.rapid7.com/insightvm/en-us/api/'
  },
  {
    id: 'openvas_api',
    type: 'openvas_api',
    name: 'OpenVAS API',
    description: 'Conectar à API do OpenVAS via GMP',
    icon: 'Shield',
    category: 'vulnerability_scanner',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'basic_auth',
    documentationUrl: 'https://docs.greenbone.net/API/GMP/gmp.html'
  },

  // DAST Tools
  {
    id: 'burp_file',
    type: 'burp_file',
    name: 'Burp Suite',
    description: 'Importar relatório XML do Burp Suite',
    icon: 'Bug',
    category: 'dast',
    supportedFormats: ['.xml'],
    requiresAuth: false,
    documentationUrl: 'https://portswigger.net/burp/documentation'
  },
  {
    id: 'owasp_zap_file',
    type: 'owasp_zap_file',
    name: 'OWASP ZAP',
    description: 'Importar relatório XML/JSON do OWASP ZAP',
    icon: 'Zap',
    category: 'dast',
    supportedFormats: ['.xml', '.json'],
    requiresAuth: false,
    documentationUrl: 'https://www.zaproxy.org/docs/'
  },
  {
    id: 'owasp_zap_api',
    type: 'owasp_zap_api',
    name: 'OWASP ZAP API',
    description: 'Conectar à API do OWASP ZAP',
    icon: 'Zap',
    category: 'dast',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://www.zaproxy.org/docs/api/'
  },
  {
    id: 'burp_enterprise_api',
    type: 'burp_enterprise_api',
    name: 'Burp Suite Enterprise',
    description: 'Conectar à API do Burp Suite Enterprise',
    icon: 'Bug',
    category: 'dast',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://portswigger.net/burp/documentation/enterprise/api-documentation'
  },

  // SAST Tools
  {
    id: 'sonarqube_api',
    type: 'sonarqube_api',
    name: 'SonarQube',
    description: 'Conectar à API do SonarQube',
    icon: 'Code',
    category: 'sast',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'token',
    documentationUrl: 'https://docs.sonarqube.org/latest/extend/web-api/'
  },
  {
    id: 'checkmarx_api',
    type: 'checkmarx_api',
    name: 'Checkmarx',
    description: 'Conectar à API do Checkmarx SAST',
    icon: 'Code',
    category: 'sast',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'oauth',
    documentationUrl: 'https://checkmarx.com/resource/documents/en/34965-68702-checkmarx-one-api-guide.html'
  },
  {
    id: 'veracode_api',
    type: 'veracode_api',
    name: 'Veracode',
    description: 'Conectar à API do Veracode',
    icon: 'Code',
    category: 'sast',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://docs.veracode.com/r/c_rest_api'
  },

  // Cloud Security
  {
    id: 'aws_inspector_api',
    type: 'aws_inspector_api',
    name: 'AWS Inspector',
    description: 'Conectar à API do AWS Inspector',
    icon: 'Cloud',
    category: 'cloud',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://docs.aws.amazon.com/inspector/v2/APIReference/'
  },
  {
    id: 'azure_defender_api',
    type: 'azure_defender_api',
    name: 'Microsoft Defender',
    description: 'Conectar à API do Microsoft Defender for Cloud',
    icon: 'Cloud',
    category: 'cloud',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'oauth',
    documentationUrl: 'https://docs.microsoft.com/en-us/rest/api/securitycenter/'
  },
  {
    id: 'gcp_security_api',
    type: 'gcp_security_api',
    name: 'GCP Security Command Center',
    description: 'Conectar à API do Google Cloud Security Command Center',
    icon: 'Cloud',
    category: 'cloud',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'oauth',
    documentationUrl: 'https://cloud.google.com/security-command-center/docs/reference/rest'
  },
  {
    id: 'orca_security_api',
    type: 'orca_security_api',
    name: 'Orca Security',
    description: 'Conectar à API do Orca Security Cloud Security Platform',
    icon: 'Cloud',
    category: 'cloud',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key',
    documentationUrl: 'https://docs.orcasecurity.io/docs/api-reference'
  },

  // Generic Formats
  {
    id: 'csv_file',
    type: 'csv_file',
    name: 'Arquivo CSV',
    description: 'Importar vulnerabilidades de arquivo CSV',
    icon: 'FileText',
    category: 'file',
    supportedFormats: ['.csv'],
    requiresAuth: false
  },
  {
    id: 'json_file',
    type: 'json_file',
    name: 'Arquivo JSON',
    description: 'Importar vulnerabilidades de arquivo JSON',
    icon: 'FileText',
    category: 'file',
    supportedFormats: ['.json'],
    requiresAuth: false
  },
  {
    id: 'xml_file',
    type: 'xml_file',
    name: 'Arquivo XML',
    description: 'Importar vulnerabilidades de arquivo XML',
    icon: 'FileText',
    category: 'file',
    supportedFormats: ['.xml'],
    requiresAuth: false
  },
  {
    id: 'generic_api',
    type: 'generic_api',
    name: 'API Genérica',
    description: 'Conectar a qualquer API REST personalizada',
    icon: 'Globe',
    category: 'api',
    supportedFormats: ['API'],
    requiresAuth: true,
    authType: 'api_key'
  }
];

const getIconComponent = (iconName: string) => {
  const icons: Record<string, React.ComponentType<any>> = {
    Shield,
    Bug,
    Code,
    Cloud,
    FileText,
    Globe,
    Server,
    Target,
    Zap,
    Database,
    Lock,
    Eye,
    Scan,
    AlertTriangle
  };
  return icons[iconName] || FileText;
};

interface VulnerabilityImportDropdownProps {
  onImportSelect?: (source: ImportSource) => void;
}

export default function VulnerabilityImportDropdown({ onImportSelect }: VulnerabilityImportDropdownProps) {
  const [selectedSource, setSelectedSource] = useState<ImportSource | null>(null);
  const [isDialogOpen, setIsDialogOpen] = useState(false);

  const handleSourceSelect = (source: ImportSource) => {
    setSelectedSource(source);
    setIsDialogOpen(true);
    onImportSelect?.(source);
  };

  const groupedSources = IMPORT_SOURCES.reduce((acc, source) => {
    if (!acc[source.category]) {
      acc[source.category] = [];
    }
    acc[source.category].push(source);
    return acc;
  }, {} as Record<string, ImportSource[]>);

  const getCategoryLabel = (category: string) => {
    const labels: Record<string, string> = {
      vulnerability_scanner: 'Scanners de Vulnerabilidade',
      sast: 'Análise Estática (SAST)',
      dast: 'Análise Dinâmica (DAST)',
      cloud: 'Segurança em Nuvem',
      file: 'Arquivos',
      api: 'APIs Personalizadas'
    };
    return labels[category] || category;
  };

  const getCategoryIcon = (category: string) => {
    const icons: Record<string, React.ComponentType<any>> = {
      vulnerability_scanner: Shield,
      sast: Code,
      dast: Bug,
      cloud: Cloud,
      file: FileText,
      api: Globe
    };
    const IconComponent = icons[category] || FileText;
    return <IconComponent className="h-4 w-4" />;
  };

  return (
    <>
      <DropdownMenu>
        <DropdownMenuTrigger asChild>
          <Button variant="outline" className="min-w-32">
            <Upload className="h-4 w-4 mr-2" />
            Importar
            <ChevronDown className="h-4 w-4 ml-2" />
          </Button>
        </DropdownMenuTrigger>
        <DropdownMenuContent className="w-80" align="end">
          <DropdownMenuLabel className="flex items-center gap-2">
            <Upload className="h-4 w-4" />
            Importar Vulnerabilidades
          </DropdownMenuLabel>
          <DropdownMenuSeparator />
          
          {Object.entries(groupedSources).map(([category, sources]) => (
            <DropdownMenuSub key={category}>
              <DropdownMenuSubTrigger className="flex items-center gap-2">
                {getCategoryIcon(category)}
                {getCategoryLabel(category)}
              </DropdownMenuSubTrigger>
              <DropdownMenuSubContent className="w-72">
                {sources.map((source) => {
                  const IconComponent = getIconComponent(source.icon);
                  return (
                    <DropdownMenuItem
                      key={source.id}
                      onClick={() => handleSourceSelect(source)}
                      className="flex flex-col items-start gap-1 p-3 cursor-pointer"
                    >
                      <div className="flex items-center gap-2 w-full">
                        <IconComponent className="h-4 w-4 text-muted-foreground" />
                        <span className="font-medium">{source.name}</span>
                        {source.requiresAuth && (
                          <Lock className="h-3 w-3 text-muted-foreground ml-auto" />
                        )}
                      </div>
                      <p className="text-xs text-muted-foreground leading-tight">
                        {source.description}
                      </p>
                      <div className="flex items-center gap-1 mt-1">
                        {source.supportedFormats.map((format) => (
                          <span
                            key={format}
                            className="text-xs bg-muted px-1.5 py-0.5 rounded"
                          >
                            {format}
                          </span>
                        ))}
                      </div>
                    </DropdownMenuItem>
                  );
                })}
              </DropdownMenuSubContent>
            </DropdownMenuSub>
          ))}
        </DropdownMenuContent>
      </DropdownMenu>

      {/* Dialog para configuração da importação */}
      <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center gap-2">
              {selectedSource && (
                <>
                  {React.createElement(getIconComponent(selectedSource.icon), { 
                    className: "h-5 w-5" 
                  })}
                  Importar de {selectedSource.name}
                </>
              )}
            </DialogTitle>
          </DialogHeader>
          
          {selectedSource && (
            <ImportSourceSelector
              source={selectedSource}
              onClose={() => setIsDialogOpen(false)}
            />
          )}
        </DialogContent>
      </Dialog>
    </>
  );
}