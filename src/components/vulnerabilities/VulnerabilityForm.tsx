import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Shield, 
  Save, 
  ArrowLeft,
  AlertTriangle,
  Info,
  X,
  Plus,
  User,
  FileText,
  Code,
  Globe,
  Server,
  Smartphone,
  Database,
  Cloud,
  Monitor,
  Target,
  Settings
} from 'lucide-react';
import { useNavigate, useParams } from 'react-router-dom';
import { toast } from 'sonner';
import { useCustomFields } from './hooks/useCustomFields';

// Types
type VulnerabilitySeverity = 'Critical' | 'High' | 'Medium' | 'Low' | 'Info';
type VulnerabilityStatus = 'Open' | 'In_Progress' | 'Testing' | 'Resolved' | 'Accepted' | 'False_Positive' | 'Duplicate';
type VulnerabilitySource = 'Pentest' | 'SAST' | 'DAST' | 'Cloud' | 'Infrastructure' | 'Manual' | 'Risk_Register' | 'Bug_Bounty' | 'Compliance_Audit';
type AssetType = 'Web_Application' | 'Mobile_App' | 'API' | 'Database' | 'Server' | 'Network_Device' | 'Cloud_Service' | 'Desktop_App';
type RemediationEffort = 'Low' | 'Medium' | 'High' | 'Very_High';
type BusinessImpact = 'Low' | 'Medium' | 'High' | 'Critical';

const SEVERITY_OPTIONS: { value: VulnerabilitySeverity; label: string; color: string }[] = [
  { value: 'Critical', label: 'Crítica', color: 'bg-red-100 text-red-800' },
  { value: 'High', label: 'Alta', color: 'bg-orange-100 text-orange-800' },
  { value: 'Medium', label: 'Média', color: 'bg-yellow-100 text-yellow-800' },
  { value: 'Low', label: 'Baixa', color: 'bg-blue-100 text-blue-800' },
  { value: 'Info', label: 'Informativa', color: 'bg-gray-100 text-gray-800' },
];

const STATUS_OPTIONS: { value: VulnerabilityStatus; label: string }[] = [
  { value: 'Open', label: 'Aberta' },
  { value: 'In_Progress', label: 'Em Progresso' },
  { value: 'Testing', label: 'Em Teste' },
  { value: 'Resolved', label: 'Resolvida' },
  { value: 'Accepted', label: 'Aceita' },
  { value: 'False_Positive', label: 'Falso Positivo' },
  { value: 'Duplicate', label: 'Duplicada' },
];

const SOURCE_OPTIONS: { value: VulnerabilitySource; label: string; icon: any }[] = [
  { value: 'Pentest', label: 'Teste de Penetração', icon: Shield },
  { value: 'SAST', label: 'SAST', icon: Code },
  { value: 'DAST', label: 'DAST', icon: Globe },
  { value: 'Cloud', label: 'Cloud Security', icon: Cloud },
  { value: 'Infrastructure', label: 'Infraestrutura', icon: Server },
  { value: 'Manual', label: 'Manual', icon: User },
  { value: 'Risk_Register', label: 'Registro de Riscos', icon: FileText },
  { value: 'Bug_Bounty', label: 'Bug Bounty', icon: Target },
  { value: 'Compliance_Audit', label: 'Auditoria de Compliance', icon: Shield },
];

const ASSET_TYPE_OPTIONS: { value: AssetType; label: string; icon: any }[] = [
  { value: 'Web_Application', label: 'Aplicação Web', icon: Globe },
  { value: 'Mobile_App', label: 'Aplicativo Mobile', icon: Smartphone },
  { value: 'API', label: 'API', icon: Code },
  { value: 'Database', label: 'Banco de Dados', icon: Database },
  { value: 'Server', label: 'Servidor', icon: Server },
  { value: 'Network_Device', label: 'Dispositivo de Rede', icon: Monitor },
  { value: 'Cloud_Service', label: 'Serviço em Nuvem', icon: Cloud },
  { value: 'Desktop_App', label: 'Aplicação Desktop', icon: Monitor },
];

const EFFORT_OPTIONS: { value: RemediationEffort; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Very_High', label: 'Muito Alto' },
];

const IMPACT_OPTIONS: { value: BusinessImpact; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Critical', label: 'Crítico' },
];

export default function VulnerabilityForm() {
  const navigate = useNavigate();
  const { id } = useParams();
  const { customFields, getFieldValues, saveFieldValues } = useCustomFields();
  
  const isEditing = Boolean(id);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [customFieldValues, setCustomFieldValues] = useState<Record<string, any>>({});
  
  // Form state
  const [formData, setFormData] = useState({
    id: '',
    app_id: '',
    title: '',
    description: '',
    severity: 'Medium' as VulnerabilitySeverity,
    cvss_score: '',
    cvss_vector: '',
    cve_id: '',
    cwe_id: '',
    source_type: 'Manual' as VulnerabilitySource,
    source_tool: '',
    source_scan_id: '',
    asset_name: '',
    asset_type: 'Web_Application' as AssetType,
    asset_ip: '',
    asset_url: '',
    status: 'Open' as VulnerabilityStatus,
    assigned_to: '',
    assigned_team: '',
    due_date: '',
    remediation_effort: 'Medium' as RemediationEffort,
    business_impact: 'Medium' as BusinessImpact,
    tags: [] as string[],
    remediation_steps: '',
    remediation_notes: '',
    false_positive_reason: '',
    retest_required: false,
    exploit_available: false,
    patch_available: false,
    workaround_available: false,
    compliance_frameworks: [] as string[],
  });

  const [newTag, setNewTag] = useState('');
  const [errors, setErrors] = useState<{ [key: string]: string }>({});

  useEffect(() => {
    if (isEditing && id) {
      loadVulnerability(id);
      loadCustomFieldValues(id);
    }
  }, [id, isEditing]);

  const loadCustomFieldValues = async (vulnerabilityId: string) => {
    try {
      const values = await getFieldValues(vulnerabilityId);
      setCustomFieldValues(values);
    } catch (error) {
      console.error('Error loading custom field values:', error);
    }
  };

  const loadVulnerability = async (vulnerabilityId: string) => {
    setLoading(true);
    try {
      // Simulate loading vulnerability data
      const mockVulnerability = {
        id: 'VULN-2024-001',
        app_id: 'APP-WEB-001',
        title: 'SQL Injection in Login Form',
        description: 'The login form is vulnerable to SQL injection attacks...',
        severity: 'High' as VulnerabilitySeverity,
        cvss_score: '8.1',
        cve_id: 'CVE-2024-1234',
        source_type: 'DAST' as VulnerabilitySource,
        source_tool: 'OWASP ZAP',
        asset_name: 'Web Portal',
        asset_type: 'Web_Application' as AssetType,
        status: 'Open' as VulnerabilityStatus,
        remediation_effort: 'Medium' as RemediationEffort,
        business_impact: 'High' as BusinessImpact,
        tags: ['sql-injection', 'authentication'],
        remediation_steps: 'Use parameterized queries...',
      };
      
      setFormData(prev => ({ ...prev, ...mockVulnerability }));
    } catch (error) {
      toast.error('Erro ao carregar vulnerabilidade');
      navigate('/vulnerabilities/management');
    } finally {
      setLoading(false);
    }
  };

  const validateForm = (): boolean => {
    const newErrors: { [key: string]: string } = {};

    if (!formData.title.trim()) {
      newErrors.title = 'Título é obrigatório';
    }

    if (!formData.description.trim()) {
      newErrors.description = 'Descrição é obrigatória';
    }

    if (!formData.asset_name.trim()) {
      newErrors.asset_name = 'Nome do ativo é obrigatório';
    }

    if (!formData.source_tool.trim()) {
      newErrors.source_tool = 'Ferramenta de origem é obrigatória';
    }

    if (formData.cvss_score && (isNaN(Number(formData.cvss_score)) || Number(formData.cvss_score) < 0 || Number(formData.cvss_score) > 10)) {
      newErrors.cvss_score = 'CVSS Score deve ser um número entre 0 e 10';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSave = async () => {
    if (!validateForm()) {
      toast.error('Corrija os erros no formulário');
      return;
    }

    setSaving(true);
    try {
      // Simulate saving
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Save custom field values
      const vulnerabilityId = id || 'new-' + Date.now();
      await saveFieldValues(vulnerabilityId, customFieldValues);
      
      if (isEditing) {
        toast.success('Vulnerabilidade atualizada com sucesso');
      } else {
        toast.success('Vulnerabilidade criada com sucesso');
      }

      navigate('/vulnerabilities/management');
    } catch (error) {
      toast.error('Erro ao salvar vulnerabilidade');
    } finally {
      setSaving(false);
    }
  };

  const calculateRiskScore = (): number => {
    const severityWeight = {
      Critical: 10,
      High: 8,
      Medium: 5,
      Low: 3,
      Info: 1
    };

    const impactWeight = {
      Critical: 4,
      High: 3,
      Medium: 2,
      Low: 1
    };

    const baseScore = severityWeight[formData.severity] || 5;
    const impactMultiplier = impactWeight[formData.business_impact] || 2;
    
    return Math.min(10, Math.round((baseScore * impactMultiplier) / 4));
  };

  const calculatePriorityScore = (): number => {
    let priority = calculateRiskScore();
    
    if (formData.exploit_available) priority += 2;
    if (!formData.patch_available) priority += 1;
    if (formData.retest_required) priority += 1;
    
    return Math.min(10, priority);
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }));
      setNewTag('');
    }
  };

  const handleRemoveTag = (tagToRemove: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(tag => tag !== tagToRemove)
    }));
  };

  const getSeverityBadge = (severity: VulnerabilitySeverity) => {
    const option = SEVERITY_OPTIONS.find(opt => opt.value === severity);
    return (
      <Badge className={option?.color}>
        {option?.label}
      </Badge>
    );
  };

  const renderCustomField = (field: any) => {
    const value = customFieldValues[field.name] || field.defaultValue || '';
    
    const updateCustomFieldValue = (fieldName: string, newValue: any) => {
      setCustomFieldValues(prev => ({
        ...prev,
        [fieldName]: newValue
      }));
    };

    switch (field.type) {
      case 'select':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Select 
              value={value} 
              onValueChange={(newValue) => updateCustomFieldValue(field.name, newValue)}
            >
              <SelectTrigger>
                <SelectValue placeholder={field.placeholder || `Selecione ${field.label}`} />
              </SelectTrigger>
              <SelectContent>
                {field.options?.map((option: string) => (
                  <SelectItem key={option} value={option}>
                    {option}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'textarea':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Textarea
              id={field.name}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              rows={3}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'boolean':
        return (
          <div key={field.id} className="space-y-2">
            <div className="flex items-center space-x-2">
              <Switch
                checked={Boolean(value)}
                onCheckedChange={(checked) => updateCustomFieldValue(field.name, checked)}
              />
              <Label htmlFor={field.name}>
                {field.label}
                {field.required && <span className="text-red-500 ml-1">*</span>}
              </Label>
            </div>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'number':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="number"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              min={field.validation?.min}
              max={field.validation?.max}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'date':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="date"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'email':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="email"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'url':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="url"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      default: // text, phone
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type={field.type === 'phone' ? 'tel' : 'text'}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" onClick={() => navigate('/vulnerabilities/management')}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Voltar
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Shield className="h-8 w-8 text-primary" />
              {isEditing ? 'Editar Vulnerabilidade' : 'Nova Vulnerabilidade'}
            </h1>
            <p className="text-muted-foreground">
              {isEditing ? 'Atualize as informações da vulnerabilidade' : 'Registre uma nova vulnerabilidade no sistema'}
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => navigate('/vulnerabilities/management')}>
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Salvando...
              </>
            ) : (
              <>
                <Save className="h-4 w-4 mr-2" />
                {isEditing ? 'Atualizar' : 'Criar'}
              </>
            )}
          </Button>
        </div>
      </div>

      <Tabs defaultValue="basic" className="w-full">
        <TabsList>
          <TabsTrigger value="basic">Informações Básicas</TabsTrigger>
          <TabsTrigger value="technical">Detalhes Técnicos</TabsTrigger>
          <TabsTrigger value="remediation">Remediação</TabsTrigger>
          <TabsTrigger value="classification">Classificação</TabsTrigger>
          {customFields.length > 0 && (
            <TabsTrigger value="custom">Campos Customizados</TabsTrigger>
          )}
        </TabsList>

        <TabsContent value="basic" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Informações Básicas</CardTitle>
              <CardDescription>
                Dados principais da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* ID and APPID */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="id">ID</Label>
                  <Input
                    id="id"
                    value={formData.id}
                    onChange={(e) => setFormData(prev => ({ ...prev, id: e.target.value }))}
                    placeholder="Ex: VULN-2024-001"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="app_id">APPID</Label>
                  <Input
                    id="app_id"
                    value={formData.app_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, app_id: e.target.value }))}
                    placeholder="Ex: APP-WEB-001"
                  />
                </div>
              </div>

              {/* Title and Description */}
              <div className="grid grid-cols-1 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="title">Título *</Label>
                  <Input
                    id="title"
                    value={formData.title}
                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="Ex: SQL Injection no formulário de login"
                    className={errors.title ? 'border-red-500' : ''}
                  />
                  {errors.title && (
                    <p className="text-sm text-red-600">{errors.title}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="description">Descrição *</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="Descreva detalhadamente a vulnerabilidade encontrada..."
                    rows={4}
                    className={errors.description ? 'border-red-500' : ''}
                  />
                  {errors.description && (
                    <p className="text-sm text-red-600">{errors.description}</p>
                  )}
                </div>
              </div>

              {/* Severity and Status */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Severidade</Label>
                  <Select value={formData.severity} onValueChange={(value) => setFormData(prev => ({ ...prev, severity: value as VulnerabilitySeverity }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {SEVERITY_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <Badge className={option.color}>{option.label}</Badge>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Status</Label>
                  <Select value={formData.status} onValueChange={(value) => setFormData(prev => ({ ...prev, status: value as VulnerabilityStatus }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {STATUS_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Asset Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_name">Nome do Ativo *</Label>
                  <Input
                    id="asset_name"
                    value={formData.asset_name}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_name: e.target.value }))}
                    placeholder="Ex: Portal Web Principal"
                    className={errors.asset_name ? 'border-red-500' : ''}
                  />
                  {errors.asset_name && (
                    <p className="text-sm text-red-600">{errors.asset_name}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label>Tipo de Ativo</Label>
                  <Select value={formData.asset_type} onValueChange={(value) => setFormData(prev => ({ ...prev, asset_type: value as AssetType }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {ASSET_TYPE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Asset Details */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_ip">IP do Ativo</Label>
                  <Input
                    id="asset_ip"
                    value={formData.asset_ip}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_ip: e.target.value }))}
                    placeholder="Ex: 192.168.1.100"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="asset_url">URL do Ativo</Label>
                  <Input
                    id="asset_url"
                    value={formData.asset_url}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_url: e.target.value }))}
                    placeholder="Ex: https://portal.empresa.com"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="technical" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Detalhes Técnicos</CardTitle>
              <CardDescription>
                Informações técnicas e de origem da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Source Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Tipo de Fonte</Label>
                  <Select value={formData.source_type} onValueChange={(value) => setFormData(prev => ({ ...prev, source_type: value as VulnerabilitySource }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {SOURCE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_tool">Ferramenta de Origem *</Label>
                  <Input
                    id="source_tool"
                    value={formData.source_tool}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_tool: e.target.value }))}
                    placeholder="Ex: OWASP ZAP, Nessus, Manual"
                    className={errors.source_tool ? 'border-red-500' : ''}
                  />
                  {errors.source_tool && (
                    <p className="text-sm text-red-600">{errors.source_tool}</p>
                  )}
                </div>
              </div>

              {/* CVE and CWE */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cve_id">CVE ID</Label>
                  <Input
                    id="cve_id"
                    value={formData.cve_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cve_id: e.target.value }))}
                    placeholder="Ex: CVE-2024-1234"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cwe_id">CWE ID</Label>
                  <Input
                    id="cwe_id"
                    value={formData.cwe_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cwe_id: e.target.value }))}
                    placeholder="Ex: CWE-89"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_scan_id">ID do Scan</Label>
                  <Input
                    id="source_scan_id"
                    value={formData.source_scan_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_scan_id: e.target.value }))}
                    placeholder="ID do scan de origem"
                  />
                </div>
              </div>

              {/* CVSS Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cvss_score">CVSS Score</Label>
                  <Input
                    id="cvss_score"
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    value={formData.cvss_score}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_score: e.target.value }))}
                    placeholder="Ex: 8.1"
                    className={errors.cvss_score ? 'border-red-500' : ''}
                  />
                  {errors.cvss_score && (
                    <p className="text-sm text-red-600">{errors.cvss_score}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cvss_vector">CVSS Vector</Label>
                  <Input
                    id="cvss_vector"
                    value={formData.cvss_vector}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_vector: e.target.value }))}
                    placeholder="Ex: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
                  />
                </div>
              </div>

              {/* Flags */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Características</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.exploit_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, exploit_available: checked }))}
                    />
                    <Label>Exploit disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.patch_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, patch_available: checked }))}
                    />
                    <Label>Patch disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.workaround_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, workaround_available: checked }))}
                    />
                    <Label>Workaround disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.retest_required}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, retest_required: checked }))}
                    />
                    <Label>Reteste necessário</Label>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="remediation" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Remediação</CardTitle>
              <CardDescription>
                Informações sobre correção e remediação da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Assignment */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="assigned_to">Responsável</Label>
                  <Input
                    id="assigned_to"
                    value={formData.assigned_to}
                    onChange={(e) => setFormData(prev => ({ ...prev, assigned_to: e.target.value }))}
                    placeholder="Email do responsável"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="assigned_team">Equipe Responsável</Label>
                  <Input
                    id="assigned_team"
                    value={formData.assigned_team}
                    onChange={(e) => setFormData(prev => ({ ...prev, assigned_team: e.target.value }))}
                    placeholder="Nome da equipe"
                  />
                </div>
              </div>

              {/* Due Date */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="due_date">Prazo para Correção</Label>
                  <Input
                    id="due_date"
                    type="date"
                    value={formData.due_date}
                    onChange={(e) => setFormData(prev => ({ ...prev, due_date: e.target.value }))}
                  />
                </div>
              </div>

              {/* Remediation Steps */}
              <div className="space-y-2">
                <Label htmlFor="remediation_steps">Passos de Remediação</Label>
                <Textarea
                  id="remediation_steps"
                  value={formData.remediation_steps}
                  onChange={(e) => setFormData(prev => ({ ...prev, remediation_steps: e.target.value }))}
                  placeholder="Descreva os passos necessários para corrigir a vulnerabilidade..."
                  rows={4}
                />
              </div>

              {/* Remediation Notes */}
              <div className="space-y-2">
                <Label htmlFor="remediation_notes">Notas de Remediação</Label>
                <Textarea
                  id="remediation_notes"
                  value={formData.remediation_notes}
                  onChange={(e) => setFormData(prev => ({ ...prev, remediation_notes: e.target.value }))}
                  placeholder="Notas adicionais sobre a remediação..."
                  rows={3}
                />
              </div>

              {/* False Positive Reason */}
              {formData.status === 'False_Positive' && (
                <div className="space-y-2">
                  <Label htmlFor="false_positive_reason">Motivo do Falso Positivo</Label>
                  <Textarea
                    id="false_positive_reason"
                    value={formData.false_positive_reason}
                    onChange={(e) => setFormData(prev => ({ ...prev, false_positive_reason: e.target.value }))}
                    placeholder="Explique por que esta vulnerabilidade é um falso positivo..."
                    rows={3}
                  />
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="classification" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Classificação e Priorização</CardTitle>
              <CardDescription>
                Classificação de risco e impacto no negócio
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Risk Classification */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Esforço de Remediação</Label>
                  <Select value={formData.remediation_effort} onValueChange={(value) => setFormData(prev => ({ ...prev, remediation_effort: value as RemediationEffort }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {EFFORT_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto no Negócio</Label>
                  <Select value={formData.business_impact} onValueChange={(value) => setFormData(prev => ({ ...prev, business_impact: value as BusinessImpact }))}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      {IMPACT_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Calculated Scores */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Card>
                  <CardContent className="p-4">
                    <div className="text-center">
                      <p className="text-sm text-muted-foreground">Score de Risco</p>
                      <p className="text-2xl font-bold text-red-600">{calculateRiskScore()}/10</p>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardContent className="p-4">
                    <div className="text-center">
                      <p className="text-sm text-muted-foreground">Score de Prioridade</p>
                      <p className="text-2xl font-bold text-orange-600">{calculatePriorityScore()}/10</p>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Tags */}
              <div className="space-y-4">
                <Label>Tags</Label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {formData.tags.map((tag, index) => (
                    <Badge key={index} variant="secondary" className="flex items-center gap-1">
                      {tag}
                      <X 
                        className="h-3 w-3 cursor-pointer" 
                        onClick={() => handleRemoveTag(tag)}
                      />
                    </Badge>
                  ))}
                </div>
                <div className="flex gap-2">
                  <Input
                    value={newTag}
                    onChange={(e) => setNewTag(e.target.value)}
                    placeholder="Nova tag"
                    onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}
                  />
                  <Button type="button" variant="outline" onClick={handleAddTag}>
                    <Plus className="h-4 w-4" />
                  </Button>
                </div>
              </div>

              {/* Risk Summary */}
              <Alert>
                <Info className="h-4 w-4" />
                <AlertDescription>
                  <div className="space-y-2">
                    <p className="font-medium">Resumo da Classificação:</p>
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      <div>
                        <p>Severidade: {getSeverityBadge(formData.severity)}</p>
                        <p>Impacto: <Badge variant="outline">{IMPACT_OPTIONS.find(o => o.value === formData.business_impact)?.label}</Badge></p>
                      </div>
                      <div>
                        <p>Esforço: <Badge variant="outline">{EFFORT_OPTIONS.find(o => o.value === formData.remediation_effort)?.label}</Badge></p>
                        <p>Score Final: <Badge className="bg-red-100 text-red-800">{calculateRiskScore()}/10</Badge></p>
                      </div>
                    </div>
                  </div>
                </AlertDescription>
              </Alert>
            </CardContent>
          </Card>
        </TabsContent>

        {customFields.length > 0 && (
          <TabsContent value="custom" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Campos Customizados</CardTitle>
                <CardDescription>
                  Campos personalizados configurados para sua organização
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {customFields
                    .filter(field => field.tab === 'custom' || field.tab === undefined)
                    .sort((a, b) => a.order - b.order)
                    .map(field => renderCustomField(field))}
                </div>
                
                {customFields.filter(field => field.tab === 'custom' || field.tab === undefined).length === 0 && (
                  <div className="text-center py-8 text-muted-foreground">
                    <Settings className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p className="text-lg font-medium mb-2">Nenhum campo customizado</p>
                    <p>Os campos customizados aparecerão aqui quando configurados</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        )}
      </Tabs>
    </div>
  );
}