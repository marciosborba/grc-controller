import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Switch } from '@/components/ui/switch';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { 
  Shield, 
  Save, 
  ArrowLeft,
  AlertTriangle,
  Info,
  X,
  Plus,
  User,
  FileText,
  Code,
  Globe,
  Server,
  Smartphone,
  Database,
  Cloud,
  Monitor,
  Target,
  Settings
} from 'lucide-react';
import { useNavigate, useParams } from 'react-router-dom';
import { toast } from 'sonner';
import { useCustomFields } from './hooks/useCustomFields';

// Types
type VulnerabilitySeverity = 'Critical' | 'High' | 'Medium' | 'Low' | 'Info';
type VulnerabilityStatus = 'Open' | 'In_Progress' | 'Testing' | 'Resolved' | 'Accepted' | 'False_Positive' | 'Duplicate';
type VulnerabilitySource = 'Pentest' | 'SAST' | 'DAST' | 'Cloud' | 'Infrastructure' | 'Manual' | 'Risk_Register' | 'Bug_Bounty' | 'Compliance_Audit';
type AssetType = 'Web_Application' | 'Mobile_App' | 'API' | 'Database' | 'Server' | 'Network_Device' | 'Cloud_Service' | 'Desktop_App';
type RemediationEffort = 'Low' | 'Medium' | 'High' | 'Very_High';
type BusinessImpact = 'Low' | 'Medium' | 'High' | 'Critical';

const SEVERITY_OPTIONS: { value: VulnerabilitySeverity; label: string; color: string }[] = [
  { value: 'Critical', label: 'Crítica', color: 'bg-red-100 text-red-800' },
  { value: 'High', label: 'Alta', color: 'bg-orange-100 text-orange-800' },
  { value: 'Medium', label: 'Média', color: 'bg-yellow-100 text-yellow-800' },
  { value: 'Low', label: 'Baixa', color: 'bg-blue-100 text-blue-800' },
  { value: 'Info', label: 'Informativa', color: 'bg-gray-100 text-gray-800' },
];

const STATUS_OPTIONS: { value: VulnerabilityStatus; label: string }[] = [
  { value: 'Open', label: 'Aberta' },
  { value: 'In_Progress', label: 'Em Progresso' },
  { value: 'Testing', label: 'Em Teste' },
  { value: 'Resolved', label: 'Resolvida' },
  { value: 'Accepted', label: 'Aceita' },
  { value: 'False_Positive', label: 'Falso Positivo' },
  { value: 'Duplicate', label: 'Duplicada' },
];

const SOURCE_OPTIONS: { value: VulnerabilitySource; label: string; icon: any }[] = [
  { value: 'Pentest', label: 'Teste de Penetração', icon: Shield },
  { value: 'SAST', label: 'SAST', icon: Code },
  { value: 'DAST', label: 'DAST', icon: Globe },
  { value: 'Cloud', label: 'Cloud Security', icon: Cloud },
  { value: 'Infrastructure', label: 'Infraestrutura', icon: Server },
  { value: 'Manual', label: 'Manual', icon: User },
  { value: 'Risk_Register', label: 'Registro de Riscos', icon: FileText },
  { value: 'Bug_Bounty', label: 'Bug Bounty', icon: Target },
  { value: 'Compliance_Audit', label: 'Auditoria de Compliance', icon: Shield },
];

const ASSET_TYPE_OPTIONS: { value: AssetType; label: string; icon: any }[] = [
  { value: 'Web_Application', label: 'Aplicação Web', icon: Globe },
  { value: 'Mobile_App', label: 'Aplicativo Mobile', icon: Smartphone },
  { value: 'API', label: 'API', icon: Code },
  { value: 'Database', label: 'Banco de Dados', icon: Database },
  { value: 'Server', label: 'Servidor', icon: Server },
  { value: 'Network_Device', label: 'Dispositivo de Rede', icon: Monitor },
  { value: 'Cloud_Service', label: 'Serviço em Nuvem', icon: Cloud },
  { value: 'Desktop_App', label: 'Aplicação Desktop', icon: Monitor },
];

const EFFORT_OPTIONS: { value: RemediationEffort; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Very_High', label: 'Muito Alto' },
];

const IMPACT_OPTIONS: { value: BusinessImpact; label: string }[] = [
  { value: 'Low', label: 'Baixo' },
  { value: 'Medium', label: 'Médio' },
  { value: 'High', label: 'Alto' },
  { value: 'Critical', label: 'Crítico' },
];

export default function VulnerabilityForm() {
  const navigate = useNavigate();
  const { id } = useParams();
  const { customFields, getFieldValues, saveFieldValues } = useCustomFields();
  
  const isEditing = Boolean(id);
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);
  const [customFieldValues, setCustomFieldValues] = useState<Record<string, any>>({});
  
  // Form state
  const [formData, setFormData] = useState({
    id: '',
    app_id: '',
    title: '',
    description: '',
    severity: 'Medium' as VulnerabilitySeverity,
    cvss_score: '',
    cvss_vector: '',
    cve_id: '',
    cwe_id: '',
    source_type: 'Manual' as VulnerabilitySource,
    source_tool: '',
    source_scan_id: '',
    asset_name: '',
    asset_type: 'Web_Application' as AssetType,
    asset_ip: '',
    asset_url: '',
    status: 'Open' as VulnerabilityStatus,
    assigned_to: '',
    assigned_team: '',
    due_date: '',
    remediation_effort: 'Medium' as RemediationEffort,
    business_impact: 'Medium' as BusinessImpact,
    tags: [] as string[],
    remediation_steps: '',
    remediation_notes: '',
    false_positive_reason: '',
    retest_required: false,
    exploit_available: false,
    patch_available: false,
    workaround_available: false,
    compliance_frameworks: [] as string[],
  });

  // Advanced Risk Calculation State
  const [riskFactors, setRiskFactors] = useState({
    // CVSS 3.1 Base Metrics
    attackVector: 'Network' as 'Network' | 'Adjacent' | 'Local' | 'Physical',
    attackComplexity: 'Low' as 'Low' | 'High',
    privilegesRequired: 'None' as 'None' | 'Low' | 'High',
    userInteraction: 'None' as 'None' | 'Required',
    scope: 'Unchanged' as 'Unchanged' | 'Changed',
    confidentialityImpact: 'High' as 'None' | 'Low' | 'High',
    integrityImpact: 'High' as 'None' | 'Low' | 'High',
    availabilityImpact: 'High' as 'None' | 'Low' | 'High',
    
    // Environmental Factors
    assetExposure: 'Internet' as 'Internet' | 'Internal' | 'Restricted' | 'Isolated',
    assetCriticality: 'High' as 'Low' | 'Medium' | 'High' | 'Critical',
    dataClassification: 'Confidential' as 'Public' | 'Internal' | 'Confidential' | 'Restricted',
    
    // Temporal Factors
    exploitCodeMaturity: 'Functional' as 'Not_Defined' | 'Unproven' | 'Proof_of_Concept' | 'Functional' | 'High',
    remediationLevel: 'Official_Fix' as 'Not_Defined' | 'Official_Fix' | 'Temporary_Fix' | 'Workaround' | 'Unavailable',
    reportConfidence: 'Confirmed' as 'Not_Defined' | 'Unknown' | 'Reasonable' | 'Confirmed',
    
    // Business Impact
    businessCriticality: 'High' as 'Low' | 'Medium' | 'High' | 'Critical',
    complianceImpact: 'High' as 'None' | 'Low' | 'Medium' | 'High',
    reputationImpact: 'Medium' as 'Low' | 'Medium' | 'High' | 'Critical',
    financialImpact: 'Medium' as 'Low' | 'Medium' | 'High' | 'Critical',
  });

  const [newTag, setNewTag] = useState('');
  const [errors, setErrors] = useState<{ [key: string]: string }>({});

  useEffect(() => {
    if (isEditing && id) {
      loadVulnerability(id);
      loadCustomFieldValues(id);
    }
  }, [id, isEditing]);

  const loadCustomFieldValues = async (vulnerabilityId: string) => {
    try {
      const values = await getFieldValues(vulnerabilityId);
      setCustomFieldValues(values);
    } catch (error) {
      console.error('Error loading custom field values:', error);
    }
  };

  const loadVulnerability = async (vulnerabilityId: string) => {
    setLoading(true);
    try {
      // Simulate loading vulnerability data
      const mockVulnerability = {
        id: 'VULN-2024-001',
        app_id: 'APP-WEB-001',
        title: 'SQL Injection in Login Form',
        description: 'The login form is vulnerable to SQL injection attacks...',
        severity: 'High' as VulnerabilitySeverity,
        cvss_score: '8.1',
        cve_id: 'CVE-2024-1234',
        source_type: 'DAST' as VulnerabilitySource,
        source_tool: 'OWASP ZAP',
        asset_name: 'Web Portal',
        asset_type: 'Web_Application' as AssetType,
        status: 'Open' as VulnerabilityStatus,
        remediation_effort: 'Medium' as RemediationEffort,
        business_impact: 'High' as BusinessImpact,
        tags: ['sql-injection', 'authentication'],
        remediation_steps: 'Use parameterized queries...',
      };
      
      setFormData(prev => ({ ...prev, ...mockVulnerability }));
    } catch (error) {
      toast.error('Erro ao carregar vulnerabilidade');
      navigate('/vulnerabilities/list');
    } finally {
      setLoading(false);
    }
  };

  const validateForm = (): boolean => {
    const newErrors: { [key: string]: string } = {};

    if (!formData.title.trim()) {
      newErrors.title = 'Título é obrigatório';
    }

    if (!formData.description.trim()) {
      newErrors.description = 'Descrição é obrigatória';
    }

    if (!formData.asset_name.trim()) {
      newErrors.asset_name = 'Nome do ativo é obrigatório';
    }

    if (!formData.source_tool.trim()) {
      newErrors.source_tool = 'Ferramenta de origem é obrigatória';
    }

    if (formData.cvss_score && (isNaN(Number(formData.cvss_score)) || Number(formData.cvss_score) < 0 || Number(formData.cvss_score) > 10)) {
      newErrors.cvss_score = 'CVSS Score deve ser um número entre 0 e 10';
    }

    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  };

  const handleSave = async () => {
    if (!validateForm()) {
      toast.error('Corrija os erros no formulário');
      return;
    }

    setSaving(true);
    try {
      // Simulate saving
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Save custom field values
      const vulnerabilityId = id || 'new-' + Date.now();
      await saveFieldValues(vulnerabilityId, customFieldValues);
      
      if (isEditing) {
        toast.success('Vulnerabilidade atualizada com sucesso');
      } else {
        toast.success('Vulnerabilidade criada com sucesso');
      }

      navigate('/vulnerabilities/list');
    } catch (error) {
      toast.error('Erro ao salvar vulnerabilidade');
    } finally {
      setSaving(false);
    }
  };

  // Advanced CVSS 3.1 Calculator
  const calculateCVSSBaseScore = (): number => {
    const attackVectorScores = { Network: 0.85, Adjacent: 0.62, Local: 0.55, Physical: 0.2 };
    const attackComplexityScores = { Low: 0.77, High: 0.44 };
    const privilegesRequiredScores = {
      None: 0.85,
      Low: riskFactors.scope === 'Unchanged' ? 0.62 : 0.68,
      High: riskFactors.scope === 'Unchanged' ? 0.27 : 0.50
    };
    const userInteractionScores = { None: 0.85, Required: 0.62 };
    const impactScores = { None: 0, Low: 0.22, High: 0.56 };

    const exploitability = 8.22 * attackVectorScores[riskFactors.attackVector] * 
                          attackComplexityScores[riskFactors.attackComplexity] * 
                          privilegesRequiredScores[riskFactors.privilegesRequired] * 
                          userInteractionScores[riskFactors.userInteraction];

    const impact = 1 - ((1 - impactScores[riskFactors.confidentialityImpact]) * 
                       (1 - impactScores[riskFactors.integrityImpact]) * 
                       (1 - impactScores[riskFactors.availabilityImpact]));

    let baseScore;
    if (impact <= 0) {
      baseScore = 0;
    } else if (riskFactors.scope === 'Unchanged') {
      baseScore = Math.min(10, (impact + exploitability));
    } else {
      baseScore = Math.min(10, 1.08 * (impact + exploitability));
    }

    return Math.round(baseScore * 10) / 10;
  };

  const calculateTemporalScore = (): number => {
    const exploitCodeMaturityScores = {
      Not_Defined: 1.0, Unproven: 0.91, Proof_of_Concept: 0.94, Functional: 0.97, High: 1.0
    };
    const remediationLevelScores = {
      Not_Defined: 1.0, Official_Fix: 0.95, Temporary_Fix: 0.96, Workaround: 0.97, Unavailable: 1.0
    };
    const reportConfidenceScores = {
      Not_Defined: 1.0, Unknown: 0.92, Reasonable: 0.96, Confirmed: 1.0
    };

    const baseScore = calculateCVSSBaseScore();
    const temporalScore = baseScore * 
                         exploitCodeMaturityScores[riskFactors.exploitCodeMaturity] * 
                         remediationLevelScores[riskFactors.remediationLevel] * 
                         reportConfidenceScores[riskFactors.reportConfidence];

    return Math.round(temporalScore * 10) / 10;
  };

  const calculateEnvironmentalScore = (): number => {
    const exposureMultiplier = {
      Internet: 1.2, Internal: 1.0, Restricted: 0.8, Isolated: 0.6
    };
    const criticalityMultiplier = {
      Low: 0.7, Medium: 0.85, High: 1.0, Critical: 1.15
    };
    const dataClassificationMultiplier = {
      Public: 0.7, Internal: 0.85, Confidential: 1.0, Restricted: 1.15
    };

    const temporalScore = calculateTemporalScore();
    const environmentalScore = temporalScore * 
                              exposureMultiplier[riskFactors.assetExposure] * 
                              criticalityMultiplier[riskFactors.assetCriticality] * 
                              dataClassificationMultiplier[riskFactors.dataClassification];

    return Math.min(10, Math.round(environmentalScore * 10) / 10);
  };

  const calculateBusinessRiskScore = (): number => {
    const businessWeights = {
      Low: 1, Medium: 2, High: 3, Critical: 4
    };
    const complianceWeights = {
      None: 0, Low: 1, Medium: 2, High: 3
    };

    const technicalScore = calculateEnvironmentalScore();
    const businessFactor = (
      businessWeights[riskFactors.businessCriticality] + 
      businessWeights[riskFactors.reputationImpact] + 
      businessWeights[riskFactors.financialImpact] + 
      complianceWeights[riskFactors.complianceImpact]
    ) / 13; // Normalize to 0-1

    const finalScore = (technicalScore * 0.7) + (businessFactor * 10 * 0.3);
    return Math.min(10, Math.round(finalScore * 10) / 10);
  };

  const calculatePriorityScore = (): number => {
    let priority = calculateBusinessRiskScore();
    
    // Temporal factors
    if (riskFactors.exploitCodeMaturity === 'Functional' || riskFactors.exploitCodeMaturity === 'High') priority += 1;
    if (riskFactors.remediationLevel === 'Unavailable') priority += 1;
    if (riskFactors.assetExposure === 'Internet') priority += 0.5;
    if (riskFactors.assetCriticality === 'Critical') priority += 0.5;
    
    return Math.min(10, Math.round(priority * 10) / 10);
  };

  const getRiskLevel = (score: number): { level: string; color: string; description: string } => {
    if (score >= 9.0) return { level: 'Crítico', color: 'bg-red-600 text-white', description: 'Requer ação imediata' };
    if (score >= 7.0) return { level: 'Alto', color: 'bg-red-500 text-white', description: 'Alta prioridade' };
    if (score >= 4.0) return { level: 'Médio', color: 'bg-yellow-500 text-white', description: 'Prioridade moderada' };
    if (score >= 0.1) return { level: 'Baixo', color: 'bg-green-500 text-white', description: 'Baixa prioridade' };
    return { level: 'Informativo', color: 'bg-gray-500 text-white', description: 'Apenas informativo' };
  };

  const calculateRiskScore = (): number => {
    return calculateBusinessRiskScore();
  };

  const handleAddTag = () => {
    if (newTag.trim() && !formData.tags.includes(newTag.trim())) {
      setFormData(prev => ({
        ...prev,
        tags: [...prev.tags, newTag.trim()]
      }));
      setNewTag('');
    }
  };

  const handleRemoveTag = (tagToRemove: string) => {
    setFormData(prev => ({
      ...prev,
      tags: prev.tags.filter(tag => tag !== tagToRemove)
    }));
  };

  const getSeverityBadge = (severity: VulnerabilitySeverity) => {
    const option = SEVERITY_OPTIONS.find(opt => opt.value === severity);
    return (
      <Badge className={option?.color}>
        {option?.label}
      </Badge>
    );
  };

  const renderCustomField = (field: any) => {
    const value = customFieldValues[field.name] || field.defaultValue || '';
    
    const updateCustomFieldValue = (fieldName: string, newValue: any) => {
      setCustomFieldValues(prev => ({
        ...prev,
        [fieldName]: newValue
      }));
    };

    switch (field.type) {
      case 'select':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Select 
              value={value} 
              onValueChange={(newValue) => updateCustomFieldValue(field.name, newValue)}
            >
              <SelectTrigger>
                <SelectValue placeholder={field.placeholder || `Selecione ${field.label}`} />
              </SelectTrigger>
              <SelectContent>
                {field.options?.map((option: string) => (
                  <SelectItem key={option} value={option}>
                    {option}
                  </SelectItem>
                ))}
              </SelectContent>
            </Select>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'textarea':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Textarea
              id={field.name}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              rows={3}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'boolean':
        return (
          <div key={field.id} className="space-y-2">
            <div className="flex items-center space-x-2">
              <Switch
                checked={Boolean(value)}
                onCheckedChange={(checked) => updateCustomFieldValue(field.name, checked)}
              />
              <Label htmlFor={field.name}>
                {field.label}
                {field.required && <span className="text-red-500 ml-1">*</span>}
              </Label>
            </div>
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'number':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="number"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
              min={field.validation?.min}
              max={field.validation?.max}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'date':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="date"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'email':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="email"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      case 'url':
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type="url"
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
      
      default: // text, phone
        return (
          <div key={field.id} className="space-y-2">
            <Label htmlFor={field.name}>
              {field.label}
              {field.required && <span className="text-red-500 ml-1">*</span>}
            </Label>
            <Input
              id={field.name}
              type={field.type === 'phone' ? 'tel' : 'text'}
              value={value}
              onChange={(e) => updateCustomFieldValue(field.name, e.target.value)}
              placeholder={field.placeholder}
            />
            {field.description && (
              <p className="text-xs text-muted-foreground">{field.description}</p>
            )}
          </div>
        );
    }
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[400px]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          <Button variant="ghost" onClick={() => navigate('/vulnerabilities/list')}>
            <ArrowLeft className="h-4 w-4 mr-2" />
            Voltar
          </Button>
          <div>
            <h1 className="text-3xl font-bold flex items-center gap-2">
              <Shield className="h-8 w-8 text-primary" />
              {isEditing ? 'Editar Vulnerabilidade' : 'Nova Vulnerabilidade'}
            </h1>
            <p className="text-muted-foreground">
              {isEditing ? 'Atualize as informações da vulnerabilidade' : 'Registre uma nova vulnerabilidade no sistema'}
            </p>
          </div>
        </div>
        <div className="flex gap-2">
          <Button variant="outline" onClick={() => navigate('/vulnerabilities/list')}>
            Cancelar
          </Button>
          <Button onClick={handleSave} disabled={saving}>
            {saving ? (
              <>
                <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Salvando...
              </>
            ) : (
              <>
                <Save className="h-4 w-4 mr-2" />
                {isEditing ? 'Atualizar' : 'Criar'}
              </>
            )}
          </Button>
        </div>
      </div>

      <Tabs defaultValue="basic" className="w-full">
        <TabsList>
          <TabsTrigger value="basic">Informações Básicas</TabsTrigger>
          <TabsTrigger value="technical">Detalhes Técnicos</TabsTrigger>
          <TabsTrigger value="remediation">Remediação</TabsTrigger>
          <TabsTrigger value="classification">Classificação</TabsTrigger>
          {customFields.length > 0 && (
            <TabsTrigger value="custom">Campos Customizados</TabsTrigger>
          )}
        </TabsList>

        <TabsContent value="basic" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Informações Básicas</CardTitle>
              <CardDescription>
                Dados principais da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* ID and APPID */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="id">ID</Label>
                  <Input
                    id="id"
                    value={formData.id}
                    onChange={(e) => setFormData(prev => ({ ...prev, id: e.target.value }))}
                    placeholder="Ex: VULN-2024-001"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="app_id">APPID</Label>
                  <Input
                    id="app_id"
                    value={formData.app_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, app_id: e.target.value }))}
                    placeholder="Ex: APP-WEB-001"
                  />
                </div>
              </div>

              {/* Title and Description */}
              <div className="grid grid-cols-1 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="title">Título *</Label>
                  <Input
                    id="title"
                    value={formData.title}
                    onChange={(e) => setFormData(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="Ex: SQL Injection no formulário de login"
                    className={errors.title ? 'border-red-500' : ''}
                  />
                  {errors.title && (
                    <p className="text-sm text-red-600">{errors.title}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="description">Descrição *</Label>
                  <Textarea
                    id="description"
                    value={formData.description}
                    onChange={(e) => setFormData(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="Descreva detalhadamente a vulnerabilidade encontrada..."
                    rows={4}
                    className={errors.description ? 'border-red-500' : ''}
                  />
                  {errors.description && (
                    <p className="text-sm text-red-600">{errors.description}</p>
                  )}
                </div>
              </div>

              {/* Severity and Status */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Severidade</Label>
                  <Select value={formData.severity} onValueChange={(value) => setFormData(prev => ({ ...prev, severity: value as VulnerabilitySeverity }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {SEVERITY_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <Badge className={option.color}>{option.label}</Badge>
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Status</Label>
                  <Select value={formData.status} onValueChange={(value) => setFormData(prev => ({ ...prev, status: value as VulnerabilityStatus }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {STATUS_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Asset Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_name">Nome do Ativo *</Label>
                  <Input
                    id="asset_name"
                    value={formData.asset_name}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_name: e.target.value }))}
                    placeholder="Ex: Portal Web Principal"
                    className={errors.asset_name ? 'border-red-500' : ''}
                  />
                  {errors.asset_name && (
                    <p className="text-sm text-red-600">{errors.asset_name}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label>Tipo de Ativo</Label>
                  <Select value={formData.asset_type} onValueChange={(value) => setFormData(prev => ({ ...prev, asset_type: value as AssetType }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {ASSET_TYPE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Asset Details */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="asset_ip">IP do Ativo</Label>
                  <Input
                    id="asset_ip"
                    value={formData.asset_ip}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_ip: e.target.value }))}
                    placeholder="Ex: 192.168.1.100"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="asset_url">URL do Ativo</Label>
                  <Input
                    id="asset_url"
                    value={formData.asset_url}
                    onChange={(e) => setFormData(prev => ({ ...prev, asset_url: e.target.value }))}
                    placeholder="Ex: https://portal.empresa.com"
                  />
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="technical" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Detalhes Técnicos</CardTitle>
              <CardDescription>
                Informações técnicas e de origem da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Source Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Tipo de Fonte</Label>
                  <Select value={formData.source_type} onValueChange={(value) => setFormData(prev => ({ ...prev, source_type: value as VulnerabilitySource }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {SOURCE_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          <div className="flex items-center gap-2">
                            <option.icon className="h-4 w-4" />
                            {option.label}
                          </div>
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_tool">Ferramenta de Origem *</Label>
                  <Input
                    id="source_tool"
                    value={formData.source_tool}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_tool: e.target.value }))}
                    placeholder="Ex: OWASP ZAP, Nessus, Manual"
                    className={errors.source_tool ? 'border-red-500' : ''}
                  />
                  {errors.source_tool && (
                    <p className="text-sm text-red-600">{errors.source_tool}</p>
                  )}
                </div>
              </div>

              {/* CVE and CWE */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cve_id">CVE ID</Label>
                  <Input
                    id="cve_id"
                    value={formData.cve_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cve_id: e.target.value }))}
                    placeholder="Ex: CVE-2024-1234"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cwe_id">CWE ID</Label>
                  <Input
                    id="cwe_id"
                    value={formData.cwe_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, cwe_id: e.target.value }))}
                    placeholder="Ex: CWE-89"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="source_scan_id">ID do Scan</Label>
                  <Input
                    id="source_scan_id"
                    value={formData.source_scan_id}
                    onChange={(e) => setFormData(prev => ({ ...prev, source_scan_id: e.target.value }))}
                    placeholder="ID do scan de origem"
                  />
                </div>
              </div>

              {/* CVSS Information */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="cvss_score">CVSS Score</Label>
                  <Input
                    id="cvss_score"
                    type="number"
                    min="0"
                    max="10"
                    step="0.1"
                    value={formData.cvss_score}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_score: e.target.value }))}
                    placeholder="Ex: 8.1"
                    className={errors.cvss_score ? 'border-red-500' : ''}
                  />
                  {errors.cvss_score && (
                    <p className="text-sm text-red-600">{errors.cvss_score}</p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor="cvss_vector">CVSS Vector</Label>
                  <Input
                    id="cvss_vector"
                    value={formData.cvss_vector}
                    onChange={(e) => setFormData(prev => ({ ...prev, cvss_vector: e.target.value }))}
                    placeholder="Ex: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H"
                  />
                </div>
              </div>

              {/* Flags */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Características</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.exploit_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, exploit_available: checked }))}
                    />
                    <Label>Exploit disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.patch_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, patch_available: checked }))}
                    />
                    <Label>Patch disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.workaround_available}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, workaround_available: checked }))}
                    />
                    <Label>Workaround disponível</Label>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Switch
                      checked={formData.retest_required}
                      onCheckedChange={(checked) => setFormData(prev => ({ ...prev, retest_required: checked }))}
                    />
                    <Label>Reteste necessário</Label>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="remediation" className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>Remediação</CardTitle>
              <CardDescription>
                Informações sobre correção e remediação da vulnerabilidade
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Assignment */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="assigned_to">Responsável</Label>
                  <Input
                    id="assigned_to"
                    value={formData.assigned_to}
                    onChange={(e) => setFormData(prev => ({ ...prev, assigned_to: e.target.value }))}
                    placeholder="Email do responsável"
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor="assigned_team">Equipe Responsável</Label>
                  <Input
                    id="assigned_team"
                    value={formData.assigned_team}
                    onChange={(e) => setFormData(prev => ({ ...prev, assigned_team: e.target.value }))}
                    placeholder="Nome da equipe"
                  />
                </div>
              </div>

              {/* Due Date */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="due_date">Prazo para Correção</Label>
                  <Input
                    id="due_date"
                    type="date"
                    value={formData.due_date}
                    onChange={(e) => setFormData(prev => ({ ...prev, due_date: e.target.value }))}
                  />
                </div>
              </div>

              {/* Remediation Steps */}
              <div className="space-y-2">
                <Label htmlFor="remediation_steps">Passos de Remediação</Label>
                <Textarea
                  id="remediation_steps"
                  value={formData.remediation_steps}
                  onChange={(e) => setFormData(prev => ({ ...prev, remediation_steps: e.target.value }))}
                  placeholder="Descreva os passos necessários para corrigir a vulnerabilidade..."
                  rows={4}
                />
              </div>

              {/* Remediation Notes */}
              <div className="space-y-2">
                <Label htmlFor="remediation_notes">Notas de Remediação</Label>
                <Textarea
                  id="remediation_notes"
                  value={formData.remediation_notes}
                  onChange={(e) => setFormData(prev => ({ ...prev, remediation_notes: e.target.value }))}
                  placeholder="Notas adicionais sobre a remediação..."
                  rows={3}
                />
              </div>

              {/* False Positive Reason */}
              {formData.status === 'False_Positive' && (
                <div className="space-y-2">
                  <Label htmlFor="false_positive_reason">Motivo do Falso Positivo</Label>
                  <Textarea
                    id="false_positive_reason"
                    value={formData.false_positive_reason}
                    onChange={(e) => setFormData(prev => ({ ...prev, false_positive_reason: e.target.value }))}
                    placeholder="Explique por que esta vulnerabilidade é um falso positivo..."
                    rows={3}
                  />
                </div>
              )}
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="classification" className="space-y-6">
          {/* Risk Calculator Header */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <AlertTriangle className="h-6 w-6" />
                Calculadora de Risco e Priorização
              </CardTitle>
              <CardDescription>
                Calcule a criticidade, prioridade e risco da vulnerabilidade baseado em padrões da indústria (CVSS 3.1)
              </CardDescription>
            </CardHeader>
          </Card>

          {/* CVSS 3.1 Base Metrics */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">CVSS 3.1 - Métricas Base</CardTitle>
              <CardDescription>
                Configure os vetores de ataque para calcular o score base CVSS
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Vetor de Ataque (AV)</Label>
                  <Select value={riskFactors.attackVector} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, attackVector: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Network" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Rede (N)</SelectItem>
                      <SelectItem value="Adjacent" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Adjacente (A)</SelectItem>
                      <SelectItem value="Local" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Local (L)</SelectItem>
                      <SelectItem value="Physical" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Físico (P)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Complexidade do Ataque (AC)</Label>
                  <Select value={riskFactors.attackComplexity} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, attackComplexity: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixa (L)</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alta (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Privilégios Necessários (PR)</Label>
                  <Select value={riskFactors.privilegesRequired} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, privilegesRequired: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhum (N)</SelectItem>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo (L)</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Interação do Usuário (UI)</Label>
                  <Select value={riskFactors.userInteraction} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, userInteraction: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhuma (N)</SelectItem>
                      <SelectItem value="Required" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Necessária (R)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Escopo (S)</Label>
                  <Select value={riskFactors.scope} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, scope: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Unchanged" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Inalterado (U)</SelectItem>
                      <SelectItem value="Changed" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alterado (C)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto na Confidencialidade (C)</Label>
                  <Select value={riskFactors.confidentialityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, confidentialityImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhum (N)</SelectItem>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo (L)</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto na Integridade (I)</Label>
                  <Select value={riskFactors.integrityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, integrityImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhum (N)</SelectItem>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo (L)</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto na Disponibilidade (A)</Label>
                  <Select value={riskFactors.availabilityImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, availabilityImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhum (N)</SelectItem>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo (L)</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto (H)</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              <div className="bg-primary/10 p-4 rounded-lg border">
                <div className="flex items-center gap-2 mb-2">
                  <Info className="h-4 w-4 text-primary" />
                  <span className="font-medium text-foreground">CVSS Base Score</span>
                </div>
                <div className="text-2xl font-bold text-primary">{calculateCVSSBaseScore()}/10</div>
                <p className="text-sm text-muted-foreground mt-1">Score base calculado automaticamente</p>
              </div>
            </CardContent>
          </Card>

          {/* Environmental and Temporal Factors */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Environmental Factors */}
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Fatores Ambientais</CardTitle>
                <CardDescription>
                  Contexto do ambiente e exposição do ativo
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label>Exposição do Ativo</Label>
                  <Select value={riskFactors.assetExposure} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, assetExposure: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Internet" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Internet (Público)</SelectItem>
                      <SelectItem value="Internal" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Rede Interna</SelectItem>
                      <SelectItem value="Restricted" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Rede Restrita</SelectItem>
                      <SelectItem value="Isolated" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Isolado</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Criticidade do Ativo</Label>
                  <Select value={riskFactors.assetCriticality} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, assetCriticality: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixa</SelectItem>
                      <SelectItem value="Medium" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Média</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alta</SelectItem>
                      <SelectItem value="Critical" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Crítica</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Classificação dos Dados</Label>
                  <Select value={riskFactors.dataClassification} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, dataClassification: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Public" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Público</SelectItem>
                      <SelectItem value="Internal" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Interno</SelectItem>
                      <SelectItem value="Confidential" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Confidencial</SelectItem>
                      <SelectItem value="Restricted" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Restrito</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>

            {/* Temporal Factors */}
            <Card>
              <CardHeader>
                <CardTitle className="text-lg">Fatores Temporais</CardTitle>
                <CardDescription>
                  Maturidade do exploit e disponibilidade de correções
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="space-y-2">
                  <Label>Maturidade do Exploit</Label>
                  <Select value={riskFactors.exploitCodeMaturity} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, exploitCodeMaturity: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Not_Defined" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Não Definido</SelectItem>
                      <SelectItem value="Unproven" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Não Comprovado</SelectItem>
                      <SelectItem value="Proof_of_Concept" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Prova de Conceito</SelectItem>
                      <SelectItem value="Functional" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Funcional</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Nível de Remediação</Label>
                  <Select value={riskFactors.remediationLevel} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, remediationLevel: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Not_Defined" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Não Definido</SelectItem>
                      <SelectItem value="Official_Fix" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Correção Oficial</SelectItem>
                      <SelectItem value="Temporary_Fix" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Correção Temporária</SelectItem>
                      <SelectItem value="Workaround" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Contorno</SelectItem>
                      <SelectItem value="Unavailable" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Indisponível</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Confiança do Relatório</Label>
                  <Select value={riskFactors.reportConfidence} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, reportConfidence: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Not_Defined" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Não Definido</SelectItem>
                      <SelectItem value="Unknown" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Desconhecido</SelectItem>
                      <SelectItem value="Reasonable" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Razoável</SelectItem>
                      <SelectItem value="Confirmed" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Confirmado</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Business Impact Assessment */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Avaliação de Impacto no Negócio</CardTitle>
              <CardDescription>
                Impacto específico da vulnerabilidade no contexto organizacional
              </CardDescription>
            </CardHeader>
            <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div className="space-y-2">
                  <Label>Criticidade do Negócio</Label>
                  <Select value={riskFactors.businessCriticality} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, businessCriticality: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixa</SelectItem>
                      <SelectItem value="Medium" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Média</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alta</SelectItem>
                      <SelectItem value="Critical" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Crítica</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto de Compliance</Label>
                  <Select value={riskFactors.complianceImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, complianceImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="None" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Nenhum</SelectItem>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo</SelectItem>
                      <SelectItem value="Medium" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Médio</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto Reputacional</Label>
                  <Select value={riskFactors.reputationImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, reputationImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo</SelectItem>
                      <SelectItem value="Medium" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Médio</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto</SelectItem>
                      <SelectItem value="Critical" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Crítico</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto Financeiro</Label>
                  <Select value={riskFactors.financialImpact} onValueChange={(value) => setRiskFactors(prev => ({ ...prev, financialImpact: value as any }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="Low" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Baixo</SelectItem>
                      <SelectItem value="Medium" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Médio</SelectItem>
                      <SelectItem value="High" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Alto</SelectItem>
                      <SelectItem value="Critical" style={{color: '#000000 !important'}} className="data-[highlighted]:text-black data-[state=checked]:text-black focus:text-black">Crítico</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Risk Calculation Results */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Resultados da Avaliação de Risco</CardTitle>
              <CardDescription>
                Scores calculados baseados nos fatores configurados
              </CardDescription>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="text-center p-4 bg-primary/10 rounded-lg border">
                  <p className="text-sm text-primary font-medium">CVSS Base</p>
                  <p className="text-2xl font-bold text-foreground">{calculateCVSSBaseScore()}</p>
                  <p className="text-xs text-muted-foreground">Score técnico base</p>
                </div>

                <div className="text-center p-4 bg-secondary/50 rounded-lg border">
                  <p className="text-sm text-foreground font-medium">CVSS Temporal</p>
                  <p className="text-2xl font-bold text-foreground">{calculateTemporalScore()}</p>
                  <p className="text-xs text-muted-foreground">Com fatores temporais</p>
                </div>

                <div className="text-center p-4 bg-accent/50 rounded-lg border">
                  <p className="text-sm text-foreground font-medium">Score Ambiental</p>
                  <p className="text-2xl font-bold text-foreground">{calculateEnvironmentalScore()}</p>
                  <p className="text-xs text-muted-foreground">Com contexto ambiental</p>
                </div>

                <div className="text-center p-4 bg-destructive/10 rounded-lg border">
                  <p className="text-sm text-destructive font-medium">Risco Final</p>
                  <p className="text-2xl font-bold text-destructive">{calculateBusinessRiskScore()}</p>
                  <p className="text-xs text-muted-foreground">Risco total do negócio</p>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <h4 className="font-semibold">Classificação de Risco</h4>
                  <div className="space-y-2">
                    {(() => {
                      const risk = getRiskLevel(calculateBusinessRiskScore());
                      return (
                        <div className="flex items-center gap-3">
                          <Badge className={risk.color}>{risk.level}</Badge>
                          <span className="text-sm">{risk.description}</span>
                        </div>
                      );
                    })()}
                  </div>
                  
                  <div className="space-y-2">
                    <p className="text-sm font-medium">Score de Prioridade</p>
                    <div className="flex items-center gap-3">
                      <span className="text-2xl font-bold text-foreground">{calculatePriorityScore()}</span>
                      <span className="text-sm text-muted-foreground">/ 10</span>
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  <h4 className="font-semibold">Recomendações</h4>
                  <div className="space-y-2 text-sm">
                    {calculateBusinessRiskScore() >= 9.0 && (
                      <div className="flex items-start gap-2">
                        <AlertTriangle className="h-4 w-4 text-destructive mt-0.5" />
                        <span className="text-sm">Correção imediata necessária - risco crítico</span>
                      </div>
                    )}
                    {calculateBusinessRiskScore() >= 7.0 && calculateBusinessRiskScore() < 9.0 && (
                      <div className="flex items-start gap-2">
                        <AlertTriangle className="h-4 w-4 text-orange-500 dark:text-orange-400 mt-0.5" />
                        <span className="text-sm">Alta prioridade - corrigir em até 30 dias</span>
                      </div>
                    )}
                    {riskFactors.assetExposure === 'Internet' && (
                      <div className="flex items-start gap-2">
                        <Globe className="h-4 w-4 text-primary mt-0.5" />
                        <span className="text-sm">Ativo exposto à internet - monitoramento contínuo</span>
                      </div>
                    )}
                    {riskFactors.exploitCodeMaturity === 'Functional' && (
                      <div className="flex items-start gap-2">
                        <Code className="h-4 w-4 text-purple-500 dark:text-purple-400 mt-0.5" />
                        <span className="text-sm">Exploit funcional disponível - prioridade elevada</span>
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Legacy Fields */}
          <Card>
            <CardHeader>
              <CardTitle className="text-lg">Informações Complementares</CardTitle>
              <CardDescription>
                Tags e informações adicionais
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-6">
              {/* Effort and Impact */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label>Esforço de Remediação</Label>
                  <Select value={formData.remediation_effort} onValueChange={(value) => setFormData(prev => ({ ...prev, remediation_effort: value as RemediationEffort }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {EFFORT_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>

                <div className="space-y-2">
                  <Label>Impacto no Negócio (Legacy)</Label>
                  <Select value={formData.business_impact} onValueChange={(value) => setFormData(prev => ({ ...prev, business_impact: value as BusinessImpact }))}>
                    <SelectTrigger style={{color: '#000000'}} className="dark:[color:#ffffff] [&>span]:[color:#000000] dark:[&>span]:[color:#ffffff]">
                      <SelectValue className="text-black dark:text-white [&>span]:!text-black [&>span]:dark:!text-white" />
                    </SelectTrigger>
                    <SelectContent>
                      {IMPACT_OPTIONS.map(option => (
                        <SelectItem key={option.value} value={option.value}>
                          {option.label}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* Tags */}
              <div className="space-y-4">
                <Label>Tags</Label>
                <div className="flex flex-wrap gap-2 mb-2">
                  {formData.tags.map((tag, index) => (
                    <Badge key={index} variant="secondary" className="flex items-center gap-1">
                      {tag}
                      <X 
                        className="h-3 w-3 cursor-pointer" 
                        onClick={() => handleRemoveTag(tag)}
                      />
                    </Badge>
                  ))}
                </div>
                <div className="flex gap-2">
                  <Input
                    value={newTag}
                    onChange={(e) => setNewTag(e.target.value)}
                    placeholder="Nova tag"
                    onKeyPress={(e) => e.key === 'Enter' && handleAddTag()}
                  />
                  <Button type="button" variant="outline" onClick={handleAddTag}>
                    <Plus className="h-4 w-4" />
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        {customFields.length > 0 && (
          <TabsContent value="custom" className="space-y-6">
            <Card>
              <CardHeader>
                <CardTitle>Campos Customizados</CardTitle>
                <CardDescription>
                  Campos personalizados configurados para sua organização
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {customFields
                    .filter(field => field.tab === 'custom' || field.tab === undefined)
                    .sort((a, b) => a.order - b.order)
                    .map(field => renderCustomField(field))}
                </div>
                
                {customFields.filter(field => field.tab === 'custom' || field.tab === undefined).length === 0 && (
                  <div className="text-center py-8 text-muted-foreground">
                    <Settings className="h-12 w-12 mx-auto mb-4 opacity-50" />
                    <p className="text-lg font-medium mb-2">Nenhum campo customizado</p>
                    <p>Os campos customizados aparecerão aqui quando configurados</p>
                  </div>
                )}
              </CardContent>
            </Card>
          </TabsContent>
        )}
      </Tabs>
    </div>
  );
}