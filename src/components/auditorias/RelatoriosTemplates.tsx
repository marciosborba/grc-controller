import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { \n  BookOpen,\n  Plus,\n  Edit,\n  Eye,\n  Trash2,\n  Copy,\n  Download,\n  Upload,\n  FileText,\n  Settings,\n  Award,\n  Shield,\n  AlertTriangle,\n  TrendingUp,\n  Activity,\n  Zap,\n  Search,\n  Filter\n} from 'lucide-react';\nimport { useAuth } from '@/contexts/AuthContextOptimized';\nimport { useCurrentTenantId } from '@/contexts/TenantSelectorContext';\nimport { supabase } from '@/integrations/supabase/client';\nimport { toast } from 'sonner';\nimport { sanitizeInput, secureLog } from '@/utils/securityLogger';\nimport { getStatusColor, getTypeColor } from './utils/auditUtils';\n\ninterface ReportTemplate {\n  id: string;\n  tenant_id: string;\n  nome: string;\n  tipo: 'executivo' | 'tecnico' | 'compliance' | 'risco' | 'performance' | 'seguimento' | 'especial';\n  categoria: 'interno' | 'externo' | 'regulatorio' | 'investigativo';\n  descricao: string;\n  estrutura: TemplateStructure;\n  campos_obrigatorios: string[];\n  campos_opcionais: string[];\n  versao: string;\n  ativo: boolean;\n  publico: boolean;\n  usado_em: number;\n  criado_por: string;\n  data_criacao: string;\n  data_atualizacao: string;\n  tags: string[];\n  nivel_complexidade: 'basico' | 'intermediario' | 'avancado';\n  tempo_estimado: number; // em horas\n  aprovado_por?: string;\n  data_aprovacao?: string;\n}\n\ninterface TemplateStructure {\n  secoes: TemplateSection[];\n  configuracoes: TemplateConfig;\n}\n\ninterface TemplateSection {\n  id: string;\n  nome: string;\n  descricao: string;\n  obrigatoria: boolean;\n  ordem: number;\n  tipo: 'texto' | 'lista' | 'tabela' | 'grafico' | 'anexo';\n  configuracao: any;\n  conteudo_exemplo?: string;\n}\n\ninterface TemplateConfig {\n  formato_pagina: 'A4' | 'Letter';\n  orientacao: 'portrait' | 'landscape';\n  incluir_cabecalho: boolean;\n  incluir_rodape: boolean;\n  numeracao_paginas: boolean;\n  marca_dagua: boolean;\n  nivel_confidencialidade_padrao: 'publico' | 'interno' | 'confidencial' | 'restrito';\n}\n\nconst templateTypes = [\n  { \n    value: 'executivo', \n    label: 'Relatório Executivo',\n    description: 'Para alta administração e stakeholders',\n    icon: Award,\n    color: 'text-purple-600'\n  },\n  { \n    value: 'tecnico', \n    label: 'Relatório Técnico',\n    description: 'Análise detalhada e técnica',\n    icon: Settings,\n    color: 'text-blue-600'\n  },\n  { \n    value: 'compliance', \n    label: 'Compliance',\n    description: 'Conformidade regulatória',\n    icon: Shield,\n    color: 'text-green-600'\n  },\n  { \n    value: 'risco', \n    label: 'Gestão de Risco',\n    description: 'Avaliação e mitigação de riscos',\n    icon: AlertTriangle,\n    color: 'text-red-600'\n  },\n  { \n    value: 'performance', \n    label: 'Performance',\n    description: 'Indicadores e métricas',\n    icon: TrendingUp,\n    color: 'text-orange-600'\n  },\n  { \n    value: 'seguimento', \n    label: 'Follow-up',\n    description: 'Acompanhamento de ações',\n    icon: Activity,\n    color: 'text-indigo-600'\n  },\n  { \n    value: 'especial', \n    label: 'Especial',\n    description: 'Investigações específicas',\n    icon: Zap,\n    color: 'text-yellow-600'\n  }\n];\n\nconst complexityLevels = [\n  { value: 'basico', label: 'Básico', color: 'bg-green-500 text-white', description: 'Template simples e direto' },\n  { value: 'intermediario', label: 'Intermediário', color: 'bg-yellow-500 text-white', description: 'Template com estrutura moderada' },\n  { value: 'avancado', label: 'Avançado', color: 'bg-red-500 text-white', description: 'Template complexo e detalhado' }\n];\n\nconst defaultSections = [\n  {\n    id: 'resumo_executivo',\n    nome: 'Resumo Executivo',\n    descricao: 'Síntese dos principais pontos para a alta administração',\n    obrigatoria: true,\n    ordem: 1,\n    tipo: 'texto' as const,\n    configuracao: { max_caracteres: 2000 },\n    conteudo_exemplo: 'Este relatório apresenta os resultados da auditoria realizada em...'\n  },\n  {\n    id: 'introducao',\n    nome: 'Introdução',\n    descricao: 'Contextualização e objetivos da auditoria',\n    obrigatoria: true,\n    ordem: 2,\n    tipo: 'texto' as const,\n    configuracao: { max_caracteres: 1500 },\n    conteudo_exemplo: 'A presente auditoria teve como objetivo avaliar...'\n  },\n  {\n    id: 'escopo_metodologia',\n    nome: 'Escopo e Metodologia',\n    descricao: 'Definição do escopo e metodologia utilizada',\n    obrigatoria: true,\n    ordem: 3,\n    tipo: 'texto' as const,\n    configuracao: { max_caracteres: 1000 },\n    conteudo_exemplo: 'O escopo desta auditoria compreendeu...'\n  },\n  {\n    id: 'resultados',\n    nome: 'Resultados e Achados',\n    descricao: 'Principais resultados e achados da auditoria',\n    obrigatoria: true,\n    ordem: 4,\n    tipo: 'lista' as const,\n    configuracao: { tipo_lista: 'numerada' },\n    conteudo_exemplo: '1. Controle adequado identificado em...\\n2. Deficiência observada em...'\n  },\n  {\n    id: 'recomendacoes',\n    nome: 'Recomendações',\n    descricao: 'Recomendações para melhoria dos controles',\n    obrigatoria: true,\n    ordem: 5,\n    tipo: 'lista' as const,\n    configuracao: { tipo_lista: 'numerada' },\n    conteudo_exemplo: '1. Implementar controle de...\\n2. Revisar processo de...'\n  },\n  {\n    id: 'conclusao',\n    nome: 'Conclusão',\n    descricao: 'Conclusões finais da auditoria',\n    obrigatoria: true,\n    ordem: 6,\n    tipo: 'texto' as const,\n    configuracao: { max_caracteres: 1000 },\n    conteudo_exemplo: 'Com base nos trabalhos realizados, concluímos que...'\n  },\n  {\n    id: 'plano_acao',\n    nome: 'Plano de Ação',\n    descricao: 'Plano de implementação das recomendações',\n    obrigatoria: false,\n    ordem: 7,\n    tipo: 'tabela' as const,\n    configuracao: { \n      colunas: ['Recomendação', 'Responsável', 'Prazo', 'Status'],\n      editavel: true\n    },\n    conteudo_exemplo: 'Tabela com plano de ação detalhado'\n  },\n  {\n    id: 'anexos',\n    nome: 'Anexos',\n    descricao: 'Documentos e evidências complementares',\n    obrigatoria: false,\n    ordem: 8,\n    tipo: 'anexo' as const,\n    configuracao: { tipos_permitidos: ['pdf', 'doc', 'xls', 'img'] },\n    conteudo_exemplo: 'Evidências e documentos de suporte'\n  }\n];\n\nexport function RelatoriosTemplates() {\n  const { user } = useAuth();\n  const selectedTenantId = useCurrentTenantId();\n  const effectiveTenantId = user?.isPlatformAdmin ? selectedTenantId : user?.tenantId;\n  \n  const [templates, setTemplates] = useState<ReportTemplate[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [searchTerm, setSearchTerm] = useState('');\n  const [filterType, setFilterType] = useState('all');\n  const [filterComplexity, setFilterComplexity] = useState('all');\n  const [selectedTemplate, setSelectedTemplate] = useState<ReportTemplate | null>(null);\n  const [dialogOpen, setDialogOpen] = useState(false);\n  const [viewDialogOpen, setViewDialogOpen] = useState(false);\n  const [sectionsDialogOpen, setSectionsDialogOpen] = useState(false);\n  \n  const [formData, setFormData] = useState({\n    nome: '',\n    tipo: 'executivo' as const,\n    categoria: 'interno' as const,\n    descricao: '',\n    nivel_complexidade: 'basico' as const,\n    tempo_estimado: 8,\n    publico: false,\n    tags: [] as string[],\n    estrutura: {\n      secoes: defaultSections,\n      configuracoes: {\n        formato_pagina: 'A4' as const,\n        orientacao: 'portrait' as const,\n        incluir_cabecalho: true,\n        incluir_rodape: true,\n        numeracao_paginas: true,\n        marca_dagua: false,\n        nivel_confidencialidade_padrao: 'interno' as const\n      }\n    }\n  });\n\n  useEffect(() => {\n    if (effectiveTenantId) {\n      loadTemplates();\n    }\n  }, [effectiveTenantId]);\n\n  const loadTemplates = async () => {\n    try {\n      setLoading(true);\n      \n      const { data, error } = await supabase\n        .from('templates_relatorios')\n        .select('*')\n        .eq('tenant_id', effectiveTenantId)\n        .order('data_atualizacao', { ascending: false });\n\n      if (error) {\n        secureLog('error', 'Erro ao carregar templates', error);\n        toast.error('Erro ao carregar templates');\n      } else {\n        setTemplates(data || []);\n      }\n    } catch (error) {\n      secureLog('error', 'Erro ao carregar templates', error);\n      toast.error('Erro ao carregar templates');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleSaveTemplate = async () => {\n    try {\n      if (!formData.nome || !formData.descricao) {\n        toast.error('Preencha todos os campos obrigatórios');\n        return;\n      }\n\n      const sanitizedData = {\n        nome: sanitizeInput(formData.nome),\n        tipo: formData.tipo,\n        categoria: formData.categoria,\n        descricao: sanitizeInput(formData.descricao),\n        estrutura: formData.estrutura,\n        campos_obrigatorios: formData.estrutura.secoes\n          .filter(s => s.obrigatoria)\n          .map(s => s.id),\n        campos_opcionais: formData.estrutura.secoes\n          .filter(s => !s.obrigatoria)\n          .map(s => s.id),\n        versao: selectedTemplate ? selectedTemplate.versao : '1.0',\n        ativo: true,\n        publico: formData.publico,\n        usado_em: 0,\n        nivel_complexidade: formData.nivel_complexidade,\n        tempo_estimado: formData.tempo_estimado,\n        tags: formData.tags,\n        tenant_id: effectiveTenantId,\n        criado_por: user?.id\n      };\n\n      const { data, error } = selectedTemplate \n        ? await supabase\n            .from('templates_relatorios')\n            .update(sanitizedData)\n            .eq('id', selectedTemplate.id)\n            .eq('tenant_id', effectiveTenantId)\n            .select()\n        : await supabase\n            .from('templates_relatorios')\n            .insert(sanitizedData)\n            .select();\n\n      if (error) {\n        throw error;\n      }\n\n      toast.success(selectedTemplate ? 'Template atualizado com sucesso!' : 'Template criado com sucesso!');\n      setDialogOpen(false);\n      resetForm();\n      loadTemplates();\n\n    } catch (error) {\n      secureLog('error', 'Erro ao salvar template', error);\n      toast.error('Erro ao salvar template');\n    }\n  };\n\n  const handleDeleteTemplate = async (id: string) => {\n    if (!window.confirm('Tem certeza que deseja excluir este template?')) return;\n\n    try {\n      const { error } = await supabase\n        .from('templates_relatorios')\n        .delete()\n        .eq('id', id)\n        .eq('tenant_id', effectiveTenantId);\n\n      if (error) throw error;\n\n      toast.success('Template excluído com sucesso!');\n      loadTemplates();\n    } catch (error) {\n      secureLog('error', 'Erro ao excluir template', error);\n      toast.error('Erro ao excluir template');\n    }\n  };\n\n  const handleDuplicateTemplate = async (template: ReportTemplate) => {\n    try {\n      const duplicatedData = {\n        ...template,\n        id: undefined,\n        nome: `${template.nome} (Cópia)`,\n        versao: '1.0',\n        usado_em: 0,\n        data_criacao: new Date().toISOString(),\n        data_atualizacao: new Date().toISOString(),\n        criado_por: user?.id\n      };\n\n      const { error } = await supabase\n        .from('templates_relatorios')\n        .insert(duplicatedData);\n\n      if (error) throw error;\n\n      toast.success('Template duplicado com sucesso!');\n      loadTemplates();\n    } catch (error) {\n      secureLog('error', 'Erro ao duplicar template', error);\n      toast.error('Erro ao duplicar template');\n    }\n  };\n\n  const resetForm = () => {\n    setFormData({\n      nome: '',\n      tipo: 'executivo',\n      categoria: 'interno',\n      descricao: '',\n      nivel_complexidade: 'basico',\n      tempo_estimado: 8,\n      publico: false,\n      tags: [],\n      estrutura: {\n        secoes: defaultSections,\n        configuracoes: {\n          formato_pagina: 'A4',\n          orientacao: 'portrait',\n          incluir_cabecalho: true,\n          incluir_rodape: true,\n          numeracao_paginas: true,\n          marca_dagua: false,\n          nivel_confidencialidade_padrao: 'interno'\n        }\n      }\n    });\n    setSelectedTemplate(null);\n  };\n\n  const openEditDialog = (template: ReportTemplate) => {\n    setSelectedTemplate(template);\n    setFormData({\n      nome: template.nome,\n      tipo: template.tipo,\n      categoria: template.categoria,\n      descricao: template.descricao,\n      nivel_complexidade: template.nivel_complexidade,\n      tempo_estimado: template.tempo_estimado,\n      publico: template.publico,\n      tags: template.tags || [],\n      estrutura: template.estrutura\n    });\n    setDialogOpen(true);\n  };\n\n  const openViewDialog = (template: ReportTemplate) => {\n    setSelectedTemplate(template);\n    setViewDialogOpen(true);\n  };\n\n  const filteredTemplates = templates.filter(template => {\n    const matchesSearch = !searchTerm || \n      template.nome.toLowerCase().includes(searchTerm.toLowerCase()) ||\n      template.descricao.toLowerCase().includes(searchTerm.toLowerCase());\n    \n    const matchesType = filterType === 'all' || template.tipo === filterType;\n    const matchesComplexity = filterComplexity === 'all' || template.nivel_complexidade === filterComplexity;\n    \n    return matchesSearch && matchesType && matchesComplexity;\n  });\n\n  const getComplexityColor = (complexity: string) => {\n    const level = complexityLevels.find(l => l.value === complexity);\n    return level?.color || 'bg-gray-500 text-white';\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Templates de Relatórios</h1>\n          <p className=\"text-muted-foreground\">Crie e gerencie templates profissionais para seus relatórios</p>\n        </div>\n        <div className=\"flex gap-2\">\n          <Button variant=\"outline\">\n            <Upload className=\"h-4 w-4 mr-2\" />\n            Importar\n          </Button>\n          <Button onClick={() => { resetForm(); setDialogOpen(true); }}>\n            <Plus className=\"h-4 w-4 mr-2\" />\n            Novo Template\n          </Button>\n        </div>\n      </div>\n\n      {/* Filtros */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Filtros e Pesquisa</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n            <div className=\"relative\">\n              <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground\" />\n              <Input\n                placeholder=\"Buscar templates...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                className=\"pl-10\"\n              />\n            </div>\n            \n            <Select value={filterType} onValueChange={setFilterType}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Tipo\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Todos os Tipos</SelectItem>\n                {templateTypes.map(type => (\n                  <SelectItem key={type.value} value={type.value}>\n                    {type.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n\n            <Select value={filterComplexity} onValueChange={setFilterComplexity}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Complexidade\" />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"all\">Todas as Complexidades</SelectItem>\n                {complexityLevels.map(level => (\n                  <SelectItem key={level.value} value={level.value}>\n                    {level.label}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Templates Grid */}\n      <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n        {filteredTemplates.length === 0 ? (\n          <div className=\"col-span-full\">\n            <Card>\n              <CardContent className=\"p-8 text-center\">\n                <BookOpen className=\"mx-auto h-12 w-12 text-muted-foreground\" />\n                <h3 className=\"mt-4 text-lg font-semibold\">Nenhum template encontrado</h3>\n                <p className=\"text-muted-foreground\">Crie seu primeiro template ou ajuste os filtros.</p>\n                <Button className=\"mt-4\" onClick={() => { resetForm(); setDialogOpen(true); }}>\n                  <Plus className=\"h-4 w-4 mr-2\" />\n                  Criar Template\n                </Button>\n              </CardContent>\n            </Card>\n          </div>\n        ) : (\n          filteredTemplates.map((template) => {\n            const typeInfo = templateTypes.find(t => t.value === template.tipo);\n            const IconComponent = typeInfo?.icon || FileText;\n            \n            return (\n              <Card key={template.id} className=\"hover:shadow-lg transition-shadow\">\n                <CardHeader>\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex items-center gap-3\">\n                      <div className={`p-2 rounded-lg bg-muted ${typeInfo?.color}`}>\n                        <IconComponent className=\"h-5 w-5\" />\n                      </div>\n                      <div>\n                        <CardTitle className=\"text-lg\">{template.nome}</CardTitle>\n                        <CardDescription className=\"text-sm\">\n                          {typeInfo?.label} • v{template.versao}\n                        </CardDescription>\n                      </div>\n                    </div>\n                    <div className=\"flex gap-1\">\n                      <Button variant=\"ghost\" size=\"sm\" onClick={() => openViewDialog(template)}>\n                        <Eye className=\"h-4 w-4\" />\n                      </Button>\n                      <Button variant=\"ghost\" size=\"sm\" onClick={() => openEditDialog(template)}>\n                        <Edit className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <p className=\"text-sm text-muted-foreground mb-4 line-clamp-2\">\n                    {template.descricao}\n                  </p>\n                  \n                  <div className=\"space-y-3\">\n                    <div className=\"flex items-center justify-between\">\n                      <Badge className={getComplexityColor(template.nivel_complexidade)}>\n                        {complexityLevels.find(l => l.value === template.nivel_complexidade)?.label}\n                      </Badge>\n                      <span className=\"text-sm text-muted-foreground\">\n                        ~{template.tempo_estimado}h\n                      </span>\n                    </div>\n                    \n                    <div className=\"flex items-center justify-between text-sm\">\n                      <span className=\"text-muted-foreground\">\n                        {template.estrutura.secoes.length} seções\n                      </span>\n                      <span className=\"text-muted-foreground\">\n                        Usado {template.usado_em}x\n                      </span>\n                    </div>\n\n                    {template.tags && template.tags.length > 0 && (\n                      <div className=\"flex flex-wrap gap-1\">\n                        {template.tags.slice(0, 3).map((tag, index) => (\n                          <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                            {tag}\n                          </Badge>\n                        ))}\n                        {template.tags.length > 3 && (\n                          <Badge variant=\"secondary\" className=\"text-xs\">\n                            +{template.tags.length - 3}\n                          </Badge>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex gap-2 mt-4\">\n                    <Button size=\"sm\" className=\"flex-1\">\n                      Usar Template\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\" onClick={() => handleDuplicateTemplate(template)}>\n                      <Copy className=\"h-4 w-4\" />\n                    </Button>\n                    <Button variant=\"outline\" size=\"sm\">\n                      <Download className=\"h-4 w-4\" />\n                    </Button>\n                    <Button \n                      variant=\"outline\" \n                      size=\"sm\" \n                      onClick={() => handleDeleteTemplate(template.id)}\n                    >\n                      <Trash2 className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                </CardContent>\n              </Card>\n            );\n          })\n        )}\n      </div>\n\n      {/* Dialog para Criar/Editar Template */}\n      <Dialog open={dialogOpen} onOpenChange={setDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {selectedTemplate ? 'Editar Template' : 'Novo Template de Relatório'}\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-6\">\n            {/* Informações Básicas */}\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label>Nome do Template *</Label>\n                <Input \n                  value={formData.nome}\n                  onChange={(e) => setFormData(prev => ({...prev, nome: e.target.value}))}\n                  placeholder=\"Nome do template\"\n                />\n              </div>\n              \n              <div>\n                <Label>Tipo de Relatório *</Label>\n                <Select value={formData.tipo} onValueChange={(value) => setFormData(prev => ({...prev, tipo: value as any}))}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {templateTypes.map(type => (\n                      <SelectItem key={type.value} value={type.value}>\n                        {type.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label>Nível de Complexidade</Label>\n                <Select value={formData.nivel_complexidade} onValueChange={(value) => setFormData(prev => ({...prev, nivel_complexidade: value as any}))}>\n                  <SelectTrigger>\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {complexityLevels.map(level => (\n                      <SelectItem key={level.value} value={level.value}>\n                        {level.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <Label>Tempo Estimado (horas)</Label>\n                <Input \n                  type=\"number\"\n                  value={formData.tempo_estimado}\n                  onChange={(e) => setFormData(prev => ({...prev, tempo_estimado: parseInt(e.target.value) || 0}))}\n                  min=\"1\"\n                  max=\"100\"\n                />\n              </div>\n            </div>\n\n            <div>\n              <Label>Descrição *</Label>\n              <Textarea \n                value={formData.descricao}\n                onChange={(e) => setFormData(prev => ({...prev, descricao: e.target.value}))}\n                placeholder=\"Descreva o propósito e uso deste template\"\n                rows={3}\n              />\n            </div>\n\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox \n                id=\"publico\"\n                checked={formData.publico}\n                onCheckedChange={(checked) => setFormData(prev => ({...prev, publico: !!checked}))}\n              />\n              <Label htmlFor=\"publico\">Template público (visível para outros usuários)</Label>\n            </div>\n\n            {/* Configurações de Estrutura */}\n            <div className=\"border rounded-lg p-4\">\n              <h4 className=\"font-semibold mb-4\">Estrutura do Template</h4>\n              <div className=\"space-y-3\">\n                <p className=\"text-sm text-muted-foreground\">\n                  Este template contém {formData.estrutura.secoes.length} seções:\n                </p>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                  {formData.estrutura.secoes.map((secao, index) => (\n                    <div key={secao.id} className=\"flex items-center justify-between p-2 border rounded\">\n                      <div>\n                        <span className=\"text-sm font-medium\">{secao.nome}</span>\n                        {secao.obrigatoria && (\n                          <Badge variant=\"secondary\" className=\"ml-2 text-xs\">Obrigatória</Badge>\n                        )}\n                      </div>\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {secao.tipo}\n                      </Badge>\n                    </div>\n                  ))}\n                </div>\n                <Button \n                  variant=\"outline\" \n                  size=\"sm\" \n                  onClick={() => setSectionsDialogOpen(true)}\n                >\n                  <Settings className=\"h-4 w-4 mr-2\" />\n                  Configurar Seções\n                </Button>\n              </div>\n            </div>\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setDialogOpen(false)}>\n              Cancelar\n            </Button>\n            <Button onClick={handleSaveTemplate}>\n              {selectedTemplate ? 'Atualizar' : 'Criar'} Template\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Dialog para Visualizar Template */}\n      <Dialog open={viewDialogOpen} onOpenChange={setViewDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle className=\"flex items-center gap-2\">\n              {selectedTemplate && (\n                <>\n                  {(() => {\n                    const typeInfo = templateTypes.find(t => t.value === selectedTemplate.tipo);\n                    const IconComponent = typeInfo?.icon || FileText;\n                    return <IconComponent className=\"h-5 w-5\" />;\n                  })()}\n                  {selectedTemplate.nome}\n                </>\n              )}\n            </DialogTitle>\n          </DialogHeader>\n          \n          {selectedTemplate && (\n            <div className=\"space-y-6\">\n              {/* Metadados */}\n              <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-muted rounded-lg\">\n                <div>\n                  <Label className=\"text-xs\">Tipo</Label>\n                  <p className=\"font-medium\">{templateTypes.find(t => t.value === selectedTemplate.tipo)?.label}</p>\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Complexidade</Label>\n                  <Badge className={getComplexityColor(selectedTemplate.nivel_complexidade)}>\n                    {complexityLevels.find(l => l.value === selectedTemplate.nivel_complexidade)?.label}\n                  </Badge>\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Tempo Estimado</Label>\n                  <p className=\"font-medium\">{selectedTemplate.tempo_estimado}h</p>\n                </div>\n                <div>\n                  <Label className=\"text-xs\">Usado</Label>\n                  <p className=\"font-medium\">{selectedTemplate.usado_em} vezes</p>\n                </div>\n              </div>\n\n              {/* Descrição */}\n              <div>\n                <h4 className=\"font-semibold mb-2\">Descrição</h4>\n                <p className=\"text-sm leading-relaxed\">{selectedTemplate.descricao}</p>\n              </div>\n\n              {/* Estrutura */}\n              <div>\n                <h4 className=\"font-semibold mb-4\">Estrutura do Template</h4>\n                <div className=\"space-y-3\">\n                  {selectedTemplate.estrutura.secoes\n                    .sort((a, b) => a.ordem - b.ordem)\n                    .map((secao, index) => (\n                    <div key={secao.id} className=\"border rounded-lg p-4\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"flex items-center gap-2\">\n                          <span className=\"text-sm font-medium text-muted-foreground\">\n                            {secao.ordem}.\n                          </span>\n                          <h5 className=\"font-medium\">{secao.nome}</h5>\n                          {secao.obrigatoria && (\n                            <Badge variant=\"secondary\" className=\"text-xs\">Obrigatória</Badge>\n                          )}\n                        </div>\n                        <Badge variant=\"outline\" className=\"text-xs\">\n                          {secao.tipo}\n                        </Badge>\n                      </div>\n                      <p className=\"text-sm text-muted-foreground mb-2\">{secao.descricao}</p>\n                      {secao.conteudo_exemplo && (\n                        <div className=\"bg-muted p-2 rounded text-xs\">\n                          <strong>Exemplo:</strong> {secao.conteudo_exemplo}\n                        </div>\n                      )}\n                    </div>\n                  ))}\n                </div>\n              </div>\n\n              {/* Tags */}\n              {selectedTemplate.tags && selectedTemplate.tags.length > 0 && (\n                <div>\n                  <h4 className=\"font-semibold mb-2\">Tags</h4>\n                  <div className=\"flex flex-wrap gap-2\">\n                    {selectedTemplate.tags.map((tag, index) => (\n                      <Badge key={index} variant=\"secondary\">\n                        {tag}\n                      </Badge>\n                    ))}\n                  </div>\n                </div>\n              )}\n            </div>\n          )}\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setViewDialogOpen(false)}>\n              Fechar\n            </Button>\n            <Button variant=\"outline\">\n              <Copy className=\"h-4 w-4 mr-2\" />\n              Duplicar\n            </Button>\n            <Button>\n              Usar Template\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default RelatoriosTemplates;"