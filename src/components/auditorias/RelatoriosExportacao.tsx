import React, { useState, useEffect } from 'react';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from \"@/components/ui/dialog\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Progress } from \"@/components/ui/progress\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { \n  Download,\n  FileText,\n  Mail,\n  Printer,\n  Share2,\n  Settings,\n  Calendar,\n  Users,\n  Eye,\n  CheckCircle,\n  AlertTriangle,\n  Clock,\n  Filter,\n  Zap,\n  Globe,\n  Lock,\n  Palette,\n  Layout,\n  Image,\n  Type,\n  FileImage,\n  FileSpreadsheet,\n  FilePdf,\n  FileCode\n} from 'lucide-react';\nimport { useAuth } from '@/contexts/AuthContextOptimized';\nimport { useCurrentTenantId } from '@/contexts/TenantSelectorContext';\nimport { supabase } from '@/integrations/supabase/client';\nimport { toast } from 'sonner';\nimport { sanitizeInput, secureLog } from '@/utils/securityLogger';\nimport { getStatusColor, formatDate } from './utils/auditUtils';\n\ninterface ExportConfig {\n  formato: 'pdf' | 'docx' | 'html' | 'excel' | 'pptx';\n  qualidade: 'baixa' | 'media' | 'alta' | 'maxima';\n  incluir_anexos: boolean;\n  incluir_assinaturas: boolean;\n  incluir_marca_dagua: boolean;\n  incluir_cabecalho: boolean;\n  incluir_rodape: boolean;\n  numeracao_paginas: boolean;\n  orientacao: 'portrait' | 'landscape';\n  tamanho_papel: 'A4' | 'A3' | 'Letter' | 'Legal';\n  margem: 'estreita' | 'normal' | 'larga';\n  fonte: 'Arial' | 'Times New Roman' | 'Calibri' | 'Helvetica';\n  tamanho_fonte: number;\n  tema_cores: 'corporativo' | 'azul' | 'verde' | 'cinza' | 'personalizado';\n  logo_empresa: boolean;\n  confidencialidade_visivel: boolean;\n  data_geracao_visivel: boolean;\n  versao_visivel: boolean;\n}\n\ninterface DistributionConfig {\n  metodo: 'email' | 'download' | 'compartilhamento' | 'impressao';\n  destinatarios: string[];\n  assunto?: string;\n  mensagem?: string;\n  prazo_acesso?: string;\n  senha_protegido: boolean;\n  senha?: string;\n  notificar_visualizacao: boolean;\n  permitir_download: boolean;\n  permitir_comentarios: boolean;\n  data_expiracao?: string;\n}\n\ninterface ReportExport {\n  id: string;\n  relatorio_id: string;\n  relatorio_titulo: string;\n  formato: string;\n  status: 'processando' | 'concluido' | 'erro' | 'cancelado';\n  progresso: number;\n  tamanho_arquivo?: number;\n  url_download?: string;\n  data_criacao: string;\n  data_expiracao?: string;\n  criado_por: string;\n  configuracao: ExportConfig;\n  distribuicao?: DistributionConfig;\n  downloads_count: number;\n  visualizacoes_count: number;\n}\n\nconst exportFormats = [\n  {\n    value: 'pdf',\n    label: 'PDF',\n    description: 'Formato universal, ideal para distribuição',\n    icon: FilePdf,\n    color: 'text-red-600',\n    features: ['Preserva formatação', 'Seguro', 'Universal']\n  },\n  {\n    value: 'docx',\n    label: 'Word (DOCX)',\n    description: 'Editável no Microsoft Word',\n    icon: FileText,\n    color: 'text-blue-600',\n    features: ['Editável', 'Comentários', 'Controle de alterações']\n  },\n  {\n    value: 'html',\n    label: 'HTML',\n    description: 'Visualização web interativa',\n    icon: Globe,\n    color: 'text-green-600',\n    features: ['Interativo', 'Responsivo', 'Links ativos']\n  },\n  {\n    value: 'excel',\n    label: 'Excel (XLSX)',\n    description: 'Dados tabulares e gráficos',\n    icon: FileSpreadsheet,\n    color: 'text-emerald-600',\n    features: ['Dados estruturados', 'Gráficos', 'Análise']\n  },\n  {\n    value: 'pptx',\n    label: 'PowerPoint (PPTX)',\n    description: 'Apresentação executiva',\n    icon: FileImage,\n    color: 'text-orange-600',\n    features: ['Apresentação', 'Slides', 'Visual']\n  }\n];\n\nconst qualityLevels = [\n  { value: 'baixa', label: 'Baixa', description: 'Arquivo menor, qualidade reduzida' },\n  { value: 'media', label: 'Média', description: 'Equilíbrio entre qualidade e tamanho' },\n  { value: 'alta', label: 'Alta', description: 'Boa qualidade, arquivo maior' },\n  { value: 'maxima', label: 'Máxima', description: 'Melhor qualidade, arquivo grande' }\n];\n\nconst colorThemes = [\n  { value: 'corporativo', label: 'Corporativo', colors: ['#1e40af', '#3b82f6', '#60a5fa'] },\n  { value: 'azul', label: 'Azul Profissional', colors: ['#1e3a8a', '#3b82f6', '#93c5fd'] },\n  { value: 'verde', label: 'Verde Sustentável', colors: ['#166534', '#22c55e', '#86efac'] },\n  { value: 'cinza', label: 'Cinza Elegante', colors: ['#374151', '#6b7280', '#d1d5db'] },\n  { value: 'personalizado', label: 'Personalizado', colors: ['#000000', '#666666', '#cccccc'] }\n];\n\nconst distributionMethods = [\n  {\n    value: 'download',\n    label: 'Download Direto',\n    description: 'Baixar arquivo imediatamente',\n    icon: Download\n  },\n  {\n    value: 'email',\n    label: 'Envio por Email',\n    description: 'Enviar para destinatários específicos',\n    icon: Mail\n  },\n  {\n    value: 'compartilhamento',\n    label: 'Link de Compartilhamento',\n    description: 'Gerar link seguro para acesso',\n    icon: Share2\n  },\n  {\n    value: 'impressao',\n    label: 'Impressão',\n    description: 'Preparar para impressão física',\n    icon: Printer\n  }\n];\n\nexport function RelatoriosExportacao() {\n  const { user } = useAuth();\n  const selectedTenantId = useCurrentTenantId();\n  const effectiveTenantId = user?.isPlatformAdmin ? selectedTenantId : user?.tenantId;\n  \n  const [reports, setReports] = useState<any[]>([]);\n  const [exports, setExports] = useState<ReportExport[]>([]);\n  const [loading, setLoading] = useState(true);\n  const [selectedReport, setSelectedReport] = useState<any>(null);\n  const [exportDialogOpen, setExportDialogOpen] = useState(false);\n  const [distributionDialogOpen, setDistributionDialogOpen] = useState(false);\n  const [currentStep, setCurrentStep] = useState(1);\n  const [processing, setProcessing] = useState(false);\n  \n  const [exportConfig, setExportConfig] = useState<ExportConfig>({\n    formato: 'pdf',\n    qualidade: 'alta',\n    incluir_anexos: true,\n    incluir_assinaturas: true,\n    incluir_marca_dagua: false,\n    incluir_cabecalho: true,\n    incluir_rodape: true,\n    numeracao_paginas: true,\n    orientacao: 'portrait',\n    tamanho_papel: 'A4',\n    margem: 'normal',\n    fonte: 'Arial',\n    tamanho_fonte: 11,\n    tema_cores: 'corporativo',\n    logo_empresa: true,\n    confidencialidade_visivel: true,\n    data_geracao_visivel: true,\n    versao_visivel: true\n  });\n  \n  const [distributionConfig, setDistributionConfig] = useState<DistributionConfig>({\n    metodo: 'download',\n    destinatarios: [],\n    senha_protegido: false,\n    notificar_visualizacao: false,\n    permitir_download: true,\n    permitir_comentarios: false\n  });\n\n  useEffect(() => {\n    if (effectiveTenantId) {\n      loadData();\n    }\n  }, [effectiveTenantId]);\n\n  const loadData = async () => {\n    try {\n      setLoading(true);\n      \n      // Carregar relatórios disponíveis\n      const { data: reportsData, error: reportsError } = await supabase\n        .from('relatorios_auditoria')\n        .select(`\n          *,\n          projetos_auditoria(titulo, codigo)\n        `)\n        .eq('tenant_id', effectiveTenantId)\n        .in('status', ['aprovado', 'publicado', 'distribuido', 'rascunho', 'revisao'])\n        .order('created_at', { ascending: false });\n\n      if (reportsError) {\n        secureLog('error', 'Erro ao carregar relatórios', reportsError);\n      } else {\n        setReports(reportsData || []);\n      }\n\n      // Carregar histórico de exportações\n      const { data: exportsData, error: exportsError } = await supabase\n        .from('relatorios_exportacoes')\n        .select('*')\n        .eq('tenant_id', effectiveTenantId)\n        .order('data_criacao', { ascending: false })\n        .limit(50);\n\n      if (exportsError) {\n        secureLog('error', 'Erro ao carregar exportações', exportsError);\n      } else {\n        setExports(exportsData || []);\n      }\n\n    } catch (error) {\n      secureLog('error', 'Erro ao carregar dados de exportação', error);\n      toast.error('Erro ao carregar dados de exportação');\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const handleStartExport = (report: any) => {\n    setSelectedReport(report);\n    setCurrentStep(1);\n    setExportDialogOpen(true);\n  };\n\n  const handleExportReport = async () => {\n    if (!selectedReport) return;\n\n    try {\n      setProcessing(true);\n      \n      // Simular processo de exportação\n      const exportData = {\n        relatorio_id: selectedReport.id,\n        relatorio_titulo: selectedReport.titulo,\n        formato: exportConfig.formato,\n        status: 'processando' as const,\n        progresso: 0,\n        configuracao: exportConfig,\n        distribuicao: distributionConfig,\n        downloads_count: 0,\n        visualizacoes_count: 0,\n        tenant_id: effectiveTenantId,\n        criado_por: user?.id\n      };\n\n      const { data, error } = await supabase\n        .from('relatorios_exportacoes')\n        .insert(exportData)\n        .select()\n        .single();\n\n      if (error) throw error;\n\n      // Simular progresso de exportação\n      const exportId = data.id;\n      let progress = 0;\n      \n      const progressInterval = setInterval(async () => {\n        progress += Math.random() * 20;\n        if (progress >= 100) {\n          progress = 100;\n          clearInterval(progressInterval);\n          \n          // Finalizar exportação\n          await supabase\n            .from('relatorios_exportacoes')\n            .update({\n              status: 'concluido',\n              progresso: 100,\n              url_download: `/api/reports/download/${exportId}`,\n              tamanho_arquivo: Math.floor(Math.random() * 5000000) + 1000000 // 1-5MB simulado\n            })\n            .eq('id', exportId);\n          \n          toast.success('Relatório exportado com sucesso!');\n          setProcessing(false);\n          setExportDialogOpen(false);\n          loadData();\n          \n          // Executar distribuição se configurada\n          if (distributionConfig.metodo !== 'download') {\n            handleDistribution(data);\n          }\n        } else {\n          await supabase\n            .from('relatorios_exportacoes')\n            .update({ progresso: Math.floor(progress) })\n            .eq('id', exportId);\n        }\n      }, 500);\n\n    } catch (error) {\n      secureLog('error', 'Erro ao exportar relatório', error);\n      toast.error('Erro ao exportar relatório');\n      setProcessing(false);\n    }\n  };\n\n  const handleDistribution = async (exportData: any) => {\n    try {\n      switch (distributionConfig.metodo) {\n        case 'email':\n          // Simular envio por email\n          toast.info('Enviando relatório por email...');\n          setTimeout(() => {\n            toast.success(`Relatório enviado para ${distributionConfig.destinatarios.length} destinatários`);\n          }, 2000);\n          break;\n          \n        case 'compartilhamento':\n          // Gerar link de compartilhamento\n          const shareLink = `${window.location.origin}/shared/report/${exportData.id}`;\n          navigator.clipboard.writeText(shareLink);\n          toast.success('Link de compartilhamento copiado para a área de transferência');\n          break;\n          \n        case 'impressao':\n          // Abrir janela de impressão\n          window.open(`/api/reports/print/${exportData.id}`, '_blank');\n          toast.info('Abrindo visualização para impressão...');\n          break;\n      }\n    } catch (error) {\n      secureLog('error', 'Erro na distribuição', error);\n      toast.error('Erro na distribuição do relatório');\n    }\n  };\n\n  const formatFileSize = (bytes: number): string => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const getStatusIcon = (status: string) => {\n    switch (status) {\n      case 'processando': return <Clock className=\"h-4 w-4 text-yellow-500\" />;\n      case 'concluido': return <CheckCircle className=\"h-4 w-4 text-green-500\" />;\n      case 'erro': return <AlertTriangle className=\"h-4 w-4 text-red-500\" />;\n      default: return <Clock className=\"h-4 w-4 text-gray-500\" />;\n    }\n  };\n\n  if (loading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-[400px]\">\n        <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary\"></div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"flex justify-between items-center\">\n        <div>\n          <h1 className=\"text-3xl font-bold\">Exportação de Relatórios</h1>\n          <p className=\"text-muted-foreground\">Exporte e distribua seus relatórios em múltiplos formatos</p>\n        </div>\n      </div>\n\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-6\">\n        {/* Relatórios Disponíveis */}\n        <div className=\"lg:col-span-2 space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Relatórios Disponíveis para Exportação</CardTitle>\n              <CardDescription>\n                Selecione um relatório aprovado para exportar\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {reports.length === 0 ? (\n                  <div className=\"text-center py-8\">\n                    <FileText className=\"mx-auto h-12 w-12 text-muted-foreground\" />\n                    <h3 className=\"mt-4 text-lg font-semibold\">Nenhum relatório disponível</h3>\n                    <p className=\"text-muted-foreground\">Não há relatórios aprovados para exportação.</p>\n                  </div>\n                ) : (\n                  reports.map((report) => (\n                    <div key={report.id} className=\"flex items-center justify-between p-4 border rounded-lg hover:shadow-sm transition-shadow\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center gap-2 mb-1\">\n                          <h4 className=\"font-medium\">{report.titulo}</h4>\n                          <Badge className={getStatusColor(report.status)}>\n                            {report.status}\n                          </Badge>\n                          {report.versao && (\n                            <Badge variant=\"secondary\">v{report.versao}</Badge>\n                          )}\n                        </div>\n                        <p className=\"text-sm text-muted-foreground\">\n                          Projeto: {report.projetos_auditoria?.titulo} • \n                          Criado em {formatDate(report.created_at)}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground mt-1 line-clamp-1\">\n                          {report.resumo_executivo}\n                        </p>\n                      </div>\n                      <div className=\"flex gap-2\">\n                        <Button variant=\"outline\" size=\"sm\">\n                          <Eye className=\"h-4 w-4\" />\n                        </Button>\n                        <Button size=\"sm\" onClick={() => handleStartExport(report)}>\n                          <Download className=\"h-4 w-4 mr-2\" />\n                          Exportar\n                        </Button>\n                      </div>\n                    </div>\n                  ))\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n\n        {/* Histórico de Exportações */}\n        <div className=\"space-y-4\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Exportações Recentes</CardTitle>\n              <CardDescription>\n                Histórico das últimas exportações\n              </CardDescription>\n            </CardHeader>\n            <CardContent>\n              <div className=\"space-y-3\">\n                {exports.length === 0 ? (\n                  <div className=\"text-center py-4\">\n                    <Download className=\"mx-auto h-8 w-8 text-muted-foreground\" />\n                    <p className=\"text-sm text-muted-foreground mt-2\">Nenhuma exportação ainda</p>\n                  </div>\n                ) : (\n                  exports.slice(0, 10).map((exportItem) => (\n                    <div key={exportItem.id} className=\"border rounded-lg p-3\">\n                      <div className=\"flex items-center justify-between mb-2\">\n                        <div className=\"flex items-center gap-2\">\n                          {getStatusIcon(exportItem.status)}\n                          <span className=\"text-sm font-medium\">\n                            {exportFormats.find(f => f.value === exportItem.formato)?.label}\n                          </span>\n                        </div>\n                        {exportItem.status === 'concluido' && (\n                          <Button variant=\"ghost\" size=\"sm\">\n                            <Download className=\"h-3 w-3\" />\n                          </Button>\n                        )}\n                      </div>\n                      <p className=\"text-xs text-muted-foreground line-clamp-1\">\n                        {exportItem.relatorio_titulo}\n                      </p>\n                      <div className=\"flex items-center justify-between mt-2 text-xs text-muted-foreground\">\n                        <span>{formatDate(exportItem.data_criacao)}</span>\n                        {exportItem.tamanho_arquivo && (\n                          <span>{formatFileSize(exportItem.tamanho_arquivo)}</span>\n                        )}\n                      </div>\n                      {exportItem.status === 'processando' && (\n                        <Progress value={exportItem.progresso} className=\"mt-2 h-1\" />\n                      )}\n                    </div>\n                  ))\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n\n      {/* Dialog de Exportação */}\n      <Dialog open={exportDialogOpen} onOpenChange={setExportDialogOpen}>\n        <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              Exportar Relatório: {selectedReport?.titulo}\n            </DialogTitle>\n          </DialogHeader>\n          \n          <div className=\"space-y-6\">\n            {/* Progress Steps */}\n            <div className=\"flex items-center justify-center space-x-4\">\n              {[1, 2, 3].map((step) => (\n                <div key={step} className=\"flex items-center\">\n                  <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium ${\n                    currentStep >= step ? 'bg-primary text-primary-foreground' : 'bg-muted text-muted-foreground'\n                  }`}>\n                    {step}\n                  </div>\n                  {step < 3 && (\n                    <div className={`w-12 h-0.5 mx-2 ${\n                      currentStep > step ? 'bg-primary' : 'bg-muted'\n                    }`} />\n                  )}\n                </div>\n              ))}\n            </div>\n            \n            <div className=\"text-center text-sm text-muted-foreground\">\n              {currentStep === 1 && 'Configurações de Formato'}\n              {currentStep === 2 && 'Opções de Distribuição'}\n              {currentStep === 3 && 'Confirmação e Exportação'}\n            </div>\n\n            {/* Step 1: Formato e Configurações */}\n            {currentStep === 1 && (\n              <div className=\"space-y-6\">\n                {/* Formato */}\n                <div>\n                  <Label className=\"text-base font-semibold\">Formato de Exportação</Label>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 mt-3\">\n                    {exportFormats.map((format) => {\n                      const IconComponent = format.icon;\n                      return (\n                        <Card \n                          key={format.value}\n                          className={`cursor-pointer transition-all hover:shadow-md ${\n                            exportConfig.formato === format.value ? 'ring-2 ring-primary bg-primary/5' : ''\n                          }`}\n                          onClick={() => setExportConfig(prev => ({...prev, formato: format.value as any}))}\n                        >\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start gap-3\">\n                              <IconComponent className={`h-6 w-6 ${format.color}`} />\n                              <div className=\"flex-1\">\n                                <h4 className=\"font-medium text-sm\">{format.label}</h4>\n                                <p className=\"text-xs text-muted-foreground mt-1\">{format.description}</p>\n                                <div className=\"flex flex-wrap gap-1 mt-2\">\n                                  {format.features.map((feature, index) => (\n                                    <Badge key={index} variant=\"secondary\" className=\"text-xs\">\n                                      {feature}\n                                    </Badge>\n                                  ))}\n                                </div>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                </div>\n\n                {/* Configurações de Qualidade */}\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label>Qualidade</Label>\n                    <Select value={exportConfig.qualidade} onValueChange={(value) => setExportConfig(prev => ({...prev, qualidade: value as any}))}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        {qualityLevels.map(level => (\n                          <SelectItem key={level.value} value={level.value}>\n                            {level.label} - {level.description}\n                          </SelectItem>\n                        ))}\n                      </SelectContent>\n                    </Select>\n                  </div>\n                  \n                  <div>\n                    <Label>Orientação</Label>\n                    <Select value={exportConfig.orientacao} onValueChange={(value) => setExportConfig(prev => ({...prev, orientacao: value as any}))}>\n                      <SelectTrigger>\n                        <SelectValue />\n                      </SelectTrigger>\n                      <SelectContent>\n                        <SelectItem value=\"portrait\">Retrato</SelectItem>\n                        <SelectItem value=\"landscape\">Paisagem</SelectItem>\n                      </SelectContent>\n                    </Select>\n                  </div>\n                </div>\n\n                {/* Opções de Conteúdo */}\n                <div>\n                  <Label className=\"text-base font-semibold\">Conteúdo a Incluir</Label>\n                  <div className=\"grid grid-cols-2 gap-4 mt-3\">\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"anexos\"\n                          checked={exportConfig.incluir_anexos}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, incluir_anexos: !!checked}))}\n                        />\n                        <Label htmlFor=\"anexos\">Incluir anexos</Label>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"assinaturas\"\n                          checked={exportConfig.incluir_assinaturas}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, incluir_assinaturas: !!checked}))}\n                        />\n                        <Label htmlFor=\"assinaturas\">Incluir assinaturas</Label>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"cabecalho\"\n                          checked={exportConfig.incluir_cabecalho}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, incluir_cabecalho: !!checked}))}\n                        />\n                        <Label htmlFor=\"cabecalho\">Incluir cabeçalho</Label>\n                      </div>\n                    </div>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"rodape\"\n                          checked={exportConfig.incluir_rodape}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, incluir_rodape: !!checked}))}\n                        />\n                        <Label htmlFor=\"rodape\">Incluir rodapé</Label>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"numeracao\"\n                          checked={exportConfig.numeracao_paginas}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, numeracao_paginas: !!checked}))}\n                        />\n                        <Label htmlFor=\"numeracao\">Numeração de páginas</Label>\n                      </div>\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"marca_dagua\"\n                          checked={exportConfig.incluir_marca_dagua}\n                          onCheckedChange={(checked) => setExportConfig(prev => ({...prev, incluir_marca_dagua: !!checked}))}\n                        />\n                        <Label htmlFor=\"marca_dagua\">Marca d'água</Label>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Step 2: Distribuição */}\n            {currentStep === 2 && (\n              <div className=\"space-y-6\">\n                <div>\n                  <Label className=\"text-base font-semibold\">Método de Distribuição</Label>\n                  <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3 mt-3\">\n                    {distributionMethods.map((method) => {\n                      const IconComponent = method.icon;\n                      return (\n                        <Card \n                          key={method.value}\n                          className={`cursor-pointer transition-all hover:shadow-md ${\n                            distributionConfig.metodo === method.value ? 'ring-2 ring-primary bg-primary/5' : ''\n                          }`}\n                          onClick={() => setDistributionConfig(prev => ({...prev, metodo: method.value as any}))}\n                        >\n                          <CardContent className=\"p-4\">\n                            <div className=\"flex items-start gap-3\">\n                              <IconComponent className=\"h-5 w-5 text-primary\" />\n                              <div>\n                                <h4 className=\"font-medium text-sm\">{method.label}</h4>\n                                <p className=\"text-xs text-muted-foreground mt-1\">{method.description}</p>\n                              </div>\n                            </div>\n                          </CardContent>\n                        </Card>\n                      );\n                    })}\n                  </div>\n                </div>\n\n                {/* Configurações específicas por método */}\n                {distributionConfig.metodo === 'email' && (\n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label>Destinatários (emails separados por vírgula)</Label>\n                      <Textarea \n                        placeholder=\"email1@empresa.com, email2@empresa.com\"\n                        value={distributionConfig.destinatarios.join(', ')}\n                        onChange={(e) => setDistributionConfig(prev => ({\n                          ...prev, \n                          destinatarios: e.target.value.split(',').map(email => email.trim()).filter(Boolean)\n                        }))}\n                      />\n                    </div>\n                    <div>\n                      <Label>Assunto</Label>\n                      <Input \n                        placeholder=\"Relatório de Auditoria - [Nome do Relatório]\"\n                        value={distributionConfig.assunto || ''}\n                        onChange={(e) => setDistributionConfig(prev => ({...prev, assunto: e.target.value}))}\n                      />\n                    </div>\n                    <div>\n                      <Label>Mensagem</Label>\n                      <Textarea \n                        placeholder=\"Segue em anexo o relatório de auditoria...\"\n                        value={distributionConfig.mensagem || ''}\n                        onChange={(e) => setDistributionConfig(prev => ({...prev, mensagem: e.target.value}))}\n                        rows={3}\n                      />\n                    </div>\n                  </div>\n                )}\n\n                {distributionConfig.metodo === 'compartilhamento' && (\n                  <div className=\"space-y-4\">\n                    <div>\n                      <Label>Data de Expiração</Label>\n                      <Input \n                        type=\"date\"\n                        value={distributionConfig.data_expiracao || ''}\n                        onChange={(e) => setDistributionConfig(prev => ({...prev, data_expiracao: e.target.value}))}\n                      />\n                    </div>\n                    <div className=\"space-y-3\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Checkbox \n                          id=\"senha_protegido\"\n                          checked={distributionConfig.senha_protegido}\n                          onCheckedChange={(checked) => setDistributionConfig(prev => ({...prev, senha_protegido: !!checked}))}\n                        />\n                        <Label htmlFor=\"senha_protegido\">Proteger com senha</Label>\n                      </div>\n                      {distributionConfig.senha_protegido && (\n                        <Input \n                          type=\"password\"\n                          placeholder=\"Digite a senha\"\n                          value={distributionConfig.senha || ''}\n                          onChange={(e) => setDistributionConfig(prev => ({...prev, senha: e.target.value}))}\n                        />\n                      )}\n                    </div>\n                  </div>\n                )}\n\n                {/* Opções gerais */}\n                <div>\n                  <Label className=\"text-base font-semibold\">Opções de Acesso</Label>\n                  <div className=\"space-y-3 mt-3\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox \n                        id=\"notificar_visualizacao\"\n                        checked={distributionConfig.notificar_visualizacao}\n                        onCheckedChange={(checked) => setDistributionConfig(prev => ({...prev, notificar_visualizacao: !!checked}))}\n                      />\n                      <Label htmlFor=\"notificar_visualizacao\">Notificar quando visualizado</Label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox \n                        id=\"permitir_download\"\n                        checked={distributionConfig.permitir_download}\n                        onCheckedChange={(checked) => setDistributionConfig(prev => ({...prev, permitir_download: !!checked}))}\n                      />\n                      <Label htmlFor=\"permitir_download\">Permitir download</Label>\n                    </div>\n                    <div className=\"flex items-center space-x-2\">\n                      <Checkbox \n                        id=\"permitir_comentarios\"\n                        checked={distributionConfig.permitir_comentarios}\n                        onCheckedChange={(checked) => setDistributionConfig(prev => ({...prev, permitir_comentarios: !!checked}))}\n                      />\n                      <Label htmlFor=\"permitir_comentarios\">Permitir comentários</Label>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            )}\n\n            {/* Step 3: Confirmação */}\n            {currentStep === 3 && (\n              <div className=\"space-y-6\">\n                <div className=\"bg-muted p-4 rounded-lg\">\n                  <h4 className=\"font-semibold mb-3\">Resumo da Exportação</h4>\n                  <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                    <div>\n                      <strong>Relatório:</strong> {selectedReport?.titulo}\n                    </div>\n                    <div>\n                      <strong>Formato:</strong> {exportFormats.find(f => f.value === exportConfig.formato)?.label}\n                    </div>\n                    <div>\n                      <strong>Qualidade:</strong> {qualityLevels.find(q => q.value === exportConfig.qualidade)?.label}\n                    </div>\n                    <div>\n                      <strong>Distribuição:</strong> {distributionMethods.find(d => d.value === distributionConfig.metodo)?.label}\n                    </div>\n                  </div>\n                </div>\n\n                {processing && (\n                  <div className=\"text-center\">\n                    <div className=\"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4\"></div>\n                    <p className=\"text-sm text-muted-foreground\">Processando exportação...</p>\n                  </div>\n                )}\n              </div>\n            )}\n          </div>\n\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setExportDialogOpen(false)} disabled={processing}>\n              Cancelar\n            </Button>\n            {currentStep > 1 && (\n              <Button variant=\"outline\" onClick={() => setCurrentStep(prev => prev - 1)} disabled={processing}>\n                Voltar\n              </Button>\n            )}\n            {currentStep < 3 ? (\n              <Button onClick={() => setCurrentStep(prev => prev + 1)}>\n                Próximo\n              </Button>\n            ) : (\n              <Button onClick={handleExportReport} disabled={processing}>\n                {processing ? 'Exportando...' : 'Exportar Relatório'}\n              </Button>\n            )}\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\nexport default RelatoriosExportacao;"