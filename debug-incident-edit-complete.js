/**
 * üîç DEBUG COMPLETO - PROBLEMA DE EDI√á√ÉO DE INCIDENTES
 * 
 * Este script combina todos os debugs necess√°rios para identificar
 * por que o modal de edi√ß√£o de incidentes n√£o est√° salvando no banco.
 * 
 * BASEADO NA AN√ÅLISE DO C√ìDIGO:
 * - IncidentManagementPage.tsx: Gerencia o modal e chama updateIncident
 * - IncidentForm.tsx: Formul√°rio que captura os dados
 * - useIncidentManagement.ts: Hook que faz a chamada para o servi√ßo
 * - incidentService.ts: Servi√ßo que faz a chamada para o Supabase
 */

(function() {
    'use strict';
    
    console.log('üöÄ DEBUG COMPLETO - EDI√á√ÉO DE INCIDENTES');
    console.log('üéØ Identificando por que as edi√ß√µes n√£o s√£o salvas...\n');
    
    // ============================================================================
    // CONFIGURA√á√ÉO E UTILIT√ÅRIOS
    // ============================================================================
    
    const DEBUG_CONFIG = {\n        verbose: true,\n        trackFormData: true,\n        trackNetworkCalls: true,\n        trackReactState: true,\n        trackSupabase: true\n    };\n    \n    function log(type, message, data = null) {\n        const timestamp = new Date().toLocaleTimeString();\n        const prefix = {\n            section: 'üîç',\n            step: 'üìå',\n            success: '‚úÖ',\n            error: '‚ùå',\n            warning: '‚ö†Ô∏è',\n            network: 'üåê',\n            database: 'üóÑÔ∏è',\n            form: 'üìù',\n            react: '‚öõÔ∏è'\n        };\n        \n        console.log(`${prefix[type] || 'üìã'} [${timestamp}] ${message}`);\n        if (data && DEBUG_CONFIG.verbose) {\n            console.log('   üìä Dados:', data);\n        }\n    }\n    \n    // ============================================================================\n    // AN√ÅLISE ESPEC√çFICA DO PROBLEMA\n    // ============================================================================\n    \n    function analyzeIncidentEditFlow() {\n        log('section', 'ANALISANDO FLUXO DE EDI√á√ÉO DE INCIDENTES');\n        \n        const modal = document.querySelector('[role=\"dialog\"][id^=\"radix-\"]');\n        if (!modal) {\n            log('warning', 'Modal n√£o encontrado - aguardando abertura...');\n            return false;\n        }\n        \n        // 1. Verificar se √© modal de edi√ß√£o\n        const title = modal.querySelector('h2');\n        const isEditModal = title && title.textContent.includes('Editar');\n        log('step', `Modal tipo: ${isEditModal ? 'EDI√á√ÉO' : 'CRIA√á√ÉO'}`);\n        \n        if (!isEditModal) {\n            log('warning', 'Este n√£o √© um modal de edi√ß√£o');\n            return false;\n        }\n        \n        // 2. Verificar estrutura do formul√°rio\n        const form = modal.querySelector('form');\n        if (!form) {\n            log('error', 'Formul√°rio n√£o encontrado no modal!');\n            return false;\n        }\n        \n        // 3. Verificar campos obrigat√≥rios\n        const requiredFields = {\n            title: form.querySelector('#title'),\n            type: form.querySelector('[role=\"combobox\"]'), // Select customizado\n            category: form.querySelectorAll('[role=\"combobox\"]')[1],\n            severity: form.querySelectorAll('[role=\"combobox\"]')[2],\n            priority: form.querySelectorAll('[role=\"combobox\"]')[3]\n        };\n        \n        log('step', 'Campos encontrados:', {\n            title: !!requiredFields.title,\n            type: !!requiredFields.type,\n            category: !!requiredFields.category,\n            severity: !!requiredFields.severity,\n            priority: !!requiredFields.priority\n        });\n        \n        // 4. Verificar dados pr√©-preenchidos\n        const currentData = {\n            title: requiredFields.title?.value || '',\n            description: form.querySelector('#description')?.value || ''\n        };\n        \n        // Para selects customizados, pegar o texto exibido\n        const selects = form.querySelectorAll('[role=\"combobox\"] span');\n        selects.forEach((span, index) => {\n            const fieldNames = ['type', 'category', 'severity', 'priority'];\n            if (fieldNames[index] && span.textContent) {\n                currentData[fieldNames[index]] = span.textContent;\n            }\n        });\n        \n        log('step', 'Dados atuais do formul√°rio:', currentData);\n        \n        // 5. Verificar bot√£o de salvar\n        const saveButton = Array.from(modal.querySelectorAll('button'))\n            .find(btn => btn.textContent.includes('Atualizar'));\n        \n        if (!saveButton) {\n            log('error', 'Bot√£o \"Atualizar Incidente\" n√£o encontrado!');\n            return false;\n        }\n        \n        log('step', 'Bot√£o salvar encontrado:', {\n            text: saveButton.textContent,\n            disabled: saveButton.disabled,\n            type: saveButton.type\n        });\n        \n        return {\n            modal,\n            form,\n            saveButton,\n            currentData,\n            requiredFields\n        };\n    }\n    \n    // ============================================================================\n    // MONITORAMENTO DE OPERA√á√ïES ESPEC√çFICAS\n    // ============================================================================\n    \n    function monitorIncidentOperations() {\n        log('section', 'MONITORANDO OPERA√á√ïES DE INCIDENTE');\n        \n        // Interceptar todas as requisi√ß√µes para a tabela incidents\n        const originalFetch = window.fetch;\n        window.fetch = function(url, options) {\n            const isIncidentOperation = typeof url === 'string' && \n                (url.includes('/incidents') || url.includes('incidents'));\n            \n            if (isIncidentOperation) {\n                log('network', 'REQUISI√á√ÉO INCIDENTES:', {\n                    url,\n                    method: options?.method || 'GET',\n                    body: options?.body\n                });\n                \n                // Tentar parsear o body se for JSON\n                if (options?.body) {\n                    try {\n                        const bodyData = JSON.parse(options.body);\n                        log('database', 'DADOS ENVIADOS:', bodyData);\n                    } catch (e) {\n                        log('database', 'BODY (n√£o JSON):', options.body);\n                    }\n                }\n            }\n            \n            return originalFetch.apply(this, arguments)\n                .then(response => {\n                    if (isIncidentOperation) {\n                        log('network', 'RESPOSTA INCIDENTES:', {\n                            status: response.status,\n                            ok: response.ok,\n                            statusText: response.statusText\n                        });\n                        \n                        // Clonar para ler o body\n                        const clonedResponse = response.clone();\n                        clonedResponse.text().then(text => {\n                            try {\n                                const data = JSON.parse(text);\n                                log('database', 'RESPOSTA DADOS:', data);\n                            } catch (e) {\n                                log('database', 'RESPOSTA (texto):', text.substring(0, 200));\n                            }\n                        });\n                    }\n                    return response;\n                })\n                .catch(error => {\n                    if (isIncidentOperation) {\n                        log('error', 'ERRO NA REQUISI√á√ÉO INCIDENTES:', error);\n                    }\n                    throw error;\n                });\n        };\n    }\n    \n    // ============================================================================\n    // MONITORAMENTO DE EVENTOS DO FORMUL√ÅRIO\n    // ============================================================================\n    \n    function monitorFormEvents() {\n        log('section', 'MONITORANDO EVENTOS DO FORMUL√ÅRIO');\n        \n        const checkAndMonitor = () => {\n            const analysis = analyzeIncidentEditFlow();\n            if (!analysis) return;\n            \n            const { form, saveButton, currentData } = analysis;\n            \n            // Monitorar submit do formul√°rio\n            form.addEventListener('submit', function(e) {\n                log('form', 'üöÄ SUBMIT DO FORMUL√ÅRIO DISPARADO');\n                log('form', 'preventDefault chamado:', e.defaultPrevented);\n                \n                // Capturar dados no momento do submit\n                const formData = new FormData(form);\n                const submitData = {};\n                for (let [key, value] of formData.entries()) {\n                    submitData[key] = value;\n                }\n                \n                log('form', 'DADOS DO SUBMIT:', submitData);\n                \n                // Verificar se h√° dados v√°lidos\n                if (!submitData.title || submitData.title.trim() === '') {\n                    log('error', 'T√çTULO VAZIO NO SUBMIT!');\n                }\n            }, true);\n            \n            // Monitorar clique no bot√£o salvar\n            saveButton.addEventListener('click', function(e) {\n                log('form', 'üñ±Ô∏è  CLIQUE NO BOT√ÉO SALVAR');\n                log('form', 'Bot√£o estado:', {\n                    disabled: e.target.disabled,\n                    text: e.target.textContent,\n                    type: e.target.type\n                });\n                \n                // Verificar se o formul√°rio √© v√°lido\n                const titleInput = form.querySelector('#title');\n                if (titleInput && !titleInput.value.trim()) {\n                    log('error', 'TENTATIVA DE SALVAR COM T√çTULO VAZIO!');\n                }\n            }, true);\n            \n            // Monitorar mudan√ßas nos campos\n            const inputs = form.querySelectorAll('input, textarea');\n            inputs.forEach(input => {\n                input.addEventListener('change', function(e) {\n                    log('form', `Campo alterado: ${e.target.id || 'sem-id'}`, {\n                        valor: e.target.value,\n                        valido: e.target.checkValidity()\n                    });\n                });\n            });\n        };\n        \n        // Verificar imediatamente e depois observar mudan√ßas\n        checkAndMonitor();\n        \n        // Observer para quando o modal for aberto\n        const observer = new MutationObserver(() => {\n            checkAndMonitor();\n        });\n        \n        observer.observe(document.body, {\n            childList: true,\n            subtree: true\n        });\n    }\n    \n    // ============================================================================\n    // VERIFICA√á√ÉO DE HOOKS E ESTADO\n    // ============================================================================\n    \n    function checkReactHooksState() {\n        log('section', 'VERIFICANDO ESTADO DOS HOOKS REACT');\n        \n        // Tentar encontrar o estado do useIncidentManagement\n        const modal = document.querySelector('[role=\"dialog\"]');\n        if (!modal) return;\n        \n        // Procurar por React Fiber\n        for (let key in modal) {\n            if (key.startsWith('__reactFiber') || key.startsWith('__reactInternalInstance')) {\n                try {\n                    const fiber = modal[key];\n                    let current = fiber;\n                    let depth = 0;\n                    \n                    while (current && depth < 15) {\n                        // Procurar por hooks relacionados a incidentes\n                        if (current.memoizedState) {\n                            const state = current.memoizedState;\n                            \n                            // Verificar se h√° estado relacionado a incidentes\n                            if (typeof state === 'object' && state !== null) {\n                                const stateStr = JSON.stringify(state).toLowerCase();\n                                if (stateStr.includes('incident') || stateStr.includes('edit')) {\n                                    log('react', `Estado encontrado (depth ${depth}):`, state);\n                                }\n                            }\n                        }\n                        \n                        // Verificar props\n                        if (current.memoizedProps) {\n                            const props = current.memoizedProps;\n                            if (typeof props === 'object' && props !== null) {\n                                const propsStr = JSON.stringify(props).toLowerCase();\n                                if (propsStr.includes('incident') || propsStr.includes('onsubmit')) {\n                                    log('react', `Props encontradas (depth ${depth}):`, props);\n                                }\n                            }\n                        }\n                        \n                        current = current.return;\n                        depth++;\n                    }\n                    break;\n                } catch (e) {\n                    log('warning', 'Erro ao acessar React Fiber:', e.message);\n                }\n            }\n        }\n    }\n    \n    // ============================================================================\n    // TESTE ESPEC√çFICO DE EDI√á√ÉO\n    // ============================================================================\n    \n    function testIncidentEdit() {\n        log('section', 'EXECUTANDO TESTE DE EDI√á√ÉO');\n        \n        const analysis = analyzeIncidentEditFlow();\n        if (!analysis) {\n            log('warning', 'N√£o √© poss√≠vel testar - modal n√£o encontrado');\n            return;\n        }\n        \n        const { form, saveButton, currentData } = analysis;\n        \n        // Fazer uma pequena altera√ß√£o no t√≠tulo\n        const titleInput = form.querySelector('#title');\n        if (titleInput) {\n            const originalTitle = titleInput.value;\n            const testTitle = originalTitle + ' [TESTE]';\n            \n            log('step', 'Alterando t√≠tulo para teste...');\n            titleInput.value = testTitle;\n            titleInput.dispatchEvent(new Event('input', { bubbles: true }));\n            titleInput.dispatchEvent(new Event('change', { bubbles: true }));\n            \n            setTimeout(() => {\n                log('step', 'T√≠tulo ap√≥s altera√ß√£o:', titleInput.value);\n                \n                // Simular clique no bot√£o (apenas se n√£o estiver desabilitado)\n                if (!saveButton.disabled) {\n                    log('step', 'Simulando clique no bot√£o salvar...');\n                    saveButton.click();\n                } else {\n                    log('warning', 'Bot√£o salvar est√° desabilitado');\n                }\n                \n                // Restaurar t√≠tulo original ap√≥s 5 segundos\n                setTimeout(() => {\n                    titleInput.value = originalTitle;\n                    titleInput.dispatchEvent(new Event('input', { bubbles: true }));\n                    log('step', 'T√≠tulo restaurado para o original');\n                }, 5000);\n            }, 1000);\n        }\n    }\n    \n    // ============================================================================\n    // VERIFICA√á√ÉO DE PROBLEMAS COMUNS\n    // ============================================================================\n    \n    function checkCommonIssues() {\n        log('section', 'VERIFICANDO PROBLEMAS COMUNS');\n        \n        // 1. Verificar se h√° erros de valida√ß√£o\n        const errorElements = document.querySelectorAll('.text-red-500, .error, [data-error]');\n        if (errorElements.length > 0) {\n            log('warning', 'Erros de valida√ß√£o encontrados:', \n                Array.from(errorElements).map(el => el.textContent)\n            );\n        }\n        \n        // 2. Verificar se h√° campos obrigat√≥rios vazios\n        const requiredInputs = document.querySelectorAll('input[required], [aria-required=\"true\"]');\n        const emptyRequired = Array.from(requiredInputs).filter(input => !input.value.trim());\n        if (emptyRequired.length > 0) {\n            log('warning', 'Campos obrigat√≥rios vazios:', \n                emptyRequired.map(input => input.id || input.name)\n            );\n        }\n        \n        // 3. Verificar conectividade\n        fetch('/api/health')\n            .then(response => {\n                log('success', 'Conectividade OK:', response.status);\n            })\n            .catch(error => {\n                log('error', 'Problema de conectividade:', error.message);\n            });\n        \n        // 4. Verificar autentica√ß√£o\n        const authToken = localStorage.getItem('supabase.auth.token') || \n                         sessionStorage.getItem('access_token');\n        if (!authToken) {\n            log('warning', 'Token de autentica√ß√£o n√£o encontrado');\n        } else {\n            log('success', 'Token de autentica√ß√£o presente');\n        }\n        \n        // 5. Verificar se h√° opera√ß√µes em andamento\n        const loadingElements = document.querySelectorAll('[data-loading], .loading, .spinner');\n        if (loadingElements.length > 0) {\n            log('step', 'Opera√ß√µes em andamento detectadas:', loadingElements.length);\n        }\n    }\n    \n    // ============================================================================\n    // INICIALIZA√á√ÉO PRINCIPAL\n    // ============================================================================\n    \n    function init() {\n        log('section', 'INICIALIZANDO DEBUG COMPLETO');\n        \n        // Aguardar carregamento completo\n        setTimeout(() => {\n            monitorIncidentOperations();\n            monitorFormEvents();\n            checkCommonIssues();\n            \n            // Verificar estado React periodicamente\n            setInterval(() => {\n                if (document.querySelector('[role=\"dialog\"]')) {\n                    checkReactHooksState();\n                }\n            }, 5000);\n            \n            log('success', 'Debug completo inicializado!');\n            \n        }, 1000);\n    }\n    \n    // ============================================================================\n    // INTERFACE P√öBLICA\n    // ============================================================================\n    \n    window.incidentEditDebug = {\n        analyze: analyzeIncidentEditFlow,\n        test: testIncidentEdit,\n        checkIssues: checkCommonIssues,\n        checkState: checkReactHooksState\n    };\n    \n    // Inicializar\n    init();\n    \n    // Instru√ß√µes\n    console.log(`\nüéØ DEBUG EDI√á√ÉO DE INCIDENTES ATIVO!\n\nüìã COMANDOS DISPON√çVEIS:\n‚Ä¢ incidentEditDebug.analyze() - Analisar modal atual\n‚Ä¢ incidentEditDebug.test() - Testar edi√ß√£o automaticamente\n‚Ä¢ incidentEditDebug.checkIssues() - Verificar problemas comuns\n‚Ä¢ incidentEditDebug.checkState() - Verificar estado React\n\nüîç COMO USAR:\n1. Abra um incidente existente para edi√ß√£o\n2. Observe os logs autom√°ticos no console\n3. Fa√ßa altera√ß√µes e tente salvar\n4. Use os comandos acima para an√°lise detalhada\n\n‚ö†Ô∏è  PONTOS DE ATEN√á√ÉO:\n‚Ä¢ Verifique se h√° erros de valida√ß√£o\n‚Ä¢ Confirme se os dados est√£o sendo enviados\n‚Ä¢ Observe se h√° problemas de conectividade\n‚Ä¢ Verifique se o token de autentica√ß√£o est√° presente\n`);\n    \n})();