# 🔍 DEBUG DETALHADO - Erro de Edição de Políticas\n\n## 📋 **Instruções para Debug**\n\nO sistema agora possui logs extremamente detalhados para identificar exatamente onde está ocorrendo o erro.\n\n---\n\n## 🧪 **Como Testar e Capturar Logs**\n\n### **1. Preparação:**\n1. **Abra**: Console do navegador (F12 → Console)\n2. **Limpe**: Console (Ctrl+L ou botão limpar)\n3. **Acesse**: `http://localhost:8080/policy-management`\n4. **Vá para**: Aba \"Elaboração\"\n\n### **2. Teste de Edição:**\n1. **Clique**: Em uma política para expandir\n2. **Clique**: Botão \"Editar\"\n3. **Modifique**: Qualquer campo (título, categoria, etc.)\n4. **Clique**: \"Salvar Alterações\"\n5. **Observe**: Logs detalhados no console\n\n### **3. Captura de Logs:**\n1. **Copie**: Todos os logs que começam com \"=== 🔍 DEBUG DETALHADO\"\n2. **Cole**: Em um arquivo de texto\n3. **Envie**: Para análise\n\n---\n\n## 📊 **Logs Implementados**\n\n### **Seção 1: Validações Iniciais**\n```\n=== 🔍 DEBUG DETALHADO - INÍCIO DO SALVAMENTO ===\n⏰ Timestamp: [data/hora]\n👤 Usuário: [dados do usuário]\n📝 editingPolicy: [política sendo editada]\n📋 editFormData: [dados do formulário]\n📎 attachedDocuments: [documentos anexados]\n🔄 isLoading atual: [estado de loading]\n```\n\n### **Seção 2: Validação de Campos**\n```\n✅ VALIDAÇÃO 1: editingPolicy existe\n🔍 Validando título...\n📝 Título atual: \"[título]\"\n📏 Comprimento do título: [número]\n🧹 Título após trim: \"[título limpo]\"\n✅ VALIDAÇÃO 2: Título válido\n\n🔍 Validando categoria...\n📂 Categoria atual: \"[categoria]\"\n📂 Tipo da categoria: [tipo]\n📋 Categorias disponíveis: [array]\n🔍 Categoria está na lista? [true/false]\n✅ VALIDAÇÃO 3: Categoria válida\n```\n\n### **Seção 3: Preparação dos Dados**\n```\n🏗️ Construindo objeto updatedPolicy...\n📦 updatedPolicy construído:\n  - ID: [id]\n  - Título: [título]\n  - Categoria: [categoria]\n  - Tipo: [tipo]\n  - Prioridade: [prioridade]\n  - Data efetiva: [data]\n  - Data revisão: [data]\n  - Data expiração: [data]\n  - URL documento: [url]\n  - Metadados: [metadados]\n  - Updated by: [usuário]\n```\n\n### **Seção 4: Salvamento no Banco**\n```\n=== 💾 INÍCIO DO SALVAMENTO NO BANCO ===\n📥 updatedPolicy recebido: [dados]\n🏗️ Construindo updateData...\n📊 updateData construído:\n  - title: string → [valor]\n  - description: string → [valor]\n  - category: string → [valor]\n  - document_type: string → [valor]\n  - effective_date: string → [valor]\n  - review_date: string → [valor]\n  - expiration_date: string → [valor]\n  - priority: string → [valor]\n  - document_url: string → [valor]\n  - metadata: object → [valor]\n  - updated_at: string → [valor]\n  - updated_by: string → [valor]\n\n🆔 ID da política para update: [id]\n🔍 Tipo do ID: [tipo]\n🚀 Executando query no Supabase...\n📡 Tabela: policies\n🔧 Operação: UPDATE\n🎯 Condição: id = [id]\n⏱️ Query executada em [tempo]ms\n```\n\n### **Seção 5: Resposta do Banco**\n```\n📡 Resposta completa do Supabase:\n  - error: [erro ou null]\n  - data: [dados retornados]\n  - data length: [quantidade]\n\n✅ Update realizado com sucesso!\n📄 Linhas afetadas: [número]\n📄 Dados atualizados: [dados]\n```\n\n### **Seção 6: Tratamento de Erros**\n```\n=== ❌ ERRO DO SUPABASE DETECTADO ===\n🚨 Erro completo: [erro]\n🚨 Código do erro: [código]\n🚨 Mensagem: [mensagem]\n🚨 Detalhes: [detalhes]\n🚨 Hint: [dica]\n\n🔍 ERRO DE CONSTRAINT DETECTADO!\n🔍 Verificando valores que podem estar causando o erro...\n❌ Categoria inválida: [categoria]\n✅ Categorias válidas: [array]\n❌ Tipo de documento inválido: [tipo]\n✅ Tipos válidos: [array]\n```\n\n---\n\n## 🎯 **Pontos de Verificação**\n\n### **1. Validações de Entrada:**\n- ✅ `editingPolicy` existe?\n- ✅ Título não está vazio?\n- ✅ Categoria foi selecionada?\n- ✅ Categoria está na lista válida?\n- ✅ Tipo de documento está na lista válida?\n\n### **2. Preparação dos Dados:**\n- ✅ `updatedPolicy` foi construído corretamente?\n- ✅ Todos os campos necessários estão presentes?\n- ✅ Tipos de dados estão corretos?\n- ✅ ID da política está presente?\n\n### **3. Execução da Query:**\n- ✅ `updateData` foi construído corretamente?\n- ✅ Query foi executada?\n- ✅ Tempo de execução foi razoável?\n- ✅ Resposta foi recebida?\n\n### **4. Análise da Resposta:**\n- ✅ Erro foi retornado?\n- ✅ Dados foram retornados?\n- ✅ Número de linhas afetadas?\n- ✅ Tipo de erro (se houver)?\n\n---\n\n## 🚨 **Possíveis Causas de Erro**\n\n### **1. Erro de Constraint (Código 23514):**\n- **Categoria inválida**: Não está na lista de categorias permitidas\n- **Tipo de documento inválido**: Não está na lista de tipos permitidos\n- **Status inválido**: Valor não permitido para status\n\n### **2. Erro de Permissão:**\n- **RLS (Row Level Security)**: Usuário não tem permissão para editar\n- **Tenant**: Política não pertence ao tenant do usuário\n\n### **3. Erro de Dados:**\n- **ID inválido**: Política não existe\n- **Campos obrigatórios**: Campos NOT NULL estão vazios\n- **Tipos de dados**: Incompatibilidade de tipos\n\n### **4. Erro de Conexão:**\n- **Timeout**: Query demorou muito para executar\n- **Rede**: Problema de conectividade\n- **Supabase**: Serviço indisponível\n\n---\n\n## 📝 **Exemplo de Log Completo**\n\n```\n=== 🔍 DEBUG DETALHADO - INÍCIO DO SALVAMENTO ===\n⏰ Timestamp: 2025-08-23T14:30:00.000Z\n👤 Usuário: { id: \"123\", email: \"user@example.com\" }\n📝 editingPolicy: { id: \"policy-123\", title: \"Política Original\" }\n📋 editFormData: { title: \"Política Editada\", category: \"Compliance\" }\n📎 attachedDocuments: []\n🔄 isLoading atual: false\n\n✅ VALIDAÇÃO 1: editingPolicy existe\n🔍 Validando título...\n📝 Título atual: \"Política Editada\"\n📏 Comprimento do título: 16\n🧹 Título após trim: \"Política Editada\"\n✅ VALIDAÇÃO 2: Título válido\n\n🔍 Validando categoria...\n📂 Categoria atual: \"Compliance\"\n📂 Tipo da categoria: string\n📋 Categorias disponíveis: [\"Compliance\", \"Segurança\", ...]\n🔍 Categoria está na lista? true\n✅ VALIDAÇÃO 3: Categoria válida\n\n✅ TODAS AS VALIDAÇÕES PASSARAM - Iniciando salvamento...\n🔄 Definindo isLoading = true\n🏗️ Construindo objeto updatedPolicy...\n📦 updatedPolicy construído:\n  - ID: policy-123\n  - Título: Política Editada\n  - Categoria: Compliance\n  ...\n\n🚀 Chamando handleSavePolicy...\n\n=== 💾 INÍCIO DO SALVAMENTO NO BANCO ===\n📥 updatedPolicy recebido: { id: \"policy-123\", ... }\n🏗️ Construindo updateData...\n📊 updateData construído:\n  - title: string → Política Editada\n  - category: string → Compliance\n  ...\n\n🚀 Executando query no Supabase...\n⏱️ Query executada em 150ms\n📡 Resposta completa do Supabase:\n  - error: null\n  - data: [{ id: \"policy-123\", title: \"Política Editada\" }]\n  - data length: 1\n\n✅ Update realizado com sucesso!\n📄 Linhas afetadas: 1\n🔄 Chamando onPolicyUpdate()...\n🎉 Exibindo toast de sucesso...\n✅ handleSavePolicy concluído com sucesso\n✅ handleSavePolicy retornou com sucesso\n🔄 Fechando modal e limpando estado...\n🎉 SALVAMENTO CONCLUÍDO COM SUCESSO!\n🔄 Definindo isLoading = false\n=== 🏁 FIM DO DEBUG DETALHADO ===\n```\n\n---\n\n## 🎯 **Próximos Passos**\n\n1. **Execute** o teste de edição\n2. **Copie** todos os logs do console\n3. **Identifique** onde o processo para ou falha\n4. **Analise** os valores dos campos\n5. **Verifique** se há erros de constraint\n6. **Envie** os logs para análise detalhada\n\n---\n\n*Debug implementado em: 23 de Agosto de 2025*  \n*Objetivo: Identificar causa raiz do erro de edição*  \n*Status: 🔍 AGUARDANDO LOGS DE TESTE*