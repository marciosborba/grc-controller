/**
 * ðŸ” DEBUG ESPECÃFICO - OPERAÃ‡Ã•ES SUPABASE E HOOKS
 * 
 * Este script monitora especificamente as operaÃ§Ãµes do Supabase
 * e do hook useIncidentManagement para identificar problemas
 * na persistÃªncia de dados.
 */

(function() {
    'use strict';
    
    console.log('ðŸ”§ INICIANDO DEBUG DAS OPERAÃ‡Ã•ES SUPABASE');
    console.log('ðŸ“Š Monitorando hooks e persistÃªncia de dados...\n');
    
    // ============================================================================
    // UTILITÃRIOS DE LOG
    // ============================================================================
    
    function logSection(title) {
        console.log(`\n${'='.repeat(60)}`);
        console.log(`ðŸ”§ ${title}`);
        console.log(`${'='.repeat(60)}`);
    }
    
    function logStep(step, data = null) {
        console.log(`ðŸ”¹ ${step}`);
        if (data) {
            console.log('   ðŸ“‹ Dados:', data);
        }
    }
    
    function logError(error, context = '') {
        console.error(`âŒ ERRO ${context}:`, error);
        if (error.stack) {
            console.error('   ðŸ“š Stack:', error.stack);
        }
    }
    
    function logSuccess(message, data = null) {
        console.log(`âœ… ${message}`);
        if (data) {
            console.log('   ðŸ“‹ Dados:', data);
        }
    }
    
    function logWarning(message, data = null) {
        console.warn(`âš ï¸  ${message}`);
        if (data) {
            console.warn('   ðŸ“‹ Dados:', data);
        }
    }
    
    // ============================================================================
    // MONITORAMENTO DO SUPABASE CLIENT
    // ============================================================================
    
    function monitorSupabaseClient() {
        logSection('MONITORANDO CLIENTE SUPABASE');
        
        // Tentar encontrar o cliente Supabase
        let supabaseClient = null;
        
        // Verificar diferentes locais onde o cliente pode estar
        const possibleLocations = [
            () => window.supabase,
            () => window.__SUPABASE_CLIENT__,
            () => window.app?.supabase,
            () => document.querySelector('[data-supabase]')?.supabase
        ];
        
        for (const getClient of possibleLocations) {
            try {
                const client = getClient();
                if (client && typeof client.from === 'function') {
                    supabaseClient = client;
                    logSuccess('Cliente Supabase encontrado!');
                    break;
                }
            } catch (e) {
                // Ignorar erros de acesso
            }
        }
        
        if (!supabaseClient) {\n            logWarning('Cliente Supabase nÃ£o encontrado diretamente');\n            \n            // Tentar interceptar atravÃ©s de mÃ³dulos\n            try {\n                // Interceptar importaÃ§Ãµes dinÃ¢micas\n                const originalImport = window.import || (() => {});\n                window.import = function(module) {\n                    logStep('MÃ³dulo importado:', module);\n                    return originalImport.apply(this, arguments);\n                };\n            } catch (e) {\n                logWarning('NÃ£o foi possÃ­vel interceptar imports:', e.message);\n            }\n            \n            return null;\n        }\n        \n        // Interceptar operaÃ§Ãµes do Supabase\n        const originalFrom = supabaseClient.from;\n        supabaseClient.from = function(table) {\n            logStep('ðŸ—„ï¸  SUPABASE.FROM() chamado:', { table });\n            \n            const query = originalFrom.call(this, table);\n            \n            // Interceptar mÃ©todos de query\n            const methods = ['select', 'insert', 'update', 'delete', 'upsert'];\n            \n            methods.forEach(method => {\n                if (query[method]) {\n                    const originalMethod = query[method];\n                    query[method] = function(...args) {\n                        logStep(`ðŸ“ SUPABASE.${method.toUpperCase()}():`, {\n                            table,\n                            args: args.length > 0 ? args : 'sem argumentos'\n                        });\n                        \n                        const result = originalMethod.apply(this, args);\n                        \n                        // Interceptar mÃ©todos de filtro e execuÃ§Ã£o\n                        const filterMethods = ['eq', 'neq', 'gt', 'gte', 'lt', 'lte', 'like', 'ilike', 'in', 'is', 'filter'];\n                        \n                        filterMethods.forEach(filterMethod => {\n                            if (result[filterMethod]) {\n                                const originalFilter = result[filterMethod];\n                                result[filterMethod] = function(...filterArgs) {\n                                    logStep(`ðŸ” FILTRO ${filterMethod.toUpperCase()}():`, {\n                                        table,\n                                        method,\n                                        filter: filterArgs\n                                    });\n                                    return originalFilter.apply(this, filterArgs);\n                                };\n                            }\n                        });\n                        \n                        // Interceptar execuÃ§Ã£o final\n                        if (result.then) {\n                            return result.then(response => {\n                                logStep(`ðŸ“¥ RESPOSTA ${method.toUpperCase()}():`, {\n                                    table,\n                                    success: !response.error,\n                                    error: response.error,\n                                    data: response.data,\n                                    count: response.count\n                                });\n                                \n                                if (response.error) {\n                                    logError(`Erro na operaÃ§Ã£o ${method}:`, response.error);\n                                }\n                                \n                                return response;\n                            }).catch(error => {\n                                logError(`Erro na promise ${method}:`, error);\n                                throw error;\n                            });\n                        }\n                        \n                        return result;\n                    };\n                }\n            });\n            \n            return query;\n        };\n        \n        return supabaseClient;\n    }\n    \n    // ============================================================================\n    // MONITORAMENTO DE REACT QUERY\n    // ============================================================================\n    \n    function monitorReactQuery() {\n        logSection('MONITORANDO REACT QUERY');\n        \n        // Tentar encontrar o QueryClient\n        let queryClient = null;\n        \n        // Verificar se React Query estÃ¡ disponÃ­vel\n        if (window.ReactQuery) {\n            logStep('React Query encontrado no window');\n        }\n        \n        // Interceptar console.log para capturar logs do React Query\n        const originalConsoleLog = console.log;\n        console.log = function(...args) {\n            const message = args.join(' ');\n            if (message.includes('Query') || message.includes('Mutation')) {\n                logStep('ðŸ”„ LOG REACT QUERY:', args);\n            }\n            return originalConsoleLog.apply(this, args);\n        };\n        \n        // Tentar interceptar fetch para queries\n        const originalFetch = window.fetch;\n        window.fetch = function(url, options) {\n            if (typeof url === 'string' && url.includes('supabase')) {\n                logStep('ðŸŒ FETCH SUPABASE:', {\n                    url,\n                    method: options?.method || 'GET',\n                    headers: options?.headers,\n                    body: options?.body\n                });\n            }\n            \n            return originalFetch.apply(this, arguments)\n                .then(response => {\n                    if (typeof url === 'string' && url.includes('supabase')) {\n                        logStep('ðŸ“¥ RESPOSTA SUPABASE:', {\n                            url,\n                            status: response.status,\n                            ok: response.ok\n                        });\n                    }\n                    return response;\n                })\n                .catch(error => {\n                    if (typeof url === 'string' && url.includes('supabase')) {\n                        logError('Erro no fetch Supabase:', error);\n                    }\n                    throw error;\n                });\n        };\n    }\n    \n    // ============================================================================\n    // MONITORAMENTO DE HOOKS CUSTOMIZADOS\n    // ============================================================================\n    \n    function monitorCustomHooks() {\n        logSection('MONITORANDO HOOKS CUSTOMIZADOS');\n        \n        // Tentar interceptar chamadas de hooks atravÃ©s do React DevTools\n        if (window.__REACT_DEVTOOLS_GLOBAL_HOOK__) {\n            logStep('React DevTools encontrado');\n            \n            const devTools = window.__REACT_DEVTOOLS_GLOBAL_HOOK__;\n            \n            // Interceptar eventos do React\n            const originalOnCommitFiberRoot = devTools.onCommitFiberRoot;\n            if (originalOnCommitFiberRoot) {\n                devTools.onCommitFiberRoot = function(id, root, ...args) {\n                    logStep('ðŸ”„ REACT COMMIT:', { id, root: root.constructor.name });\n                    return originalOnCommitFiberRoot.apply(this, [id, root, ...args]);\n                };\n            }\n        }\n        \n        // Monitorar mudanÃ§as no localStorage (pode ser usado por hooks)\n        const originalSetItem = localStorage.setItem;\n        localStorage.setItem = function(key, value) {\n            if (key.includes('incident') || key.includes('query')) {\n                logStep('ðŸ’¾ LOCALSTORAGE SET:', { key, value });\n            }\n            return originalSetItem.apply(this, arguments);\n        };\n        \n        const originalGetItem = localStorage.getItem;\n        localStorage.getItem = function(key) {\n            const result = originalGetItem.apply(this, arguments);\n            if (key.includes('incident') || key.includes('query')) {\n                logStep('ðŸ“– LOCALSTORAGE GET:', { key, value: result });\n            }\n            return result;\n        };\n    }\n    \n    // ============================================================================\n    // ANÃLISE DE ESTADO DA APLICAÃ‡ÃƒO\n    // ============================================================================\n    \n    function analyzeApplicationState() {\n        logSection('ANALISANDO ESTADO DA APLICAÃ‡ÃƒO');\n        \n        // Verificar se hÃ¡ dados de incidentes em memÃ³ria\n        const possibleStates = [\n            () => window.__APP_STATE__,\n            () => window.store,\n            () => window.state,\n            () => document.querySelector('[data-state]')?.dataset.state\n        ];\n        \n        possibleStates.forEach((getState, index) => {\n            try {\n                const state = getState();\n                if (state) {\n                    logStep(`Estado encontrado (${index + 1}):`, state);\n                }\n            } catch (e) {\n                // Ignorar erros\n            }\n        });\n        \n        // Verificar React Fiber para encontrar estado dos componentes\n        const modal = document.querySelector('[role=\"dialog\"]');\n        if (modal) {\n            for (let key in modal) {\n                if (key.startsWith('__reactFiber') || key.startsWith('__reactInternalInstance')) {\n                    try {\n                        const fiber = modal[key];\n                        logStep('ðŸ§¬ React Fiber encontrado');\n                        \n                        // Navegar pela Ã¡rvore de componentes\n                        let current = fiber;\n                        let depth = 0;\n                        while (current && depth < 10) {\n                            if (current.memoizedState) {\n                                logStep(`Estado do componente (depth ${depth}):`, current.memoizedState);\n                            }\n                            if (current.memoizedProps) {\n                                logStep(`Props do componente (depth ${depth}):`, current.memoizedProps);\n                            }\n                            current = current.return;\n                            depth++;\n                        }\n                        break;\n                    } catch (e) {\n                        logWarning('Erro ao acessar React Fiber:', e.message);\n                    }\n                }\n            }\n        }\n    }\n    \n    // ============================================================================\n    // TESTE DE CONECTIVIDADE\n    // ============================================================================\n    \n    function testConnectivity() {\n        logSection('TESTANDO CONECTIVIDADE');\n        \n        // Teste bÃ¡sico de fetch\n        fetch('/api/health')\n            .then(response => {\n                logStep('âœ… Conectividade API:', {\n                    status: response.status,\n                    ok: response.ok\n                });\n            })\n            .catch(error => {\n                logWarning('âŒ Erro de conectividade API:', error.message);\n            });\n        \n        // Teste de conectividade com Supabase\n        const supabaseUrl = 'https://myxvxponlmulnjstbjwd.supabase.co';\n        fetch(`${supabaseUrl}/rest/v1/`, {\n            headers: {\n                'apikey': 'sua-api-key-aqui' // Substitua pela chave real se necessÃ¡rio\n            }\n        })\n            .then(response => {\n                logStep('âœ… Conectividade Supabase:', {\n                    status: response.status,\n                    ok: response.ok\n                });\n            })\n            .catch(error => {\n                logWarning('âŒ Erro de conectividade Supabase:', error.message);\n            });\n    }\n    \n    // ============================================================================\n    // VERIFICAÃ‡ÃƒO DE PERMISSÃ•ES\n    // ============================================================================\n    \n    function checkPermissions() {\n        logSection('VERIFICANDO PERMISSÃ•ES');\n        \n        // Verificar se hÃ¡ informaÃ§Ãµes de usuÃ¡rio\n        const possibleUserSources = [\n            () => window.user,\n            () => window.currentUser,\n            () => window.auth?.user,\n            () => localStorage.getItem('user'),\n            () => sessionStorage.getItem('user')\n        ];\n        \n        possibleUserSources.forEach((getUser, index) => {\n            try {\n                const user = getUser();\n                if (user) {\n                    logStep(`UsuÃ¡rio encontrado (${index + 1}):`, \n                        typeof user === 'string' ? JSON.parse(user) : user\n                    );\n                }\n            } catch (e) {\n                // Ignorar erros\n            }\n        });\n        \n        // Verificar tokens de autenticaÃ§Ã£o\n        const possibleTokens = [\n            localStorage.getItem('supabase.auth.token'),\n            localStorage.getItem('access_token'),\n            sessionStorage.getItem('access_token'),\n            document.cookie.includes('access_token')\n        ];\n        \n        possibleTokens.forEach((token, index) => {\n            if (token) {\n                logStep(`Token encontrado (${index + 1}):`, \n                    typeof token === 'string' ? token.substring(0, 50) + '...' : 'presente'\n                );\n            }\n        });\n    }\n    \n    // ============================================================================\n    // INICIALIZAÃ‡ÃƒO\n    // ============================================================================\n    \n    function init() {\n        logSection('INICIALIZANDO DEBUG SUPABASE');\n        \n        setTimeout(() => {\n            const supabaseClient = monitorSupabaseClient();\n            monitorReactQuery();\n            monitorCustomHooks();\n            analyzeApplicationState();\n            checkPermissions();\n            testConnectivity();\n            \n            logSuccess('Debug Supabase inicializado!');\n            \n            // Verificar periodicamente se hÃ¡ operaÃ§Ãµes\n            setInterval(() => {\n                const modal = document.querySelector('[role=\"dialog\"]');\n                if (modal && modal.querySelector('form')) {\n                    // Modal estÃ¡ aberto, verificar se hÃ¡ operaÃ§Ãµes pendentes\n                    const loadingElements = modal.querySelectorAll('[data-loading], .loading, .spinner');\n                    if (loadingElements.length > 0) {\n                        logStep('ðŸ”„ OperaÃ§Ã£o em andamento detectada');\n                    }\n                }\n            }, 2000);\n            \n        }, 1000);\n    }\n    \n    // ============================================================================\n    // INTERFACE PÃšBLICA\n    // ============================================================================\n    \n    window.supabaseDebug = {\n        testConnectivity,\n        checkPermissions,\n        analyzeState: analyzeApplicationState\n    };\n    \n    // Inicializar\n    init();\n    \n    console.log(`\nðŸ”§ COMANDOS SUPABASE DEBUG:\n`);\n    console.log('â€¢ supabaseDebug.testConnectivity() - Testar conectividade');\n    console.log('â€¢ supabaseDebug.checkPermissions() - Verificar permissÃµes');\n    console.log('â€¢ supabaseDebug.analyzeState() - Analisar estado da aplicaÃ§Ã£o\\n');\n    \n})();