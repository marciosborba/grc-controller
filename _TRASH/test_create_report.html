<!DOCTYPE html>
<html>
<head>
    <title>Teste de Criação de Relatório</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>Teste de Criação de Relatório</h1>
    <button onclick="testCreateReport()">Criar Relatório de Teste</button>
    <div id="result"></div>

    <script>
        const supabaseUrl = 'http://127.0.0.1:54321'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0'
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey)

        async function testCreateReport() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Testando...';

            try {
                // Primeiro, buscar um tenant
                const { data: tenants, error: tenantError } = await supabase
                    .from('tenants')
                    .select('id')
                    .limit(1);

                if (tenantError) {
                    throw new Error('Erro ao buscar tenant: ' + tenantError.message);
                }

                if (!tenants || tenants.length === 0) {
                    throw new Error('Nenhum tenant encontrado');
                }

                const tenantId = tenants[0].id;

                // Criar relatório
                const novoRelatorio = {
                    tenant_id: tenantId,
                    codigo: `TEST-${Date.now()}`,
                    titulo: `Teste de Relatório - ${new Date().toLocaleDateString('pt-BR')}`,
                    tipo: 'executivo',
                    categoria: 'interno',
                    resumo_executivo: 'Relatório de teste criado via JavaScript.',
                    status: 'rascunho',
                    prioridade: 'media',
                    total_apontamentos: 0,
                    apontamentos_criticos: 0,
                    compliance_score: 0
                };

                console.log('Tentando criar relatório:', novoRelatorio);

                const { data: relatorio, error: relatorioError } = await supabase
                    .from('relatorios_auditoria')
                    .insert(novoRelatorio)
                    .select()
                    .single();

                if (relatorioError) {
                    throw new Error('Erro ao criar relatório: ' + JSON.stringify(relatorioError));
                }

                resultDiv.innerHTML = `
                    <h3>✅ Sucesso!</h3>
                    <p><strong>Código:</strong> ${relatorio.codigo}</p>
                    <p><strong>Título:</strong> ${relatorio.titulo}</p>
                    <p><strong>Tipo:</strong> ${relatorio.tipo}</p>
                    <p><strong>Status:</strong> ${relatorio.status}</p>
                `;

            } catch (error) {
                console.error('Erro:', error);
                resultDiv.innerHTML = `
                    <h3>❌ Erro</h3>
                    <p>${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>