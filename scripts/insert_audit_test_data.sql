-- =====================================================\n-- SCRIPT DE DADOS DE TESTE PARA MÓDULO DE AUDITORIA\n-- Criado por: Especialista em Auditoria (30 anos exp.)\n-- Objetivo: Validar fluxo completo de auditoria\n-- =====================================================\n\n-- Verificar se existe tenant para inserir dados\nDO $$\nDECLARE\n    tenant_uuid UUID;\n    profile_uuid UUID;\nBEGIN\n    -- Buscar primeiro tenant disponível\n    SELECT id INTO tenant_uuid FROM tenants LIMIT 1;\n    \n    IF tenant_uuid IS NULL THEN\n        RAISE NOTICE 'Nenhum tenant encontrado. Criando tenant de teste...';\n        \n        -- Criar tenant de teste\n        INSERT INTO tenants (id, name, slug, created_at) \n        VALUES (gen_random_uuid(), 'Empresa Teste Auditoria', 'empresa-teste', NOW())\n        RETURNING id INTO tenant_uuid;\n    END IF;\n    \n    -- Buscar primeiro profile disponível\n    SELECT id INTO profile_uuid FROM profiles WHERE tenant_id = tenant_uuid LIMIT 1;\n    \n    IF profile_uuid IS NULL THEN\n        RAISE NOTICE 'Nenhum profile encontrado para o tenant. Usando NULL para created_by.';\n    END IF;\n    \n    RAISE NOTICE 'Usando tenant: % e profile: %', tenant_uuid, profile_uuid;\n    \n    -- =====================================================\n    -- 1. UNIVERSO AUDITÁVEL - Processos Críticos\n    -- =====================================================\n    \n    INSERT INTO universo_auditavel (\n        tenant_id, codigo, nome, descricao, tipo, nivel, criticidade, \n        frequencia_auditoria, responsavel, status, created_by, updated_by\n    ) VALUES \n    -- Processos Financeiros (Alto Risco)\n    (tenant_uuid, 'PROC-001', 'Contas a Pagar', 'Processo de pagamento de fornecedores incluindo aprovações, três vias e controles de duplicatas', 'processo', 1, 'alta', 12, 'João Silva - CFO', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'PROC-002', 'Contas a Receber', 'Processo de faturamento e cobrança de clientes', 'processo', 1, 'alta', 12, 'Maria Santos - Controladoria', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'PROC-003', 'Folha de Pagamento', 'Processamento de salários, benefícios e encargos', 'processo', 1, 'critica', 6, 'Carlos Oliveira - RH', 'ativo', profile_uuid, profile_uuid),\n    \n    -- Sistemas Críticos\n    (tenant_uuid, 'SYS-001', 'ERP Financeiro', 'Sistema SAP para gestão financeira e contábil', 'sistema', 1, 'critica', 12, 'Ana Costa - TI', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'SYS-002', 'Sistema de Vendas', 'CRM e sistema de vendas online', 'sistema', 1, 'alta', 18, 'Pedro Lima - Vendas', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'SYS-003', 'Backup e Recovery', 'Sistema de backup e recuperação de dados', 'sistema', 1, 'critica', 6, 'Ana Costa - TI', 'ativo', profile_uuid, profile_uuid),\n    \n    -- Departamentos\n    (tenant_uuid, 'DEPT-001', 'Controladoria', 'Departamento de controladoria e compliance', 'departamento', 1, 'alta', 24, 'Maria Santos', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'DEPT-002', 'Tecnologia da Informação', 'Departamento de TI e segurança da informação', 'departamento', 1, 'critica', 12, 'Ana Costa', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'DEPT-003', 'Recursos Humanos', 'Gestão de pessoas e folha de pagamento', 'departamento', 1, 'media', 24, 'Carlos Oliveira', 'ativo', profile_uuid, profile_uuid),\n    \n    -- Subsidiárias\n    (tenant_uuid, 'SUB-001', 'Filial São Paulo', 'Filial principal em São Paulo', 'subsidiaria', 1, 'alta', 18, 'Roberto Silva - Gerente', 'ativo', profile_uuid, profile_uuid),\n    (tenant_uuid, 'SUB-002', 'Filial Rio de Janeiro', 'Filial secundária no Rio de Janeiro', 'subsidiaria', 2, 'media', 24, 'Fernanda Costa - Gerente', 'ativo', profile_uuid, profile_uuid)\n    ON CONFLICT (tenant_id, codigo) DO NOTHING;\n    \n    -- =====================================================\n    -- 2. PLANO ANUAL DE AUDITORIA 2025\n    -- =====================================================\n    \n    INSERT INTO planos_auditoria_anuais (\n        tenant_id, codigo, titulo, ano_exercicio, descricao, \n        data_aprovacao, aprovado_por, status, total_horas_planejadas, \n        total_recursos_orcados, created_by, updated_by\n    ) VALUES (\n        tenant_uuid,\n        'PAA-2025',\n        'Plano Anual de Auditoria Interna 2025',\n        2025,\n        'Plano anual baseado em avaliação de riscos contemplando processos críticos, sistemas de TI, compliance regulatório e follow-up de recomendações anteriores.',\n        '2024-12-15',\n        profile_uuid,\n        'approved',\n        2400.0,\n        450000.00,\n        profile_uuid,\n        profile_uuid\n    ) ON CONFLICT (tenant_id, codigo) DO NOTHING;\n    \n    -- =====================================================\n    -- 3. TRABALHOS DE AUDITORIA DETALHADOS\n    -- =====================================================\n    \n    INSERT INTO trabalhos_auditoria (\n        tenant_id, plano_anual_id, codigo, titulo, descricao, objetivos, escopo,\n        tipo_auditoria, area_auditada, unidade_organizacional, nivel_risco, frequencia,\n        data_inicio_planejada, data_fim_planejada, auditor_lider, horas_planejadas, \n        orcamento_estimado, status, prioridade, prerequisitos, recursos_necessarios,\n        created_by, updated_by\n    ) VALUES \n    -- Trabalho 1: Auditoria de Contas a Pagar\n    (\n        tenant_uuid,\n        (SELECT id FROM planos_auditoria_anuais WHERE codigo = 'PAA-2025' AND tenant_id = tenant_uuid),\n        'TAD-2025-001',\n        'Auditoria Operacional - Processo de Contas a Pagar',\n        'Auditoria operacional e de compliance do processo de contas a pagar, incluindo controles preventivos, aprovações por alçada, segregação de funções e prevenção de fraudes.',\n        ARRAY[\n            'Avaliar a efetividade dos controles internos do processo de contas a pagar',\n            'Verificar compliance com políticas internas e regulamentações',\n            'Identificar oportunidades de melhoria e automação',\n            'Validar segregação adequada de funções',\n            'Testar controles de prevenção de pagamentos duplicados'\n        ],\n        'Processo completo desde recebimento da fatura até pagamento, incluindo: aprovações por alçada, conferência de três vias (pedido, nota fiscal, recebimento), controles de duplicatas, cadastro de fornecedores e conciliações bancárias.',\n        'operational',\n        'Financeiro - Contas a Pagar',\n        'Controladoria',\n        'alto',\n        'anual',\n        '2025-02-03',\n        '2025-03-14',\n        profile_uuid,\n        280.0,\n        52000.00,\n        'planejado',\n        4,\n        ARRAY[\n            'Aprovação do orçamento anual de auditoria',\n            'Disponibilidade da equipe do departamento financeiro',\n            'Acesso completo aos sistemas ERP e documentação',\n            'Coordenação com auditoria externa para evitar sobreposição'\n        ],\n        ARRAY[\n            'Auditor sênior especialista em processos financeiros',\n            'Analista de auditoria com conhecimento em ERP',\n            'Acesso total ao sistema SAP e módulos financeiros',\n            'Ferramentas de análise de dados (ACL ou IDEA)'\n        ],\n        profile_uuid,\n        profile_uuid\n    ),\n    \n    -- Trabalho 2: Auditoria de TI e Segurança da Informação\n    (\n        tenant_uuid,\n        (SELECT id FROM planos_auditoria_anuais WHERE codigo = 'PAA-2025' AND tenant_id = tenant_uuid),\n        'TAD-2025-002',\n        'Auditoria de TI - Segurança da Informação e LGPD',\n        'Avaliação abrangente dos controles de TI, segurança cibernética, gestão de acessos, backup/recovery, monitoramento de rede e conformidade com LGPD.',\n        ARRAY[\n            'Avaliar controles de acesso lógico aos sistemas críticos',\n            'Verificar políticas e procedimentos de backup e disaster recovery',\n            'Validar compliance com LGPD e proteção de dados pessoais',\n            'Testar controles de segurança da rede e firewall',\n            'Avaliar gestão de patches e atualizações de segurança',\n            'Verificar monitoramento de atividades suspeitas'\n        ],\n        'Infraestrutura completa de TI incluindo: servidores, rede, sistemas críticos, controles de acesso, políticas de backup, segurança cibernética, proteção de dados pessoais (LGPD), gestão de incidentes de segurança.',\n        'it',\n        'Tecnologia da Informação',\n        'TI',\n        'critico',\n        'anual',\n        '2025-04-07',\n        '2025-05-30',\n        profile_uuid,\n        360.0,\n        85000.00,\n        'planejado',\n        5,\n        ARRAY[\n            'Contratação de consultoria externa especializada em cybersecurity',\n            'Mapeamento completo da infraestrutura de TI',\n            'Coordenação com área de TI para minimizar impacto operacional',\n            'Aprovação para testes de penetração controlados'\n        ],\n        ARRAY[\n            'Auditor especialista em TI com certificação CISA',\n            'Consultor externo de cybersecurity',\n            'Ferramentas de teste de penetração (Nessus, Metasploit)',\n            'Acesso administrativo aos sistemas para testes controlados'\n        ],\n        profile_uuid,\n        profile_uuid\n    ),\n    \n    -- Trabalho 3: Follow-up de Recomendações\n    (\n        tenant_uuid,\n        (SELECT id FROM planos_auditoria_anuais WHERE codigo = 'PAA-2025' AND tenant_id = tenant_uuid),\n        'TAD-2025-003',\n        'Follow-up - Implementação de Recomendações 2024',\n        'Acompanhamento sistemático da implementação das recomendações emitidas nas auditorias realizadas em 2024, com foco em recomendações de alta e média criticidade.',\n        ARRAY[\n            'Verificar status de implementação de todas as recomendações 2024',\n            'Avaliar efetividade das ações corretivas implementadas',\n            'Identificar recomendações pendentes e motivos de atraso',\n            'Atualizar sistema de acompanhamento de recomendações',\n            'Reportar status para alta administração'\n        ],\n        'Todas as recomendações emitidas entre janeiro e dezembro de 2024, classificadas como alta e média criticidade, incluindo planos de ação, evidências de implementação e testes de efetividade.',\n        'follow_up',\n        'Todas as áreas auditadas em 2024',\n        'Múltiplas',\n        'medio',\n        'semestral',\n        '2025-06-02',\n        '2025-07-11',\n        profile_uuid,\n        160.0,\n        24000.00,\n        'planejado',\n        3,\n        ARRAY[\n            'Relatórios de auditoria de 2024 com recomendações',\n            'Planos de ação formalizados pelas áreas auditadas',\n            'Acesso ao sistema de gestão de recomendações'\n        ],\n        ARRAY[\n            'Analista de auditoria com experiência em follow-up',\n            'Acesso ao sistema de gestão de recomendações',\n            'Coordenação com todas as áreas auditadas em 2024'\n        ],\n        profile_uuid,\n        profile_uuid\n    ),\n    \n    -- Trabalho 4: Auditoria de Compliance Regulatório\n    (\n        tenant_uuid,\n        (SELECT id FROM planos_auditoria_anuais WHERE codigo = 'PAA-2025' AND tenant_id = tenant_uuid),\n        'TAD-2025-004',\n        'Auditoria de Compliance - SOX e Regulamentações',\n        'Auditoria de compliance focada em Sarbanes-Oxley (SOX), controles internos sobre relatórios financeiros (ICFR) e outras regulamentações aplicáveis.',\n        ARRAY[\n            'Avaliar efetividade dos controles SOX implementados',\n            'Testar controles internos sobre relatórios financeiros (ICFR)',\n            'Verificar compliance com regulamentações setoriais',\n            'Validar processo de certificação de controles internos',\n            'Identificar deficiências materiais ou significativas'\n        ],\n        'Controles internos relacionados a relatórios financeiros, processos de fechamento contábil, controles de TI que suportam relatórios financeiros, e compliance com regulamentações aplicáveis.',\n        'compliance',\n        'Controladoria e Compliance',\n        'Controladoria',\n        'critico',\n        'anual',\n        '2025-08-04',\n        '2025-09-26',\n        profile_uuid,\n        320.0,\n        75000.00,\n        'planejado',\n        5,\n        ARRAY[\n            'Coordenação com auditoria externa (Big Four)',\n            'Documentação atualizada de todos os controles SOX',\n            'Acesso a sistemas financeiros e de relatórios'\n        ],\n        ARRAY[\n            'Auditor sênior com experiência em SOX',\n            'Especialista em controles internos',\n            'Ferramentas de documentação de controles',\n            'Acesso a sistemas financeiros e ERP'\n        ],\n        profile_uuid,\n        profile_uuid\n    )\n    ON CONFLICT (plano_anual_id, codigo) DO NOTHING;\n    \n    -- =====================================================\n    -- 4. PROJETOS DE AUDITORIA (Execuções)\n    -- =====================================================\n    \n    INSERT INTO projetos_auditoria (\n        tenant_id, codigo, titulo, descricao, universo_auditavel_id,\n        tipo_auditoria, escopo, objetivos, data_inicio, data_fim_planejada,\n        chefe_auditoria, horas_orcadas, status, fase_atual,\n        metadados, created_by, updated_by\n    ) VALUES \n    (\n        tenant_uuid,\n        'PROJ-2024-001',\n        'Auditoria de Folha de Pagamento - Concluída',\n        'Auditoria operacional do processo de folha de pagamento realizada em 2024',\n        (SELECT id FROM universo_auditavel WHERE codigo = 'PROC-003' AND tenant_id = tenant_uuid),\n        'operational',\n        'Processo completo de folha de pagamento incluindo cálculos, aprovações e pagamentos',\n        ARRAY['Validar cálculos de folha', 'Testar controles de aprovação', 'Verificar compliance trabalhista'],\n        '2024-03-01',\n        '2024-04-15',\n        profile_uuid,\n        240.0,\n        'concluido',\n        'concluida',\n        '{\"sox_audit\": false, \"regulatory\": true, \"findings_count\": 3, \"critical_findings\": 1}',\n        profile_uuid,\n        profile_uuid\n    ),\n    (\n        tenant_uuid,\n        'PROJ-2024-002',\n        'Auditoria de TI - Em Andamento',\n        'Auditoria de segurança da informação em execução',\n        (SELECT id FROM universo_auditavel WHERE codigo = 'SYS-001' AND tenant_id = tenant_uuid),\n        'it',\n        'Controles de acesso, backup e segurança de rede',\n        ARRAY['Avaliar controles de acesso', 'Testar backup/recovery', 'Verificar segurança de rede'],\n        '2024-11-01',\n        '2024-12-20',\n        profile_uuid,\n        320.0,\n        'em_andamento',\n        'fieldwork',\n        '{\"sox_audit\": false, \"regulatory\": false, \"findings_count\": 0, \"critical_findings\": 0}',\n        profile_uuid,\n        profile_uuid\n    )\n    ON CONFLICT (tenant_id, codigo) DO NOTHING;\n    \n    -- =====================================================\n    -- 5. RELATÓRIOS DE AUDITORIA\n    -- =====================================================\n    \n    INSERT INTO relatorios_auditoria (\n        tenant_id, titulo, tipo, resumo_executivo, status,\n        total_apontamentos, apontamentos_criticos, compliance_score,\n        autor_id, created_by, created_at\n    ) VALUES \n    (\n        tenant_uuid,\n        'Relatório de Auditoria - Folha de Pagamento 2024',\n        'operational',\n        'Auditoria operacional do processo de folha de pagamento identificou 3 apontamentos, sendo 1 crítico relacionado a controles de aprovação. Recomendações implementadas resultaram em melhoria significativa dos controles.',\n        'aprovado',\n        3,\n        1,\n        85,\n        profile_uuid,\n        profile_uuid,\n        '2024-04-20'\n    ),\n    (\n        tenant_uuid,\n        'Relatório Executivo - Status Geral de Auditoria Q3 2024',\n        'executivo',\n        'Relatório executivo consolidado do terceiro trimestre de 2024 apresentando status dos trabalhos de auditoria, principais achados e recomendações para a alta administração.',\n        'publicado',\n        8,\n        2,\n        78,\n        profile_uuid,\n        profile_uuid,\n        '2024-10-15'\n    ),\n    (\n        tenant_uuid,\n        'Relatório de Compliance - SOX 2024',\n        'compliance',\n        'Avaliação dos controles internos sobre relatórios financeiros (ICFR) conforme Sarbanes-Oxley. Identificadas 2 deficiências significativas que requerem ação corretiva imediata.',\n        'em_revisao',\n        5,\n        2,\n        72,\n        profile_uuid,\n        profile_uuid,\n        '2024-11-30'\n    )\n    ON CONFLICT DO NOTHING;\n    \n    RAISE NOTICE 'Dados de teste inseridos com sucesso!';\n    RAISE NOTICE 'Tenant utilizado: %', tenant_uuid;\n    RAISE NOTICE 'Profile utilizado: %', COALESCE(profile_uuid::text, 'NULL');\n    \nEND $$;