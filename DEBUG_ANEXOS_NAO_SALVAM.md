# üîç DEBUG: ANEXOS N√ÉO EST√ÉO SENDO SALVOS\n\n## üö® **Problema Reportado**\n\n**Status:** \"agora consigo anexar mas n√£o salva\"\n\n**Sintomas:**\n- ‚úÖ Upload de arquivos funciona\n- ‚úÖ Arquivos aparecem na interface\n- ‚ùå Anexos n√£o s√£o salvos no banco de dados\n- ‚ùå Anexos desaparecem ap√≥s salvar a pol√≠tica\n\n---\n\n## üîß **Debug Implementado**\n\n### **Logs Adicionados:**\n\n#### **1. Verifica√ß√£o de Metadados no Salvamento**\n```javascript\n// Em handleSaveEdit\nconsole.log('üìé Anexos que ser√£o salvos:', updatedPolicy.metadata);\nconsole.log('üìé N√∫mero de anexos:', updatedPolicy.metadata?.attachedDocuments?.length || 0);\n```\n\n#### **2. Processamento de Metadados**\n```javascript\n// Em handleSavePolicy\nconsole.log('üìé DEBUG METADADOS:');\nconsole.log('  - updatedPolicy.metadata (original):', (updatedPolicy as any).metadata);\nconsole.log('  - Tipo dos metadados:', typeof (updatedPolicy as any).metadata);\nconsole.log('  - metadataString gerada:', metadataString);\nconsole.log('  - Tamanho da string:', metadataString.length);\n```\n\n#### **3. Verifica√ß√£o P√≥s-Salvamento**\n```javascript\n// Verificar se foi realmente salvo no banco\nconst { data: verifyData } = await supabase\n  .from('policies')\n  .select('metadata, document_url')\n  .eq('id', updatedPolicy.id)\n  .single();\n  \nconsole.log('‚úÖ Dados salvos no banco:');\nconsole.log('  - document_url:', verifyData.document_url);\nconsole.log('  - metadata:', verifyData.metadata);\nconsole.log('  - attachedDocuments salvos:', parsedMetadata.attachedDocuments?.length || 0);\n```\n\n---\n\n## üß™ **Como Testar**\n\n### **1. Acesse a aplica√ß√£o:**\n```\nhttp://localhost:8080\n```\n\n### **2. Abra o Console do Navegador:**\n- **Chrome/Firefox:** F12 ‚Üí Console\n- **Safari:** Cmd+Option+C\n\n### **3. Teste o fluxo completo:**\n\n#### **Passo 1: Editar uma pol√≠tica**\n1. V√° para \"Gest√£o de Pol√≠ticas\"\n2. Clique em \"Editar\" em uma pol√≠tica existente\n3. **Observe os logs:** Deve mostrar documentos carregados\n\n#### **Passo 2: Anexar um documento**\n1. Arraste um arquivo PDF para a √°rea de upload\n2. **Observe os logs:** Deve mostrar o upload sendo realizado\n3. Verifique se o arquivo aparece na lista\n\n#### **Passo 3: Salvar a pol√≠tica**\n1. Clique em \"Salvar Altera√ß√µes\"\n2. **Observe os logs detalhados:**\n\n**Logs esperados:**\n```\n=== üîç DEBUG DETALHADO - IN√çCIO DO SALVAMENTO ===\nüìé Anexos que ser√£o salvos: {attachedDocuments: [...]}\nüìé N√∫mero de anexos: 1\n\n=== üíæ IN√çCIO DO SALVAMENTO NO BANCO ===\nüìé DEBUG METADADOS:\n  - updatedPolicy.metadata (original): {attachedDocuments: [...]}\n  - Tipo dos metadados: object\n  - metadataString gerada: {\"attachedDocuments\":[...]}\n  - Tamanho da string: 245\nüìé updateData.metadata final: {\"attachedDocuments\":[...]}\nüìé updateData.document_url: https://...\n\n‚úÖ handleSavePolicy retornou com sucesso\nüîç Verificando se os anexos foram salvos...\n‚úÖ Dados salvos no banco:\n  - document_url: https://...\n  - metadata: {\"attachedDocuments\":[...]}\n  - attachedDocuments salvos: 1\n```\n\n#### **Passo 4: Verificar persist√™ncia**\n1. Feche o modal\n2. Abra a pol√≠tica novamente para edi√ß√£o\n3. **Verifique:** Os anexos devem aparecer na lista\n\n---\n\n## üîç **Poss√≠veis Problemas e Solu√ß√µes**\n\n### **Problema 1: Metadados n√£o est√£o sendo constru√≠dos**\n**Sintoma:** `updatedPolicy.metadata` √© `undefined` ou `null`\n\n**Logs esperados:**\n```\nüìé Anexos que ser√£o salvos: undefined\nüìé N√∫mero de anexos: 0\n```\n\n**Solu√ß√£o:** Verificar se `attachedDocuments` est√° sendo passado corretamente\n\n### **Problema 2: Metadados n√£o est√£o sendo serializados**\n**Sintoma:** Erro ao fazer `JSON.stringify`\n\n**Logs esperados:**\n```\n‚ùå Erro ao processar metadata: [erro]\n- Usando metadata vazia\n```\n\n**Solu√ß√£o:** Verificar estrutura dos objetos em `attachedDocuments`\n\n### **Problema 3: Banco n√£o est√° salvando metadados**\n**Sintoma:** Update executa mas metadados n√£o persistem\n\n**Logs esperados:**\n```\n‚úÖ Dados salvos no banco:\n  - metadata: {}\n  - attachedDocuments salvos: 0\n```\n\n**Solu√ß√£o:** Verificar pol√≠ticas RLS ou constraints do banco\n\n### **Problema 4: Cache do PostgREST**\n**Sintoma:** Dados salvos mas n√£o aparecem na consulta\n\n**Logs esperados:**\n```\nüìé updateData.metadata final: {\"attachedDocuments\":[...]}\n‚úÖ Dados salvos no banco:\n  - metadata: null\n```\n\n**Solu√ß√£o:** Usar fun√ß√£o RPC ou aguardar cache expirar\n\n---\n\n## üõ†Ô∏è **Verifica√ß√µes Adicionais**\n\n### **1. Verificar no Banco Diretamente:**\n```sql\n-- Conectar ao banco remoto\npsql \"postgresql://postgres:Vo1agPUE4QGwlwqS@db.myxvxponlmulnjstbjwd.supabase.co:5432/postgres\"\n\n-- Verificar metadados de uma pol√≠tica espec√≠fica\nSELECT id, title, metadata, document_url \nFROM policies \nWHERE id = 'ID_DA_POLITICA' \nLIMIT 1;\n\n-- Verificar se h√° metadados em alguma pol√≠tica\nSELECT id, title, \n       CASE \n         WHEN metadata IS NULL THEN 'NULL'\n         WHEN metadata = '{}' THEN 'VAZIO'\n         ELSE 'COM DADOS'\n       END as metadata_status\nFROM policies \nWHERE metadata IS NOT NULL \nORDER BY updated_at DESC \nLIMIT 5;\n```\n\n### **2. Verificar Estrutura da Tabela:**\n```sql\n-- Verificar se coluna metadata existe e tipo\n\\d+ policies\n\n-- Verificar constraints\nSELECT conname, contype, pg_get_constraintdef(oid) \nFROM pg_constraint \nWHERE conrelid = 'policies'::regclass;\n```\n\n### **3. Verificar Arquivos no Storage:**\n```sql\n-- Verificar arquivos no bucket policy-documents\nSELECT name, bucket_id, created_at, metadata \nFROM storage.objects \nWHERE bucket_id = 'policy-documents' \nORDER BY created_at DESC \nLIMIT 10;\n```\n\n---\n\n## üìã **Checklist de Debug**\n\n### **Durante o Upload:**\n- [ ] Arquivo √© enviado com sucesso para o storage\n- [ ] URL p√∫blica √© gerada\n- [ ] Documento √© adicionado ao array `attachedDocuments`\n- [ ] Interface mostra o arquivo na lista\n\n### **Durante o Salvamento:**\n- [ ] `updatedPolicy.metadata` cont√©m os anexos\n- [ ] Metadados s√£o serializados corretamente\n- [ ] `updateData.metadata` cont√©m a string JSON\n- [ ] Query de update executa sem erro\n- [ ] Verifica√ß√£o p√≥s-salvamento mostra dados corretos\n\n### **Ap√≥s o Salvamento:**\n- [ ] Modal fecha sem erro\n- [ ] Pol√≠tica √© recarregada na lista\n- [ ] Ao reabrir para edi√ß√£o, anexos aparecem\n- [ ] Banco de dados cont√©m os metadados\n\n---\n\n## üéØ **Pr√≥ximos Passos**\n\n1. **Execute o teste** seguindo os passos acima\n2. **Copie todos os logs** do console\n3. **Identifique** em qual etapa o problema ocorre\n4. **Verifique** se os dados est√£o no banco\n5. **Reporte** os logs espec√≠ficos onde o problema acontece\n\n---\n\n## üìä **Estrutura Esperada dos Metadados**\n\n```json\n{\n  \"attachedDocuments\": [\n    {\n      \"id\": \"1724445123456\",\n      \"name\": \"documento.pdf\",\n      \"size\": 1024000,\n      \"type\": \"application/pdf\",\n      \"url\": \"https://myxvxponlmulnjstbjwd.supabase.co/storage/v1/object/public/policy-documents/46b1c048-85a1-423b-96fc-776007c8de1f/1724445123456-abc123.pdf\",\n      \"storagePath\": \"46b1c048-85a1-423b-96fc-776007c8de1f/1724445123456-abc123.pdf\",\n      \"uploadedAt\": \"2025-08-23T18:45:23.456Z\"\n    }\n  ]\n}\n```\n\n---\n\n*Debug implementado em: 23 de Agosto de 2025*  \n*Problema: Anexos n√£o persistem ap√≥s salvamento*  \n*Status: Aguardando logs de teste para identificar causa raiz*\n\n## üöÄ **TESTE AGORA E REPORTE OS LOGS!**\n\nCom os logs detalhados implementados, ser√° poss√≠vel identificar exatamente onde o problema est√° ocorrendo e corrigi-lo rapidamente.